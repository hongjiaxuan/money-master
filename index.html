<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Money Master</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // å•Ÿç”¨ class ç­–ç•¥ï¼Œè®“æˆ‘å€‘å¯ä»¥æ‰‹å‹•åˆ‡æ›
        }
    </script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <style>
        /* --- å…¨åŸŸæ¨£å¼è¨­å®š --- */
        :root {
            --bg-muji: #F5F5F3;
            --text-primary: #333333;
            --text-secondary: #7F7F7F;
            --border-color: #E6E6E6;
            --nav-height: 64px;
        }

        body {
            background-color: var(--bg-muji);
            color: var(--text-primary);
            font-family: "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Microsoft JhengHei", sans-serif;
            margin: 0;
            padding: 0;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }

        #root {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes slide-up {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }

        .muji-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        
        .muji-button:active {
            opacity: 0.6;
            transform: scale(0.98);
        }
        /* å¼§å½¢è¦–çª—æ•ˆæœ */
        .modal-curve-top {
            border-radius: 50% 50% 0 0 / 24px 24px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }
        
        /* é ç®—é€²åº¦æ¢å‹•ç•« */
        @keyframes grow-width {
            from { width: 0; }
            to { width: 100%; }
        }
        .animate-grow { animation: grow-width 1s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        /* è¨˜å¸³é›»å­é›å‹•ç•« */
        @keyframes fan-out {
            from { opacity: 0; transform: translate(0, 0) scale(0.5); }
        }
        /* --- Dark Mode å…¨åŸŸè¦†å¯« (è«è˜­è¿ªæ·±ç°ç‰ˆ) --- */
        /* 1. èƒŒæ™¯è‰²ï¼šä½¿ç”¨æŸ”å’Œçš„éœ§é¢æ·±ç°ï¼Œè€Œéç´”é»‘ */
        html.dark body {
            background-color: #2B2D30; /* è«è˜­è¿ªæ·±ç‚­ç° */
            color: #E6E6E6; /* æŸ”å’Œç™½ï¼Œä¸åˆºçœ¼ */
        }
        
        /* 2. å¡ç‰‡èƒŒæ™¯ï¼šæ¯”èƒŒæ™¯ç¨äº®ä¸€é»çš„ç°è‰²ï¼Œç‡Ÿé€ å±¤æ¬¡æ„Ÿ */
        html.dark .bg-white { 
            background-color: #36393F !important; /* é¡ä¼¼ Discord çš„èˆ’é©ç° */
            border-color: #40444B !important;     /* é‚Šæ¡†é¡è‰²è¦æ·¡åŒ– */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2) !important; /* æŸ”å’Œé™°å½± */
        }
        
        /* 3. ä¿®æ­£åŸæœ¬çš„æ·ºç°èƒŒæ™¯ */
        html.dark .bg-\[\#F5F5F3\] { 
            background-color: #2B2D30 !important; /* èˆ‡ Body èƒŒæ™¯ä¸€è‡´ */
        } 
        
        /* 4. ä¿®æ­£è¼¸å…¥æ¡†èˆ‡æ¬¡è¦å€å¡Š */
        html.dark .bg-gray-50, 
        html.dark .bg-gray-100 { 
            background-color: #40444B !important; /* æ·ºä¸€é»çš„ç° */
            border-color: #4F545C !important; 
        }
        
        html.dark .bg-gray-200 { 
            background-color: #4F545C !important; 
        }

        /* 5. åè½‰ä¸»è¦é»‘è‰²æŒ‰éˆ• (æ”¹æˆæ·ºç°ç™½ï¼Œè®“æ–‡å­—è®Šæ·±ç°) */
        html.dark .bg-\[\#333\] { 
            background-color: #B9BBBE !important; /* è«è˜­è¿ªæ·ºç° */
            color: #202225 !important;            /* æ·±è‰²æ–‡å­— */
        } 
        
        /* 6. æ–‡å­—é¡è‰²å„ªåŒ– (é™ä½å°æ¯”åº¦) */
        html.dark .text-\[\#333\] { color: #E6E6E6 !important; }
        html.dark .text-gray-600 { color: #B9BBBE !important; } /* æ¬¡è¦æ–‡å­— */
        html.dark .text-gray-500 { color: #A0A0A0 !important; }
        html.dark .text-gray-400 { color: #888888 !important; }
        
        /* 7. é‚Šæ¡†èˆ‡ç´°ç¯€ */
        html.dark .border-gray-100, 
        html.dark .border-gray-200 { 
            border-color: #40444B !important; 
        }
        
        html.dark input, 
        html.dark select { 
            color: #E6E6E6 !important; 
            background-color: transparent !important; 
        }
        
        html.dark .shadow-sm, 
        html.dark .shadow-md, 
        html.dark .shadow-lg { 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3) !important; 
        }
        
        /* 8. ç‰¹æ®Šä¿®æ­£ */
        html.dark .muji-card { 
            background-color: #36393F; 
            border-color: #40444B; 
        }
        /* åœ–è¡¨æ–‡å­— */
        html.dark .recharts-text { fill: #A0A0A0 !important; }
        /* --- è¨˜å¸³é›»å­é›æ¨£å¼ --- */
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        .animate-bounce-slow { animation: bounce-slow 2s infinite ease-in-out; }
        
        /* å°è©±æ¡†å°å°¾å·´ */
        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px 6px 0;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        /* æ·±è‰²æ¨¡å¼ä¸‹çš„å°è©±æ¡† */
        html.dark .speech-bubble { background-color: #36393F; color: #E6E6E6; border: 1px solid #40444B; }
        html.dark .speech-bubble::after { border-color: #40444B transparent transparent transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // --- Icons ---
        const IconPaths = {
            wallet: <path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4M4 6v12c0 1.1.9 2 2 2h14v-4M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z" />,
            creditCard: <g><rect width="20" height="14" x="2" y="5" rx="2" /><line x1="2" x2="22" y1="10" y2="10" /></g>,
            banknote: <g><rect width="20" height="12" x="2" y="6" rx="2" /><circle cx="12" cy="12" r="2" /><path d="M6 12h.01M18 12h.01" /></g>,
            plus: <g><path d="M5 12h14" /><path d="M12 5v14" /></g>,
            home: <g><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></g>,
            pieChart: <g><path d="M21.21 15.89A10 10 0 1 1 8 2.83" /><path d="M22 12A10 10 0 0 0 12 2v10z" /></g>,
            settings: <g><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></g>,
            back: <path d="m15 18-6-6 6-6" />,
            chevronRight: <path d="m9 18 6-6-6-6" />,
            chevronDown: <path d="m6 9 6 6 6-6" />,
            fileText: <g><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" x2="8" y1="13" y2="13" /><line x1="16" x2="8" y1="17" y2="17" /><line x1="10" x2="8" y1="9" y2="9" /></g>,
            trash: <g><path d="M3 6h18" /><path d="M19 6v14c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V6" /><path d="M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></g>,
            calendar: <g><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></g>,
            rotateCcw: <g><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></g>,
            close: <g><path d="M18 6 6 18" /><path d="m6 6 12 12" /></g>,
            list: <g><line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" /><line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" /></g>,
            edit: <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />,
            utensils: <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2M7 2v20M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7" />,
            bus: <path d="M8 6v6M15 6v6M2 12h19.6M18 18h3s.5-1.7.5-2.8M15 12V2.12C15.04.97 14.16.04 13 .04H8C6.84.04 5.96.97 6 2.12V12M1 18h3s.5-1.7.5-2.8M6 12v5M18 12v5" />, 
            shoppingBag: <g><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></g>,
            film: <g><rect width="20" height="20" x="2" y="2" rx="2.18" ry="2.18"/><line x1="7" x2="7" y1="2" y2="22"/><line x1="17" x2="17" y1="2" y2="22"/><line x1="2" x2="22" y1="12" y2="12"/><line x1="2" x2="7" y1="7" y2="7"/><line x1="2" x2="7" y1="17" y2="17"/><line x1="17" x2="22" y1="17" y2="17"/><line x1="17" x2="22" y1="7" y2="7"/></g>,
            briefcase: <g><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></g>,
            trendingUp: <g><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></g>,
            circleDollar: <g><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 18V6"/></g>,
            split: <path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l5 5M4 4l5 5"/>,
            medical: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>,
            more: <g><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></g>,
            users: <g><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></g>,
            check: <polyline points="20 6 9 17 4 12" />,
            download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>,
            lightning: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />,
            template: <g><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><line x1="3" y1="9" x2="21" y2="9" /><line x1="9" y1="21" x2="9" y2="9" /></g>,
            image: <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />,
            search: <g><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></g>,
            cloud: <path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.1-2.6-2.2-4.7-4.8-4.7-2.3 0-4.2 1.6-4.7 3.8C1.8 15.6 1.8 18.5 4.5 19h13z" />,
            upload: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></g>,
	        chevronUp: <path d="m18 15-6-6-6 6" />,
            grid: <g><rect x="3" y="3" width="7" height="7" /><rect x="14" y="3" width="7" height="7" /><rect x="14" y="14" width="7" height="7" /><rect x="3" y="14" width="7" height="7" /></g>,
            userCheck: <g><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></g>,
            moon: <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />,
            sun: <g><circle cx="12" cy="12" r="5" /><line x1="12" y1="1" x2="12" y2="3" /><line x1="12" y1="21" x2="12" y2="23" /><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" /><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" /><line x1="1" y1="12" x2="3" y2="12" /><line x1="21" y1="12" x2="23" y2="12" /><line x1="4.22" y1="19.78" x2="5.64" y2="18.36" /><line x1="18.36" y1="5.64" x2="19.78" y2="4.22" /></g>,
            eye: <g><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" /><circle cx="12" cy="12" r="3" /></g>,
            eyeOff: <g><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24" /><line x1="1" y1="1" x2="23" y2="23" /></g>,
            camera: <g><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></g>,
        // --- è²¡å‹™èˆ‡è³‡ç”¢ (æ¸…æ™°ç‰ˆ) ---
            wallet: <path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4M4 6v12c0 1.1.9 2 2 2h14v-4M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z" />,
            creditCard: <g><rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" y1="10" x2="22" y2="10" /></g>,
            banknote: <g><rect x="2" y="6" width="20" height="12" rx="2" /><circle cx="12" cy="12" r="2" /><path d="M6 12h.01M18 12h.01" /></g>,
            circleDollar: <g><circle cx="12" cy="12" r="10" /><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8M12 18V6" /></g>,
            trendingUp: <polyline points="23 6 13.5 15.5 8.5 10.5 1 18 17 6 23 6 23 12" />,
            briefcase: <g><rect x="2" y="7" width="20" height="14" rx="2" ry="2" /><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" /></g>,
            split: <path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l5 5M4 4l5 5" />,
            users: <g><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></g>,
            userCheck: <g><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><polyline points="16 11 18 13 22 9" /></g>,

            // --- ç”Ÿæ´»èˆ‡æ¶ˆè²» (å…·è±¡åŒ–) ---
            home: <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />,
            shoppingBag: <path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4ZM3 6h18M16 10a4 4 0 0 1-8 0" />,
            utensils: <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2M7 2v20M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7" />,
            coffee: <path d="M18 8h1a4 4 0 0 1 0 8h-1M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8zM6 1v3M10 1v3M14 1v3" />,
            more: <g><circle cx="12" cy="12" r="1" /><circle cx="19" cy="12" r="1" /><circle cx="5" cy="12" r="1" /></g>,

            // --- äº¤é€š (å…·è±¡åŒ–) ---
            bus: <path d="M8 6v6M15 6v6M2 12h19.6M18 18h3s.5-1.7.5-2.8M15 12V2.12C15.04.97 14.16.04 13 .04H8C6.84.04 5.96.97 6 2.12V12M1 18h3s.5-1.7.5-2.8M6 12v5M18 12v5" />,
            car: <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2M7 17h.01M17 17h.01M5 17h14" />,
            plane: <path d="M2 12h20M2 12l5-5M7 12l5 5M12 7l5-2M12 17l5 2" />, 
            map: <path d="M1 6v16l7-4 8 4 7-4V2l-7 4-8-4-7 4zM8 2v16M16 6v16" />,

            // --- å¨›æ¨‚èˆ‡ä¼‘é–’ (å…·è±¡åŒ–) ---
            film: <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18" />,
            game: <path d="M21 12a9 9 0 1 1-6.21-8.56M2 12a9 9 0 0 1 3.56-7.23M12 12v.01M8 12v.01M16 12v.01M12 16v.01" />, 
            music: <path d="M9 18V5l12-2v13M9 18a3 3 0 1 1-3-3 3 3 0 0 1 3 3zM21 16a3 3 0 1 1-3-3 3 3 0 0 1 3 3z" />,
            gift: <path d="M20 12v10H4V12M2 7h20v5H2zM12 22V7M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7zM12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z" />,

            // --- å¥åº·èˆ‡å®¶åº­ (å…·è±¡åŒ–) ---
            medical: <path d="M8 2v4M16 2v4M3 6h18v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6zm8 5v6M8 14h6" />,
            heart: <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />,
            baby: <path d="M9 12h.01M15 12h.01M12 16c1.5 0 3-1 3-3s-1.5-3-3-3-3 1-3 3 1.5 3 3 3zM12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z" />, 
            pet: <path d="M12 2a2 2 0 0 1 2 2 2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2zm-6 3a2 2 0 0 1 2 2 2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2zm12 0a2 2 0 0 1 2 2 2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2zm-1 9a4 4 0 0 1-8 0v-2a4 4 0 0 1 8 0v2z" />, 
            leaf: <path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10ZM2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12" />,

            // --- æ•™è‚²èˆ‡å·¥å…· (å…·è±¡åŒ–) ---
            book: <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />,
            pen: <path d="M12 19l7-7 3 3-7 7-3-3zM18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5zM2 2l7.586 7.586M11 11l-4 4" />,
            phone: <rect x="5" y="2" width="14" height="20" rx="2" ry="2" />,
            wifi: <path d="M5 12.55a11 11 0 0 1 14.08 0M1.42 9a16 16 0 0 1 21.16 0M8.53 16.11a6 6 0 0 1 6.95 0M12 20h.01" />,
            tool: <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />,
            star: <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
        };
        const Icon = ({ name, size = 20, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {IconPaths[name] || IconPaths.close}
            </svg>
        );

        // --- å·¥å…·å‡½å¼ ---
        // 1. é‡‘é¡åƒåˆ†ä½æ ¼å¼åŒ–
        const formatMoney = (amount) => {
            if (amount === undefined || amount === null || isNaN(amount)) return '0';
            // ç§»é™¤å°æ•¸é»å¾Œå¤šé¤˜çš„ 0ï¼Œè‹¥æœ‰å°æ•¸å‰‡ä¿ç•™
            return Number(amount).toLocaleString('en-US', { maximumFractionDigits: 2 });
        };

        // 2. ç”¢ç”Ÿ UUID (ç¢ºä¿ ID å”¯ä¸€æ€§)
        const generateId = () => Date.now().toString() + Math.random().toString(36).substr(2, 5);
        // --- Mock Data ---
        const INITIAL_ACCOUNTS = [
            { id: 'a1', name: 'ç¾é‡‘', type: 'cash', balance: 0, initialBalance: 0, currency: 'TWD' },
            { id: 'a2', name: 'éŠ€è¡Œ', type: 'bank', balance: 0, initialBalance: 0, currency: 'TWD' },
            { id: 'a3', name: 'ä¿¡ç”¨å¡', type: 'liability', balance: 0, initialBalance: 0, currency: 'TWD', limit: 150000 },
        ];

        const INITIAL_CATEGORIES = {
            expense: [
                { id: 'c1', name: 'é¤é£²', iconKey: 'utensils', color: '#A5A58D', subCategories: [{id:'c1s1', name:'æ—©é¤'}, {id:'c1s2', name:'åˆé¤'}, {id:'c1s3', name:'æ™šé¤'}] },
                { id: 'c2', name: 'äº¤é€š', iconKey: 'bus', color: '#6B705C', subCategories: [{id:'c2s1', name:'æ·é‹'}, {id:'c2s2', name:'è¨ˆç¨‹è»Š'}, {id:'c2s3', name:'åŠ æ²¹'}] },
                { id: 'c3', name: 'æ—¥ç”¨', iconKey: 'shoppingBag', color: '#CB997E', subCategories: [] },
                { id: 'c4', name: 'å¨›æ¨‚', iconKey: 'film', color: '#DDBEA9', subCategories: [] },
                { id: 'c5', name: 'é†«ç™‚', iconKey: 'medical', color: '#FFE8D6', subCategories: [] },
            ],
            income: [
                { id: 'i1', name: 'è–ªè³‡', iconKey: 'briefcase', color: '#B7B7A4', subCategories: [] },
                { id: 'i2', name: 'æŠ•è³‡', iconKey: 'trendingUp', color: '#A5A58D', subCategories: [] },
                { id: 'i3', name: 'å…¶ä»–', iconKey: 'circleDollar', color: '#DDBEA9', subCategories: [] },
            ]
        };

        const getLocalDateString = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
// --- æ™ºæ…§ç°¡è¨Šè§£æèˆ‡é›»å­é›é€£å‹• Hook ---
const useSmsAutoParser = (onDetected, setPetMsg) => {
    const { accounts, triggerHaptic, autoSmsEnabled } = React.useContext(DataContext);

    const SMS_RULES = [
        {
            bank: 'å°æ–°',
            regex: /æ‚¨æ–¼(\d{2}\/\d{2}).*?åˆ·å¡NT\$([\d,]+)/,
            pos: { date: 1, amount: 2 }
        },
        {
            bank: 'å¯Œé‚¦',
            regex: /å¯Œé‚¦ä¿¡ç”¨å¡.*?(\d{2}\/\d{2}).*?NT\$([\d,]+)/,
            pos: { date: 1, amount: 2 }
        },
        {
            bank: 'å°‡ä¾†',
            regex: /å°‡ä¾†éŠ€è¡Œ.*?(\d{2}\/\d{2}).*?æ¶ˆè²»NT\$([\d,]+)/,
            pos: { date: 1, amount: 2 }
        }
    ];

    useEffect(() => {
        if (!autoSmsEnabled) return;
        const checkClipboard = async () => {
            try {
                // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´ä¸¦ç²å¾—æ¬Šé™
                const text = await navigator.clipboard.readText();
                if (!text || text.length < 10) return;

                for (let rule of SMS_RULES) {
                    const match = text.match(rule.regex);
                    if (match) {
                        const amount = parseInt(match[rule.pos.amount].replace(/,/g, ''));
                        const dateStr = match[rule.pos.date];
                        const year = new Date().getFullYear();
                        const [m, d] = dateStr.split('/');
                        const formattedDate = `${year}-${m}-${d}`;

                        // éœ‡å‹•ä¸¦è®“é›»å­é›èªªè©±
                        if (triggerHaptic) triggerHaptic(20);
                        setPetMsg(`èåˆ°${rule.bank}çš„å¸³å–®äº†ï¼ğŸ”âœ¨`);

                        onDetected({
                            amount,
                            date: formattedDate,
                            bank: rule.bank,
                            note: `[è‡ªå‹•åµæ¸¬] ${rule.bank} åˆ·å¡`,
                            // è©¦åœ–å°‹æ‰¾åç¨±ç›¸è¿‘çš„å¸³æˆ¶
                            accountId: accounts.find(a => a.name.includes(rule.bank))?.id || accounts[0].id
                        });

                        // è§£ææˆåŠŸå¾Œæ¸…é™¤å‰ªè²¼ç°¿ï¼Œé¿å…ç„¡é™å¾ªç’°
                        await navigator.clipboard.writeText("");
                        break;
                    }
                }
            } catch (err) {
                // éœé»˜å¤±æ•—ï¼ˆé€šå¸¸æ˜¯æ¬Šé™å•é¡Œï¼‰
            }
        };

        window.addEventListener('focus', checkClipboard);
        return () => window.removeEventListener('focus', checkClipboard);
    }, [accounts, onDetected, setPetMsg, autoSmsEnabled]); // â˜… è¨˜å¾—æŠŠ autoSmsEnabled åŠ é€² dependencies
};
// å·¥å…·ï¼šç¹ªè£½åˆ†å¸³åœ–ç‰‡ (ä¿®æ­£ç‰ˆï¼šæ”¯æ´æ¨™ç¤ºä»˜æ¬¾äºº)
    const drawReceipt = (items, totalAmount) => {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const padding = 40;
            const lineHeight = 50;
            const headerHeight = 120;
            const footerHeight = 100;
            const width = 600;
            const height = headerHeight + (items.length * lineHeight) + footerHeight + padding; // å‹•æ…‹é«˜åº¦

            canvas.width = width;
            canvas.height = height;

            // èƒŒæ™¯
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, width, height);

            // æ¨™é¡Œ
            ctx.fillStyle = '#333333';
            ctx.font = 'bold 36px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('åˆ†å¸³æ˜ç´°', width / 2, 70);
            
            ctx.fillStyle = '#999999';
            ctx.font = '24px sans-serif';
            ctx.fillText(new Date().toISOString().split('T')[0], width / 2, 110);

            // åˆ†éš”ç·š
            ctx.beginPath();
            ctx.moveTo(padding, headerHeight);
            ctx.lineTo(width - padding, headerHeight);
            ctx.strokeStyle = '#E5E5E5';
            ctx.stroke();

            // åˆ—è¡¨
            ctx.font = '28px sans-serif';
            let y = headerHeight + 50;
            
            items.forEach(item => {
                // é …ç›®åç¨±
                ctx.textAlign = 'left';
                ctx.fillStyle = '#333333';
                ctx.fillText(item.name, padding, y);
                
                // ç‰¹åˆ¥æ¨™è¨»ï¼šå¦‚æœæ˜¯å°æ–¹å¢Šä»˜
                if (item.isOtherPaid) {
                    ctx.font = '20px sans-serif';
                    ctx.fillStyle = '#D9534F'; // ç´…è‰²
                    const nameWidth = ctx.measureText(item.name).width;
                    ctx.fillText('(å°æ–¹å¢Š)', padding + 20 + 200, y); // ç°¡å–®ä½ç§»
                    ctx.font = '28px sans-serif'; // é‚„åŸå­—é«”
                }

                // é‡‘é¡
                ctx.textAlign = 'right';
                ctx.fillStyle = item.isOtherPaid ? '#D9534F' : '#333333';
                ctx.fillText(`${item.isOtherPaid ? '-' : ''}$${item.amount}`, width - padding, y);
                
                y += lineHeight;
            });

            // ç¸½çµåˆ†éš”ç·š
            ctx.beginPath();
            ctx.moveTo(padding, height - footerHeight + 20);
            ctx.lineTo(width - padding, height - footerHeight + 20);
            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 2;
            ctx.stroke();

            // ç¸½çµ
            ctx.fillStyle = '#333333';
            ctx.textAlign = 'left';
            ctx.font = 'bold 32px sans-serif';
            ctx.fillText('ç¸½è¨ˆæ·¨é¡', padding, height - 30);

            ctx.textAlign = 'right';
            ctx.fillStyle = totalAmount >= 0 ? '#333333' : '#D9534F';
            ctx.fillText(`${totalAmount >= 0 ? 'æˆ‘å¤šä»˜ ' : 'æˆ‘å°‘ä»˜ '}$${Math.abs(totalAmount)}`, width - padding, height - 30);

            canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.9);
        });
    };

        // --- Components ---
        const Card = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`muji-card p-4 ${className}`}>
                {children}
            </div>
        );
// ä¿®æ”¹ï¼šç§»é™¤å…§éƒ¨çš„ setDialogï¼Œæ”¹ç”±å¤–éƒ¨å‚³å…¥çš„å‡½å¼æ§åˆ¶
const CustomDialog = ({ isOpen, title, content, isConfirm, onConfirm, onCancel }) => {
            if (!isOpen) return null;

            // â˜… ä¿®æ­£é—œéµï¼šå»ºç«‹ä¸€å€‹å°ˆå±¬çš„è™•ç†å‡½å¼
            const handleConfirmClick = () => {
                // 1. å…ˆåŸ·è¡Œç¢ºèªå‹•ä½œ (ä¾‹å¦‚åˆªé™¤)
                if (onConfirm) onConfirm();
                
                // 2. â˜… å¼·åˆ¶åŸ·è¡Œå–æ¶ˆå‹•ä½œ (ä¹Ÿå°±æ˜¯é—œé–‰è¦–çª—)
                // å› ç‚º DataProvider è£¡çš„ onCancel å°±æ˜¯è² è²¬æŠŠ show è¨­ç‚º false
                if (onCancel) onCancel();
            };

            return (
                <div className="fixed inset-0 z-[2000] bg-black/40 flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-white w-full max-w-xs rounded-lg shadow-xl animate-scale-in p-6">
                        <h3 className="text-lg font-medium text-[#333] mb-2">{title}</h3>
                        <p className="text-sm text-gray-500 mb-6 leading-relaxed whitespace-pre-wrap">{content}</p>
                        <div className="flex gap-3 justify-end">
                            {isConfirm && (
                                <button onClick={onCancel} className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-50 rounded transition">å–æ¶ˆ</button>
                            )}
                            {/* é€™è£¡ç¶å®šæˆ‘å€‘æ–°å¯«çš„ handleConfirmClick */}
                            <button onClick={handleConfirmClick} className="px-4 py-2 text-sm bg-[#333] text-white rounded shadow hover:bg-black transition">
                                {isConfirm ? 'ç¢ºèª' : 'çŸ¥é“äº†'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
// ==========================================
    // â˜… å‡ç´šç‰ˆï¼šTransactionCard (æ”¯æ´æ»‘å‹•æ“ä½œ Swipe-to-Action)
    // ==========================================
    const TransactionCard = ({ transaction, onClick }) => {
        // â˜… åŠ å…¥ handleDeleteTransaction æ”¯æ´å¿«é€Ÿåˆªé™¤
        const { accounts, categories, handleDeleteTransaction, triggerHaptic } = React.useContext(DataContext);
        
        // --- æ»‘å‹•ç‹€æ…‹ç®¡ç† ---
        const [translateX, setTranslateX] = useState(0);
        const [isDragging, setIsDragging] = useState(false);
        const touchStartX = useRef(0);
        const touchStartY = useRef(0);

        const handleTouchStart = (e) => {
            touchStartX.current = e.touches[0].clientX;
            touchStartY.current = e.touches[0].clientY;
            setIsDragging(true);
        };

        const handleTouchMove = (e) => {
            if (!isDragging) return;
            const diffX = e.touches[0].clientX - touchStartX.current;
            const diffY = e.touches[0].clientY - touchStartY.current;

            // å¦‚æœä¸»è¦æ˜¯ä¸Šä¸‹æ»‘å‹• (æ»¾å‹•é é¢)ï¼Œå°±å–æ¶ˆå·¦å³æ»‘å‹•çš„åˆ¤å®š
            if (Math.abs(diffY) > Math.abs(diffX) && Math.abs(diffX) < 10) {
                setIsDragging(false);
                return;
            }

            // â˜… æ–°å¢é€™è¡Œï¼šç¢ºèªæ˜¯ã€Œå·¦å³æ°´å¹³æ»‘å‹•ã€æ™‚ï¼Œåƒæ‰é€™å€‹äº‹ä»¶ï¼Œä¸è®“å¤–å±¤æ”¶åˆ°ç¿»é æŒ‡ä»¤
            e.stopPropagation();

            // é™åˆ¶æœ€å¤§æ»‘å‹•è·é›¢ç‚º 80px
            let newX = diffX;
            if (newX > 80) newX = 80;
            if (newX < -80) newX = -80;
            setTranslateX(newX);
        };

        // â˜… ä¿®æ­£ï¼šæ‹¬è™Ÿå…§è¨˜å¾—åŠ ä¸Š e
        const handleTouchEnd = (e) => {
            // â˜… æ–°å¢é€™è¡Œï¼šå¦‚æœå¡ç‰‡ç¢ºå¯¦è¢«æ»‘å‹•äº†ï¼ŒçµæŸæ™‚ä¹Ÿé˜»æ“‹äº‹ä»¶
            if (translateX !== 0) e.stopPropagation(); 
            
            setIsDragging(false);
            // æ ¹æ“šæ»‘å‹•è·é›¢æ±ºå®šæ˜¯å¦è¦ã€Œå¸é™„ã€å±•é–‹
            if (translateX < -40) {
                setTranslateX(-80); // å‘å·¦æ»‘å±•é–‹ (åˆªé™¤)
                if(triggerHaptic) triggerHaptic(10);
            } else if (translateX > 40) {
                setTranslateX(80); // å‘å³æ»‘å±•é–‹ (ç·¨è¼¯)
                if(triggerHaptic) triggerHaptic(10);
            } else {
                setTranslateX(0); // å½ˆå›åŸä½
            }
        };

        const getAccountInfo = (id) => {
            if (!id) return null;
            if (id === 'external_payer') return { name: 'åˆ†å¸³ä¾†æº', color: '#999' };
            if (id === 'external_receiver') return { name: 'åˆ†å¸³å°è±¡', color: '#999' };
            if (id === 'external_borrower') return { name: 'ä»£å¢Šå°è±¡', color: '#999' };
            return accounts.find(a => a.id === id) || { name: 'å·²åˆªé™¤å¸³æˆ¶', color: '#ccc', type: 'unknown' };
        };

        const account = getAccountInfo(transaction.accountId);
        const targetAccount = getAccountInfo(transaction.targetAccountId);
        
let category = null;
        if (transaction.type === 'expense') category = categories.expense.find(c => c.id === transaction.categoryId);
        else if (transaction.type === 'income') category = categories.income.find(c => c.id === transaction.categoryId);
        
        // â˜… ä¿®æ­£ï¼šç¾åŒ–ã€Œçµæ¸…è½‰å¸³ã€çš„é¡¯ç¤ºï¼Œä¸¦ä¿®å¾©æ‰¾ä¸åˆ°åœ–ç¤ºè®Šæˆ X çš„å•é¡Œ
        const isReimbursement = transaction.categoryId === 'reimbursement';
        const catName = category ? category.name : (isReimbursement ? 'åˆ†å¸³çµæ¸…' : (transaction.type === 'transfer' ? 'è½‰å¸³' : 'æœªçŸ¥åˆ†é¡'));
        const catIcon = category ? category.iconKey : (isReimbursement ? 'check' : (transaction.type === 'transfer' ? 'rotateCcw' : 'more'));
        const catColor = category ? category.color : (isReimbursement ? '#5CB85C' : '#999');

        return (
            <div className="relative w-full rounded-xl mb-2 overflow-hidden">
                {/* --- åº•å±¤æŒ‰éˆ•å€ (æ»‘å‹•å¾Œéœ²å‡ºçš„éƒ¨åˆ†) --- */}
                <div className={`absolute inset-0 flex justify-between items-center px-4 transition-colors duration-300 ${
                    translateX < -5 ? 'bg-[#D9534F]' : 
                    translateX > 5 ? 'bg-[#333]' : 
                    'bg-transparent'
                }`}>
                    <div className={`text-white flex items-center gap-1.5 text-sm font-bold transition-opacity ${translateX > 20 ? 'opacity-100' : 'opacity-0'}`} onClick={(e) => { e.stopPropagation(); setTranslateX(0); onClick(); }}>
                        <Icon name="edit" size={16}/> ç·¨è¼¯
                    </div>
                    <div className={`text-white flex items-center gap-1.5 text-sm font-bold transition-opacity ${translateX < -20 ? 'opacity-100' : 'opacity-0'}`} onClick={(e) => { e.stopPropagation(); setTranslateX(0); handleDeleteTransaction(transaction.id); }}>
                        <Icon name="trash" size={16}/> åˆªé™¤
                    </div>
                </div>

                {/* --- é ‚å±¤å¡ç‰‡æœ¬é«” --- */}
                <div 
                    onTouchStart={handleTouchStart}
                    onTouchMove={handleTouchMove}
                    onTouchEnd={handleTouchEnd}
                    onClick={() => {
                        if (translateX !== 0) setTranslateX(0);
                        else onClick();
                    }}
                    className="relative z-10 bg-white dark:bg-[#36393F] p-3 rounded-xl border border-transparent shadow-sm flex items-center justify-between cursor-pointer active:scale-[0.99]"
                    style={{ 
                        transform: `translateX(${translateX}px)`, 
                        transition: isDragging ? 'none' : 'transform 0.25s cubic-bezier(0.2, 0.8, 0.2, 1)' 
                    }}
                >
                    <div className="flex items-center gap-3 w-full min-w-0 pr-2">
                        {/* â˜… ä¿®æ­£ï¼šé‡å°çµæ¸…é …ç›®çµ¦äºˆå°ˆå±¬ç¶ è‰²èƒŒæ™¯ */}
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${transaction.type === 'transfer' && !isReimbursement ? 'bg-gray-100 text-gray-500' : ''}`} style={transaction.type !== 'transfer' || isReimbursement ? {backgroundColor: `${catColor}20`, color: catColor} : {}}>
                            <Icon name={catIcon} size={20} />
                        </div>
                        <div className="min-w-0 flex-1">
                            <div className="text-sm font-medium text-[#333] dark:text-white flex items-center gap-2 truncate">
                                {catName}
                                {transaction.tags && transaction.tags.map(t => <span key={t} className={`text-[9px] px-1.5 rounded shrink-0 ${t === '#å·²çµæ¸…' ? 'bg-green-50 text-green-600' : 'bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300'}`}>{t}</span>)}
                            </div>
                            {/* â˜… ä¿®æ­£ï¼šæ”¾å¯¬å¸³æˆ¶åç¨±é¡¯ç¤ºå¯¬åº¦ (max-w-[100px])ï¼Œæ”¹å–„æ“æ“ æ„Ÿ */}
                            <div className="text-xs text-gray-400 flex items-center gap-1 truncate w-full">
                                {transaction.type === 'transfer' ? (
                                    <span className="truncate shrink-0 max-w-[100px]">{account.name}</span>
                                ) : (
                                    <span className="truncate shrink-0 max-w-[100px]">{account.name} {transaction.payer === 'me' && '(æˆ‘å¢Š)'} {transaction.payer === 'other' && '(æ¬ æ¬¾)'} {transaction.payer === 'advance' && '(ä»£è³¼)'}</span>
                                )}
                                {transaction.type === 'transfer' && <><Icon name="chevronRight" size={10} className="shrink-0"/><span className="truncate shrink-0 max-w-[100px]">{targetAccount ? targetAccount.name : '???'}</span></>}
                                {transaction.note && <span className="border-l border-gray-300 pl-1 ml-1 truncate"> {transaction.note}</span>}
                            </div>
                        </div>
                    </div>
                    <div className="text-right whitespace-nowrap shrink-0">
                        <div className={`text-base font-medium ${transaction.type === 'expense' ? 'text-[#333] dark:text-white' : transaction.type === 'income' ? 'text-[#5CB85C]' : 'text-gray-500'}`}>
                            {transaction.type === 'expense' ? '-' : transaction.type === 'income' ? '+' : ''}
                            {transaction.type === 'expense' && transaction.splitMyShare !== undefined
                                ? formatMoney(transaction.splitMyShare)
                                : formatMoney(transaction.amount)}
                        </div>
                        {transaction.type === 'expense' && transaction.splitMyShare !== undefined && (
                            <div className="text-[10px] text-gray-400 mt-0.5">ä»˜ {formatMoney(transaction.amount)}</div>
                        )}
                    </div>
                </div>
            </div>
        );
    };


        const NavButton = ({ iconName, label, isActive, onClick }) => (
            <button onClick={onClick} className={`flex flex-col items-center gap-1.5 transition-all ${isActive ? 'text-[#333]' : 'text-gray-300 hover:text-gray-400'}`}>
                <Icon name={iconName} size={22} strokeWidth={isActive ? 2 : 1.5} />
                <span className="text-[9px] font-medium tracking-widest uppercase">{label}</span>
            </button>
        );
        const SettingItem = ({ iconName, label, className = "", hasArrow }) => (
            <div className={`bg-white p-4 rounded border border-transparent shadow-sm hover:shadow-md hover:border-gray-200 transition cursor-pointer flex items-center justify-between ${className}`}>
                <div className="flex items-center gap-3">
                    <Icon name={iconName} size={18} className={className ? "text-current" : "text-gray-400"} />
                    <span className={`text-sm ${className ? "" : "text-gray-600"}`}>{label}</span>
                </div>
                {hasArrow ? <Icon name="chevronRight" size={16} className="text-gray-300" /> : null}
            </div>
        );
        const BottomFanMenu = ({ title, items, centerContent, onBack, onClose }) => {
            const radius = 135;
            const startAngle = -170; // Left-ish
            const endAngle = -10;    // Right-ish
            const total = items.length;
            const step = total > 1 ? (endAngle - startAngle) / (total - 1) : 0;

            return (
                <div className="fixed inset-0 z-[1000] flex flex-col justify-end animate-fade-in">
                    <div className="absolute inset-0 bg-black/30 backdrop-blur-[2px]" onClick={onClose}></div>
                    <div className="relative w-full h-[320px] bg-white rounded-t-[40px] shadow-2xl animate-slide-up overflow-hidden z-10 flex flex-col items-center">
                        <div className="w-full text-center mt-6 mb-2">
                            <h3 className="text-sm font-bold text-gray-400 tracking-widest uppercase">{title}</h3>
                        </div>
                        <div className="absolute bottom-[-60px] left-1/2 -translate-x-1/2 w-[350px] h-[350px] rounded-full border border-dashed border-gray-200 pointer-events-none"></div>
                        <div className="absolute bottom-6 left-1/2 -translate-x-1/2 z-20">
                            {centerContent ? centerContent : (
                                <button onClick={onBack || onClose} className="w-16 h-16 rounded-full bg-[#333] text-white flex items-center justify-center shadow-lg active:scale-90 transition">
                                    <Icon name={onBack ? "back" : "close"} size={24} />
                                </button>
                            )}
                        </div>
                        <div className="absolute bottom-[60px] left-1/2 w-0 h-0 z-10">
                            {items.map((item, index) => {
                                const angleDeg = total === 1 ? -90 : startAngle + (index * step);
                                const angleRad = angleDeg * (Math.PI / 180);
                                const x = radius * Math.cos(angleRad);
                                const y = radius * Math.sin(angleRad);
                                return (
                                    <button 
                                        key={item.id} 
                                        onClick={item.onClick}
                                        className="absolute w-16 h-16 -ml-8 -mt-8 rounded-full bg-white shadow-md border border-gray-100 flex flex-col items-center justify-center gap-0.5 active:scale-95 transition-all hover:bg-gray-50 hover:-translate-y-1"
                                        style={{ 
                                            transform: `translate(${x}px, ${y}px)`,
                                            animation: `fan-out 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) ${index * 0.05}s backwards`
                                        }}
                                    >
                                        {item.icon}
                                        <span className="text-[10px] font-medium text-gray-600 leading-none scale-90">{item.label}</span>
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

// --- å·¥å…·ï¼šæ‰‹å‹¢åµæ¸¬ Hook ---
const useSwipe = ({ onSwipeLeft, onSwipeRight, threshold = 50 }) => {
    const [touchStart, setTouchStart] = useState(null);
    const [touchEnd, setTouchEnd] = useState(null);
    const [touchStartY, setTouchStartY] = useState(null);
    const [touchEndY, setTouchEndY] = useState(null);

    const onTouchStart = (e) => {
        setTouchEnd(null);
        setTouchStart(e.targetTouches[0].clientX);
        setTouchStartY(e.targetTouches[0].clientY);
    };

    const onTouchMove = (e) => {
        setTouchEnd(e.targetTouches[0].clientX);
        setTouchEndY(e.targetTouches[0].clientY);
    };

    const onTouchEnd = () => {
        if (!touchStart || !touchEnd) return;
        
        const distanceX = touchStart - touchEnd;
        const distanceY = touchStartY - touchEndY;
        const isLeftSwipe = distanceX > threshold;
        const isRightSwipe = distanceX < -threshold;
        
        // é˜²å‘†ï¼šå¦‚æœæ˜¯å‚ç›´æ²å‹•ï¼ˆYè»¸ç§»å‹•å¤§æ–¼Xè»¸ï¼‰ï¼Œå‰‡ä¸è§¸ç™¼å·¦å³æ»‘å‹•
        if (Math.abs(distanceX) < Math.abs(distanceY)) return;

        if (isLeftSwipe && onSwipeLeft) {
            onSwipeLeft();
        }
        if (isRightSwipe && onSwipeRight) {
            onSwipeRight();
        }
    };

    return { onTouchStart, onTouchMove, onTouchEnd };
};
// 1. å»ºç«‹ Context ç‰©ä»¶
const DataContext = React.createContext();

// 2. å»ºç«‹ DataProvider å…ƒä»¶ (é€™æ˜¯æ–°çš„è³‡æ–™å€‰åº«)
const DataProvider = ({ children }) => {
    // ==========================================
    // A. è³‡æ–™ç‹€æ…‹ (State) - å¾ App æ¬éä¾†
    // ==========================================
    // 1. è³‡æ–™åº« State
    const [transactions, setTransactions] = useState(() => { try { return JSON.parse(localStorage.getItem('mm_transactions')) || []; } catch { return []; } });
    const [accounts, setAccounts] = useState(() => { try { return JSON.parse(localStorage.getItem('mm_accounts')) || INITIAL_ACCOUNTS; } catch { return INITIAL_ACCOUNTS; } });
    const [categories, setCategories] = useState(() => { try { return JSON.parse(localStorage.getItem('mm_categories')) || INITIAL_CATEGORIES; } catch { return INITIAL_CATEGORIES; } });
    const [quickTemplates, setQuickTemplates] = useState(() => { try { return JSON.parse(localStorage.getItem('mm_templates')) || []; } catch { return []; } });
    const [recurringItems, setRecurringItems] = useState(() => { try { return JSON.parse(localStorage.getItem('mm_recurring')) || []; } catch { return []; } });
    
    const [cloudSettings, setCloudSettings] = useState(() => { try { return JSON.parse(localStorage.getItem('mm_cloud_settings')) || { url: '', password: '' }; } catch { return { url: '', password: '' }; } });
    const [lastSyncTime, setLastSyncTime] = useState(() => localStorage.getItem('mm_last_sync_time') || '');
    // å…¨åŸŸ UI ç‹€æ…‹ (Dialog & Loading)
    const [dialog, setDialog] = useState({ show: false, title: '', content: '', isConfirm: false, onConfirm: () => {} });
    const [isSaving, setIsSaving] = useState(false);
    const [isDarkMode, setIsDarkMode] = useState(() => { 
        try { return localStorage.getItem('mm_theme') === 'dark'; } catch { return false; } 
    });
// â˜… æ–°å¢ï¼šéš±ç§æ¨¡å¼ (é è¨­é—œé–‰)
    const [isPrivacyMode, setIsPrivacyMode] = useState(() => {
        try { return localStorage.getItem('mm_privacy') === 'true'; } catch { return false; }
    });
    // ç›£è½ä¸¦å„²å­˜è¨­å®š
    useEffect(() => {
        localStorage.setItem('mm_privacy', isPrivacyMode);
    }, [isPrivacyMode]);
    // â˜… æ–°å¢ï¼šç°¡è¨Šè‡ªå‹•è¨˜å¸³é–‹é—œ
    const [autoSmsEnabled, setAutoSmsEnabled] = useState(() => {
        try { return localStorage.getItem('mm_auto_sms') === 'true'; } catch { return false; }
    });
    useEffect(() => { localStorage.setItem('mm_auto_sms', autoSmsEnabled); }, [autoSmsEnabled]);

    const togglePrivacy = () => {
        setIsPrivacyMode(prev => !prev);
        triggerHaptic();
    };
    // Dark Mode Effect
    useEffect(() => {
        if (isDarkMode) {
            document.documentElement.classList.add('dark');
            localStorage.setItem('mm_theme', 'dark');
            // æ›´æ–°ç‹€æ…‹åˆ—é¡è‰² (é‡å°æ‰‹æ©Ÿç€è¦½å™¨)
            let metaThemeColor = document.querySelector("meta[name=theme-color]");
            if (!metaThemeColor) {
                metaThemeColor = document.createElement("meta");
                metaThemeColor.name = "theme-color";
                document.head.appendChild(metaThemeColor);
            }
            metaThemeColor.content = "#121212";
        } else {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('mm_theme', 'light');
            let metaThemeColor = document.querySelector("meta[name=theme-color]");
            if (metaThemeColor) metaThemeColor.content = "#F5F5F3";
        }
    }, [isDarkMode]);

    const toggleTheme = () => {
        setIsDarkMode(prev => !prev);
        triggerHaptic();
    };
    // ==========================================
    // B. æŒä¹…åŒ–èˆ‡è‡ªå‹•é‚è¼¯ (Effects) - å¾ App æ¬éä¾†
    // ==========================================
    // 2. æŒä¹…åŒ–
    useEffect(() => { localStorage.setItem('mm_transactions', JSON.stringify(transactions)); }, [transactions]);
    useEffect(() => { localStorage.setItem('mm_accounts', JSON.stringify(accounts)); }, [accounts]);
    useEffect(() => { localStorage.setItem('mm_categories', JSON.stringify(categories)); }, [categories]);
    useEffect(() => { localStorage.setItem('mm_templates', JSON.stringify(quickTemplates)); }, [quickTemplates]);
    useEffect(() => { localStorage.setItem('mm_recurring', JSON.stringify(recurringItems)); }, [recurringItems]);
    useEffect(() => { localStorage.setItem('mm_cloud_settings', JSON.stringify(cloudSettings)); }, [cloudSettings]);
    useEffect(() => { if(lastSyncTime) localStorage.setItem('mm_last_sync_time', lastSyncTime); }, [lastSyncTime]);
    // 3. è‡ªå‹•å‚™ä»½
    useEffect(() => {
        if (!cloudSettings.url || !cloudSettings.password) return;
        const timer = setTimeout(() => handleCloudBackup(true), 5000); 
        return () => clearTimeout(timer);
    }, [transactions, accounts, categories, quickTemplates, recurringItems]);
    // --- ä¿®æ­£ï¼šé€±æœŸå¸³å–®æª¢æŸ¥é‚è¼¯ (æ”¯æ´å¤šé¡å‹) ---
// ==========================================
    // ä¿®æ­£ç‰ˆï¼šé€±æœŸå¸³å–®æª¢æŸ¥ (checkRecurring)
    // ä¿®æ­£é»ï¼šç§»é™¤ã€Œæ¯æ—¥åªåŸ·è¡Œä¸€æ¬¡ã€çš„é™åˆ¶ï¼Œæ”¹ç‚ºå³æ™‚åµæ¸¬
    // ==========================================
    useEffect(() => {
        const checkRecurring = () => {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;
            const currentDay = today.getDate();
            
            // ç”¢ç”Ÿç•¶æœˆ Key (ä¾‹å¦‚: "2023-10")ï¼Œç”¨ä¾†åˆ¤æ–·è©²æœˆæ˜¯å¦å·²åŸ·è¡Œé
            const currentMonthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;

            // âŒ ç§»é™¤ï¼šåŸæœ¬çš„ã€Œæ¯æ—¥åªåŸ·è¡Œä¸€æ¬¡ã€é–å®š
            // const lastRunDate = localStorage.getItem('mm_last_recurring_run');
            // if (lastRunDate === todayStr) return; 

            let newTxList = [];
            let hasUpdates = false;

            // éæ­·æ‰€æœ‰é€±æœŸé …ç›®
            const updatedRecurring = recurringItems.map(item => {
                // 1. åŸºæœ¬éæ¿¾ï¼šå·²æš«åœã€å°šæœªé–‹å§‹ã€å·²çµæŸ
                if (item.active === false) return item;
                if (item.startDate && item.startDate > currentMonthKey) return item;
                if (item.totalPeriods && (item.executedPeriods || 0) >= item.totalPeriods) return item;
                
                // 2. â˜… æ ¸å¿ƒé˜²å‘†ï¼šæª¢æŸ¥ã€Œæœ¬æœˆã€æ˜¯å¦å·²ç¶“åŸ·è¡Œé
                // åªè¦é€™å„æœˆåŸ·è¡Œéï¼Œå°±ç®—æ²’æœ‰ã€Œæ¯æ—¥é–å®šã€ä¹Ÿä¸æœƒé‡è¤‡è¨˜å¸³ï¼Œå®‰å…¨ï¼
                if (item.lastGeneratedMonth === currentMonthKey) return item;

                // 3. è¨ˆç®—åŸ·è¡Œæ—¥ (è™•ç† 2/30 -> 2/28 çš„æƒ…æ³)
                const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
                const targetDay = Math.min(item.day, daysInMonth);

                // 4. æª¢æŸ¥å¸³æˆ¶æ˜¯å¦å­˜åœ¨ (é˜²é–ƒé€€)
                const accountExists = accounts.some(acc => acc.id === item.accountId);
                if (!accountExists) return item;
                if (item.type === 'transfer' && item.targetAccountId) {
                    const targetExists = accounts.some(acc => acc.id === item.targetAccountId);
                    if (!targetExists) return item;
                }

                // 5. è§¸ç™¼è¨˜å¸³ï¼šå¦‚æœã€Œä»Šå¤©æ—¥æœŸã€ >= ã€Œè¨­å®šåŸ·è¡Œæ—¥ã€
                if (currentDay >= targetDay) {
                    
                    // â˜… çµ‚æ¥µä¿®å¾©ï¼šè£œå›éºå¤±çš„æ—¥æœŸèˆ‡æœŸæ•¸è¨ˆç®—è®Šæ•¸ï¼
                    const executedCount = (item.executedPeriods || 0) + 1; 
                    const txDate = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(targetDay).padStart(2, '0')}`;

                    const isLastPeriod = item.totalPeriods && (executedCount === item.totalPeriods);
                    const baseAmount = (isLastPeriod && item.lastPeriodAmount != null) ? Number(item.lastPeriodAmount) : Number(item.amount);
                    const totalAmount = baseAmount + Number(item.interest || 0);                    
                    
                    // ç”¢ç”Ÿæ–°äº¤æ˜“
                    const newTx = {
                        id: Date.now().toString() + Math.random().toString().slice(2, 5),
                        createdAt: Date.now(),
                        date: txDate,
                        amount: totalAmount, // â˜… ä¿®æ­£ï¼šæ”¹ç”¨åŒ…å«ç‰¹æ®Šæœ«æœŸèˆ‡åˆ©æ¯çš„ç¸½é‡‘é¡
                        type: item.type || 'expense',
                        categoryId: item.type === 'transfer' ? 'transfer' : item.categoryId,
                        accountId: item.accountId,
                        targetAccountId: item.type === 'transfer' ? item.targetAccountId : null,
                        note: `[é€±æœŸ] ${item.name} (${executedCount}/${item.totalPeriods || 'âˆ'})${item.interest ? ` (å«æ¯${item.interest})` : ''}`,
                        tags: ['#é€±æœŸ'],
                        recurringId: item.id // â˜… ä¿®æ­£ï¼šè£œä¸Šé—œè¯IDï¼Œç¢ºä¿é›™å‘é€£å‹•èƒ½æ­£å¸¸é‹ä½œ
                    };

                    newTxList.push(newTx);
                    hasUpdates = true;
                    
                    // æ›´æ–°è©²é …ç›®çš„ç‹€æ…‹ (æ¨™è¨˜æœ¬æœˆå·²åŸ·è¡Œ)
                    return { 
                        ...item, 
                        lastGeneratedMonth: currentMonthKey, 
                        executedPeriods: executedCount 
                    };
                }
                return item;
            });

            // å¦‚æœæœ‰ç”¢ç”Ÿæ–°äº¤æ˜“ï¼ŒåŸ·è¡Œæ›´æ–°
            if (hasUpdates) {
                // æ›´æ–°äº¤æ˜“åˆ—è¡¨
                setTransactions(prev => [...newTxList, ...prev].sort((a, b) => new Date(b.date) - new Date(a.date)));
                
                // æ›´æ–°å¸³æˆ¶é¤˜é¡
                let newAccounts = [...accounts];
                newTxList.forEach(tx => {
                    const amount = Number(tx.amount);
                    if (tx.type === 'transfer') {
                        newAccounts = newAccounts.map(a => {
                            if (a.id === tx.accountId) return { ...a, balance: a.balance - amount };
                            if (a.id === tx.targetAccountId) return { ...a, balance: a.balance + amount };
                            return a;
                        });
                    } else {
                        const isExpense = tx.type === 'expense';
                        newAccounts = newAccounts.map(a => 
                            a.id === tx.accountId 
                            ? { ...a, balance: a.balance + (isExpense ? -amount : amount) } 
                            : a
                        );
                    }
                });
                setAccounts(newAccounts);

                // æ›´æ–°é€±æœŸé …ç›®
                setRecurringItems(updatedRecurring);

                // é€šçŸ¥
                if (typeof showAlert === 'function') {
                    showAlert('é€±æœŸå…¥å¸³', `å·²è‡ªå‹•åŸ·è¡Œ ${newTxList.length} ç­†å®šæœŸäº¤æ˜“`);
                }
                
                // è‡ªå‹•å‚™ä»½ (å¦‚æœæœ‰é–‹å•Ÿ)
                if (cloudSettings && cloudSettings.autoBackup) {
                    setTimeout(() => handleCloudBackup(true), 2000);
                }
            }
        };

        // å»¶é² 1 ç§’åŸ·è¡Œ (Debounce)
        const timer = setTimeout(checkRecurring, 1000);
        return () => clearTimeout(timer);

    }, [recurringItems, accounts]); // ç§»é™¤ä¾è³´ cloudSettings/handleCloudBackup ä»¥é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“    // ==========================================
    // C. æ“ä½œé‚è¼¯ (Handlers) - å¾ App æ¬éä¾†
    // ==========================================
    // è§¸ç™¼éœ‡å‹•åé¥‹
    const triggerHaptic = (pattern = 10) => {
        try {
            // åŠ å¼·é˜²å‘†ï¼šç¢ºèªç€è¦½å™¨æ”¯æ´ vibrate API ä¸”ä¸æ˜¯åœ¨ç‰¹æ®Šç’°å¢ƒ
            if (typeof navigator !== 'undefined' && navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        } catch (e) {
            // å¦‚æœå ±éŒ¯ï¼Œéœé»˜å¤±æ•—ï¼Œä¸è¦è®“ç¨‹å¼å´©æ½°
            console.log('Haptic not supported');
        }
    };
// 1. å…¨åŸŸ UI å‘¼å«
    const showAlert = (title, content) => {
        setDialog({ show: true, title, content, isConfirm: false, onConfirm: () => setDialog(prev => ({...prev, show: false})) });
    };

    // â˜… ä¿®æ­£é‡é»ï¼šåœ¨é€™è£¡åŒ…è£¹ onConfirmActionï¼ŒåŸ·è¡Œå®Œå‹•ä½œå¾Œè‡ªå‹•é—œé–‰è¦–çª—
    const showConfirm = (title, content, onConfirmAction) => {
        setDialog({
            show: true,
            title,
            content,
            isConfirm: true,
            onConfirm: () => {
                if (onConfirmAction) onConfirmAction(); // 1. åŸ·è¡Œåˆªé™¤å‹•ä½œ
                setDialog(prev => ({...prev, show: false})); // 2. é—œé–‰è¦–çª—
            }
        });
    };
        // 2. äº¤æ˜“å­˜æª” (ä¿®æ­£ç‰ˆï¼šåŠ å…¥é˜²è¿´åœˆåƒæ•¸ skipSyncPlan)
    const handleSaveTransaction = (tx, editingId = null, skipSyncPlan = false) => {
        let newAcc = [...accounts];
        let newTx = [...transactions];
        
        // --- A. èˆŠäº¤æ˜“å›æ»¾ (é‚„åŸé¤˜é¡) ---
        let originalCreatedAt = Date.now(); 

        if (editingId) {
            const oldTx = transactions.find(t => t.id === editingId);
            if (oldTx) {
                originalCreatedAt = oldTx.createdAt || Date.now();
                if (oldTx.payer !== 'other') {
                     if (oldTx.type === 'transfer') {
                        newAcc = newAcc.map(a => { 
                            if (a.id === oldTx.accountId) return { ...a, balance: a.balance + oldTx.amount }; 
                            if (a.id === oldTx.targetAccountId) return { ...a, balance: a.balance - oldTx.amount }; 
                            return a; 
                        });
                    } else {
                        newAcc = newAcc.map(a => a.id === oldTx.accountId ? {...a, balance: a.balance + (oldTx.type === 'expense' ? oldTx.amount : -oldTx.amount)} : a);
                    }
                }
            }
            newTx = newTx.filter(t => t.id !== editingId);
        }
        
        // --- B. æ–°äº¤æ˜“æ‰£æ¬¾ ---
        if (tx.payer !== 'other') {
             if (tx.type === 'transfer') {
                newAcc = newAcc.map(a => { 
                    if (a.id === tx.accountId) return { ...a, balance: a.balance - tx.amount }; 
                    if (a.id === tx.targetAccountId) return { ...a, balance: a.balance + tx.amount }; 
                    return a; 
                });
            } else {
                newAcc = newAcc.map(a => a.id === tx.accountId ? {...a, balance: a.balance + (tx.type === 'expense' ? -tx.amount : tx.amount)} : a);
            }
        }
        
        // --- C. çµ„åˆæœ€çµ‚ç‰©ä»¶ ---
        const finalTx = { 
            ...tx, 
            id: editingId || generateId(), 
            createdAt: editingId ? originalCreatedAt : Date.now() 
        };

// â˜… æ–°å¢ï¼šé€£å‹•æ›´æ–°é€±æœŸè¨ˆç•«é‡‘é¡ (é›™å‘ç¶å®š)
        if (!skipSyncPlan && editingId && tx.recurringId) {
            const oldTx = transactions.find(t => t.id === editingId);
            const plan = recurringItems.find(r => r.id === tx.recurringId);
            if (oldTx && plan && oldTx.amount !== tx.amount) {
                setTimeout(() => {
                    showConfirm(
                        'åŒæ­¥æ›´æ–°è¨ˆç•«',
                        'æ‚¨ä¿®æ”¹äº†æ­¤ç­†åˆ†æœŸ/é€±æœŸçš„é‡‘é¡ã€‚\n\næ˜¯å¦è¦åŒæ­¥æ›´æ–°ã€Œæœªä¾†æ‰€æœ‰æœŸæ•¸ã€çš„é è¨­æ‰£æ¬¾é‡‘é¡ï¼Ÿ',
                        () => {
                            setRecurringItems(prev => prev.map(r => r.id === plan.id ? { ...r, amount: tx.amount, interest: 0 } : r));
                        }
                    );
                }, 350);
            }
        }
        
        // --- D. æ’åºï¼šå…ˆæ¯”æ—¥æœŸ(Date)ï¼Œæ—¥æœŸç›¸åŒæ¯”å»ºç«‹æ™‚é–“(createdAt) ---
        newTx = [finalTx, ...newTx].sort((a, b) => { 
            const dateDiff = new Date(b.date) - new Date(a.date); 
            if (dateDiff !== 0) return dateDiff; 
            return (b.createdAt || 0) - (a.createdAt || 0); 
        });
        
        setAccounts(newAcc);
        setTransactions(newTx);
    };
// 3. åˆªé™¤äº¤æ˜“
    const handleDeleteTransaction = (txId) => { 
        showConfirm('åˆªé™¤', 'ç¢ºå®šåˆªé™¤æ­¤ç­†äº¤æ˜“ï¼Ÿ', () => { 
            const tx = transactions.find(t => t.id === txId); 
            if (!tx) return;

            let newAcc = [...accounts]; 
            
            if (tx.payer !== 'other') {
                if (tx.type === 'transfer') { 
                    newAcc = newAcc.map(a => { 
                        if (a.id === tx.accountId) return { ...a, balance: a.balance + tx.amount }; 
                        if (a.id === tx.targetAccountId) return { ...a, balance: a.balance - tx.amount }; 
                        return a; 
                    }); 
                } else { 
                    newAcc = newAcc.map(a => a.id === tx.accountId ? {...a, balance: a.balance + (tx.type === 'expense' ? tx.amount : -tx.amount)} : a); 
                } 
            }
            
            setTransactions(prev => prev.filter(t => t.id !== txId)); 
            setAccounts(newAcc); 

            // â˜… ä¿®æ­£ï¼šå¾¹åº•ç§»é™¤ window.confirmï¼Œæ”¹ç”¨ç³»çµ±å½ˆçª—æ¥åŠ›
            if (tx.recurringId && recurringItems.some(r => r.id === tx.recurringId)) {
                setTimeout(() => {
                    showConfirm(
                        'é€£å‹•åˆªé™¤é€±æœŸè¨ˆç•«', 
                        'é€™ç­†äº¤æ˜“é—œè¯äº†åˆ†æœŸ/é€±æœŸè¨ˆç•«ã€‚\n\næ˜¯å¦è¦ä¸€ä½µã€Œåˆªé™¤æœªä¾†çš„è‡ªå‹•æ‰£æ¬¾è¨ˆç•«ã€ï¼Ÿ\n(æŒ‰å–æ¶ˆå‰‡åƒ…åˆªé™¤æ­¤ç­†äº¤æ˜“)', 
                        () => {
                            setRecurringItems(prev => prev.filter(r => r.id !== tx.recurringId));
                        }
                    );
                }, 350); // çµ¦äºˆ 350ms è®“ä¸Šä¸€å€‹åˆªé™¤è¦–çª—å„ªé›…åœ°é—œé–‰
            }
        }); 
    };

    // å¸³æˆ¶å­˜æª” 
    const handleSaveAccount = (accData) => { 
        const existing = accounts.find(a => a.id === accData.id); 
        
        if (existing) { 
            // ç·¨è¼¯ç¾æœ‰å¸³æˆ¶
            const diff = accData.balance - existing.balance; 
            if (diff !== 0) { 
                const type = diff > 0 ? 'income' : 'expense'; 
                const adjTx = { 
                    id: generateId(), 
                    createdAt: Date.now(), 
                    date: getLocalDateString(), 
                    amount: Math.abs(diff), 
                    type: type, 
                    categoryId: 'adjustment', 
                    subCategoryId: null, 
                    accountId: accData.id, 
                    note: 'é¤˜é¡èª¿æ•´', 
                    tags: ['#èª¿æ•´'] 
                }; 
                setTransactions(prev => [adjTx, ...prev].sort((a, b) => new Date(b.date) - new Date(a.date))); 
            } 
            const updatedAccount = { ...existing, ...accData, initialBalance: existing.initialBalance }; 
            setAccounts(accounts.map(a => a.id === accData.id ? updatedAccount : a)); 
        } else { 
            // æ–°å¢å¸³æˆ¶
            const maxOrder = accounts.reduce((max, a) => Math.max(max, a.sortOrder || 0), 0); 
            setAccounts([...accounts, { ...accData, id: generateId(), initialBalance: accData.balance, sortOrder: maxOrder + 1 }]); 
        } 
        // æ³¨æ„ï¼šé€™è£¡ç§»é™¤äº† setEditingAccount(null)ï¼Œå› ç‚ºé€™æ˜¯ UI å±¤çš„å·¥ä½œ
    };
    // åˆªé™¤å¸³æˆ¶é‚è¼¯
    const handleDeleteAccount = (accId) => {
        // 1. æª¢æŸ¥æ˜¯å¦æœ‰é—œè¯äº¤æ˜“
        const relatedTxCount = transactions.filter(t => t.accountId === accId || t.targetAccountId === accId).length;
        const relatedRecurring = recurringItems.filter(r => r.accountId === accId || r.targetAccountId === accId).length;
        
        let warningMsg = 'ç¢ºå®šè¦åˆªé™¤æ­¤å¸³æˆ¶ï¼Ÿ';
        
        if (relatedTxCount > 0 || relatedRecurring > 0) {
            warningMsg = `âš ï¸ è­¦å‘Šï¼šæ­¤å¸³æˆ¶åŒ…å« ${relatedTxCount} ç­†äº¤æ˜“èˆ‡ ${relatedRecurring} å€‹é€±æœŸè¨­å®šã€‚\n\nåˆªé™¤å¾Œï¼Œç›¸é—œäº¤æ˜“ç´€éŒ„å°‡ä¿ç•™ï¼Œä½†å¸³æˆ¶åç¨±å°‡é¡¯ç¤ºç‚ºæœªçŸ¥ã€‚`;
        }

        showConfirm('åˆªé™¤å¸³æˆ¶', warningMsg, () => {
            setAccounts(prev => prev.filter(a => a.id !== accId));
         });
    };
    //  åˆ†å¸³çµæ¸…
    const handleSettleSplit = (newTransactions, newAccounts) => { setTransactions(newTransactions.sort((a, b) => new Date(b.date) - new Date(a.date))); setAccounts(newAccounts); };            
    //  å¸³æˆ¶æ’åº
    const handleReorderAccounts = (newAccounts) => { setAccounts(newAccounts); };
    //  æš«æ™‚é‚„æ¬¾æç¤º
    const handleRepay = (liabilityAcc) => {
         const amount = Math.abs(liabilityAcc.balance);
         const bankAcc = accounts.find(a => a.type === 'bank') || accounts[0];
         // é€™è£¡éœ€è¦é€é Context è§¸ç™¼ Modalï¼Œä½†ç°¡åŒ–èµ·è¦‹ï¼Œæˆ‘å€‘å…ˆç”¨ Alert æç¤º
         // å¯¦éš›ä¸Šé€™æ‡‰è©²åœ¨ UI å±¤è™•ç†ï¼Œæˆ–è€…å°‡ Modal ç‹€æ…‹ç§»å…¥ Context
         showAlert('æç¤º', 'è«‹è‡³é¦–é ä½¿ç”¨ã€Œè½‰å¸³ã€åŠŸèƒ½é€²è¡Œé‚„æ¬¾');
    }
    //  åˆä½µä¸¦åˆªé™¤åˆ†é¡
    const handleMergeAndDeleteCategory = (deleteId, targetId) => {
        // 1. æ›´æ–°äº¤æ˜“
        const newTransactions = transactions.map(t => t.categoryId === deleteId ? { ...t, categoryId: targetId } : t);
        setTransactions(newTransactions);
        
        // 2. æ›´æ–°é€±æœŸè¨­å®š
        const newRecurring = recurringItems.map(r => r.categoryId === deleteId ? { ...r, categoryId: targetId } : r);
        setRecurringItems(newRecurring);

        // 3. æ›´æ–°æ¨¡æ¿
        const newTemplates = quickTemplates.map(t => t.categoryId === deleteId ? { ...t, categoryId: targetId } : t);
        setQuickTemplates(newTemplates);

        // 4. åŸ·è¡Œåˆªé™¤ (éœ€åˆ¤æ–·æ˜¯ expense é‚„æ˜¯ income)
        const isExpense = categories.expense.some(c => c.id === deleteId);
        const listName = isExpense ? 'expense' : 'income';
        const newCategories = {
            ...categories,
            [listName]: categories[listName].filter(c => c.id !== deleteId)
        };
        setCategories(newCategories);
        showAlert('å®Œæˆ', 'åˆ†é¡å·²åˆªé™¤ï¼Œäº¤æ˜“è³‡æ–™å·²ç§»è½‰ã€‚');
    };
    //  è³‡æ–™åŒ¯å…¥åŒ¯å‡º
// 1. ä¿®æ­£ï¼šåŒ¯å‡ºè³‡æ–™ (åŠ å…¥åå¥½è¨­å®š)
    const handleExportData = () => {
        const data = {
            version: '5.2', // æ¨™è¨˜ç‰ˆæœ¬è™Ÿ
            timestamp: Date.now(),
            transactions,
            accounts,
            categories,
            recurringItems,
            quickTemplates,
            cloudSettings,
            // â˜… æ–°å¢ï¼šå‚™ä»½åå¥½è¨­å®š (æ·±è‰²æ¨¡å¼ã€éš±ç§æ¨¡å¼)
            preferences: {
                theme: isDarkMode ? 'dark' : 'light',
                privacy: isPrivacyMode,
            }
        };
        
        const jsonString = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const href = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = href;
        link.download = `money_master_backup_${getLocalDateString()}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
// ==========================================
    // ä¿®æ­£ç‰ˆ 3ï¼šæª”æ¡ˆåŒ¯å…¥ (åŒæ­¥æ›´æ–°æ™‚é–“)
    // ==========================================
    const handleImportData = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importedData = JSON.parse(event.target.result);
                
                if (!importedData.transactions || !importedData.accounts) {
                    showAlert('éŒ¯èª¤', 'æ ¼å¼éŒ¯èª¤ï¼šé€™ä¼¼ä¹ä¸æ˜¯æ­£ç¢ºçš„å‚™ä»½æª”');
                    return;
                }

                showConfirm('é‚„åŸè³‡æ–™', 'é€™å°‡è¦†è“‹ç›®å‰çš„æœ¬æ©Ÿè³‡æ–™ï¼Œç¢ºå®šé‚„åŸï¼Ÿ', () => {
                    const savedCloudSettings = localStorage.getItem('mm_cloud_settings');
                    localStorage.clear();

                    if(importedData.transactions) localStorage.setItem('mm_transactions', JSON.stringify(importedData.transactions));
                    if(importedData.accounts) localStorage.setItem('mm_accounts', JSON.stringify(importedData.accounts));
                    if(importedData.categories) localStorage.setItem('mm_categories', JSON.stringify(importedData.categories));
                    if(importedData.recurringItems) localStorage.setItem('mm_recurring', JSON.stringify(importedData.recurringItems));
                    if(importedData.quickTemplates) localStorage.setItem('mm_templates', JSON.stringify(importedData.quickTemplates));
                    
                    if (savedCloudSettings) {
                        localStorage.setItem('mm_cloud_settings', savedCloudSettings);
                    } else if (importedData.cloudSettings) {
                        localStorage.setItem('mm_cloud_settings', JSON.stringify(importedData.cloudSettings));
                    }

                    // â˜… é—œéµï¼šæ›´æ–°åŒæ­¥æ™‚é–“ (é¿å…åŒ¯å…¥èˆŠæª”å¾Œï¼Œé›²ç«¯è‡ªå‹•æª¢æŸ¥åˆä»¥ç‚ºé›²ç«¯æ¯”è¼ƒæ–°è€Œè·³è¦–çª—)
                    // ä½¿ç”¨æª”æ¡ˆå…§çš„ timestampï¼Œè‹¥ç„¡å‰‡ç”¨ç¾åœ¨æ™‚é–“
                    const importTime = importedData.timestamp || importedData.lastBackup || new Date().toISOString();
                    localStorage.setItem('mm_last_sync_time', new Date(importTime).toISOString());

                    if (importedData.preferences) {
                        localStorage.setItem('mm_theme', importedData.preferences.theme === 'dark' ? 'dark' : 'light');
                        localStorage.setItem('mm_privacy', importedData.preferences.privacy ? 'true' : 'false');
                    }
                    sessionStorage.setItem('mm_just_restored', 'true');

                    window.location.reload();
                });
            } catch (err) {
                console.error(err);
                showAlert('éŒ¯èª¤', 'è®€å–å¤±æ•—ï¼šæª”æ¡ˆå¯èƒ½å·²ææ¯€');
            }
        };
        reader.readAsText(file);
        e.target.value = '';
    };
    // åŒ¯å‡º CSV (Excel å°ˆç”¨)
    const handleExportCSV = () => {
        // 1. å®šç¾© CSV æ¨™é¡Œ
        const headers = ['ID', 'æ—¥æœŸ', 'é¡å‹', 'é‡‘é¡', 'åˆ†é¡', 'ç´°é …', 'å¸³æˆ¶', 'è½‰å…¥å¸³æˆ¶', 'å‚™è¨»', 'æ¨™ç±¤'];
        
        // 2. è½‰æ›è³‡æ–™
        const rows = transactions.map(t => {
            const catName = (t.type === 'expense' ? categories.expense : categories.income).find(c => c.id === t.categoryId)?.name || (t.categoryId === 'reimbursement' ? 'åˆ†å¸³çµæ¸…' : 'å…¶ä»–');
            
            // å°‹æ‰¾ç´°é …åç¨±
            let subName = '';
            if (t.subCategoryId) {
                const cat = (t.type === 'expense' ? categories.expense : categories.income).find(c => c.id === t.categoryId);
                const sub = cat?.subCategories?.find(s => s.id === t.subCategoryId);
                subName = sub ? sub.name : '';
            }

            const accName = accounts.find(a => a.id === t.accountId)?.name || 'æœªçŸ¥';
            const targetAccName = t.targetAccountId ? (accounts.find(a => a.id === t.targetAccountId)?.name || '') : '';
            const tagsStr = t.tags ? t.tags.join(' ') : '';
            const typeStr = t.type === 'expense' ? 'æ”¯å‡º' : (t.type === 'income' ? 'æ”¶å…¥' : 'è½‰å¸³');

            // è™•ç† CSV ç‰¹æ®Šå­—å…ƒ (å¦‚é€—è™Ÿ)
            const safeNote = `"${(t.note || '').replace(/"/g, '""')}"`; 

            return [
                t.id,
                t.date,
                typeStr,
                t.amount,
                catName,
                subName,
                accName,
                targetAccName,
                safeNote,
                tagsStr
            ].join(',');
        });

        // 3. çµ„åˆå…§å®¹ (åŠ ä¸Š BOM \uFEFF è®“ Excel èƒ½æ­£ç¢ºè­˜åˆ¥ä¸­æ–‡)
        const csvContent = '\uFEFF' + headers.join(',') + '\n' + rows.join('\n');

        // 4. ä¸‹è¼‰æª”æ¡ˆ
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `money_master_export_${getLocalDateString()}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
    // 7. é›²ç«¯å‚™ä»½ç›¸é—œ
// ==========================================
    // DataProvider ä¿®æ­£é‡é»ï¼š
    // 1. handleCloudBackup: å‚™ä»½æ™‚å¯«å…¥ lastBackup æ™‚é–“
    // 2. handleManualRestore: åš´æ ¼æ¯”å°æ™‚é–“ï¼Œé˜²æ­¢å¾ªç’°
    // 3. useEffect: å¯¦ä½œè‡ªå‹•å‚™ä»½ (Debounce)
    // ==========================================

    // 1. é›²ç«¯å‚™ä»½
// ==========================================
    // ä¿®æ­£ç‰ˆ 4ï¼šé›²ç«¯å‚™ä»½ (ä¿®å¾©æ‰‹æ©Ÿä¸Šå‚³å•é¡Œ + åŠ å…¥ Loading)
    // ==========================================
const handleCloudBackup = async (silent = false) => {
        if (!cloudSettings.url) {
            if (!silent) showAlert('æç¤º', 'è«‹å…ˆè¨­å®š Google Apps Script URL');
            return;
        }

        const performBackup = async () => {
            if (!silent) setIsSaving(true);

            const now = new Date().toISOString();
            const payload = {
                action: 'backup',
                password: cloudSettings.password,
                data: {
                    transactions, accounts, categories, recurringItems, quickTemplates,
                    preferences: { theme: isDarkMode ? 'dark' : 'light', privacy: isPrivacyMode },
                    lastBackup: now
                }
            };

            try {
                const res = await fetch(cloudSettings.url, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) });
                const result = await res.json();

                if (result.status === 'success' || result.success) {
                    localStorage.setItem('mm_last_sync_time', now);
                    if (!silent) showAlert('æˆåŠŸ', 'âœ… å‚™ä»½æˆåŠŸï¼');
                    else console.log('â˜ï¸ è‡ªå‹•å‚™ä»½å®Œæˆ:', now);
                } else {
                    if (!silent) showAlert('å‚™ä»½å¤±æ•—', 'âŒ ' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (e) {
                console.error(e);
                if (!silent) showAlert('é€£ç·šéŒ¯èª¤', `âŒ ${e.message}\nè«‹æª¢æŸ¥ URL æˆ–ç¶²è·¯é€£ç·šã€‚`);
            } finally {
                if (!silent) setIsSaving(false);
            }
        };

        if (silent) {
            performBackup();
        } else {
            showConfirm('é›²ç«¯å‚™ä»½', 'ç¢ºå®šä¸Šå‚³ç›®å‰è³‡æ–™è‡³ Google Driveï¼Ÿ', () => {
                performBackup();
            });
        }
    };
    // 2. é›²ç«¯é‚„åŸ (å«é˜²å¾ªç’°é‚è¼¯)
const handleManualRestore = async (url, pwd, isAutoCheck = false) => {
        if (!url) {
            if (!isAutoCheck) showAlert('æç¤º', 'è«‹å…ˆè¨­å®š URL');
            return;
        }

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ op: 'restore', password: pwd })
            });
            
            const result = await res.json();

            // æª¢æŸ¥æ˜¯å¦åŒ…å«è³‡æ–™ (transactions) æˆ–è€…ç‹€æ…‹ç‚º success
            // æ‚¨çš„ GAS åœ¨é‚„åŸæ™‚ç›´æ¥å›å‚³æª”æ¡ˆå…§å®¹ï¼Œæ‰€ä»¥æˆ‘å€‘æª¢æŸ¥æ˜¯å¦æœ‰ transactions æ¬„ä½
            if ((result.status === 'success' || result.success) || (result && (result.transactions || result.accounts))) {
                
                // å¦‚æœ result æœ¬èº«å°±æ˜¯è³‡æ–™ (èˆŠç‰ˆ GAS)ï¼Œæˆ–æ˜¯ result.data æ˜¯è³‡æ–™ (æ¨™æº– API)
                const cloudData = result.data || result; 
                
                // æ™‚é–“æ¯”å°é‚è¼¯
                const cloudTimeStr = cloudData.lastBackup || cloudData.timestamp;
                const cloudTime = cloudTimeStr ? new Date(cloudTimeStr).getTime() : 0;
                const localSyncStr = localStorage.getItem('mm_last_sync_time');
                const localTime = localSyncStr ? new Date(localSyncStr).getTime() : 0;

                if (isAutoCheck && (!cloudTime || cloudTime <= localTime + 2000)) {
                    return; 
                }

                const backupTimeDisplay = cloudTimeStr ? new Date(cloudTimeStr).toLocaleString() : 'æœªçŸ¥æ™‚é–“';
                
                showConfirm(
                    isAutoCheck ? 'é›²ç«¯åŒæ­¥é€šçŸ¥' : 'é›²ç«¯é‚„åŸ', 
                    `ç™¼ç¾æ–°ç‰ˆé›²ç«¯å‚™ä»½ï¼\nå‚™ä»½æ™‚é–“ï¼š${backupTimeDisplay}\n\næ˜¯å¦ä¸‹è¼‰ä¸¦è¦†è“‹æœ¬æ©Ÿè³‡æ–™ï¼Ÿ`, 
                    () => {
                        const currentCloudSettings = {
                            url: url,
                            password: pwd,
                            autoCheck: cloudSettings.autoCheck,
                            autoBackup: cloudSettings.autoBackup
                        };

                        localStorage.clear();
                        
                        if(cloudData.transactions) localStorage.setItem('mm_transactions', JSON.stringify(cloudData.transactions));
                        if(cloudData.accounts) localStorage.setItem('mm_accounts', JSON.stringify(cloudData.accounts));
                        if(cloudData.categories) localStorage.setItem('mm_categories', JSON.stringify(cloudData.categories));
                        if(cloudData.recurringItems) localStorage.setItem('mm_recurring', JSON.stringify(cloudData.recurringItems));
                        if(cloudData.quickTemplates) localStorage.setItem('mm_templates', JSON.stringify(cloudData.quickTemplates));
                        
                        localStorage.setItem('mm_cloud_settings', JSON.stringify(currentCloudSettings));

                        const newSyncTime = cloudTimeStr || new Date().toISOString();
                        localStorage.setItem('mm_last_sync_time', newSyncTime);

                        if (cloudData.preferences) {
                            localStorage.setItem('mm_theme', cloudData.preferences.theme === 'dark' ? 'dark' : 'light');
                            localStorage.setItem('mm_privacy', cloudData.preferences.privacy ? 'true' : 'false');
                        }

                        sessionStorage.setItem('mm_just_restored', 'true');
                        window.location.reload();
                    },
                    () => {
                        if (isAutoCheck && cloudTimeStr) {
                            localStorage.setItem('mm_last_sync_time', cloudTimeStr);
                        }
                    }
                );
            } else if (result.status === 'error') {
                if (!isAutoCheck) showAlert('æç¤º', 'é›²ç«¯ç„¡å‚™ä»½è³‡æ–™');
            }
        } catch (e) {
            if (!isAutoCheck) showAlert('éŒ¯èª¤', 'é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ URL èˆ‡ç¶²è·¯ç‹€æ…‹ã€‚');
        }
    };
    // 3. â˜… æ–°å¢ï¼šè‡ªå‹•å‚™ä»½ç›£è½å™¨ (Debounce 5ç§’)
    useEffect(() => {
        // åªæœ‰ç•¶è¨­å®šé–‹å•Ÿï¼Œä¸” URL å­˜åœ¨æ™‚æ‰åŸ·è¡Œ
        if (cloudSettings.autoBackup && cloudSettings.url) {
            // è¨­å®šä¸€å€‹è¨ˆæ™‚å™¨ï¼Œ5ç§’å¾ŒåŸ·è¡Œå‚™ä»½
            const timer = setTimeout(() => {
                handleCloudBackup(true); // true = éœé»˜æ¨¡å¼ï¼Œä¸è·³ alert
            }, 5000);

            // å¦‚æœ 5ç§’å…§è³‡æ–™åˆè®Šå‹•ï¼Œæ¸…é™¤ä¸Šä¸€å€‹è¨ˆæ™‚å™¨ (é‡æ–°è¨ˆæ™‚)
            return () => clearTimeout(timer);
        }
    }, [
        // ç›£è½æ‰€æœ‰è³‡æ–™è®Šå‹•
        transactions, accounts, categories, recurringItems, quickTemplates, 
        cloudSettings.autoBackup // ç›£è½é–‹é—œ
    ]);

    // 4. å•Ÿå‹•æ™‚è‡ªå‹•æª¢æŸ¥ (ä¿æŒåŸæœ¬é‚è¼¯)
    const hasCheckedCloud = useRef(false);
    
    useEffect(() => {
        // â˜… æ–°å¢ï¼šæª¢æŸ¥æ˜¯å¦å‰›é‚„åŸå®Œ
        // sessionStorage çš„ç‰¹æ€§æ˜¯ï¼šé é¢é‡æ•´é‚„åœ¨ï¼Œä½†é—œé–‰åˆ†é å°±æœƒæ¶ˆå¤±
        // é€™éå¸¸é©åˆç”¨ä¾†åˆ¤æ–·ã€Œæ˜¯å¦å‰›ç¶“æ­·éé‡æ•´ã€
        const justRestored = sessionStorage.getItem('mm_just_restored');

        if (justRestored) {
            console.log('ğŸ”„ åµæ¸¬åˆ°å‰›å®Œæˆé‚„åŸï¼Œå¼·åˆ¶è·³éæœ¬æ¬¡è‡ªå‹•æª¢æŸ¥');
            // æ¸…é™¤æ——æ¨™ï¼Œä¸‹æ¬¡é‡é–‹ App (éé‡æ•´) æ™‚æ‰æœƒæ­£å¸¸æª¢æŸ¥
            sessionStorage.removeItem('mm_just_restored');
            // æ¨™è¨˜ç‚ºå·²æª¢æŸ¥ï¼Œé¿å…å¾ŒçºŒé‚è¼¯è§¸ç™¼
            hasCheckedCloud.current = true;
            return;
        }

        // åŸæœ¬çš„æª¢æŸ¥é‚è¼¯
        if (!hasCheckedCloud.current && cloudSettings.url && cloudSettings.autoCheck) {
            hasCheckedCloud.current = true;
            setTimeout(() => {
                // true = éœé»˜æ¨¡å¼
                handleManualRestore(cloudSettings.url, cloudSettings.password, true);
            }, 1000);
        }
    }, [cloudSettings.url, cloudSettings.autoCheck]);

    const applyCloudData = (data) => {const finalData = data.transactions ? data : (data.data || data);if (!finalData.transactions) { showAlert('éŒ¯èª¤', 'æ ¼å¼æœ‰èª¤'); return; }setTransactions(finalData.transactions || []); setAccounts(finalData.accounts || []); setCategories(finalData.categories || []); setQuickTemplates(finalData.quickTemplates || []); setRecurringItems(finalData.recurringItems || []);setLastSyncTime(finalData.backupDate || new Date().toISOString());if(!data.silent) showAlert('å®Œæˆ', 'è³‡æ–™å·²åŒæ­¥ï¼');};

    // ==========================================
    // D. å°å¤–å…¬é–‹çš„è³‡æ–™ (Context Value)
    // ==========================================
    const value = {
        transactions, accounts, categories, quickTemplates, recurringItems, cloudSettings,isDarkMode, toggleTheme,isPrivacyMode, togglePrivacy,
        setTransactions, setAccounts, setCategories, setQuickTemplates, setRecurringItems, setCloudSettings,autoSmsEnabled, setAutoSmsEnabled,
        totalAssets: useMemo(() => accounts.reduce((sum, acc) => sum + acc.balance, 0), [accounts]),
        
        // å‹•ä½œ
        handleSaveTransaction, handleDeleteTransaction, handleSaveAccount, handleReorderAccounts,
        handleSettleSplit, handleRepay, handleMergeAndDeleteCategory, // â˜… è¨˜å¾—åŒ¯å‡ºé€™å€‹
        handleExportData, handleExportCSV,handleImportData,handleDeleteAccount,hasCheckedCloud,
        handleCloudBackup, handleManualRestore, applyCloudData,
        showAlert, showConfirm, setIsSaving,

        triggerHaptic
    };
    return (
        <DataContext.Provider value={value}>
            {children}
            {/* å…¨åŸŸå…ƒä»¶æ”¾åœ¨é€™è£¡ */}
            <CustomDialog isOpen={dialog.show} title={dialog.title} content={dialog.content} isConfirm={dialog.isConfirm} onConfirm={dialog.onConfirm} onCancel={() => setDialog(prev => ({...prev, show: false}))} />
            {isSaving && <div className="fixed inset-0 z-[1300] bg-black/50 flex items-center justify-center animate-fade-in"><div className="bg-white px-6 py-4 rounded-lg shadow-xl flex items-center gap-3"><div className="w-4 h-4 border-2 border-gray-200 border-t-[#333] rounded-full animate-spin"></div><span className="text-sm font-medium text-[#333]">è™•ç†ä¸­...</span></div></div>}
        </DataContext.Provider>
    );
};
// ==========================================
        // ä¿®æ­£ç‰ˆ AccountModal (æ–°å¢æ™‚è‡ªå‹•åŒæ­¥é¤˜é¡)
        // ==========================================
        const AccountModal = ({ initialData, onClose, onSave, onDelete }) => {
            const data = initialData || {};

            const [name, setName] = useState(data.name || '');
            const [type, setType] = useState(data.type || 'cash');
            // ç·¨è¼¯æ¨¡å¼ç”¨åŸæœ¬çš„é¤˜é¡ï¼Œæ–°å¢æ¨¡å¼é è¨­ç‚º '0'
            const [balance, setBalance] = useState(data.balance !== undefined ? data.balance.toString() : '0');
            const [initialBalance, setInitialBalance] = useState(data.initialBalance !== undefined ? data.initialBalance.toString() : '0');
            
            // ä¿¡ç”¨å¡å°ˆå±¬æ¬„ä½
            const [limit, setLimit] = useState(data.limit ? data.limit.toString() : '');
            const [billDay, setBillDay] = useState(data.billDay ? data.billDay.toString() : '');
            const [dueDay, setDueDay] = useState(data.dueDay ? data.dueDay.toString() : '');
            const [reminder, setReminder] = useState(data.reminder || false);

            // â˜… æ–°å¢ï¼šå¦‚æœæ˜¯ã€Œæ–°å¢å¸³æˆ¶ã€æ¨¡å¼ï¼Œç•¶ã€ŒæœŸåˆé¤˜é¡ã€æ”¹è®Šæ™‚ï¼Œè‡ªå‹•åŒæ­¥çµ¦ã€Œç›®å‰é¤˜é¡ã€
            useEffect(() => {
                if (!data.id) {
                    setBalance(initialBalance);
                }
            }, [initialBalance, data.id]);

            const handleSave = () => {
                if (!name.trim()) return;
                
                const accData = {
                    id: data.id, 
                    name, 
                    type,
                    // æ–°å¢æ¨¡å¼ä¸‹ï¼Œbalance æœƒè¢«ä¸Šé¢çš„ useEffect åŒæ­¥ç‚º initialBalance
                    balance: Number(balance),
                    initialBalance: Number(initialBalance),
                    currency: 'TWD'
                };

                if (type === 'liability') {
                    accData.limit = limit ? Number(limit) : 0;
                    accData.billDay = billDay ? Number(billDay) : null;
                    accData.dueDay = dueDay ? Number(dueDay) : null;
                    accData.reminder = reminder;
                }

                onSave(accData);
            };

            return (
                <div className="fixed inset-0 z-[1100] bg-black/40 flex items-center justify-center p-6 animate-fade-in">
                    <div className="absolute inset-0" onClick={onClose}></div>
                    
                    <div className="bg-white w-full max-w-sm rounded-lg shadow-xl p-6 animate-slide-up max-h-[85vh] overflow-y-auto relative z-10">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-medium text-[#333]">{data.id ? 'ç·¨è¼¯å¸³æˆ¶' : 'æ–°å¢å¸³æˆ¶'}</h3>
                            <div className="flex gap-2">
                                {data.id && (
                                    <button onClick={() => onDelete(data.id)} className="p-2 text-gray-300 hover:text-red-500 transition">
                                        <Icon name="trash" />
                                    </button>
                                )}
                                <button onClick={onClose} className="p-2 -mr-2 text-gray-400"><Icon name="close" /></button>
                            </div>
                        </div>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="text-xs text-gray-400 block mb-1">å¸³æˆ¶åç¨±</label>
                                <input className="w-full border-b py-1 outline-none text-[#333] placeholder-gray-300" placeholder="ä¾‹å¦‚ï¼šå°æ–°ä¿¡ç”¨å¡" value={name} onChange={e => setName(e.target.value)} />
                            </div>
                            
                            <div>
                                <label className="text-xs text-gray-400 block mb-1">é¡å‹</label>
                                <div className="flex bg-gray-100 p-1 rounded-lg">
                                    <button onClick={() => setType('cash')} className={`flex-1 py-2 text-xs font-medium rounded transition ${type === 'cash' ? 'bg-white text-[#333] shadow-sm' : 'text-gray-500'}`}>ç¾é‡‘</button>
                                    <button onClick={() => setType('bank')} className={`flex-1 py-2 text-xs font-medium rounded transition ${type === 'bank' ? 'bg-white text-[#333] shadow-sm' : 'text-gray-500'}`}>éŠ€è¡Œ</button>
                                    <button onClick={() => setType('liability')} className={`flex-1 py-2 text-xs font-medium rounded transition ${type === 'liability' ? 'bg-white text-[#333] shadow-sm' : 'text-gray-500'}`}>ä¿¡ç”¨å¡</button>
                                </div>
                            </div>
                            
                            {type === 'liability' && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-100 space-y-3 mt-2">
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">ä¿¡ç”¨é¡åº¦</label>
                                        <input type="number" className="w-full border-b border-gray-300 bg-transparent py-1 outline-none text-[#333]" placeholder="ä¾‹å¦‚: 150000" value={limit} onChange={e => setLimit(e.target.value)} />
                                    </div>
                                    <div className="flex gap-4">
                                        <div className="flex-1">
                                            <label className="text-xs text-gray-500 block mb-1">çµå¸³æ—¥ (æ¯æœˆ)</label>
                                            <input type="number" min="1" max="31" className="w-full border-b border-gray-300 bg-transparent py-1 outline-none text-[#333]" placeholder="æ—¥" value={billDay} onChange={e => setBillDay(e.target.value)} />
                                        </div>
                                        <div className="flex-1">
                                            <label className="text-xs text-gray-500 block mb-1">é‚„æ¬¾æ—¥ (æ¯æœˆ)</label>
                                            <input type="number" min="1" max="31" className="w-full border-b border-gray-300 bg-transparent py-1 outline-none text-[#333]" placeholder="æ—¥" value={dueDay} onChange={e => setDueDay(e.target.value)} />
                                        </div>
                                    </div>
                                    <div className="flex justify-between items-center pt-1">
                                        <span className="text-xs text-gray-500">å•Ÿç”¨ç¹³æ¬¾æé†’</span>
                                        <div onClick={() => setReminder(!reminder)} className={`w-10 h-5 rounded-full relative cursor-pointer transition ${reminder ? 'bg-[#333]' : 'bg-gray-300'}`}>
                                            <div className={`w-3 h-3 bg-white rounded-full absolute top-1 transition-all ${reminder ? 'left-6' : 'left-1'}`}></div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div>
                                <label className="text-xs text-gray-400 block mb-1">æœŸåˆé¤˜é¡</label>
                                <input type="number" className="w-full border-b py-1 outline-none text-[#333]" placeholder="0" value={initialBalance} onChange={e => setInitialBalance(e.target.value)} />
                            </div>
                            
                            {/* â˜… ä¿®æ”¹ï¼šåªæœ‰åœ¨ã€Œç·¨è¼¯æ¨¡å¼ (data.id å­˜åœ¨)ã€æ™‚æ‰é¡¯ç¤ºã€Œç›®å‰é¤˜é¡ã€ */}
                            {data.id && (
                                <div>
                                    <label className="text-xs text-gray-400 block mb-1">ç›®å‰é¤˜é¡ (ä¿®æ”¹å°‡è‡ªå‹•ç”¢ç”Ÿèª¿æ•´ç´€éŒ„)</label>
                                    <input type="number" className="w-full border-b py-1 outline-none font-bold text-[#333]" value={balance} onChange={e => setBalance(e.target.value)} />
                                </div>
                            )}
                        </div>
                        
                        <div className="flex gap-3 mt-8 justify-end">
                            <button onClick={onClose} className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-50 rounded">å–æ¶ˆ</button>
                            <button onClick={handleSave} className="px-6 py-2 text-sm bg-[#333] text-white rounded shadow hover:bg-black transition">å„²å­˜</button>
                        </div>
                    </div>
                </div>
            );
        };
        // ==========================================
// â˜… è£œå›ï¼šå¸³æˆ¶æ˜ç´°ç¨ç«‹è¦–çª— (AccountDetailView)
// ==========================================
const AccountDetailView = ({ accountId, transactions, accounts, categories, onBack, onEditTransaction }) => {
    const account = accounts.find(a => a.id === accountId);
    
    // é è¨­é¸ä¸­ç•¶å‰å¹´æœˆ
    const [year, setYear] = useState(new Date().getFullYear());
    const [month, setMonth] = useState(new Date().getMonth() + 1);

    // ç¯©é¸è©²å¸³æˆ¶ & è©²å¹´æœˆçš„äº¤æ˜“
    const filteredTx = useMemo(() => {
        return transactions.filter(t => {
            const d = new Date(t.date);
            // åˆ¤æ–·æ¢ä»¶ï¼š
            // 1. è©²äº¤æ˜“å±¬æ–¼æ­¤å¸³æˆ¶ (æˆ–æ˜¯è½‰å¸³çš„è½‰å…¥å°è±¡)
            // 2. å¹´ä»½ç¬¦åˆ
            // 3. æœˆä»½ç¬¦åˆ
            const isRelated = t.accountId === accountId || t.targetAccountId === accountId;
            const isTimeMatch = d.getFullYear() === year && (d.getMonth() + 1) === month;
            return isRelated && isTimeMatch;
        }).sort((a, b) => new Date(b.date) - new Date(a.date)); // æ—¥æœŸæ–°åˆ°èˆŠæ’åº
    }, [transactions, accountId, year, month]);

    if (!account) return null;

    return (
        // z-30 ç¢ºä¿è“‹åœ¨è³‡ç”¢åˆ—è¡¨ä¹‹ä¸Šï¼Œanimate-slide-up ç”¢ç”Ÿæ»‘å…¥æ•ˆæœ
        <div className="h-full bg-[#F5F5F3] flex flex-col animate-slide-up z-30 fixed inset-0">
            {/* é ‚éƒ¨å°èˆªåˆ— */}
            <div className="bg-white px-5 pt-12 pb-4 border-b border-gray-200">
                <div className="flex items-center gap-4 mb-6">
                    <button onClick={onBack} className="p-1 -ml-2 text-gray-500 hover:text-black">
                        <Icon name="back" size={24}/>
                    </button>
                    <h2 className="text-xl font-medium">{account.name}</h2>
                </div>
                
                {/* é¤˜é¡èˆ‡æ—¥æœŸç¯©é¸ */}
                <div className="flex justify-between items-end">
                    <div>
                        <div className="text-xs text-gray-400 uppercase tracking-widest mb-1">ç›®å‰é¤˜é¡</div>
                        <div className={`text-2xl font-light ${account.balance < 0 ? 'text-[#D9534F]' : 'text-gray-800'}`}>
                            ${formatMoney(account.balance)}
                        </div>
                    </div>
                    <div className="flex gap-2">
                        <select value={year} onChange={e => setYear(Number(e.target.value))} className="bg-[#F5F5F3] text-sm px-2 py-1 rounded outline-none text-[#333]">
                            {Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i).map(y => <option key={y} value={y}>{y}å¹´</option>)}
                        </select>
                        <select value={month} onChange={e => setMonth(Number(e.target.value))} className="bg-[#F5F5F3] text-sm px-2 py-1 rounded outline-none text-[#333]">
                            {Array.from({length: 12}, (_, i) => i + 1).map(m => <option key={m} value={m}>{m}æœˆ</option>)}
                        </select>
                    </div>
                </div>
            </div>

            {/* äº¤æ˜“åˆ—è¡¨ */}
            <div className="flex-1 overflow-y-auto p-4 space-y-3 pb-24">
                {filteredTx.length > 0 ? (
                    filteredTx.map(t => (
                        <TransactionCard 
                            key={t.id} 
                            transaction={t} 
                            accounts={accounts} // é€™è£¡è¦å‚³å…¥ accounts ä»¥ä¾¿é¡¯ç¤ºè½‰å¸³åç¨±
                            categories={categories} // é€™è£¡è¦å‚³å…¥ categories ä»¥ä¾¿é¡¯ç¤ºåˆ†é¡åç¨±
                            onClick={() => onEditTransaction(t)} 
                        />
                    ))
                ) : (
                    <div className="text-center py-20 text-gray-400 text-sm">
                        æ­¤æœˆä»½ç„¡äº¤æ˜“ç´€éŒ„
                    </div>
                )}
            </div>
        </div>
    );
};
// ==========================================
// 3. MainLayout (è² è²¬ UI é¡¯ç¤ºèˆ‡å°èˆª) [ä¿®å¾©é€£çµç‰ˆ]
// ==========================================
const MainLayout = () => {
    const [activeTab, setActiveTab] = useState('home');
    const [showAddModal, setShowAddModal] = useState(false);
    const [showQuickSheet, setShowQuickSheet] = useState(false);
    const [showQuickEntry, setShowQuickEntry] = useState(null);
    const [editingTransaction, setEditingTransaction] = useState(null);
    const [selectedAccountId, setSelectedAccountId] = useState(null);
    const [editingAccount, setEditingAccount] = useState(null);
    const [petExternalMsg, setPetExternalMsg] = useState('');
    const MAIN_TABS = ['home', 'split_manager', 'assets', 'settings'];
    
    const { 
        transactions, accounts, categories, quickTemplates, recurringItems, totalAssets,
        handleSaveTransaction, handleDeleteTransaction, handleSaveAccount, handleReorderAccounts,
        handleDeleteAccount,
        handleExportData, handleImportData, handleManualRestore, handleCloudBackup,
        setCategories, setRecurringItems, setQuickTemplates, setCloudSettings,
        showAlert, showConfirm
    } = React.useContext(DataContext);
// 3. å‘¼å«è‡ªå‹•åµæ¸¬ Hook
useSmsAutoParser((data) => {
        showConfirm(
            'ç™¼ç¾æ–°æ¶ˆè²»',
            `åµæ¸¬åˆ°ä¾†è‡ª ${data.bank} çš„ $${data.amount} ç°¡è¨Šï¼Œè¦ç«‹åˆ»è¨˜å¸³å—ï¼Ÿ`,
            () => {
                setEditingTransaction({
                    amount: data.amount,
                    date: data.date,
                    note: data.note,
                    accountId: data.accountId,
                    type: 'expense'
                });
                setShowAddModal(true);
            }
        );
    }, setPetExternalMsg);

    const handleSwipeLeft = () => {
        const currentIndex = MAIN_TABS.indexOf(activeTab);
        if (currentIndex !== -1 && currentIndex < MAIN_TABS.length - 1) {
            setActiveTab(MAIN_TABS[currentIndex + 1]);
        }
    };

    const handleSwipeRight = () => {
        if (activeTab === 'categories' || activeTab === 'recurring' || activeTab === 'templates') {
            setActiveTab('settings');
            return;
        }
        if (activeTab === 'account_detail') {
            setActiveTab('assets');
            setSelectedAccountId(null);
            return;
        }
        const currentIndex = MAIN_TABS.indexOf(activeTab);
        if (currentIndex > 0) {
            setActiveTab(MAIN_TABS[currentIndex - 1]);
        }
    };

    const onDeleteAcc = (accId) => {
        handleDeleteAccount(accId);
        setEditingAccount(null);
    };

    const swipeHandlers = useSwipe({ onSwipeLeft: handleSwipeLeft, onSwipeRight: handleSwipeRight });

    const monthlyExpense = useMemo(() => {
        const now = new Date();
        const yearMonthPrefix = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        return transactions.filter(t => t.type === 'expense' && t.date.startsWith(yearMonthPrefix)).reduce((sum, t) => sum + ((t.splitMyShare !== undefined ? t.splitMyShare : t.amount)), 0);
    }, [transactions]);

    const onSaveTx = (tx) => {
        handleSaveTransaction(tx, editingTransaction ? editingTransaction.id : null);
        closeModal();
        if(showQuickEntry) setShowQuickEntry(null);
    };

    const onDeleteTx = (txId) => {
        handleDeleteTransaction(txId);
        closeModal();
    };

    const onSaveAcc = (accData) => {
        handleSaveAccount(accData);
        setEditingAccount(null);
    };    

    const openAddModal = () => { setEditingTransaction(null); setShowAddModal(true); };
    const openEditModal = (tx) => { setEditingTransaction(tx); setShowAddModal(true); };
    const closeModal = () => { setShowAddModal(false); setEditingTransaction(null); };

    const renderContent = () => {
        switch(activeTab) {
            case 'home': 
                return <HomeView transactions={transactions} accounts={accounts} totalAssets={totalAssets} monthlyExpense={monthlyExpense} onEditTransaction={openEditModal} categories={categories} petExternalMsg={petExternalMsg} />;
            case 'assets': 
                return <AssetsView 
                    accounts={accounts} 
                    onSelectAccount={(id) => { 
                        setSelectedAccountId(id); 
                        setActiveTab('account_detail'); 
                    }} 
                    onAddAccount={() => setEditingAccount({name:'', type:'cash', balance:0, initialBalance:0})} 
                    onEditAccount={(acc) => setEditingAccount(acc)} 
                    onReorderAccounts={handleReorderAccounts}
                />;
            
            case 'account_detail': 
                return <AccountDetailView 
                    accountId={selectedAccountId} 
                    transactions={transactions} 
                    accounts={accounts} 
                    categories={categories}
                    onBack={() => { 
                        setSelectedAccountId(null); 
                        setActiveTab('assets'); 
                    }} 
                    onEditTransaction={openEditModal} 
                />;

            case 'stats': return <StatsView transactions={transactions} categories={categories} />;
            
            // â˜… ä¿®æ­£ï¼šé€™è£¡è£œä¸Šäº†æ­£ç¢ºçš„ propsï¼Œè§£æ±ºé»æ“Šç„¡æ•ˆå•é¡Œ
            case 'settings': return <SettingsView onChangeTab={setActiveTab} />;
            case 'categories': return <CategoryManager onBack={() => setActiveTab('settings')} />;
            case 'recurring': return <RecurringManager onBack={() => setActiveTab('settings')} />;
            case 'templates': return <TemplateManager onBack={() => setActiveTab('settings')} />;
            case 'split_manager': return <SplitManager />;
            
            default: return <HomeView transactions={transactions} accounts={accounts} totalAssets={totalAssets} monthlyExpense={monthlyExpense} onEditTransaction={openEditModal} categories={categories} />;
        }
    };

    return (
        <div 
        {...swipeHandlers}
        className="h-full w-full max-w-md mx-auto border-x border-gray-200 bg-[#F5F5F3] relative flex flex-col overflow-hidden">
            <div className="flex-1 overflow-y-auto no-scrollbar pb-24 relative">{renderContent()}</div>
            
            {['home', 'assets', 'stats', 'settings'].includes(activeTab) && (
                <div className="absolute bottom-32 right-5 z-[50]">
                    <button onClick={() => setShowQuickSheet(true)} className="w-12 h-12 bg-white rounded-full text-[#333] shadow-lg border border-gray-200 flex items-center justify-center hover:scale-105 active:scale-95 transition-all">
                        <Icon name="lightning" size={20} className="fill-current text-yellow-400" />
                    </button>
                </div>
            )}

            {['home', 'assets', 'stats', 'split_manager', 'settings'].includes(activeTab) && (
                <div className="fixed bottom-0 w-full max-w-md bg-white border-t border-gray-200 px-6 h-[64px] flex justify-between items-center z-40 shadow-[0_-1px_3px_rgba(0,0,0,0.05)]">
                    <NavButton iconName="home" label="é¦–é " isActive={activeTab === 'home'} onClick={() => setActiveTab('home')} />
                    <NavButton iconName="split" label="åˆ†å¸³" isActive={activeTab === 'split_manager'} onClick={() => setActiveTab('split_manager')} />
                    <div className="relative -top-8">
                        <button onClick={openAddModal} className="w-16 h-16 bg-[#333] rounded-full flex items-center justify-center text-white shadow-xl hover:bg-[#000] transition-all transform active:scale-95 border-4 border-[#F5F5F3]"><Icon name="plus" size={32} /></button>
                    </div>
                    <NavButton iconName="wallet" label="è³‡ç”¢" isActive={activeTab === 'assets' || activeTab === 'account_detail'} onClick={() => setActiveTab('assets')} />
                    <NavButton iconName="settings" label="è¨­å®š" isActive={activeTab === 'settings' || activeTab === 'categories' || activeTab === 'templates'} onClick={() => setActiveTab('settings')} />
                </div>
            )}

            {showAddModal && <TransactionModal initialData={editingTransaction} onClose={closeModal} onSave={onSaveTx} onDelete={onDeleteTx} accounts={accounts} categories={categories} />}
            {showQuickSheet && <QuickAddSheet templates={quickTemplates} accounts={accounts} categories={categories} onClose={() => setShowQuickSheet(false)} onSelect={(tpl) => { setShowQuickSheet(false); setShowQuickEntry(tpl); }} onGoSettings={() => { setShowQuickSheet(false); setActiveTab('templates'); }} />}
            {showQuickEntry && <QuickEntryModal template={showQuickEntry} onClose={() => setShowQuickEntry(null)} onSave={onSaveTx} />}
            {editingAccount && <AccountModal initialData={editingAccount} onClose={() => setEditingAccount(null)} onSave={onSaveAcc} onDelete={onDeleteAcc}/>}
        </div>
    );
};
// ==========================================
// 4. æœ€çµ‚ Root (åŒ…è£¹å™¨) - é€™æ˜¯ä¿®æ­£å¾Œçš„ç‰ˆæœ¬
// ==========================================
function MoneyMasterApp() {
    return (
        <DataProvider>
            <MainLayout />
        </DataProvider>
    );
}

// ==========================================
    // ä¿®æ­£ç‰ˆ LocalChartAnalysis (æ”¶æ”¯åˆ†é›¢ + é ç®—ä¿®æ­£)
    // ==========================================
    const LocalChartAnalysis = ({ transactions, categories }) => {
        // æ–°å¢ï¼šåœ–è¡¨é¡å‹åˆ‡æ› (æ”¯å‡º/æ”¶å…¥)
        const [chartType, setChartType] = useState('expense'); 

        // 1. è¨ˆç®—æ•¸æ“š (åš´æ ¼å€åˆ†æ”¶å…¥èˆ‡æ”¯å‡º)
const chartData = useMemo(() => {
            const map = {};
            let totalAmount = 0;
            
// â˜… ä¿®æ­£ï¼šéæ¿¾æ‰ä»£è³¼é …ç›®ï¼Œä¸åˆ—å…¥æ”¯å‡ºèˆ‡åœ–è¡¨è¨ˆç®—
            const targetTx = transactions.filter(t => t.type === chartType && !(t.tags || []).includes('#ä»£è³¼'));
            
            // â˜… è‡´å‘½éŒ¯èª¤ä¿®å¾©ï¼šè£œå›éºå¤±çš„ targetCats å®šç¾©
            const targetCats = chartType === 'expense' ? categories.expense : categories.income;
            
            // çµ±è¨ˆå„åˆ†é¡é‡‘é¡
            targetTx.forEach(t => {
                const cat = targetCats.find(c => c.id === t.categoryId);                const id = cat ? cat.id : 'unknown';
                const name = cat ? cat.name : 'å…¶ä»–';
                
                if (!map[id]) map[id] = { 
                    id, 
                    name, 
                    value: 0, 
                    color: cat ? cat.color : '#ccc',
                    budget: (chartType === 'expense' && cat) ? (cat.budget || 0) : 0 
                };
                map[id].value += t.amount;
                totalAmount += t.amount;
            });

            const sortedData = Object.values(map).sort((a,b) => b.value - a.value);
            
            // ç”¢ç”Ÿåœ“é¤…åœ–æ¼¸å±¤
            let currentPercent = 0;
            const gradientParts = sortedData.map(item => {
                const start = currentPercent;
                const percent = totalAmount > 0 ? (item.value / totalAmount) * 100 : 0;
                const end = currentPercent + percent;
                currentPercent = end;
                return `${item.color} ${start}% ${end}%`;
            });

            const gradientString = gradientParts.length > 0 
                ? `conic-gradient(${gradientParts.join(', ')})`
                : 'conic-gradient(#E5E5E5 0% 100%)'; 

            return { data: sortedData, total: totalAmount, gradientString };
        }, [transactions, categories, chartType]);

        // 2. è¨ˆç®—ç¸½é ç®—èˆ‡ç•¶æ—¥é¤˜é¡ (åªé‡å°æ”¯å‡ºæ¨¡å¼)
        const budgetData = useMemo(() => {
            if (chartType !== 'expense') return null;

            // â˜… ä¿®æ­£ï¼šåªè¨ˆç®—ã€Œæ”¯å‡ºåˆ†é¡ã€çš„ç¸½é ç®—
            const totalBudget = categories.expense.reduce((sum, c) => sum + (c.budget || 0), 0);
            
            // â˜… ä¿®æ­£ï¼šå‰©é¤˜é ç®— = ç¸½é ç®— - ç•¶å‰é¡¯ç¤ºçš„ç¸½æ”¯å‡º (chartData.total å·²ç¶“æ˜¯éæ¿¾å¾Œçš„æ”¯å‡ºç¸½å’Œ)
            const remaining = totalBudget - chartData.total;
            
            const now = new Date();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const today = now.getDate();
            // å‰©é¤˜å¤©æ•¸ (å«ä»Šå¤©)
            const remainingDays = Math.max(1, daysInMonth - today + 1);
            
            // â˜… ä¿®æ­£ï¼šä»Šæ—¥å»ºè­° = å‰©é¤˜é‡‘é¡ / å‰©é¤˜å¤©æ•¸
            const dailyAvailable = remaining > 0 ? Math.floor(remaining / remainingDays) : 0;

            return {
                hasBudget: totalBudget > 0,
                total: totalBudget,
                remaining,
                dailyAvailable,
                progress: totalBudget > 0 ? Math.min(100, (chartData.total / totalBudget) * 100) : 0
            };
        }, [categories, chartData.total, chartType]);

        return (
            <div className="animate-fade-in flex flex-col gap-4 pb-4">
                {/* åˆ‡æ›æŒ‰éˆ• */}
                <div className="flex justify-center mb-2">
                    <div className="flex bg-gray-100 dark:bg-[#40444B] p-0.5 rounded-lg">
                        <button onClick={() => setChartType('expense')} className={`px-4 py-1 text-xs rounded-md transition ${chartType === 'expense' ? 'bg-white dark:bg-[#2B2D30] shadow text-[#333] dark:text-white' : 'text-gray-400'}`}>æ”¯å‡ºåˆ†ä½ˆ</button>
                        <button onClick={() => setChartType('income')} className={`px-4 py-1 text-xs rounded-md transition ${chartType === 'income' ? 'bg-white dark:bg-[#2B2D30] shadow text-[#333] dark:text-white' : 'text-gray-400'}`}>æ”¶å…¥ä¾†æº</button>
                    </div>
                </div>

                {/* ç¸½é ç®—ç›£æ§å¡ç‰‡ (åªåœ¨æ”¯å‡ºæ¨¡å¼é¡¯ç¤º) */}
                {chartType === 'expense' && budgetData && budgetData.hasBudget && (
                    <Card className="flex flex-col gap-3 relative overflow-hidden">
                        <div className="flex justify-between items-end z-10">
                            <div>
                                <div className="text-xs text-gray-400 uppercase tracking-widest mb-1">æœ¬æœˆé ç®—é¤˜é¡</div>
                                <div className={`text-2xl font-medium ${budgetData.remaining < 0 ? 'text-[#D9534F]' : 'text-[#333] dark:text-white'}`}>
                                    ${budgetData.remaining.toLocaleString()}
                                </div>
                            </div>
                            <div className="text-right">
                                <div className="text-[10px] text-gray-400 uppercase tracking-widest mb-1">ä»Šæ—¥å»ºè­°æ”¯å‡ºä¸Šé™</div>
                                <div className="text-base font-medium text-[#5CB85C]">${budgetData.dailyAvailable.toLocaleString()}</div>
                            </div>
                        </div>
                        <div className="h-2 w-full bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden z-10 mt-1">
                            <div 
                                className={`h-full rounded-full animate-grow ${budgetData.remaining < 0 ? 'bg-[#D9534F]' : 'bg-[#333] dark:bg-white'}`} 
                                style={{ width: `${budgetData.progress}%` }}
                            ></div>
                        </div>
                        <div className="flex justify-between text-[10px] text-gray-400 z-10">
                            <span>å·²ç”¨ ${chartData.total.toLocaleString()}</span>
                            <span>ç¸½é ç®— ${budgetData.total.toLocaleString()}</span>
                        </div>
                    </Card>
                )}

                <Card className="flex flex-col items-center pt-8 pb-8">
                    {chartData.total > 0 ? (
                        <>
                            <div className="relative w-48 h-48 rounded-full shadow-inner mb-6" style={{ background: chartData.gradientString }}>
                                <div className="absolute inset-0 m-auto w-32 h-32 bg-white dark:bg-[#36393F] rounded-full flex flex-col items-center justify-center shadow-sm">
                                    <span className="text-xs text-gray-400 uppercase tracking-widest">{chartType === 'expense' ? 'ç¸½æ”¯å‡º' : 'ç¸½æ”¶å…¥'}</span>
                                    <span className="text-xl font-medium text-[#333] dark:text-white tracking-tight">${chartData.total.toLocaleString()}</span>
                                </div>
                            </div>
                            <div className="w-full space-y-4 px-2">
                                {chartData.data.slice(0, 8).map(d => {
                                    const catBudget = d.budget;
                                    const hasCatBudget = catBudget > 0;
                                    const catProgress = hasCatBudget ? Math.min(100, (d.value / catBudget) * 100) : 0;
                                    const isOverBudget = hasCatBudget && d.value > catBudget;

                                    return (
                                        <div key={d.id} className="flex flex-col gap-1 border-b border-gray-50 dark:border-gray-700 pb-3 last:border-0">
                                            <div className="flex justify-between items-center text-xs">
                                                <div className="flex items-center gap-2">
                                                    <div className="w-3 h-3 rounded-full shadow-sm" style={{backgroundColor: d.color}}></div>
                                                    <span className="text-gray-600 dark:text-gray-300 font-medium">{d.name}</span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <span className="text-[10px] text-gray-400">{Math.round((d.value / chartData.total) * 100)}%</span>
                                                    <span className="font-medium text-gray-800 dark:text-gray-200 w-16 text-right">${d.value.toLocaleString()}</span>
                                                </div>
                                            </div>
                                            
                                            {/* å–®ä¸€åˆ†é¡é ç®—æ¢ (åªåœ¨æ”¯å‡ºæ¨¡å¼ä¸”æœ‰è¨­å®šé ç®—æ™‚é¡¯ç¤º) */}
                                            {chartType === 'expense' && hasCatBudget && (
                                                <div className="ml-5 mt-1">
                                                    <div className="h-1.5 w-full bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                                        <div 
                                                            className={`h-full rounded-full ${isOverBudget ? 'bg-[#D9534F]' : 'bg-[#333] dark:bg-white opacity-60'}`} 
                                                            style={{ width: `${catProgress}%` }}
                                                        ></div>
                                                    </div>
                                                    <div className="flex justify-between mt-0.5">
                                                        <span className={`text-[9px] ${isOverBudget ? 'text-[#D9534F]' : 'text-gray-400'}`}>
                                                            {isOverBudget ? `è¶…æ”¯ $${(d.value - catBudget).toLocaleString()}` : `å‰©é¤˜ $${(catBudget - d.value).toLocaleString()}`}
                                                        </span>
                                                        <span className="text-[9px] text-gray-300">é ç®— ${catBudget.toLocaleString()}</span>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </>
                    ) : (
                            <div className="flex flex-col items-center py-10 opacity-50">
                            <div className="w-32 h-32 rounded-full border-4 border-gray-100 dark:border-gray-700 mb-4 flex items-center justify-center bg-gray-50 dark:bg-gray-800">
                                <Icon name="pieChart" size={32} className="text-gray-300"/>
                            </div>
                            <div className="text-xs text-gray-400">æœ¬æœˆå°šç„¡è³‡æ–™</div>
                        </div>
                    )}
                </Card>
            </div>
        );
    };
// ==========================================
// â˜… å‡ç´šç‰ˆï¼šè¨˜å¸³é›»å­é› (æ”¯æ´é ç®—è¶…æ”¯è­¦å ±)
// ==========================================
const MoneyPetWidget = ({ externalMsg }) => {
    const { transactions, recurringItems, accounts, categories } = React.useContext(DataContext);
    const [message, setMessage] = useState('');
    const [isPoked, setIsPoked] = useState(false);
    const prevCountRef = useRef(transactions.length);

// 1. è¨ˆç®—æœ¬æœˆæ”¯å‡ºèˆ‡ç¸½é ç®—
    const { monthlyExp, totalBudget } = useMemo(() => {
        const now = new Date();
        const yearMonthPrefix = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

        // æœ¬æœˆæ”¯å‡º (â˜… ä¿®æ­£ï¼šå°é›ä¹Ÿè¦æ’é™¤ä»£è³¼ï¼Œé¿å…èª¤åˆ¤ç ´ç”¢)
        const exp = transactions
            .filter(t => t.type === 'expense' && t.date.startsWith(yearMonthPrefix) && !(t.tags || []).includes('#ä»£è³¼'))
            .reduce((sum, t) => sum + ((t.splitMyShare !== undefined ? t.splitMyShare : t.amount)), 0);
            
        // ç¸½é ç®—
        const budget = categories.expense.reduce((sum, c) => sum + (c.budget || 0), 0);
        return { monthlyExp: exp, totalBudget: budget };
    }, [transactions, categories]);

    // 2. åˆ¤æ–·æ˜¯å¦è¶…æ”¯ (æœ‰è¨­å®šé ç®—ï¼Œä¸”æ”¯å‡ºå¤§æ–¼é ç®—)
    const isOverBudget = totalBudget > 0 && monthlyExp > totalBudget;

    useEffect(() => {
        if (externalMsg) {
            setMessage(externalMsg);
            const timer = setTimeout(() => setMessage(''), 5000);
            return () => clearTimeout(timer);
        }
    }, [externalMsg]);

    useEffect(() => {
        if (transactions.length > prevCountRef.current) {
            setIsPoked(true); 
            setTimeout(() => setIsPoked(false), 300); 
            const feedMsgs = isOverBudget 
                ? ["é›–ç„¶å¾ˆå¥½åƒ...ä½†æˆ‘å€‘é€æ”¯äº†ğŸ˜­", "åƒåœŸå•¦ğŸ’¸", "é ç®—çˆ†ç‚¸äº†ğŸ’¥"] 
                : ["åš¼åš¼...è¬è¬æ¬¾å¾…ï¼ğŸ˜‹", "å¥½è€¶ï¼åˆåƒåˆ°ä¸€ç­†å¸³äº†ï¼âœ¨", "è®Šå¼·äº†ï¼ğŸ’ª"];
            setMessage(feedMsgs[Math.floor(Math.random() * feedMsgs.length)]);
            setTimeout(() => setMessage(''), 3000);
        }
        prevCountRef.current = transactions.length;
    }, [transactions.length, isOverBudget]);

    // 3. é›»å­é›ç‹€æ…‹åˆ¤æ–·
    const petStats = useMemo(() => {
        let stage = 'egg';
        let icon = 'ğŸ¥š';
        const count = transactions.length;
        if (count >= 100) { stage = 'king'; icon = 'ğŸ‘‘ğŸ”'; }
        else if (count >= 50) { stage = 'adult'; icon = 'ğŸ”'; }
        else if (count >= 10) { stage = 'baby'; icon = 'ğŸ£'; }

        let status = 'normal'; 
        let daysDiff = 0;
        
        if (transactions.length > 0) {
            const lastDate = new Date(transactions[0].date);
            const today = new Date();
            lastDate.setHours(0,0,0,0);
            today.setHours(0,0,0,0);
            daysDiff = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
            if (daysDiff === 0) status = 'happy';
            else if (daysDiff >= 3) status = 'sick';
        } else {
            status = 'sick';
        }

        // â˜… è¶…æ”¯æ™‚å¼·åˆ¶è®Šæˆç ´ç”¢ç‹€æ…‹
        if (isOverBudget) {
            status = 'broke';
            icon = stage === 'egg' ? 'ğŸ’¸' : 'ğŸ˜­'; // ç ´ç”¢åœ–ç¤º
        } else if (status === 'sick' && stage !== 'egg') {
            icon = 'ğŸ¤’';
        }
        return { stage, icon, status };
    }, [transactions, isOverBudget]);

    const handlePoke = () => {
        setIsPoked(true);
        setTimeout(() => setIsPoked(false), 300);
        let msgs = [];
        
        // â˜… å„ªå…ˆé¡¯ç¤ºè¶…æ”¯è­¦å‘Š
        if (isOverBudget) {
            msgs = [
                `è¶…æ”¯ $${(monthlyExp - totalBudget).toLocaleString()} å•¦ï¼`, 
                "ä¸»äººï¼Œæˆ‘å€‘æ²’éŒ¢è²·é£¼æ–™äº†...", 
                "å¿«åœæ­¢èŠ±éŒ¢ï¼ğŸ’¸"
            ];
        } else if (petStats.status === 'sick') { 
            msgs = ["å’³å’³...å¥½é¤“...", "æ•‘å‘½...", "é£¯é£¯..."]; 
        } else if (petStats.status === 'happy') { 
            msgs = ["é–‹å¿ƒï¼", "å“‡ï¼åƒå¾—å¥½é£½ï¼", "é ç®—æ§åˆ¶å¾—ä¸éŒ¯å–”ï¼"]; 
        } else { 
            msgs = ["è‚šå­ç©ºç©º", "ç­‰ä½ çš„ç´€éŒ„"]; 
        }

        // ç¹³è²»æé†’é‚è¼¯
        const today = new Date().getDate();
        recurringItems.forEach(item => {
            if (item.active !== false && item.type === 'expense' && item.day >= today && item.day <= today + 3) {
                const diff = item.day - today;
                msgs.push(`ä¸»äººï¼${diff === 0 ? "ä»Šå¤©" : diff + "å¤©å¾Œ"}æ˜¯ã€Œ${item.name}ã€æ‰£æ¬¾æ—¥å–”ï¼`);
            }
        });

        setMessage(msgs[Math.floor(Math.random() * msgs.length)]);
        setTimeout(() => setMessage(''), 3000);
    };

    return (
        <div className="flex flex-col items-center justify-center relative z-10 pointer-events-auto">
            <div className={`speech-bubble bg-[#333] text-white text-[10px] px-2 py-1 rounded mb-1 shadow-md transition-opacity duration-300 absolute -top-8 whitespace-nowrap ${message ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
                {message}
            </div>
            <button onClick={handlePoke} className={`text-4xl transition-transform cursor-pointer select-none filter drop-shadow-sm ${petStats.status === 'happy' ? 'animate-bounce-slow' : ''} ${isPoked ? 'scale-90' : 'scale-100'}`} style={{ transformOrigin: 'bottom center' }}>
                {petStats.icon}
            </button>
            <div className="mt-1">
                {petStats.status === 'broke' ? (
                    <span className="text-[9px] bg-red-100 text-red-600 px-1.5 py-0.5 rounded-full animate-pulse border border-red-200">âš ï¸ è¶…æ”¯</span>
                ) : petStats.status === 'sick' ? (
                    <span className="text-[9px] bg-red-100 text-red-500 px-1.5 py-0.5 rounded-full animate-pulse">é¤“</span>
                ) : (
                    <span className="text-[9px] bg-white/60 border border-gray-200 px-1.5 py-0.5 rounded-full text-gray-400 backdrop-blur-sm">
                        {petStats.stage === 'egg' ? 'å¹¼å¹´æœŸ' : petStats.stage === 'king' ? 'åœ‹ç‹' : 'æˆé•·æœŸ'}
                    </span>
                )}
            </div>
        </div>
    );
};
const HomeView = ({ onEditTransaction, petExternalMsg }) => {
    const { transactions, accounts, categories, totalAssets, triggerHaptic, isPrivacyMode, togglePrivacy } = React.useContext(DataContext);

    const [viewMode, setViewMode] = useState('list');
    const [currentYear, setCurrentYear] = useState(new Date().getFullYear());
    const [currentMonth, setCurrentMonth] = useState(new Date().getMonth() + 1);
    
    // --- â˜… æ–°åŠŸèƒ½ï¼šé€²éšç¯©é¸ State ---
    const [showFilter, setShowFilter] = useState(false);
    const [filters, setFilters] = useState({
        minAmount: '',
        maxAmount: '',
        categoryId: '',
        noteKeyword: ''
    });

    // --- â˜… æ–°åŠŸèƒ½ï¼šåˆ†é è¼‰å…¥ State (æ•ˆèƒ½å„ªåŒ–) ---
    const [page, setPage] = useState(1);
    const PAGE_SIZE = 20; // æ¯æ¬¡åªæ¸²æŸ“ 20 ç­†

    // é‡ç½®ç¯©é¸
    const resetFilters = () => {
        setFilters({ minAmount: '', maxAmount: '', categoryId: '', noteKeyword: '' });
        setPage(1);
        triggerHaptic();
    };

    // ç¯©é¸é‚è¼¯
    const displayTransactions = useMemo(() => {
        let data = transactions;

        // 1. åŸºç¤å¹´æœˆç¯©é¸ (å¦‚æœæ²’æœ‰é—œéµå­—æœå°‹)
        if (!filters.noteKeyword) {
            const yearMonthPrefix = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            data = data.filter(t => t.date.startsWith(yearMonthPrefix));
        }

        // 2. é€²éšç¯©é¸
        if (filters.minAmount) data = data.filter(t => t.amount >= Number(filters.minAmount));
        if (filters.maxAmount) data = data.filter(t => t.amount <= Number(filters.maxAmount));
        if (filters.categoryId) data = data.filter(t => t.categoryId === filters.categoryId);
        if (filters.noteKeyword) {
            const lower = filters.noteKeyword.toLowerCase();
            data = data.filter(t => 
                (t.note && t.note.toLowerCase().includes(lower)) ||
                (categories.expense.find(c=>c.id===t.categoryId)?.name.includes(lower)) ||
                (categories.income.find(c=>c.id===t.categoryId)?.name.includes(lower))
            );
        }

        // æ’åº
        return data.sort((a,b) => {
            const dateDiff = new Date(b.date) - new Date(a.date);
            if (dateDiff !== 0) return dateDiff;
            return (b.createdAt || 0) - (a.createdAt || 0);
        });
    }, [transactions, currentYear, currentMonth, filters, categories]);

    // â˜… åˆ†é é‚è¼¯ï¼šåªåˆ‡ç‰‡é¡¯ç¤ºå‰ N ç­†
    const paginatedTransactions = useMemo(() => {
        return displayTransactions.slice(0, page * PAGE_SIZE);
    }, [displayTransactions, page]);

    // ç•¶ç¯©é¸æ¢ä»¶æ”¹è®Šæ™‚ï¼Œé‡ç½®é ç¢¼
    useEffect(() => { setPage(1); }, [currentYear, currentMonth, filters]);

// â˜… ä¿®æ­£ï¼šå°‡ #ä»£è³¼ å¾æœ¬æœˆç¸½æ”¯å‡ºä¸­éš±è—
    const currentTotalExpense = useMemo(() => displayTransactions.filter(t => t.type === 'expense' && !(t.tags || []).includes('#ä»£è³¼')).reduce((sum, t) => sum + ((t.splitMyShare !== undefined ? t.splitMyShare : t.amount)), 0), [displayTransactions]);
    const currentTotalIncome = useMemo(() => displayTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0), [displayTransactions]);

    const groupedTransactions = useMemo(() => { 
        const groups = {}; 
        paginatedTransactions.forEach(t => { 
            if (!groups[t.date]) groups[t.date] = []; 
            groups[t.date].push(t); 
        }); 
        return Object.entries(groups).sort((a,b) => new Date(b[0]) - new Date(a[0])); 
    }, [paginatedTransactions]);

    // æ—¥æ›†æ•¸æ“š (ä¿æŒä¸è®Š)
    const calendarData = useMemo(() => {
        // ... (é€™éƒ¨åˆ†é‚è¼¯èˆ‡ä¹‹å‰ç›¸åŒï¼Œç‚ºç¯€çœç¯‡å¹…çœç•¥ï¼Œè«‹ç›´æ¥è¤‡è£½åŸæœ¬çš„æ—¥æ›†é‚è¼¯) ...
        const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
        const firstDayOfWeek = new Date(currentYear, currentMonth - 1, 1).getDay();
        const days = [];
        for (let i = 0; i < firstDayOfWeek; i++) days.push(null);
        for (let i = 1; i <= daysInMonth; i++) {
            const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            const dailyTx = transactions.filter(t => t.date === dateStr);
            const dailyExp = dailyTx.filter(t => t.type === 'expense').reduce((s,t) => s + t.amount, 0);
            const dailyInc = dailyTx.filter(t => t.type === 'income').reduce((s,t) => s + t.amount, 0);
            days.push({ day: i, dateStr, expense: dailyExp, income: dailyInc, hasData: dailyTx.length > 0 });
        }
        return days;
    }, [currentYear, currentMonth, transactions]);

    const [selectedDate, setSelectedDate] = useState(null);

return (
        <div className="h-full flex flex-col pt-10 px-6 pb-0 animate-fade-in relative">
            {/* Header Area */}
            <div className="shrink-0 mb-4 z-20 bg-[#F5F5F3] dark:bg-[#2B2D30] transition-colors">
                
                {/* â˜… ä¿®æ”¹é‡é»ï¼šæ”¹ç‚ºã€Œæœ¬æœˆæ”¶å…¥ã€èˆ‡ã€Œæœ¬æœˆæ”¯å‡ºã€ä¸¦åˆ— */}
                <div className="flex justify-between items-end mb-2"> 
                    {/* å·¦å´ï¼šç¸½æ”¶å…¥ */}
                    <div>
                        <div className="text-xs text-gray-400 mb-1 tracking-widest font-medium uppercase flex items-center gap-2">
                            {filters.noteKeyword ? 'æœå°‹æ”¶å…¥' : `${currentMonth}æœˆç¸½æ”¶å…¥`}
                            <button onClick={togglePrivacy} className="text-gray-300 hover:text-gray-500 transition">
                                <Icon name={isPrivacyMode ? "eyeOff" : "eye"} size={14} /> 
                            </button>
                        </div>
                        <div className="text-3xl font-light text-[#5CB85C] tracking-tight">
                            {isPrivacyMode ? '****' : <><span className="text-lg mr-1 font-normal">$</span>{formatMoney(currentTotalIncome)}</>}
                        </div>
                    </div>
                    
                    {/* å³å´ï¼šç¸½æ”¯å‡º */}
                    <div className="text-right">
                        <div className="text-xs text-gray-400 mb-1 tracking-widest font-medium uppercase">
                            {filters.noteKeyword ? 'æœå°‹æ”¯å‡º' : `${currentMonth}æœˆç¸½æ”¯å‡º`}
                        </div>
                        <div className="text-3xl font-light text-[#333] dark:text-white tracking-tight">
                            {isPrivacyMode ? '****' : <><span className="text-lg mr-1 font-normal">$</span>{formatMoney(currentTotalExpense)}</>}
                        </div>
                    </div>
                </div>

                {/* 2. ä¸­é–“ï¼šé›»å­é› (ä¿æŒä¸è®Š) */}
                    <div className="flex justify-center -mt-8 mb-2 relative z-10 pointer-events-none">
                        <div className="pointer-events-auto">
                            <MoneyPetWidget externalMsg={petExternalMsg} />
                        </div>
                    </div>
                {/* 3. ä¸‹åŠéƒ¨ï¼šæœå°‹èˆ‡ç¯©é¸ (ä¿æŒä¸è®Š) */}
                <div className="flex gap-2 mb-4">
                    <div className="relative flex-1">
                        <input 
                            type="text" 
                            placeholder="æœå°‹..." 
                            value={filters.noteKeyword} 
                            onChange={(e) => setFilters(prev => ({...prev, noteKeyword: e.target.value}))} 
                            className="w-full bg-white border border-gray-200 rounded-lg py-2 pl-9 pr-8 text-sm focus:border-[#333] outline-none shadow-sm transition-colors dark:bg-[#40444B] dark:border-transparent dark:text-gray-200" 
                        />
                        <div className="absolute left-3 top-2 text-gray-400"><Icon name="search" size={16}/></div>
                        {filters.noteKeyword && (
                            <button 
                                onClick={() => { setFilters(prev => ({...prev, noteKeyword: ''})); triggerHaptic(); }}
                                className="absolute right-2 top-2 text-gray-400 hover:text-gray-600 p-0.5 rounded-full hover:bg-gray-100 transition"
                            >
                                <Icon name="close" size={14}/>
                            </button>
                        )}
                    </div>
                    <button 
                        onClick={() => { setShowFilter(!showFilter); if(triggerHaptic) triggerHaptic(); }}
                        className={`px-3 rounded-lg border flex items-center gap-1 transition ${showFilter || filters.minAmount || filters.categoryId ? 'bg-[#333] text-white border-[#333]' : 'bg-white text-gray-500 border-gray-200 dark:bg-[#40444B] dark:border-transparent dark:text-gray-300'}`}
                    >
                        <Icon name="list" size={16} />
                        <span className="text-xs">ç¯©é¸</span>
                    </button>
                </div>
                {/* é€²éšç¯©é¸é¢æ¿ */}
                {showFilter && (
                    <div className="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4 animate-slide-up">
                        <div className="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label className="text-[10px] text-gray-400 uppercase block mb-1">æœ€ä½é‡‘é¡</label>
                                <input type="number" value={filters.minAmount} onChange={e => setFilters(prev=>({...prev, minAmount: e.target.value}))} className="w-full bg-gray-50 border border-gray-200 rounded p-1.5 text-sm outline-none" placeholder="0"/>
                            </div>
                            <div>
                                <label className="text-[10px] text-gray-400 uppercase block mb-1">æœ€é«˜é‡‘é¡</label>
                                <input type="number" value={filters.maxAmount} onChange={e => setFilters(prev=>({...prev, maxAmount: e.target.value}))} className="w-full bg-gray-50 border border-gray-200 rounded p-1.5 text-sm outline-none" placeholder="âˆ"/>
                            </div>
                        </div>
                        <div className="mb-3">
                            <label className="text-[10px] text-gray-400 uppercase block mb-1">æŒ‡å®šåˆ†é¡</label>
                            <select value={filters.categoryId} onChange={e => setFilters(prev=>({...prev, categoryId: e.target.value}))} className="w-full bg-gray-50 border border-gray-200 rounded p-1.5 text-sm outline-none">
                                <option value="">å…¨éƒ¨åˆ†é¡</option>
                                {categories.expense.map(c => <option key={c.id} value={c.id}>[æ”¯å‡º] {c.name}</option>)}
                                {categories.income.map(c => <option key={c.id} value={c.id}>[æ”¶å…¥] {c.name}</option>)}
                            </select>
                        </div>
                        <div className="flex justify-between items-center">
                            {/* â˜… ä¿®æ­£ï¼šæ˜é¡¯çš„å–æ¶ˆ/é‡ç½®æŒ‰éˆ• */}
                            <button onClick={() => { resetFilters(); setShowFilter(false); }} className="text-xs text-red-500 border border-red-200 px-3 py-1.5 rounded hover:bg-red-50 transition">
                                <Icon name="trash" size={12} className="inline mr-1"/>æ¸…é™¤ç¯©é¸
                            </button>
                            <button onClick={() => setShowFilter(false)} className="text-xs font-medium text-[#333] px-3 py-1.5 border border-gray-200 rounded hover:bg-gray-50">æ”¶èµ·</button>
                        </div>
                    </div>
                )}

                {/* å¹´æœˆé¸æ“‡ (åªæœ‰åœ¨æ²’æœå°‹æ™‚é¡¯ç¤º) */}
                {!filters.noteKeyword && (
                    <div className="flex justify-between items-center">
                        <div className="flex gap-2">
                             <div className="relative">
                                <select value={currentYear} onChange={(e) => setCurrentYear(Number(e.target.value))} className="appearance-none bg-white border border-gray-200 text-[#333] text-sm py-1.5 pl-3 pr-8 rounded focus:outline-none font-medium">
                                    {Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i).map(y => <option key={y} value={y}>{y}å¹´</option>)}
                                </select>
                                <Icon name="chevronDown" size={12} className="absolute right-2 top-3 text-gray-500 pointer-events-none"/>
                            </div>
                            <div className="relative">
                                <select value={currentMonth} onChange={(e) => setCurrentMonth(Number(e.target.value))} className="appearance-none bg-white border border-gray-200 text-[#333] text-sm py-1.5 pl-3 pr-8 rounded focus:outline-none font-medium">
                                    {Array.from({length: 12}, (_, i) => i + 1).map(m => <option key={m} value={m}>{m}æœˆ</option>)}
                                </select>
                                <Icon name="chevronDown" size={12} className="absolute right-2 top-3 text-gray-500 pointer-events-none"/>
                            </div>
                        </div>
                        <div className="flex bg-[#EAEAEA] p-0.5 rounded-lg">
                            <button onClick={() => { setViewMode('list'); if(triggerHaptic) triggerHaptic(); }} className={`p-1.5 rounded-md transition ${viewMode === 'list' ? 'bg-white shadow text-[#333]' : 'text-gray-400'}`}><Icon name="list" size={14}/></button>
                            <button onClick={() => { setViewMode('calendar'); if(triggerHaptic) triggerHaptic(); }} className={`p-1.5 rounded-md transition ${viewMode === 'calendar' ? 'bg-white shadow text-[#333]' : 'text-gray-400'}`}><Icon name="calendar" size={14}/></button>
                            <button onClick={() => { setViewMode('chart'); if(triggerHaptic) triggerHaptic(); }} className={`p-1.5 rounded-md transition ${viewMode === 'chart' ? 'bg-white shadow text-[#333]' : 'text-gray-400'}`}><Icon name="pieChart" size={14}/></button>
                        </div>
                    </div>
                )}
            </div>

            {/* Content Area */}
            <div className="flex-1 overflow-y-auto no-scrollbar space-y-4 pb-20">
                {(viewMode === 'list' || filters.noteKeyword) && (
                    <>
                        {groupedTransactions.length > 0 ? (
                            <>
                                {groupedTransactions.map(([date, txs]) => (
                                    <div key={date}>
                                        <div className="text-xs text-gray-400 mb-2 font-medium sticky top-0 bg-[#F5F5F3] py-1 z-10">{date}</div>
                                        <div className="space-y-3">
                                            {txs.map(t => <TransactionCard key={t.id} transaction={t} onClick={() => { if(triggerHaptic) triggerHaptic(); onEditTransaction(t); }} />)}
                                        </div>
                                    </div>
                                ))}
                                
                                {/* è¼‰å…¥æ›´å¤šæŒ‰éˆ• (å„ªåŒ–æ•ˆèƒ½ç”¨) */}
                                {paginatedTransactions.length < displayTransactions.length && (
                                    <button 
                                        onClick={() => setPage(p => p + 1)}
                                        className="w-full py-3 text-xs text-gray-400 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition"
                                    >
                                        é¡¯ç¤ºæ›´å¤šäº¤æ˜“ ({displayTransactions.length - paginatedTransactions.length} ç­†)
                                    </button>
                                )}
                            </>
                        ) : (
                            <div className="text-center py-20 text-gray-400 text-sm font-light">
                                <span className="text-4xl block mb-2">{filters.noteKeyword ? 'ğŸ”' : 'ğŸƒ'}</span>
                                {filters.noteKeyword ? 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„äº¤æ˜“' : 'æœ¬æœˆç„¡äº¤æ˜“ç´€éŒ„'}
                            </div>
                        )}
                    </>
                )}
                
                {/* æ—¥æ›†æ¨¡å¼ (çœç•¥é‡è¤‡ä»£ç¢¼ï¼Œè«‹ç›´æ¥ä½¿ç”¨åŸæœ¬çš„æ—¥æ›† JSX) */}
                {viewMode === 'calendar' && !filters.noteKeyword && (
                    <div className="animate-fade-in">
                        {/* ... è«‹è²¼ä¸ŠåŸæœ¬çš„æ—¥æ›† JSX ... */}
                        {/* é€™è£¡ç°¡å–®ç¤ºæ„ï¼Œè¨˜å¾—æŠŠåŸæœ¬çš„æ—¥æ›†ä»£ç¢¼æ”¾å›ä¾† */}
                         <div className="grid grid-cols-7 text-center mb-2">{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => <div key={d} className="text-[10px] text-gray-400">{d}</div>)}</div>
                        <div className="grid grid-cols-7 gap-1 auto-rows-[60px]">
                            {calendarData.map((cell, idx) => {
                                if (!cell) return <div key={`empty-${idx}`}></div>;
                                const isSelected = selectedDate === cell.dateStr;
                                return (
                                    <div key={cell.dateStr} onClick={() => setSelectedDate(cell.dateStr)} className={`rounded border flex flex-col items-center justify-start pt-1 cursor-pointer transition relative ${isSelected ? 'bg-white border-[#333] shadow-md z-10' : 'bg-white border-transparent hover:border-gray-200'}`}>
                                        <span className={`text-xs mb-0.5 ${cell.day === new Date().getDate() && currentMonth === new Date().getMonth()+1 ? 'bg-[#333] text-white w-5 h-5 rounded-full flex items-center justify-center' : 'text-gray-600'}`}>{cell.day}</span>
                                        {cell.expense > 0 && <span className="text-[9px] text-[#333] font-medium">-{formatMoney(cell.expense)}</span>}
                                        {cell.income > 0 && <span className="text-[9px] text-[#5CB85C] font-medium">+{formatMoney(cell.income)}</span>}
                                        {!cell.hasData && isSelected && <div className="w-1 h-1 bg-gray-300 rounded-full mt-1"></div>}
                                    </div>
                                );
                            })}
                        </div>
                        {selectedDate && (
                            <div className="mt-6 border-t border-gray-200 pt-4 animate-slide-up">
                                <div className="text-xs text-gray-400 mb-3 font-medium flex justify-between"><span>{selectedDate} çš„äº¤æ˜“</span><button onClick={() => setSelectedDate(null)} className="text-[#333]"><Icon name="close" size={12}/></button></div>
                                <div className="space-y-3">{transactions.filter(t => t.date === selectedDate).length > 0 ? transactions.filter(t => t.date === selectedDate).map(t => <TransactionCard key={t.id} transaction={t} onClick={() => onEditTransaction(t)} />) : <div className="text-center text-xs text-gray-400 py-4">æœ¬æ—¥ç„¡äº¤æ˜“</div>}</div>
                            </div>
                        )}
                    </div>
                )}

                {/* åœ–è¡¨æ¨¡å¼ (ä¿æŒä¸è®Š) */}
                {viewMode === 'chart' && !filters.noteKeyword && <LocalChartAnalysis transactions={displayTransactions} categories={categories} />}
            </div>
        </div>
    );
};

// ==========================================
// â˜… å‡ç´šç‰ˆ StatsView (é ç®—å„€è¡¨æ¿ + äº’å‹•åœ–è¡¨)
// ==========================================
const StatsView = () => {
    const { transactions, categories } = React.useContext(DataContext);
    const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, AreaChart, Area, XAxis, YAxis, CartesianGrid } = window.Recharts || {};
    
    // UI State
    const [tab, setTab] = useState('trend'); // 'trend'(è¶¨å‹¢) | 'budget'(é ç®—) | 'category'(åˆ†é¡)
    const [currentMonth, setCurrentMonth] = useState(new Date().getMonth() + 1);
    const [activeIndex, setActiveIndex] = useState(0); // åœ“é¤…åœ–äº’å‹•ç´¢å¼•

    // --- è³‡æ–™è¨ˆç®— 1: é ç®—åˆ†æ (Budget Data) ---
    const budgetData = useMemo(() => {
        const currentYear = new Date().getFullYear();
        const yearMonthPrefix = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
// 1. ç¯©é¸æœ¬æœˆæ”¯å‡º (æ’é™¤ä»£è³¼)
        const monthlyTx = transactions.filter(t => t.type === 'expense' && t.date.startsWith(yearMonthPrefix) && !(t.tags || []).includes('#ä»£è³¼'));

        // 2. ä¾åˆ†é¡çµ±è¨ˆ
        const map = {};
        categories.expense.forEach(c => {
            map[c.id] = { 
                name: c.name, 
                budget: c.budget || 0, 
                spent: 0, 
                color: c.color,
                icon: c.iconKey 
            };
        });

        monthlyTx.forEach(t => {
            if (map[t.categoryId]) {
                map[t.categoryId].spent += ((t.splitMyShare !== undefined ? t.splitMyShare : t.amount));
            }
        });

        // 3. è½‰æ›ç‚ºé™£åˆ—ä¸¦æ’åº (å„ªå…ˆé¡¯ç¤ºæœ‰è¨­å®šé ç®—æˆ–æœ‰èŠ±è²»çš„)
        return Object.values(map)
            .filter(d => d.budget > 0 || d.spent > 0)
            .sort((a, b) => {
                // æ’åºé‚è¼¯ï¼šè¶…æ”¯çš„æ’æœ€ä¸Šé¢ > é ç®—é«˜çš„æ’ä¸Šé¢
                const aRatio = a.budget > 0 ? a.spent / a.budget : 0;
                const bRatio = b.budget > 0 ? b.spent / b.budget : 0;
                return bRatio - aRatio; 
            });
    }, [transactions, currentMonth, categories]);

    // --- è³‡æ–™è¨ˆç®— 2: åœ“é¤…åœ– (Interactive Pie) ---
    const pieData = useMemo(() => {
        const currentYear = new Date().getFullYear();
        const yearMonthPrefix = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
        const filtered = transactions.filter(t => t.type === 'expense' && t.date.startsWith(yearMonthPrefix) && !(t.tags || []).includes('#ä»£è³¼'));
        const map = {};
        filtered.forEach(t => {
            const cat = categories.expense.find(c => c.id === t.categoryId);
            const name = cat ? cat.name : 'å…¶ä»–';
            if (!map[name]) map[name] = { name, value: 0, color: cat ? cat.color : '#ccc' };
            map[name].value += ((t.splitMyShare !== undefined ? t.splitMyShare : t.amount));
        });
        return Object.values(map).sort((a,b) => b.value - a.value);
    }, [transactions, currentMonth, categories]);

    // --- è³‡æ–™è¨ˆç®— 3: æ¯æ—¥è¶¨å‹¢ (Area Chart) ---
    const dailyData = useMemo(() => {
        const currentYear = new Date().getFullYear();
        const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
        const data = [];
        
        for(let i=1; i<=daysInMonth; i++) {
            const dateStr = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const dailyExp = transactions
                .filter(t => t.date === dateStr && t.type === 'expense' && !(t.tags || []).includes('#ä»£è³¼'))
                .reduce((sum, t) => sum + ((t.splitMyShare !== undefined ? t.splitMyShare : t.amount)), 0);
            data.push({ day: i, amount: dailyExp });
        }
        return data;
    }, [transactions, currentMonth]);

    // åœ“é¤…åœ–äº’å‹•ç‰¹æ•ˆ (Recharts RenderShape)
    const renderActiveShape = (props) => {
        const { cx, cy, innerRadius, outerRadius, startAngle, endAngle, fill, payload, value } = props;
        return (
            <g>
                <text x={cx} y={cy-10} dy={8} textAnchor="middle" fill={fill} className="text-sm font-bold">{payload.name}</text>
                <text x={cx} y={cy+10} dy={8} textAnchor="middle" fill="#999" className="text-xs">
                    ${value.toLocaleString()}
                </text>
                <path d={window.Recharts.Sector.renderSector({cx, cy, innerRadius, outerRadius: outerRadius + 6, startAngle, endAngle}).d} fill={fill} />
            </g>
        );
    };

    if (!PieChart) return <div className="text-center py-10 text-gray-400">è¼‰å…¥åœ–è¡¨ä¸­...</div>;

    return (
        <div className="h-full flex flex-col pt-10 px-6 pb-0 animate-fade-in">
            <div className="shrink-0 mb-4">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-medium text-[#333] tracking-wide">çµ±è¨ˆåˆ†æ</h2>
                    <div className="flex bg-gray-100 dark:bg-[#40444B] p-1 rounded-lg">
                        <button onClick={() => setTab('trend')} className={`px-3 py-1.5 text-xs rounded-md transition ${tab === 'trend' ? 'bg-white dark:bg-[#2B2D30] shadow text-[#333] dark:text-white' : 'text-gray-400'}`}>è¶¨å‹¢</button>
                        <button onClick={() => setTab('category')} className={`px-3 py-1.5 text-xs rounded-md transition ${tab === 'category' ? 'bg-white dark:bg-[#2B2D30] shadow text-[#333] dark:text-white' : 'text-gray-400'}`}>åœ“é¤…</button>
                        <button onClick={() => setTab('budget')} className={`px-3 py-1.5 text-xs rounded-md transition ${tab === 'budget' ? 'bg-white dark:bg-[#2B2D30] shadow text-[#333] dark:text-white' : 'text-gray-400'}`}>é ç®—</button>
                    </div>
                </div>
                
                {/* æœˆä»½åˆ‡æ› Bar */}
                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                    {Array.from({length: 12}, (_, i) => i + 1).map(m => (
                        <button 
                            key={m} 
                            onClick={() => { setCurrentMonth(m); setActiveIndex(0); }} 
                            className={`text-xs px-3.5 py-1.5 rounded-full border transition whitespace-nowrap 
                                ${currentMonth === m 
                                    ? 'bg-[#333] text-white border-[#333] shadow-md dark:bg-white dark:text-black' 
                                    : 'bg-white text-gray-400 border-gray-200 dark:bg-[#36393F] dark:border-gray-600'}`
                            }
                        >
                            {m}æœˆ
                        </button>
                    ))}
                </div>
            </div>

            <div className="flex-1 overflow-y-auto no-scrollbar pb-24">
                
                {/* === Tab 1: æ¯æ—¥è¶¨å‹¢ (Area Chart) === */}
                {tab === 'trend' && (
                    <div className="animate-fade-in space-y-4">
                        <Card className="h-64 pt-6 pr-4">
                            <h3 className="text-xs text-gray-400 uppercase tracking-widest absolute top-4 left-4">æ¯æ—¥æ”¯å‡ºæ›²ç·š</h3>
                            <ResponsiveContainer width="100%" height="100%">
                                <AreaChart data={dailyData}>
                                    <defs>
                                        <linearGradient id="colorExp" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor="#333" stopOpacity={0.1}/>
                                            <stop offset="95%" stopColor="#333" stopOpacity={0}/>
                                        </linearGradient>
                                    </defs>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f0f0f0" />
                                    <XAxis dataKey="day" axisLine={false} tickLine={false} tick={{fill: '#999', fontSize: 10}} minTickGap={10}/>
                                    <YAxis axisLine={false} tickLine={false} tick={{fill: '#999', fontSize: 10}} width={35}/>
                                    <Tooltip 
                                        contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)'}}
                                        formatter={(value) => `$${value}`}
                                        labelFormatter={(label) => `${currentMonth}æœˆ${label}æ—¥`}
                                    />
                                    <Area type="monotone" dataKey="amount" stroke="#333" fillOpacity={1} fill="url(#colorExp)" strokeWidth={2} />
                                </AreaChart>
                            </ResponsiveContainer>
                        </Card>
                        
                        <div className="grid grid-cols-2 gap-3">
                            <div className="bg-white dark:bg-[#36393F] p-4 rounded border border-gray-100 dark:border-gray-700">
                                <div className="text-xs text-gray-400 mb-1">æœ¬æœˆç¸½æ”¯å‡º</div>
                                <div className="text-xl font-medium text-[#333] dark:text-white">
                                    ${pieData.reduce((a,b)=>a+b.value, 0).toLocaleString()}
                                </div>
                            </div>
                            <div className="bg-white dark:bg-[#36393F] p-4 rounded border border-gray-100 dark:border-gray-700">
                                <div className="text-xs text-gray-400 mb-1">å¹³å‡æ—¥æ”¯å‡º</div>
                                <div className="text-xl font-medium text-[#333] dark:text-white">
                                    ${Math.round(pieData.reduce((a,b)=>a+b.value, 0) / new Date().getDate()).toLocaleString()}
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {/* === Tab 2: åœ“é¤…åˆ†é¡ (Interactive Pie) === */}
                {tab === 'category' && (
                    <div className="animate-fade-in">
                        <Card className="flex flex-col items-center pt-2 pb-6 min-h-[300px]">
                            {pieData.length > 0 ? (
                                <div className="h-64 w-full relative">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie 
                                                activeIndex={activeIndex}
                                                activeShape={renderActiveShape}
                                                data={pieData} 
                                                innerRadius={65} 
                                                outerRadius={85} 
                                                paddingAngle={3} 
                                                dataKey="value" 
                                                onClick={(_, index) => setActiveIndex(index)}
                                                onMouseEnter={(_, index) => setActiveIndex(index)}
                                            >
                                                {pieData.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.color} />)}
                                            </Pie>
                                        </PieChart>
                                    </ResponsiveContainer>
                                </div>
                            ) : (
                                <div className="flex flex-col items-center justify-center h-64 text-gray-400 opacity-50">
                                    <Icon name="pieChart" size={48} className="mb-2"/>
                                    <span className="text-xs">ç„¡æ”¯å‡ºè³‡æ–™</span>
                                </div>
                            )}
                        </Card>
                        
                        {/* åˆ†é¡åˆ—è¡¨ (é¡¯ç¤ºå‰ 5 å) */}
                        <div className="mt-4 space-y-3">
                            {pieData.map((d, idx) => (
                                <div 
                                    key={d.name} 
                                    onClick={() => { setActiveIndex(idx); window.scrollTo({top:0, behavior:'smooth'}); }}
                                    className={`flex justify-between items-center text-sm p-3 rounded border transition cursor-pointer
                                        ${idx === activeIndex 
                                            ? 'bg-white dark:bg-[#36393F] border-gray-300 dark:border-gray-500 shadow-sm' 
                                            : 'border-transparent hover:bg-white dark:hover:bg-[#36393F]'}`}
                                >
                                    <div className="flex items-center gap-3">
                                        <div className="w-2.5 h-2.5 rounded-full" style={{backgroundColor: d.color}}></div>
                                        <span className="text-gray-600 dark:text-gray-300">{d.name}</span>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <span className="font-medium text-[#333] dark:text-white">${d.value.toLocaleString()}</span>
                                        <span className="text-xs text-gray-400 w-8 text-right">{Math.round((d.value / pieData.reduce((a,b)=>a+b.value,0)) * 100)}%</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {/* === Tab 3: é ç®—åˆ†æ (Bullet Graph) === */}
                {tab === 'budget' && (
                    <div className="animate-fade-in space-y-4">
                        {budgetData.length > 0 ? budgetData.map(item => {
                            // è¨ˆç®—é‚è¼¯
                            const hasBudget = item.budget > 0;
                            const percentage = hasBudget ? Math.min((item.spent / item.budget) * 100, 100) : 0;
                            const isOverBudget = hasBudget && item.spent > item.budget;
                            const remaining = item.budget - item.spent;
                            
                            // é¡è‰²é‚è¼¯ï¼šç¶ è‰²(å®‰å…¨) -> é»ƒè‰²(è­¦å‘Š) -> ç´…è‰²(å±éšª)
                            let barColor = 'bg-[#5CB85C]';
                            if (percentage > 80) barColor = 'bg-yellow-400';
                            if (percentage >= 100) barColor = 'bg-[#D9534F]';
                            
                            // ç„¡é ç®—æ™‚é¡¯ç¤ºç°è‰²
                            if (!hasBudget) barColor = 'bg-gray-400';

                            return (
                                <div key={item.name} className="bg-white dark:bg-[#36393F] p-4 rounded border border-gray-100 dark:border-gray-700 shadow-sm">
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex items-center gap-3">
                                            <div className="w-8 h-8 rounded-full bg-gray-50 dark:bg-gray-700 flex items-center justify-center text-gray-500 dark:text-gray-300">
                                                <Icon name={item.icon || 'more'} size={16} />
                                            </div>
                                            <div>
                                                <div className="text-sm font-medium text-[#333] dark:text-white">{item.name}</div>
                                                <div className="text-[10px] text-gray-400">
                                                    {hasBudget 
                                                        ? (isOverBudget ? `å·²è¶…æ”¯ $${Math.abs(remaining).toLocaleString()}` : `å‰©é¤˜ $${remaining.toLocaleString()}`)
                                                        : 'æœªè¨­å®šé ç®—'}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className={`text-sm font-bold ${isOverBudget ? 'text-[#D9534F]' : 'text-[#333] dark:text-white'}`}>
                                                ${item.spent.toLocaleString()}
                                            </div>
                                            {hasBudget && <div className="text-[10px] text-gray-400"> / ${item.budget.toLocaleString()}</div>}
                                        </div>
                                    </div>

                                    {/* é€²åº¦æ¢å®¹å™¨ */}
                                    <div className="relative h-2.5 w-full bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                        {/* å¯¦éš›é€²åº¦ */}
                                        <div 
                                            className={`absolute top-0 left-0 h-full rounded-full transition-all duration-1000 ${barColor}`} 
                                            style={{ width: `${percentage}%` }}
                                        ></div>
                                        
                                        {/* è¶…æ”¯éƒ¨åˆ† (æ–‘é¦¬ç´‹) */}
                                        {isOverBudget && (
                                            <div className="absolute top-0 left-0 h-full w-full bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNCIgaGVpZ2h0PSI0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0tMSwxIGwyLC0yIE0wLDQgbDQsLTQgTTMsNSBsMiwtMiIgc3Ryb2tlPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMykiIHN0cm9rZS13aWR0aD0iMSIvPjwvc3ZnPg==')] opacity-30"></div>
                                        )}
                                    </div>
                                    
                                    {/* ç™¾åˆ†æ¯”æ¨™ç¤º */}
                                    {hasBudget && (
                                        <div className="mt-1 flex justify-end">
                                            <span className={`text-[9px] font-bold ${percentage >= 100 ? 'text-[#D9534F]' : 'text-gray-400'}`}>
                                                {Math.round((item.spent / item.budget) * 100)}%
                                            </span>
                                        </div>
                                    )}
                                </div>
                            );
                        }) : (
                            <div className="text-center py-20 text-gray-400 text-sm">æœ¬æœˆå°šç„¡æ”¯å‡ºè³‡æ–™</div>
                        )}
                        
                        <div className="text-center mt-6">
                            <button onClick={() => setTab('trend')} className="text-xs text-gray-400 underline">æŸ¥çœ‹è¶¨å‹¢åœ–</button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};
                const TransactionModal = ({ onClose, onSave, onDelete, accounts, categories, initialData }) => {
                const { transactions, triggerHaptic, setRecurringItems, showAlert } = React.useContext(DataContext);            // â˜… ä¿®æ­£ 3ï¼šè£œä¸Š setRecurringItems ä¾†å¯«å…¥åˆ†æœŸè¨ˆç•«
            // â˜… æ–°å¢ï¼šåˆ†æœŸä»˜æ¬¾ç‹€æ…‹èˆ‡éŠ€è¡Œç´šå¾®èª¿
                const [isInstallment, setIsInstallment] = useState(false);
                const [installPeriods, setInstallPeriods] = useState(3);
                const [customPeriodAmount, setCustomPeriodAmount] = useState('');
                const [remainderAdjust, setRemainderAdjust] = useState('last'); // é è¨­å°‡é¤˜é¡ä½µå…¥æœ€å¾Œä¸€æœŸ

            // æµç¨‹å®šç¾©: 
            // 1=åˆ†é¡/è½‰å‡º, 1.5=ç´°é …, 2=ä»˜æ¬¾äºº(æ”¯å‡º)/è½‰å…¥/å­˜å…¥å¸³æˆ¶(æ”¶å…¥), 3=æ‰£æ¬¾å¸³æˆ¶(æ”¯å‡º), 4=é‡‘é¡
            const [step, setStep] = useState(initialData ? 4 : 1);
            const [type, setType] = useState(initialData ? initialData.type : 'expense');
            
            const [selectedCatId, setSelectedCatId] = useState(initialData ? initialData.categoryId : null);
            const [selectedSubCatId, setSelectedSubCatId] = useState(initialData ? initialData.subCategoryId : null);
            const [selectedAcc, setSelectedAcc] = useState(initialData ? initialData.accountId : accounts[0]?.id);
            const [targetAcc, setTargetAcc] = useState(initialData ? (initialData.targetAccountId || accounts[1]?.id) : accounts[1]?.id);
            
            // splitMode: 'none'=å€‹äºº, 'me'=æˆ‘å¢Š, 'other'=å°æ–¹å¢Š
            const [splitMode, setSplitMode] = useState(initialData ? (initialData.payer === 'other' ? 'other' : (initialData.tags?.includes('#ä»£è³¼') ? 'advance' : (initialData.tags?.includes('#åˆ†å¸³') ? 'me' : 'none'))) : 'none');            
            const [amountStr, setAmountStr] = useState(initialData ? initialData.amount.toString() : '0');
            const [date, setDate] = useState(initialData ? initialData.date : getLocalDateString());
            const [note, setNote] = useState(initialData ? initialData.note : '');
            const [menuPage, setMenuPage] = useState(0);
            // â˜… æ–°å¢ OCR ç›¸é—œç‹€æ…‹
            const [isScanning, setIsScanning] = useState(false);
            const fileInputRef = useRef(null);
// â˜… ä¿®æ­£ï¼šå®‰å…¨è§£æç›®å‰çš„è¼¸å…¥é‡‘é¡ (è§£æ±º amount æ‰¾ä¸åˆ°çš„å´©æ½°å•é¡Œï¼Œä¸¦æ”¯æ´ç®—å¼å¦‚ 50+20)
            const currentParsedAmount = useMemo(() => {
                try {
                    let evalStr = amountStr;
                    if (['+','-','*','/'].includes(evalStr.slice(-1))) evalStr = evalStr.slice(0, -1);
                    return new Function('return ' + evalStr)() || 0;
                } catch (e) { return 0; }
            }, [amountStr]);
            // â˜… ä¿®æ”¹ 2ï¼šæ™ºæ…§æ’åºé‚è¼¯
            // æ ¹æ“šæœ€è¿‘ 50 ç­†äº¤æ˜“ï¼Œè¨ˆç®—å¸³æˆ¶ä½¿ç”¨é »ç‡ï¼Œå¸¸ç”¨çš„æ’å‰é¢
            const sortedAccounts = useMemo(() => {
                if (!transactions || transactions.length === 0) return accounts;

                // 1. çµ±è¨ˆåˆ†æ•¸
                const scores = {};
                // å–æœ€è¿‘ 50 ç­†å³å¯ï¼Œåæ‡‰è¿‘æœŸç¿’æ…£
                const recentTx = transactions.slice(0, 50);
                
                recentTx.forEach(tx => {
                    // è½‰å‡º/æ‰£æ¬¾/å­˜å…¥å¸³æˆ¶ +1 åˆ†
                    if (tx.accountId) scores[tx.accountId] = (scores[tx.accountId] || 0) + 1;
                    // è½‰å…¥å¸³æˆ¶ +1 åˆ†
                    if (tx.targetAccountId) scores[tx.targetAccountId] = (scores[tx.targetAccountId] || 0) + 1;
                });

                // 2. é€²è¡Œæ’åº (åˆ†æ•¸é«˜è€…åœ¨å‰ï¼Œåˆ†æ•¸ç›¸åŒç¶­æŒåŸé †åº)
                return [...accounts].sort((a, b) => {
                    const scoreA = scores[a.id] || 0;
                    const scoreB = scores[b.id] || 0;
                    if (scoreB !== scoreA) return scoreB - scoreA;
                    // å¦‚æœé »ç‡ä¸€æ¨£ï¼Œä¾ç…§åŸæœ¬çš„è‡ªè¨‚é †åº (sortOrder)
                    return (a.sortOrder || 0) - (b.sortOrder || 0);
                });
            }, [accounts, transactions]);
            // â˜… æ–°å¢ï¼šåˆ†é¡æ™ºæ…§æ’åºé‚è¼¯ (å‹•æ…‹å¸¸ç”¨æ’åº)
            // æ ¹æ“šæœ€è¿‘ 50 ç­†äº¤æ˜“ï¼ŒæŠŠæœ€å¸¸ç”¨çš„åˆ†é¡ç§»åˆ°æ‰‡å½¢é¸å–®æœ€å‰é¢
            const sortedCategories = useMemo(() => {
                if (!transactions || transactions.length === 0) return categories;

                const scores = {};
                // å–æœ€è¿‘ 50 ç­†ä¾†åˆ†æè¿‘æœŸçš„æ¶ˆè²»ç¿’æ…£
                const recentTx = transactions.slice(0, 50);
                
                recentTx.forEach(tx => {
                    if (tx.categoryId) {
                        scores[tx.categoryId] = (scores[tx.categoryId] || 0) + 1;
                    }
                });

                // æ’åºå‡½å¼ï¼šåˆ†æ•¸é«˜çš„æ’å‰é¢
                const sortList = (list) => [...list].sort((a, b) => {
                    const scoreA = scores[a.id] || 0;
                    const scoreB = scores[b.id] || 0;
                    return scoreB - scoreA;
                });

                return {
                    expense: sortList(categories.expense),
                    income: sortList(categories.income)
                };
            }, [categories, transactions]);

            // åˆ‡æ›é¡å‹æ™‚é‡ç½®
            useEffect(() => { 
                setMenuPage(0);
                if (type !== 'transfer' && !selectedCatId && !initialData) { 
                    const pool = type === 'expense' ? categories.expense : categories.income; 
                    if (pool.length > 0) setSelectedCatId(pool[0].id); 
                }
            }, [type]);

            const handleNumPad = (val) => {
                if (typeof triggerHaptic === 'function') { try { triggerHaptic(); } catch(e) {} }

                if (val === 'AC') {
                    setAmountStr('0');
                } else if (val === 'back') {
                    setAmountStr(prev => prev.length > 1 ? prev.slice(0, -1) : '0');
                } else if (val === 'OK') {
                    let amount = 0;
                    try {
                        let evalStr = amountStr;
                        if (['+','-','*','/'].includes(evalStr.slice(-1))) evalStr = evalStr.slice(0, -1);
                        amount = new Function('return ' + evalStr)();
                    } catch (e) { amount = 0; }

                    if (!amount || isNaN(amount) || amount <= 0) return;
                    
                    let finalTags = initialData ? [...(initialData.tags || [])] : [];
                    // â˜… ä¿®æ­£ï¼šæ¸…é™¤æ¨™ç±¤æ™‚æŠŠ #ä»£è³¼ ä¹Ÿæ¸…æ‰ï¼Œé¿å…ç·¨è¼¯æ™‚æ®˜ç•™
                    finalTags = finalTags.filter(t => t !== '#ä»£å¢Š' && t !== '#åˆ†å¸³' && t !== '#æ‡‰ä»˜' && t !== '#ä»£è³¼');

                    if (type === 'expense') { 
                        if (splitMode === 'me') finalTags.push('#åˆ†å¸³');
                        if (splitMode === 'advance') finalTags.push('#ä»£è³¼'); 
                        if (splitMode === 'other') finalTags.push('#æ‡‰ä»˜'); 
                    }

                const currentAcc = accounts.find(a => a.id === selectedAcc);
                    if (isInstallment && currentAcc?.type === 'liability' && type === 'expense' && !initialData) {
                        
                        // â˜… è¨ˆç®—æ¯æœŸèˆ‡é¤˜é¡åˆ†é…
                        const pAmt = customPeriodAmount ? Number(customPeriodAmount) : Math.round(amount / installPeriods);
                        let firstPeriodAmount = pAmt;
                        let regularAmount = pAmt;
                        let lastPeriodAmount = pAmt;

                        if (remainderAdjust === 'first') {
                            firstPeriodAmount = amount - (pAmt * (installPeriods - 1));
                            lastPeriodAmount = pAmt;
                        } else {
                            firstPeriodAmount = pAmt;
                            lastPeriodAmount = amount - (pAmt * (installPeriods - 1)); // å°‡èª¤å·®å…¨æ•¸å€’çµ¦æœ€å¾Œä¸€æœŸ
                        }

                        const baseDate = new Date(date);
                        const planId = 'rec_' + Date.now().toString(); 
                        
                        // 1. å„²å­˜ç¬¬ä¸€æœŸ (ä½¿ç”¨ç®—å¥½çš„é¦–æœŸé‡‘é¡)
                        onSave({
                            id: Date.now().toString(),
                            date, amount: firstPeriodAmount, type,
                            categoryId: selectedCatId, subCategoryId: selectedSubCatId,
                            accountId: selectedAcc, targetAccountId: null,
                            note: `${note || currentCat?.name || 'æ¶ˆè²»'} (1/${installPeriods}æœŸ)`,
                            tags: [...finalTags, '#åˆ†æœŸ'], payer: splitMode,
                            recurringId: planId 
                        });

                        // 2. å»ºç«‹é€±æœŸè¨­å®š (ç´€éŒ„å¸¸è¦é‡‘é¡èˆ‡ç‰¹æ®Šæœ«æœŸé‡‘é¡)
                        const newRecurring = {
                            id: planId, 
                            type: 'expense',
                            name: `${note || currentCat?.name || 'æ¶ˆè²»'} (åˆ†æœŸ)`,
                            amount: regularAmount,
                            lastPeriodAmount: lastPeriodAmount !== regularAmount ? lastPeriodAmount : null, // â˜… ç´€éŒ„ç‰¹æ®Šæœ«æœŸ
                            interest: 0, 
                            day: baseDate.getDate(),
                            accountId: selectedAcc,
                            categoryId: selectedCatId,
                            subCategoryId: selectedSubCatId,
                            startDate: `${baseDate.getFullYear()}-${String(baseDate.getMonth() + 1).padStart(2, '0')}`,
                            totalPeriods: installPeriods,
                            executedPeriods: 1, 
                            active: true,
                            lastGeneratedMonth: `${baseDate.getFullYear()}-${String(baseDate.getMonth() + 1).padStart(2, '0')}`
                        };
                setRecurringItems(prev => [...prev, newRecurring]);
                        
                        if(triggerHaptic) triggerHaptic(30);
                        showAlert('åˆ†æœŸè¨­å®šæˆåŠŸ', `å·²è¨˜ä¸‹é¦–æœŸ $${firstPeriodAmount}ã€‚\n\nå¾ŒçºŒå°‡è‡ªå‹•ç”¢ç”Ÿ ${installPeriods - 1} æœŸï¼Œ\næ¯æœŸ $${regularAmount}${lastPeriodAmount !== regularAmount ? ` (æœ«æœŸ $${lastPeriodAmount})` : ''}ï¼`);
                    } else {
                      // ä¸€èˆ¬å„²å­˜
                        onSave({ 
                            id: initialData ? initialData.id : Date.now().toString(), 
                            date, amount, type, 
                            categoryId: type === 'transfer' ? 'transfer' : selectedCatId, 
                            subCategoryId: type === 'transfer' ? null : selectedSubCatId, 
                            accountId: (type === 'expense' && splitMode === 'other') ? accounts[0].id : selectedAcc, 
                            targetAccountId: type === 'transfer' ? targetAcc : null, 
                            note, tags: finalTags, payer: splitMode,
                            recurringId: initialData ? initialData.recurringId : undefined // â˜… ç·¨è¼¯æ™‚å¿…é ˆç¹¼æ‰¿é—œè¯ï¼Œä¸å¯å¼„ä¸Ÿ
                        });
                    }
                } else {

                    if (['+','-','*','/'].includes(val) && ['+','-','*','/'].includes(amountStr.slice(-1))) return;
                    if (val === '.' && amountStr.split(/[+\-*/]/).pop().includes('.')) return;
                    setAmountStr(prev => (prev === '0' || prev === 'Error') && !['+','-','*','/','.'].includes(val) ? val : prev + val);
                }
            };
            // ==========================================
            // â˜… æ–°å¢ï¼šåœ–ç‰‡é è™•ç†å¼•æ“ (æ¥µé€Ÿå£“ç¸®ã€ç°éšã€é«˜å°æ¯”)
            // ==========================================
            const preprocessImage = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');

                            // é™åˆ¶æœ€å¤§é•·å¯¬ç‚º 1000px (å¤§å¹…æå‡æ‰‹æ©Ÿè§£æé€Ÿåº¦)
                            const MAX_DIM = 1000;
                            let width = img.width;
                            let height = img.height;

                            if (width > height && width > MAX_DIM) {
                                height *= MAX_DIM / width;
                                width = MAX_DIM;
                            } else if (height > MAX_DIM) {
                                width *= MAX_DIM / height;
                                height = MAX_DIM;
                            }

                            canvas.width = width;
                            canvas.height = height;

                            // ç¹ªè£½ä¸¦åŠ ä¸Šæ¿¾é¡ï¼šç´”ç°éš + 1.2å€å°æ¯”åº¦ (å»é™¤é™°å½±ï¼Œè®“æ–‡å­—æ›´éŠ³åˆ©)
                            ctx.filter = 'grayscale(100%) contrast(1.2)';
                            ctx.drawImage(img, 0, 0, width, height);

                            // è¼¸å‡ºå£“ç¸®å¾Œçš„å°æª”æ¡ˆ (å“è³ª 0.8)
                            canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.8);
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };
            // ==========================================
            // â˜… å‡ç´šç‰ˆ 7.0ï¼šæ¥µé€ŸèƒŒæ™¯ OCR æƒæé‚è¼¯
            // ==========================================
            const handleOCRScan = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // 1. ç¬é–“è·³è½‰åˆ°æ•¸å­—ç•«é¢
                setType('expense');
                setSplitMode('none');
                if (!selectedCatId) setSelectedCatId(categories.expense[0]?.id);
                if (!selectedAcc) setSelectedAcc(accounts[0]?.id);
                setStep(4);
                setIsScanning(true);

                // 2. ä¸Ÿåˆ°èƒŒæ™¯åŸ·è¡Œ
                (async () => {
                    try {
                        // â˜… æ ¸å¿ƒå„ªåŒ– 1ï¼šå…ˆå£“ç¸®èˆ‡å¼·åŒ–åœ–ç‰‡
                        const processedBlob = await preprocessImage(file);

                        const worker = await Tesseract.createWorker('chi_tra+eng');
                        // é€å‡ºçš„æ˜¯ã€Œå£“ç¸®éçš„é»‘ç™½åœ–ç‰‡ã€ï¼Œé€Ÿåº¦é£›å¿«ï¼
                        const { data: { text } } = await worker.recognize(processedBlob);
                        await worker.terminate();

                        let finalAmount = 0;
                        
                        // â˜… æ ¸å¿ƒå„ªåŒ– 2ï¼šå…ˆå»é™¤æ‰€æœ‰ç©ºç™½ï¼(è§£æ±ºã€Œç¸½ è¨ˆã€è¢«æ–·å­—çš„èª¤åˆ¤å•é¡Œ)
                        const cleanTextForAmount = text.replace(/\s+/g, '');

                        // --- ç­–ç•¥ A1ï¼šå¼·ç‰¹å¾µæ­£å‰‡åŒ¹é… ---
                        const keywordPattern = /(ç¸½è¨ˆ|åˆè¨ˆ|å°è¨ˆ|æ‡‰æ”¶|ç¸½é¡|å¯¦æ”¶)[:ï¼š$NT]*([0-9,]+)/i;
                        const match = cleanTextForAmount.match(keywordPattern);
                        if (match && match[2]) {
                            finalAmount = parseFloat(match[2].replace(/,/g, ''));
                        }

                        // --- ç­–ç•¥ A2ï¼šæ‰¾ã€ŒXXXå…ƒã€ä¸¦å–æœ€å¤§å€¼ ---
                        if (finalAmount === 0) {
                            const yuanMatches = [...cleanTextForAmount.matchAll(/([0-9,]+)å…ƒ/g)];
                            if (yuanMatches.length > 0) {
                                const numbers = yuanMatches.map(m => parseFloat(m[1].replace(/,/g, '')));
                                finalAmount = Math.max(...numbers); 
                            }
                        }

                        // --- ç­–ç•¥ Bï¼šåŒè¡Œé–å®šæ³• (ä¿ç•™åŸæœ¬çš„å¯¬é¬†é‚è¼¯ä½œç‚ºé˜²ç·š) ---
                        if (finalAmount === 0) {
                            const lines = text.split('\n');
                            for (let line of lines) {
                                let cleanLine = line.replace(/éš¨æ©Ÿç¢¼[\s:ï¼š]*[A-Z0-9*]{4}/gi, '').replace(/çµ±ç·¨[\s:ï¼š]*\d{8}/g, '').replace(/\s+/g, '');
                                if (/(ç¸½è¨ˆ|åˆè¨ˆ|æ‡‰æ”¶|ç¸½é¡|å°è¨ˆ|total)/i.test(cleanLine)) {
                                    const matches = cleanLine.match(/\d{1,3}(,\d{3})*(\.\d+)?|\d+(\.\d+)?/g);
                                    if (matches) {
                                        const numbers = matches.map(n => parseFloat(n.replace(/,/g, ''))).filter(n => !isNaN(n));
                                        if (numbers.length > 0) {
                                            finalAmount = Math.max(...numbers);
                                            break;
                                        }
                                    }
                                }
                            }
                        }

                        // --- ç­–ç•¥ Cï¼šçµ‚æ¥µæš´åŠ›æ’é™¤æ³• ---
                        if (finalAmount === 0) {
                            let cleanText = text.replace(/\d{8}/g, '')
                                                .replace(/\d{2,4}[-/å¹´]\d{1,2}[-/æœˆ]\d{1,2}æ—¥?/g, '')
                                                .replace(/\d{2}:\d{2}(:\d{2})?/g, '')
                                                .replace(/\d{2,3}å¹´/g, '')
                                                .replace(/[A-Z]{2}[-\s]?\d{8}/gi, '');

                            const matches = cleanText.match(/\d{1,3}(,\d{3})*(\.\d+)?|\d+(\.\d+)?/g);
                            if (matches) {
                                const numbers = matches.map(num => parseFloat(num.replace(/,/g, ''))).filter(n => !isNaN(n));
                                const validNumbers = numbers.filter(n => n < 100000 && n > 0);
                                if (validNumbers.length > 0) finalAmount = Math.max(...validNumbers);
                            }
                        }
// ==========================================
            // â˜… å‡ç´šç‰ˆ 6.0ï¼šå‹•æ…‹åç¨±åŒ¹é… + åœ–ç¤ºèªæ„é—œè¯å¼•æ“
            // ==========================================
            let detectedCategoryId = selectedCatId;
            let detectedSubCategoryId = null;

            // 1. å®šç¾©ã€Œåœ–ç¤ºèªæ„å­—å…¸ã€(Icon Semantic Dictionary)
            // å³ä½¿ä½ æ›´æ”¹äº†åˆ†é¡åç¨±ï¼Œåªè¦é¸äº†å°æ‡‰çš„ã€Œåœ–ç¤ºã€ï¼Œç³»çµ±å°±èƒ½çŒœå‡ºè©²åˆ†é¡çš„å±¬æ€§
            const iconSemanticDict = {
                'utensils': ['éºµ', 'é£¯', 'ä¾¿ç•¶', 'é¤å»³', 'éº¥ç•¶å‹', 'æ˜Ÿå·´å…‹', 'é‹', 'å£½å¸', 'æ°´é¤ƒ', 'ç‰›æ’', 'ç‚¸é›', 'åå¸', 'æ—©é¤', 'åˆé¤', 'æ™šé¤','7-11', 'å…¨å®¶', 'èŠçˆ¾å¯Œ', 'OK', 'æ‘©æ–¯', 'æ¼¢å ¡ç‹', 'è·¯æ˜“è', 'å’–å•¡å»³'],
                'coffee': ['èŒ¶', 'å’–å•¡', 'é£²æ–™', 'æ‹¿éµ', 'æ‰‹æ–', 'è¿·å®¢å¤', 'äº”ååµ', 'éº»å¤'],
                'shoppingBag': ['å…¨è¯', 'å®¶æ¨‚ç¦', 'å±ˆè‡£æ°', 'åº·æ˜¯ç¾', 'å¯¶é›…', 'ç´™è¢‹', 'å¤§æ½¤ç™¼', 'äº”é‡‘', 'è¡£æœ', 'å¤–å¥—', 'è¤²', 'é‹', 'UNIQLO'],
                'bus': ['å®¢é‹', 'å…¬è»Š', 'è»Šç¥¨', 'æ‚ éŠå¡', 'çµ±è¯', 'å’Œæ¬£'],
                'car': ['åœè»Š', 'åŠ æ²¹', 'è¨ˆç¨‹è»Š', 'ä¸­æ²¹', 'å°äº', 'Uber', '55688'],
                'plane': ['æ©Ÿç¥¨', 'èˆªç©º', 'æ—…è¡Œ', 'æ©Ÿå ´','éº»å¤'],
                'film': ['å½±åŸ', 'å¨ç§€', 'ç§€æ³°', 'åœ‹è³“', 	'é›»å½±','Netflix','å±•è¦½','é–€ç¥¨'],
                'game': ['Steam','éŠæˆ²','é»æ•¸','ä»»å¤©å ‚','PlayStation','ç©å…·'],
                'medical': ['è¨ºæ‰€', 'é†«é™¢', 'è—¥å±€', 'æ›è™Ÿ', 'é†«è—¥', 'å¥åº·', 'å¥ä¿', 'ç‰™é†«', 'çœ¼ç§‘', 'å¤§æ¨¹', 'å¿«ç¯©'],
                'home': ['æ°´è²»', 'é›»è²»', 'ç“¦æ–¯', 'ç§Ÿé‡‘', 'å®¶å…·', 'IKEA', 'å®œå¾—åˆ©', 'å°é›»'],
                'book': ['æ›¸åº—', 'åšå®¢ä¾†', 'èª å“', 'æ–‡å…·', 'å¢Šè…³çŸ³', 'è£œç¿’', 'èª²ç¨‹'],
                'phone': ['ä¸­è¯é›»ä¿¡', 'å°ç£å¤§å“¥å¤§', 'é å‚³', 'é›»è©±è²»', 'é€šè¨Š', 'è˜‹æœ', 'Apple', 'æ‰‹æ©Ÿ', '3C'],
                'briefcase': ['æ–‡å…·', 'å½±å°', 'è¾¦å…¬', 'éƒµå±€', 'å¿«é']
            };

            const cleanText = text.replace(/\s+/g, ''); // ç§»é™¤æ‰€æœ‰ç©ºæ ¼ä»¥é˜² OCR æ–·å­—
            let maxScore = 0;

            // éæ­·ä½¿ç”¨è€…ã€Œç›®å‰çœŸå¯¦å­˜åœ¨ã€çš„æ‰€æœ‰æ”¯å‡ºåˆ†é¡
            categories.expense.forEach(cat => {
                let score = 0;
                let matchedSubId = null;

                // --- ç­–ç•¥ 1ï¼šå‹•æ…‹åç¨±ç²¾æº–åŒ¹é… (Dynamic Name Matching) ---
                // å¦‚æœç™¼ç¥¨æ–‡å­—ç›´æ¥åŒ…å«ä½ è‡ªè¨‚çš„ã€Œåˆ†é¡åç¨±ã€
                if (cleanText.includes(cat.name)) {
                    score += 10; // çµ¦äºˆæ¥µé«˜æ¬Šé‡
                }

                // å¦‚æœç™¼ç¥¨æ–‡å­—åŒ…å«ä½ è‡ªè¨‚çš„ã€Œç´°é …åç¨±ã€
                if (cat.subCategories && cat.subCategories.length > 0) {
                    cat.subCategories.forEach(sub => {
                        if (cleanText.includes(sub.name)) {
                            score += 20; // ç´°é …å‘½ä¸­ï¼Œçµ¦äºˆæœ€é«˜æ¬Šé‡ (å› ç‚ºæœ€ç²¾ç¢º)
                            matchedSubId = sub.id;
                        }
                    });
                }

                // --- ç­–ç•¥ 2ï¼šåœ–ç¤ºèªæ„æ¨¡ç³ŠåŒ¹é… (Icon Semantic Matching) ---
                // æ ¹æ“šè©²åˆ†é¡æ‰€ä½¿ç”¨çš„ã€Œåœ–ç¤ºã€ï¼Œèª¿ç”¨å°æ‡‰çš„å­—å…¸åº«é€²è¡ŒåŠ åˆ†
                const keywords = iconSemanticDict[cat.iconKey] || [];
                keywords.forEach(kw => {
                    if (cleanText.includes(kw)) {
                        score += 1; // å‘½ä¸­ä¸€å€‹èªæ„é—œéµå­—åŠ  1 åˆ†
                    }
                });

                // --- æ›´æ–°æœ€é«˜åˆ†çµæœ ---
                if (score > maxScore) {
                    maxScore = score;
                    detectedCategoryId = cat.id;
                    detectedSubCategoryId = matchedSubId;
                }
            });

// --- è§£æå®Œæˆå¾Œï¼Œè‡ªå‹•æ›´æ–°ç•«é¢ ---
                if (finalAmount > 0) {
                    setAmountStr(prev => prev === '0' ? finalAmount.toString() : prev);
                    setSelectedCatId(detectedCategoryId);
                    if (detectedSubCategoryId) setSelectedSubCatId(detectedSubCategoryId);
                    if (triggerHaptic) triggerHaptic(30);
                } else {
                    showAlert('æç¤º', 'AI æ‰¾ä¸åˆ°é‡‘é¡ï¼Œè«‹ç¢ºèªåœ–ç‰‡æ¸…æ™°æˆ–æ‰‹å‹•è¼¸å…¥ã€‚');
                }
            } catch (error) {
                console.error(error);
                showAlert('éŒ¯èª¤', 'æƒæè§£æå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            } finally {
                setIsScanning(false);
                if (fileInputRef.current) fileInputRef.current.value = '';
            }
        })();
    };
    
            // â˜… 1. åŠ å…¥è¨ˆç®—å‰©é¤˜é ç®—çš„é‚è¼¯
            const categoryBudgetInfo = useMemo(() => {
                if (type !== 'expense' || !selectedCatId) return null;
                
                // æ‰¾åˆ°è©²åˆ†é¡è¨­å®š
                const cat = categories.expense.find(c => c.id === selectedCatId);
                if (!cat || !cat.budget) return null; // æ²’è¨­å®šé ç®—å°±ä¸é¡¯ç¤º

                // è¨ˆç®—æœ¬æœˆè©²åˆ†é¡å·²èŠ±è²»é‡‘é¡
                const now = new Date();
                const yearMonthPrefix = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

                const spent = transactions
                    .filter(t => {
                        // åŒ…å«è‡ªå·±ï¼Œå¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼è¦æ’é™¤è‡ªå·±(é¿å…é‡è¤‡æ‰£)
                        return t.type === 'expense' &&
                               t.categoryId === selectedCatId &&
                               t.date.startsWith(yearMonthPrefix) &&
                               (!initialData || t.id !== initialData.id);
                    })
                    .reduce((sum, t) => sum + ((t.splitMyShare !== undefined ? t.splitMyShare : t.amount)), 0);

                const remaining = cat.budget - spent;
                // åŠ å…¥æœ¬æ¬¡è¼¸å…¥çš„é‡‘é¡ (amountStr) é€²è¡Œé åˆ¤
                const currentInput = currentParsedAmount;
                const finalRemaining = remaining - currentInput;

                return { budget: cat.budget, remaining, finalRemaining };
            }, [selectedCatId, transactions, amountStr, type, initialData, categories]);
            // â˜… æ–°å¢ï¼šæ™ºæ…§å‚™è¨»è¨˜æ†¶æ¨™ç±¤
            // æŠ“å‡ºè©²åˆ†é¡æœ€å¸¸ä½¿ç”¨çš„ 4 å€‹å‚™è¨»ï¼Œç”¢ç”Ÿå¿«é€Ÿé»æ“ŠæŒ‰éˆ•
            const suggestedNotes = useMemo(() => {
                if (!selectedCatId || type === 'transfer') return [];
                
                // å–å‡ºåŒåˆ†é¡æœ€è¿‘ 100 ç­†æœ‰å¯«å‚™è¨»çš„äº¤æ˜“
                const recentTx = transactions
                    .filter(t => t.type === type && t.categoryId === selectedCatId && t.note)
                    .slice(0, 100);
                
                const noteCounts = {};
                recentTx.forEach(t => {
                    // éæ¿¾æ‰è‡ªå‹•ç”¢ç”Ÿçš„æ¨™ç±¤ (ä¾‹å¦‚ [è‡ªå‹•] åœ‹æ³°åˆ·å¡)
                    const cleanNote = t.note.trim();
                    if (cleanNote && !cleanNote.includes('[è‡ªå‹•]')) {
                        noteCounts[cleanNote] = (noteCounts[cleanNote] || 0) + 1;
                    }
                });

                // å–å‡ºé »ç‡æœ€é«˜çš„ 4 å€‹å‚™è¨»
                return Object.entries(noteCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 4)
                    .map(item => item[0]);
            }, [transactions, selectedCatId, type]);
            // --- UI æ¸²æŸ“ ---
            const renderTypeTabs = () => (
                <div className="w-full px-8 mb-2 relative z-30">
                    <div className="flex bg-gray-100 p-1.5 rounded-xl w-full shadow-inner">
                        {['expense', 'income', 'transfer'].map(t => (
                            <button key={t} onClick={() => setType(t)} className={`flex-1 py-3 text-sm font-bold rounded-lg transition-all duration-200 ${type === t ? 'bg-white text-[#333] shadow-md transform scale-100' : 'text-gray-400 hover:bg-gray-200/50'}`}>
                                {t === 'expense' ? 'æ”¯å‡º' : t === 'income' ? 'æ”¶å…¥' : 'è½‰å¸³'}
                            </button>
                        ))}
                    </div>
                </div>
            );

            const renderFanMenu = (items, onSelect, title, onBackAction) => {
                const itemsPerPage = 5;
                const totalPages = Math.ceil(items.length <= 6 ? 1 : items.length / itemsPerPage);
                const isLastPage = menuPage >= totalPages - 1;
                let displayItems = [];
                let showMore = false;

                if (items.length <= 6) { displayItems = items; } 
                else {
                    const startIndex = menuPage * itemsPerPage;
                    if (isLastPage) { displayItems = items.slice(startIndex); } 
                    else { displayItems = items.slice(startIndex, startIndex + 5); showMore = true; }
                }

                const radius = 135;
                const startAngle = -170;
                const endAngle = -10;
                const totalSlots = displayItems.length + (showMore ? 1 : 0);
                const stepAngle = totalSlots > 1 ? (endAngle - startAngle) / (totalSlots - 1) : 0;

                const handleBackClick = () => { if (menuPage > 0) setMenuPage(prev => prev - 1); else { if (onBackAction) onBackAction(); else onClose(); } };

                return (
                    <div className="fixed inset-0 z-[1000] flex flex-col justify-end animate-fade-in">
                        <div className="absolute inset-0 bg-black/30 backdrop-blur-[2px]" onClick={onClose}></div>
                        <div className="relative w-full h-[420px] bg-white rounded-t-[40px] shadow-2xl animate-slide-up overflow-hidden z-10 flex flex-col items-center pt-6">
                            
                            {/* â˜… ä¿®æ­£ 1ï¼šéš±è—çš„ç›¸æ©Ÿè¼¸å…¥æ¡†å¿…é ˆæ”¾åœ¨é€™å€‹ç•«é¢è£¡ï¼Œé»æ“Šæ‰æœƒæœ‰åæ‡‰ï¼ */}
                            <input type="file" accept="image/*" capture="environment" ref={fileInputRef} onChange={handleOCRScan} className="hidden" />
                            
                            {step === 1 && renderTypeTabs()}
                            
                            {/* â˜… ä¿®æ­£ 3ï¼šå°‡æƒææŒ‰éˆ•ç¸®å°æˆåœ–ç¤ºï¼Œæ”¾åœ¨æ¨™é¡Œåˆ—å³å´ */}
                            <div className="w-full mt-1 mb-2 h-6 relative flex justify-center items-center">
                                <h3 className="text-sm font-bold text-gray-400 tracking-widest uppercase">{menuPage > 0 ? `${title} (ç¬¬ ${menuPage + 1} é )` : title}</h3>
                                
                                {step === 1 && type === 'expense' && menuPage === 0 && (
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); if(fileInputRef.current) fileInputRef.current.click(); }} 
                                        className="absolute right-8 w-8 h-8 flex items-center justify-center bg-gray-100 text-gray-500 rounded-full hover:bg-[#333] hover:text-white transition shadow-sm active:scale-95"
                                        title="å¿«é€Ÿæƒæç™¼ç¥¨"
                                    >
                                        <Icon name="camera" size={14} />
                                    </button>
                                )}
                            </div>
                            <div className="absolute bottom-8 left-1/2 -translate-x-1/2 z-20">
                                <button onClick={handleBackClick} className="w-14 h-14 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center shadow-sm active:scale-90 transition border border-gray-200"><Icon name={(menuPage > 0 || onBackAction) ? "back" : "close"} size={24} /></button>
                            </div>
                            <div className="absolute bottom-[80px] left-1/2 w-0 h-0 z-10">
                                {displayItems.map((item, index) => {
                                    const angleDeg = totalSlots === 1 ? -90 : startAngle + (index * stepAngle);
                                    const angleRad = angleDeg * (Math.PI / 180);
                                    const x = radius * Math.cos(angleRad);
                                    const y = radius * Math.sin(angleRad);
                                    return (
                                        <button key={item.id} onClick={() => onSelect(item.id)} className="absolute w-16 h-16 -ml-8 -mt-8 rounded-full bg-white shadow-[0_4px_12px_rgba(0,0,0,0.08)] border border-gray-100 flex flex-col items-center justify-center gap-0.5 active:scale-95 transition-all hover:-translate-y-1" style={{ transform: `translate(${x}px, ${y}px)`, animation: `fan-out 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) ${index * 0.05}s backwards` }}>
                                            {item.icon}
                                            <span className="text-[10px] font-medium text-gray-600 leading-none scale-90 truncate w-12 text-center">{item.label}</span>
                                        </button>
                                    );
                                })}
                                {showMore && (() => {
                                    const index = displayItems.length;
                                    const angleDeg = startAngle + (index * stepAngle);
                                    const angleRad = angleDeg * (Math.PI / 180);
                                    const x = radius * Math.cos(angleRad);
                                    const y = radius * Math.sin(angleRad);
                                    return (
                                        <button onClick={() => setMenuPage(prev => prev + 1)} className="absolute w-16 h-16 -ml-8 -mt-8 rounded-full bg-gray-50 shadow-sm border border-gray-200 flex flex-col items-center justify-center gap-0.5 active:scale-95 transition-all" style={{ transform: `translate(${x}px, ${y}px)`, animation: `fan-out 0.4s ${index * 0.05}s backwards` }}><Icon name="grid" size={20} className="text-[#333]" /><span className="text-[10px] font-medium text-gray-600">æ›´å¤š</span></button>
                                    );
                                })()}
                            </div>
                        </div>
                    </div>
                );
            };

            // --- æµç¨‹æ§åˆ¶ ---

            // Step 1: é¸æ“‡åˆ†é¡ (æˆ–è½‰å‡ºå¸³æˆ¶)
            if (step === 1) { 
                let items = [];
                let title = "é¸æ“‡åˆ†é¡";
                let onSelect = (id) => {};

                if (type === 'transfer') {
                    title = "é¸æ“‡è½‰å‡ºå¸³æˆ¶";
                    // â˜… ä¿®æ”¹ 3ï¼šæ”¹ç”¨ sortedAccounts (æ™ºæ…§æ’åº)
                    items = sortedAccounts.map(acc => ({ 
                        id: acc.id, label: acc.name, 
                        icon: <Icon name={acc.type === 'cash' ? 'banknote' : acc.type === 'liability' ? 'creditCard' : 'wallet'} size={24} className="text-gray-600"/> 
                    }));
                    onSelect = (id) => { setSelectedAcc(id); setStep(2); };
                } else {
                    const activeCategories = type === 'expense' ? sortedCategories.expense : sortedCategories.income;
                    items = activeCategories.map(cat => ({
                        id: cat.id, label: cat.name, 
                        icon: <Icon name={cat.iconKey || 'more'} size={24} className="text-gray-600"/> 
                    }));
                    onSelect = (id) => { 
                        setSelectedCatId(id); 
                        const cat = activeCategories.find(c => c.id === id);
                        if (cat && cat.subCategories && cat.subCategories.length > 0) { setStep(1.5); } 
                        else { setSelectedSubCatId(null); setStep(2); } 
                    };
                }
                return renderFanMenu(items, onSelect, title, null);
            }

            // Step 1.5: ç´°é …
            if (step === 1.5 && type !== 'transfer') {
                const currentCat = (type === 'expense' ? categories.expense : categories.income).find(c => c.id === selectedCatId) || {};
                const items = (currentCat.subCategories || []).map(sub => ({ id: sub.id, label: sub.name, icon: <span className="text-sm font-bold text-gray-500">{sub.name[0]}</span> }));
                const onSelect = (id) => { setSelectedSubCatId(id); setStep(2); };
                return renderFanMenu(items, onSelect, `${currentCat.name} - ç´°é …`, () => setStep(1));
            }

            // Step 2: ä»˜æ¬¾äºº(æ”¯å‡º)/è½‰å…¥/å­˜å…¥å¸³æˆ¶(æ”¶å…¥)
            if (step === 2) { 
                if (type === 'transfer') {
                    const title = "é¸æ“‡è½‰å…¥å¸³æˆ¶";
                    // â˜… ä¿®æ”¹ 4ï¼šæ”¹ç”¨ sortedAccounts ä¸¦éæ¿¾
                    const targetOptions = sortedAccounts.filter(a => a.id !== selectedAcc);
                    const items = targetOptions.map(acc => ({ id: acc.id, label: acc.name, icon: <Icon name={acc.type === 'cash' ? 'banknote' : acc.type === 'liability' ? 'creditCard' : 'wallet'} size={24} className="text-gray-600"/> }));
                    const onSelect = (id) => { setTargetAcc(id); setStep(4); };
                    return renderFanMenu(items, onSelect, title, () => setStep(1));
                } else if (type === 'income') {
                    const title = "é¸æ“‡å­˜å…¥å¸³æˆ¶";
                    // â˜… ä¿®æ”¹ 5ï¼šæ”¹ç”¨ sortedAccounts
                    const items = sortedAccounts.map(acc => ({ id: acc.id, label: acc.name, icon: <Icon name={acc.type === 'cash' ? 'banknote' : acc.type === 'liability' ? 'creditCard' : 'wallet'} size={24} className="text-gray-600"/> }));
                    const onSelect = (id) => { setSelectedAcc(id); setStep(4); }; 
                    const onBack = () => {
                        const cat = categories.income.find(c => c.id === selectedCatId);
                        setStep(cat && cat.subCategories && cat.subCategories.length > 0 ? 1.5 : 1);
                    };
                    return renderFanMenu(items, onSelect, title, onBack);
                } else {
                    // æ”¯å‡ºæµç¨‹ï¼šé¸æ“‡ä»˜æ¬¾äºº
                    const items = [
                        { id: 'other', label: 'å°æ–¹å¢Šä»˜', icon: <Icon name="userCheck" size={24} className="text-[#333]"/> },
                        { id: 'none', label: 'å€‹äººæ”¯å‡º', icon: <Icon name="users" size={24} className="text-gray-400"/> }, 
                        { id: 'me', label: 'ä¸€èµ·åˆ†æ”¤', icon: <Icon name="split" size={24} className="text-[#333]"/> },
                        { id: 'advance', label: 'å¹«äººä»£è³¼', icon: <Icon name="shoppingBag" size={24} className="text-[#5CB85C]"/> },
                    ];
                    const onSelect = (id) => { 
                        setSplitMode(id);
                        if (id === 'other') setStep(4);
                        else setStep(3);
                    };
                    const onBack = () => {
                        const cat = categories.expense.find(c => c.id === selectedCatId);
                        setStep(cat && cat.subCategories && cat.subCategories.length > 0 ? 1.5 : 1);
                    };
                    return renderFanMenu(items, onSelect, "ä»˜æ¬¾äºº / åˆ†å¸³", onBack);
                }
            }
            
            // Step 3: é¸æ“‡æ‰£æ¬¾å¸³æˆ¶ (åƒ…æ”¯å‡ºå‡ºç¾)
            if (step === 3 && type === 'expense') { 
                const title = "é¸æ“‡æ‰£æ¬¾å¸³æˆ¶";
                // â˜… ä¿®æ”¹ 6ï¼šæ”¹ç”¨ sortedAccounts
                const items = sortedAccounts.map(acc => ({ id: acc.id, label: acc.name, icon: <Icon name={acc.type === 'cash' ? 'banknote' : acc.type === 'liability' ? 'creditCard' : 'wallet'} size={24} className="text-gray-600"/> }));
                const onSelect = (id) => { setSelectedAcc(id); setStep(4); };
                const onBack = () => setStep(2); 
                return renderFanMenu(items, onSelect, title, onBack);
            }

            // Step 4: è¼¸å…¥é‡‘é¡ (ä¿æŒä¸è®Š)
            const currentCat = type !== 'transfer' ? ((type === 'expense' ? categories.expense : categories.income).find(c => c.id === selectedCatId) || {}) : {};
            const currentAccData = accounts.find(a => a.id === selectedAcc) || {};
            const targetAccData = accounts.find(a => a.id === targetAcc) || {};
            
            // è¿”å›éµé‚è¼¯
            const handleBackFromAmount = () => {
                if (type === 'transfer') setStep(2);
                else if (type === 'income') setStep(2); 
                else if (splitMode === 'other') setStep(2); 
                else setStep(3); 
            };

            return (
                <div className="fixed z-[200] bg-white flex flex-col animate-slide-up modal-curve-top overflow-hidden left-0 right-0 bottom-0" style={{maxHeight: '90vh'}}>
                    <div className="flex justify-between items-center px-6 pt-6 pb-2 bg-[#F5F5F3]">
                        {initialData ? <button onClick={(e) => {e.stopPropagation(); onClose();}} className="p-2 -ml-2 text-gray-400"><Icon name="close" /></button> : <button onClick={(e) => {e.stopPropagation(); handleBackFromAmount();}} className="p-2 -ml-2 text-gray-400"><Icon name="back" /></button>}
                        <div className="flex items-center gap-2">
                             {type === 'transfer' ? (
                                <><span className="text-xs text-gray-500 bg-white border border-gray-200 px-2 py-1 rounded-full">{currentAccData.name}</span><Icon name="chevronRight" size={12} className="text-gray-400"/><span className="text-xs text-[#333] bg-white border border-[#333] px-2 py-1 rounded-full">{targetAccData.name}</span></>
                             ) : (
                                <>
                                    <button onClick={() => setStep(1)} className="flex items-center gap-1 px-3 py-1 bg-white border border-gray-200 rounded-full text-xs text-gray-600 shadow-sm active:scale-95 transition"><Icon name={currentCat.iconKey||'more'} size={14}/> {currentCat.name}</button>
                                    {type === 'expense' && (
                                        splitMode === 'other' ? (
                                            <button onClick={() => setStep(2)} className="flex items-center gap-1 px-3 py-1 bg-gray-200 border border-gray-300 rounded-full text-xs text-gray-500 shadow-inner">å°æ–¹å¢Šä»˜</button>
                                        ) : (
                                            <button onClick={() => setStep(3)} className="flex items-center gap-1 px-3 py-1 bg-white border border-gray-200 rounded-full text-xs text-gray-600 shadow-sm active:scale-95 transition">{currentAccData.name}</button>
                                        )
                                    )}
                                    {type === 'income' && (
                                        <button onClick={() => setStep(2)} className="flex items-center gap-1 px-3 py-1 bg-white border border-gray-200 rounded-full text-xs text-gray-600 shadow-sm active:scale-95 transition">{currentAccData.name}</button>
                                    )}
                                </>
                             )}
                        </div>
                        {initialData ? <button onClick={() => onDelete(initialData.id)} className="text-[#D9534F] p-2 -mr-2"><Icon name="trash" /></button> : <div className="w-8"></div>}
                    </div>
                    <div className="px-6 py-4 bg-[#F5F5F3] text-right flex flex-col justify-end">
                        {/* â˜… æ–°å¢ï¼šéå¹²æ“¾å¼çš„èƒŒæ™¯æƒææç¤º */}
                        {isScanning && (
                            <div className="absolute top-4 left-6 flex items-center gap-2 text-xs font-bold text-[#5CB85C] bg-green-100/50 px-3 py-1.5 rounded-full animate-pulse shadow-sm">
                                <div className="w-3 h-3 border-2 border-[#5CB85C] border-t-transparent rounded-full animate-spin"></div>
                                <span>ğŸ‘€ AI æ­£åœ¨çœ‹ç™¼ç¥¨...</span>
                            </div>
                        )}
                        {categoryBudgetInfo && (
                            <div className="flex justify-end mb-1 animate-fade-in">
                                <div className={`text-[10px] px-2 py-0.5 rounded-full border flex items-center gap-1 transition-colors
                                    ${categoryBudgetInfo.finalRemaining < 0 
                                        ? 'bg-red-50 text-red-500 border-red-100 dark:bg-red-900/20 dark:border-red-900' 
                                        : 'bg-green-50 text-green-600 border-green-100 dark:bg-green-900/20 dark:border-green-900'}`
                                }>
                                    <span>{categoryBudgetInfo.finalRemaining < 0 ? 'âš ï¸ è¶…æ”¯' : 'å‰©é¤˜'}</span>
                                    <span className="font-medium">${categoryBudgetInfo.finalRemaining.toLocaleString()}</span>
                                    <span className="text-gray-400">/ é ç®— ${categoryBudgetInfo.budget.toLocaleString()}</span>
                                </div>
                            </div>
                        )}
                        <div className="text-gray-400 text-xs mb-2 flex justify-end gap-3 items-center">
                            <div className="bg-white px-3 py-1 rounded-full text-[10px] border border-gray-200 shadow-sm flex items-center gap-1"><Icon name="calendar" size={12}/> <input type="date" value={date} onChange={e => setDate(e.target.value)} className="outline-none bg-transparent text-gray-600 font-medium font-sans h-full" required/></div>
                        </div>
                        
                        {/* â˜… æƒæä¸­çš„ Loading æç¤º */}
                        {isScanning ? (
                            <div className="text-lg font-medium text-gray-400 tracking-widest animate-pulse h-[60px] flex items-center justify-end">
                                æƒæè§£æä¸­...
                            </div>
                        ) : (
                            <div className={`text-6xl font-light tracking-tighter ${type === 'transfer' ? 'text-gray-600' : type === 'expense' ? 'text-[#333]' : 'text-[#5CB85C]'}`}>{amountStr}</div>
                        )}
                    </div>
                    
                    <div className="px-5 py-3 bg-white flex flex-col gap-3 relative z-10" style={{boxShadow: '0 -10px 20px rgba(0,0,0,0.03)'}}>
                        {/* â˜… æ–°å¢ï¼šç„¡ç¸«åˆ†æœŸé¸é … (åªåœ¨æ”¯å‡ºä¸”é¸ç”¨ä¿¡ç”¨å¡æ™‚å‡ºç¾) */}
                        {currentAccData?.type === 'liability' && type === 'expense' && !initialData && (
                            <div className="flex flex-col gap-2 bg-gray-50 rounded-lg px-4 py-2.5 border border-gray-100">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-2">
                                        <Icon name="calendar" size={14} className="text-gray-500"/>
                                        <span className="text-xs font-medium text-gray-600">åˆ·å¡åˆ†æœŸ</span>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        {isInstallment && (
                                            <select value={installPeriods} onChange={(e) => setInstallPeriods(Number(e.target.value))} className="text-xs bg-white border border-gray-200 rounded px-2 py-1 outline-none text-[#333] shadow-sm">
                                                {[3, 6, 12, 24, 30].map(p => <option key={p} value={p}>{p} æœŸ</option>)}
                                            </select>
                                        )}
                                        <div onClick={() => setIsInstallment(!isInstallment)} className={`w-9 h-5 rounded-full relative cursor-pointer transition-colors duration-300 ${isInstallment ? 'bg-[#333]' : 'bg-gray-300'}`}>
                                            <div className={`w-3.5 h-3.5 bg-white rounded-full absolute top-0.5 shadow-sm transition-transform duration-300 ${isInstallment ? 'left-5' : 'left-0.5'}`}></div>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* â˜… éŠ€è¡Œç´šé€²éšåˆ†æœŸè¨­å®šé¢æ¿ */}
                                {isInstallment && (
                                    <div className="pt-2 mt-1 border-t border-gray-200 flex flex-col gap-2 animate-fade-in">
                                        <div className="flex items-center justify-between">
                                            <span className="text-[10px] text-gray-500">è‡ªè¨‚æ¯æœŸé‡‘é¡ (ç©ºç™½å‰‡è‡ªå‹•å‡åˆ†)</span>
                                            {/* â˜… ä¿®æ­£ï¼šå°‡ amount æ”¹ç‚º currentParsedAmountï¼Œå¾¹åº•è§£æ±ºå´©æ½° */}
                                            <input type="number" value={customPeriodAmount} onChange={e => setCustomPeriodAmount(e.target.value)} placeholder={Math.round(currentParsedAmount / installPeriods) || 0} className="text-xs bg-white border border-gray-200 rounded px-2 py-1 outline-none text-[#333] w-20 text-right shadow-sm" />
                                        </div>
                                        <div className="flex items-center justify-between">
                                            <span className="text-[10px] text-gray-500">é™¤ä¸ç›¡ä¹‹é¤˜é¡èª¿æ•´</span>
                                            <select value={remainderAdjust} onChange={e => setRemainderAdjust(e.target.value)} className="text-xs bg-white border border-gray-200 rounded px-2 py-1 outline-none text-[#333] shadow-sm">
                                                <option value="last">ä½µå…¥æœ€å¾Œä¸€æœŸ</option>
                                                <option value="first">ä½µå…¥ç¬¬ä¸€æœŸ</option>
                                            </select>
                                        </div>
                                    </div>
                                )}
                            </div>
                         )}
                         <div className="flex gap-3">
                            {type === 'expense' && (
                                <button onClick={() => setStep(2)} className={`flex-1 rounded-lg px-3 py-3 flex flex-col items-center justify-center gap-1 transition border ${splitMode !== 'none' ? 'bg-[#333] text-white border-[#333]' : 'bg-white text-gray-400 border-gray-200'}`}>
                                    <Icon name={splitMode === 'other' ? 'userCheck' : 'split'} size={16} />
                                    <span className="text-xs font-medium">{splitMode === 'none' ? 'åˆ†å¸³' : (splitMode === 'me' ? 'æˆ‘å¢Š' : splitMode === 'advance' ? 'ä»£è³¼' : 'ä»–å¢Š')}</span>                                </button>
                            )}
                            
                            {/* â˜… ä¿®æ”¹ï¼šå‚™è¨»è¼¸å…¥æ¡†èˆ‡æ™ºæ…§æ¨™ç±¤å®¹å™¨ */}
                            <div className="flex-[3] flex flex-col gap-1.5 min-w-0">
                                <div className="bg-[#F9F9F9] rounded-lg px-3 py-3 flex items-center gap-3">
                                    <Icon name="fileText" size={16} className="text-gray-400 shrink-0"/>
                                    <input type="text" placeholder="æ–°å¢å‚™è¨»..." className="bg-transparent w-full text-sm outline-none text-gray-700 placeholder-gray-400" value={note} onChange={e => setNote(e.target.value)} />
                                </div>
                                
                                {/* é¡¯ç¤ºæ™ºæ…§è¨˜æ†¶æ¨™ç±¤ */}
                                {suggestedNotes.length > 0 && (
                                    <div className="flex gap-1.5 overflow-x-auto no-scrollbar">
                                        {suggestedNotes.map(sn => (
                                            <button 
                                                key={sn} 
                                                onClick={() => { 
                                                    setNote(sn); 
                                                    if(triggerHaptic) triggerHaptic(10); 
                                                }} 
                                                className="shrink-0 bg-white border border-gray-200 text-gray-500 text-[10px] px-2.5 py-1 rounded-full shadow-sm hover:bg-gray-50 transition active:scale-95 whitespace-nowrap"
                                            >
                                                {sn}
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                    <div className="flex-1 bg-white grid grid-cols-4 p-2 gap-2 content-end pb-6 border-t border-gray-50">
                        {['7','8','9','AC','4','5','6','+','1','2','3','-','.','0','back','OK'].map(key => (<button key={key} type="button" onClick={() => handleNumPad(key)} className={`rounded-lg text-xl font-light h-16 flex items-center justify-center muji-button ${key === 'OK' ? 'bg-[#333] text-white shadow-md' : ['+','-','AC','back'].includes(key) ? 'bg-[#F9F9F9] text-gray-500' : 'text-[#333]'}`}>{key === 'back' ? <Icon name="back" size={24}/> : key}</button>))}
                    </div>
                </div>
            );
        };

// ==========================================
// â˜… è£œå›éºå¤±å…ƒä»¶ 1: QuickAddSheet (å¿«é€Ÿè¨˜å¸³é¸å–®)
// ==========================================
const QuickAddSheet = ({ templates, accounts, categories, onClose, onSelect, onGoSettings }) => {
    const [page, setPage] = useState(0);
    
    // æ‰‡å½¢åƒæ•¸
    const radius = 130;
    const startAngle = -170;
    const endAngle = -10;
    const itemsPerPage = 5;

    // åˆ†é è¨ˆç®—é‚è¼¯
    let displayTemplates = [];
    let showMore = false;

    if (templates.length <= 6) {
        displayTemplates = templates;
    } else {
        const totalPages = Math.ceil(templates.length / itemsPerPage);
        const isLastPage = page >= totalPages - 1;
        const startIndex = page * itemsPerPage;

        if (isLastPage) {
            displayTemplates = templates.slice(startIndex);
        } else {
            displayTemplates = templates.slice(startIndex, startIndex + itemsPerPage);
            showMore = true;
        }
    }

    const totalSlots = displayTemplates.length + (showMore ? 1 : 0);
    const step = totalSlots > 1 ? (endAngle - startAngle) / (totalSlots - 1) : 0;

    const handleCenterClick = (e) => {
        e.stopPropagation(); // é˜²æ­¢èª¤è§¸èƒŒæ™¯
        if (page > 0) {
            setPage(prev => prev - 1);
        } else {
            onClose();
        }
    };

    return (
        <div className="fixed inset-0 z-[1000] flex flex-col justify-end animate-fade-in">
            {/* èƒŒæ™¯å±¤ï¼šé»æ“Šé€™è£¡æ‰æœƒé—œé–‰ */}
            <div className="absolute inset-0 bg-black/30 backdrop-blur-[2px]" onClick={onClose}></div>
            
            <div className="relative w-full h-[320px] bg-white rounded-t-[40px] shadow-2xl animate-slide-up overflow-hidden z-10 flex flex-col items-center" onClick={(e) => e.stopPropagation()}>
                <div className="w-full text-center mt-6 mb-2">
                    <h3 className="text-sm font-bold text-gray-400 tracking-widest uppercase">
                        {page > 0 ? `å¿«é€Ÿè¨˜å¸³ (ç¬¬ ${page + 1} é )` : 'å¿«é€Ÿè¨˜å¸³'}
                    </h3>
                </div>
                
                <div className="absolute bottom-[-60px] left-1/2 -translate-x-1/2 w-[350px] h-[350px] rounded-full border border-dashed border-gray-200 pointer-events-none"></div>
                
                {/* ä¸­å¤®æŒ‰éˆ• */}
                <div className="absolute bottom-6 left-1/2 -translate-x-1/2 z-20 flex flex-col gap-2 items-center">
                    {templates.length === 0 ? (
                        <button onClick={onGoSettings} className="px-6 py-3 bg-[#333] text-white rounded-full text-sm shadow-lg">å»ºç«‹æ¨¡æ¿</button>
                    ) : (
                        <button onClick={handleCenterClick} className="w-16 h-16 rounded-full bg-[#333] text-white flex items-center justify-center shadow-lg active:scale-90 transition border-4 border-white">
                            <Icon name={page > 0 ? "back" : "close"} size={24} />
                        </button>
                    )}
                </div>

                {/* æ‰‡å½¢æŒ‰éˆ•ç¾¤ */}
                <div className="absolute bottom-[60px] left-1/2 w-0 h-0 z-10">
                    {displayTemplates.map((t, index) => {
                        const angleDeg = totalSlots === 1 ? -90 : startAngle + (index * step);
                        const angleRad = angleDeg * (Math.PI / 180);
                        const x = radius * Math.cos(angleRad);
                        const y = radius * Math.sin(angleRad);
                        const accName = accounts.find(a => a.id === t.accountId)?.name || 'æœªçŸ¥';

                        return (
                            <button 
                                key={t.id} 
                                // â˜… é—œéµï¼šå‚³éå®Œæ•´çš„ t (æ¨¡æ¿ç‰©ä»¶)ï¼Œè€Œä¸æ˜¯ t.id
                                onClick={(e) => { e.stopPropagation(); onSelect(t); }}
                                className="absolute w-16 h-16 -ml-8 -mt-8 rounded-full bg-white shadow-md border border-gray-100 flex flex-col items-center justify-center gap-0.5 active:scale-95 transition-all hover:bg-gray-50 hover:border-[#333] group z-50"
                                style={{ 
                                    transform: `translate(${x}px, ${y}px)`,
                                    animation: `fan-out 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) ${index * 0.05}s backwards`
                                }}
                            >
                                <div className="text-[#333]"><Icon name={t.iconKey || 'template'} size={20}/></div>
                                <span className="text-[9px] font-medium text-gray-600 truncate max-w-[50px]">{t.name}</span>
                                <div className="absolute -bottom-8 left-1/2 -translate-x-1/2 whitespace-nowrap bg-gray-800 text-white text-[9px] px-1.5 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-30 shadow-sm">
                                    {accName} {t.isSplit && 'Â· åˆ†å¸³'}
                                </div>
                                {t.isSplit && <div className="absolute top-0 right-0 w-2.5 h-2.5 bg-[#333] rounded-full border border-white"></div>}
                            </button>
                        );
                    })}

                    {showMore && (() => {
                        const index = displayTemplates.length;
                        const angleDeg = startAngle + (index * step);
                        const angleRad = angleDeg * (Math.PI / 180);
                        const x = radius * Math.cos(angleRad);
                        const y = radius * Math.sin(angleRad);
                        
                        return (
                            <button 
                                onClick={(e) => { e.stopPropagation(); setPage(prev => prev + 1); }} 
                                className="absolute w-16 h-16 -ml-8 -mt-8 rounded-full bg-gray-50 shadow-sm border border-gray-200 flex flex-col items-center justify-center gap-0.5 active:scale-95 transition-all hover:bg-gray-100 z-50"
                                style={{ 
                                    transform: `translate(${x}px, ${y}px)`,
                                    animation: `fan-out 0.4s ${index * 0.05}s backwards` 
                                }}
                            >
                                <Icon name="grid" size={20} className="text-[#333]" />
                                <span className="text-[10px] font-medium text-gray-600">æ›´å¤š</span>
                            </button>
                        );
                    })()}
                </div>
                
                <button onClick={onGoSettings} className="absolute bottom-4 right-6 text-[10px] text-gray-400 flex items-center gap-1 hover:text-[#333] transition z-30">
                    ç®¡ç†æ¨¡æ¿ <Icon name="settings" size={10}/>
                </button>
            </div>
        </div>
    );
};

// ==========================================
// â˜… ä¿®æ­£ç‰ˆï¼šQuickEntryModal (æ”¯æ´å°æ•¸é»èˆ‡è¨ˆç®—åŠŸèƒ½)
// ==========================================
const QuickEntryModal = ({ template, onClose, onSave }) => {
    // å¼•å…¥éœ‡å‹•
    const { triggerHaptic } = React.useContext(DataContext);
    const [amountStr, setAmountStr] = useState('0');

    if (!template) return null;

    const handleNumPad = (val) => {
        if(triggerHaptic) triggerHaptic();

        if (val === 'AC') {
            setAmountStr('0');
        } else if (val === 'back') { 
            setAmountStr(prev => prev.length > 1 ? prev.slice(0, -1) : '0'); 
        } else if (val === 'OK') {
            // â˜… åŠ å…¥è¨ˆç®—é‚è¼¯ (æ”¯æ´ 50+20)
            let amount = 0;
            try {
                let evalStr = amountStr;
                if (['+','-','*','/'].includes(evalStr.slice(-1))) evalStr = evalStr.slice(0, -1);
                amount = new Function('return ' + evalStr)();
            } catch (e) { amount = 0; }

            if (amount > 0) {
                onSave({ 
                    id: Date.now().toString(), 
                    date: getLocalDateString(), 
                    amount, 
                    type: 'expense', 
                    categoryId: template.categoryId, 
                    subCategoryId: template.subCategoryId, 
                    accountId: template.accountId, 
                    note: template.name, 
                    tags: template.isSplit ? ['#åˆ†å¸³'] : [] 
                });
            }
        } else { 
            // é˜²æ­¢é€£çºŒé‹ç®—ç¬¦è™Ÿ
            if (['+','-','*','/'].includes(val) && ['+','-','*','/'].includes(amountStr.slice(-1))) return;
            setAmountStr(prev => (prev === '0' && !['+','-','*','/','.'].includes(val)) ? val : prev + val); 
        }
    };

    return (
        <div className="fixed inset-0 z-[1100] bg-black/60 flex items-end justify-center animate-fade-in">
            <div className="absolute inset-0" onClick={onClose}></div>

            <div className="bg-white w-full max-w-md rounded-t-xl animate-slide-up overflow-hidden relative z-10">
                <div className="bg-[#F5F5F3] p-4 flex justify-between items-center border-b border-gray-200">
                    <div className="flex items-center gap-2">
                        <div className="p-1.5 bg-white rounded-full border border-gray-200">
                            <Icon name={template.iconKey || 'template'} size={16}/>
                        </div>
                        <span className="text-sm font-medium text-[#333]">{template.name}</span>
                    </div>
                    <button onClick={onClose} className="p-1">
                        <Icon name="close" size={20} className="text-gray-400"/>
                    </button>
                </div>
                <div className="py-6 px-6 text-right bg-[#F5F5F3]">
                    <div className="text-4xl font-light text-[#333] tracking-tighter">${amountStr}</div>
                </div>
                
                {/* â˜… ä¿®æ”¹ï¼šæ”¹ç‚º 4 æ¬„ä½ˆå±€ï¼ŒåŠ å…¥ +, -, . */}
                <div className="bg-white grid grid-cols-4 p-2 gap-2 border-t border-gray-100">
                    {['7','8','9','AC','4','5','6','+','1','2','3','-','.','0','back','OK'].map(key => (
                        <button 
                            key={key} 
                            onClick={() => handleNumPad(key)} 
                            className={`h-14 rounded-lg text-xl font-light flex items-center justify-center transition active:bg-gray-100 
                                ${key === 'OK' ? 'bg-[#333] text-white shadow-md active:bg-black' : ['+','-','AC','back'].includes(key) ? 'bg-[#F9F9F9] text-gray-500' : 'text-[#333]'}`
                            }
                        >
                            {key === 'back' ? <Icon name="back" size={20}/> : key}
                        </button>
                    ))}
                </div>
            </div>
        </div>
    );
};

// ==========================================
// ä¿®æ­£ç‰ˆ SplitManager (å¯¦ä½œæ”¯å‡ºæ‹†åˆ†èˆ‡ä»£å¢Šé‚è¼¯)
// ==========================================
const SplitManager = () => {
    const { transactions, accounts, categories, handleSettleSplit: onSettle, showAlert: onAlert, triggerHaptic } = React.useContext(DataContext);
    const [selectedIds, setSelectedIds] = useState([]);
    const [isSettleModalOpen, setIsSettleModalOpen] = useState(false);
    
// â˜… ä¿®æ­£ï¼šå°‡ #ä»£è³¼ ä¹Ÿç´å…¥åˆ†å¸³æ¸…å–®
    const splitItems = useMemo(() => transactions.filter(t => t.type === 'expense' && t.tags && (t.tags.includes('#åˆ†å¸³') || t.tags.includes('#æ‡‰ä»˜') || t.tags.includes('#ä»£è³¼'))), [transactions]);
    const toggleSelect = (id) => setSelectedIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
    const toggleAll = () => selectedIds.length === splitItems.length ? setSelectedIds([]) : setSelectedIds(splitItems.map(t => t.id));
    
    // é€™æ˜¯åŸå§‹ç¸½æ·¨é¡ (ä¾‹å¦‚ 100å…ƒæ™šé¤ + 500å…ƒä»£è³¼ = 600)
    const netAmount = useMemo(() => {
        return splitItems.filter(t => selectedIds.includes(t.id)).reduce((sum, t) => {
            if (t.tags.includes('#åˆ†å¸³') || t.tags.includes('#ä»£è³¼')) return sum + t.amount; 
            if (t.tags.includes('#æ‡‰ä»˜')) return sum - t.amount; 
            return sum;
        }, 0);
    }, [splitItems, selectedIds]);

    // â˜… æ–°å¢ï¼šæ™ºæ…§ AA è¨ˆç®— (æ™šé¤/2 + ä»£è³¼ä¸é™¤ = 50 + 500 = 550)
    const suggestedHalfAmount = useMemo(() => {
        return splitItems.filter(t => selectedIds.includes(t.id)).reduce((sum, t) => {
            if (t.tags.includes('#ä»£è³¼')) return sum + t.amount; // ä»£è³¼éœ€ 100% æ”¶å›
            if (t.tags.includes('#åˆ†å¸³')) return sum + (t.amount / 2); // åˆ†å¸³é è¨­æ”¶å› 50%
            if (t.tags.includes('#æ‡‰ä»˜')) return sum - (t.amount / 2); // æ‡‰ä»˜é è¨­çµ¦ä»˜ 50%
            return sum;
        }, 0);
    }, [splitItems, selectedIds]);

    const handleExportImage = () => { 
        if (selectedIds.length === 0) return; 
        const itemsToDraw = splitItems.filter(t => selectedIds.includes(t.id)).map(t => { 
            const cat = categories.expense.find(c => c.id === t.categoryId); 
            return { 
                name: t.note || cat?.name || 'é …ç›®', 
                amount: t.amount,
                isOtherPaid: t.tags.includes('#æ‡‰ä»˜') 
            }; 
        }); 
        drawReceipt(itemsToDraw, netAmount).then(blob => { 
            const file = new File([blob], `bill_${getLocalDateString()}.jpg`, { type: 'image/jpeg' }); 
            if (navigator.share && navigator.canShare({ files: [file] })) { 
                navigator.share({ files: [file], title: 'åˆ†å¸³æ˜ç´°' }).catch(console.error); 
            } else { 
                const link = document.createElement('a'); 
                link.download = file.name; 
                link.href = URL.createObjectURL(blob); 
                document.body.appendChild(link); 
                link.click(); 
            } 
        }); 
    };

    // â˜… æ ¸å¿ƒä¿®æ­£é‚è¼¯
    const handleConfirmSettle = (finalAmount, targetAccountId, mode) => {
        if (finalAmount === 0) {
            onAlert('æç¤º', 'çµç®—é‡‘é¡ç‚º 0ï¼Œç„¡éœ€ç”¢ç”Ÿäº¤æ˜“');
            setIsSettleModalOpen(false);
            return;
        }
        let newTransactions = [...transactions];
        let newAccounts = [...accounts];

        // 1. ç”¢ç”Ÿçµç®—äº¤æ˜“ (æ”¶æ¬¾/ä»˜æ¬¾)
        // â˜… ä¿®æ­£ï¼šé¡å‹æ”¹ç‚º transfer (è½‰å¸³)ï¼Œé¿å…è¨ˆå…¥æ”¶å…¥/æ”¯å‡ºå ±è¡¨
        const isIncome = finalAmount > 0;
        const settleTx = {
            id: Date.now().toString(),
            createdAt: Date.now(),
            date: getLocalDateString(),
            amount: Math.abs(finalAmount),
            type: 'transfer', 
            categoryId: 'reimbursement',
            accountId: isIncome ? 'external_payer' : targetAccountId, // æ”¶æ¬¾æ™‚ä¾†æºæ˜¯å¤–éƒ¨ï¼Œä»˜æ¬¾æ™‚ä¾†æºæ˜¯è‡ªå·±
            targetAccountId: isIncome ? targetAccountId : 'external_receiver', // æ”¶æ¬¾æ™‚å­˜å…¥è‡ªå·±ï¼Œä»˜æ¬¾æ™‚è½‰çµ¦å¤–éƒ¨
            note: `åˆ†å¸³çµæ¸… (æ”¶å›ä»£å¢Š)`,
            tags: ['#å·²çµæ¸…']
        };
        newTransactions = [settleTx, ...newTransactions];
        
        // 2. æ›´æ–°å¸³æˆ¶é¤˜é¡ (ç¾é‡‘æµå¢åŠ /æ¸›å°‘)
        newAccounts = newAccounts.map(a => a.id === targetAccountId ? { ...a, balance: a.balance + finalAmount } : a);

        // 3. æ¨™è¨˜åŸå§‹äº¤æ˜“å·²çµæ¸…ï¼Œä¸¦è¨˜éŒ„æˆ‘çš„åˆ†æ”¤é¡ï¼ˆä¸æ›´å‹•å¯¦éš›ä»˜æ¬¾é‡‘é¡ï¼‰
        if (mode === 'half' || mode === 'full') {
            selectedIds.forEach(id => {
                const originalTx = transactions.find(t => t.id === id);
                if (!originalTx) return;

                if (originalTx.tags.includes('#åˆ†å¸³') || originalTx.tags.includes('#ä»£è³¼')) {
                    const originalAmount = originalTx.amount;
                    // è¨ˆç®—æˆ‘çš„å¯¦éš›åˆ†æ”¤é¡ï¼Œç”¨æ–¼çµ±è¨ˆé¡¯ç¤ºï¼ˆä»˜æ¬¾é‡‘é¡ä¸å‹•ï¼‰
                    let myShare;
                    if (mode === 'half') {
                        myShare = originalTx.tags.includes('#ä»£è³¼') ? 0 : Math.round(originalAmount / 2);
                    } else {
                        myShare = 0; // fullï¼šå°æ–¹å…¨é¡æ‰¿æ“”
                    }

                    // â˜… ä¿ç•™åŸå§‹ amountï¼ˆä¿¡ç”¨å¡å¯¦éš›ä»˜æ¬¾é‡‘é¡ï¼‰ï¼Œä»¥ splitMyShare è¨˜éŒ„æˆ‘çš„åˆ†æ”¤é¡ä¾›çµ±è¨ˆç”¨
                    newTransactions = newTransactions.map(t => {
                        if (t.id === id) {
                            return {
                                ...t,
                                splitMyShare: myShare,
                                tags: [...t.tags.filter(tag => tag !== '#åˆ†å¸³' && tag !== '#ä»£è³¼'), '#å·²çµæ¸…']
                            };
                        }
                        return t;
                    });
                } else {
                    // #æ‡‰ä»˜ï¼šå°æ–¹å·²å¢Šä»˜ï¼Œæˆ‘ä»˜æ¸…æ¬ æ¬¾å¾Œæ¨™è¨˜çµæ¸…å³å¯
                    newTransactions = newTransactions.map(t =>
                        t.id === id ? { ...t, tags: [...t.tags.filter(tag => tag !== '#æ‡‰ä»˜'), '#å·²çµæ¸…'] } : t
                    );
                }
            });
        } else {
            // è‡ªè¨‚é‡‘é¡æ¨¡å¼ï¼šæŒ‰æ¯”ä¾‹è¨ˆç®—å„ç­†åˆ†æ”¤é¡å¾Œæ¨™è¨˜å·²çµæ¸…
            const totalSelectedAmount = selectedIds.reduce((sum, id) => {
                const tx = transactions.find(t => t.id === id);
                return sum + (tx ? tx.amount : 0);
            }, 0);
            const reimbursedRatio = totalSelectedAmount > 0 ? Math.abs(finalAmount) / totalSelectedAmount : 0;

            selectedIds.forEach(id => {
                const originalTx = transactions.find(t => t.id === id);
                if (!originalTx) return;
                const filterTag = originalTx.tags.includes('#ä»£è³¼') ? '#ä»£è³¼' : (originalTx.tags.includes('#åˆ†å¸³') ? '#åˆ†å¸³' : '#æ‡‰ä»˜');
                // è¨ˆç®—æˆ‘å¯¦éš›è² æ“”çš„é‡‘é¡ = ç¸½é¡ - å°æ–¹å ±éŠ·æ¯”ä¾‹
                const myShare = Math.round(originalTx.amount * (1 - reimbursedRatio));
                newTransactions = newTransactions.map(t =>
                    t.id === id ? { ...t, splitMyShare: myShare, tags: [...t.tags.filter(tag => tag !== filterTag), '#å·²çµæ¸…'] } : t
                );
            });
        }

        onSettle(newTransactions, newAccounts);
        setIsSettleModalOpen(false);
        setSelectedIds([]);
        onAlert('æˆåŠŸ', 'å·²å®Œæˆçµæ¸…ï¼Œå ±éŠ·æ¬¾é …å·²å­˜å…¥å¸³æˆ¶');
    };

    return (
        <div className="h-full flex flex-col pt-10 px-6 pb-0 animate-fade-in">
            <div className="shrink-0 flex justify-between items-center mb-6">
                <h2 className="text-xl font-medium text-[#333] tracking-wide">åˆ†å¸³ç®¡ç†</h2>
                {splitItems.length > 0 && (
                    <button onClick={() => { if(triggerHaptic) triggerHaptic(); toggleAll(); }} className="text-xs text-gray-500 font-medium px-2 py-1 bg-white border border-gray-200 rounded hover:bg-gray-50 transition">
                        {selectedIds.length === splitItems.length ? 'å–æ¶ˆå…¨é¸' : 'å…¨é¸'}
                    </button>
                )}
            </div>

            <div className="flex-1 overflow-y-auto no-scrollbar space-y-3 pb-32">
                {splitItems.length === 0 ? (
                    <div className="text-center py-20 text-gray-400"><Icon name="check" size={48} className="mx-auto mb-4 text-gray-200"/><p>ç›®å‰ç„¡æœªçµæ¸…é …ç›®</p></div>
                ) : (
                    splitItems.map(t => { 
                        const cat = categories.expense.find(c => c.id === t.categoryId) || {}; 
                        
                        // â˜… ä¿®æ­£ï¼šç´°åˆ†ä¸‰ç¨®ç‹€æ…‹çš„åˆ¤æ–·
                        const isAdvance = t.tags.includes('#ä»£è³¼');
                        const isSplit = t.tags.includes('#åˆ†å¸³');
                        const isMyPay = isAdvance || isSplit; // åªè¦æ˜¯æˆ‘ä»˜å‡ºå»çš„éŒ¢ï¼Œéƒ½æ˜¯æ­£æ•¸

                        return (
                            <div key={t.id} onClick={() => { if(triggerHaptic) triggerHaptic(); toggleSelect(t.id); }} className={`bg-white p-4 rounded border transition cursor-pointer flex items-center gap-4 ${selectedIds.includes(t.id) ? 'border-[#333] shadow-md' : 'border-transparent shadow-sm hover:shadow-md'}`}>
                                <div className={`w-5 h-5 rounded-full border flex items-center justify-center transition ${selectedIds.includes(t.id) ? 'bg-[#333] border-[#333]' : 'border-gray-300'}`}>
                                    {selectedIds.includes(t.id) && <Icon name="check" size={12} className="text-white"/>}
                                </div>
                                <div className="flex-1 min-w-0">
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="font-medium text-[#333] text-sm truncate">{cat.name} <span className="text-xs font-normal text-gray-400 ml-1">{t.note}</span></span>
                                        <span className={`font-bold shrink-0 ${isMyPay ? 'text-[#333]' : 'text-red-500'}`}>
                                            {/* â˜… å¦‚æœæ˜¯æˆ‘ä»˜çš„(å«ä»£è³¼)å°±ä¸é¡¯ç¤ºè² è™Ÿ */}
                                            {isMyPay ? '' : '-'}${t.amount}
                                        </span>
                                    </div>
                                    <div className="text-xs text-gray-400 flex justify-between mt-1">
                                        <span>{t.date}</span>
                                        {/* â˜… ä¿®æ­£ï¼šçµ¦ä»£è³¼åŠ ä¸Šå°ˆå±¬çš„ç¶ è‰²æ¨™ç±¤ */}
                                        <span className={`text-[10px] px-1.5 py-0.5 rounded font-medium ${isAdvance ? 'bg-green-50 text-green-600' : isSplit ? 'bg-gray-100 text-gray-500' : 'bg-red-50 text-red-500'}`}>
                                            {isAdvance ? 'å¹«ä»£è³¼' : isSplit ? 'æˆ‘å…ˆå¢Š' : 'å°æ–¹å¢Š'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        ); 
                    })
                )}
            </div>

            {selectedIds.length > 0 && (
                <div className="fixed bottom-[64px] left-0 right-0 max-w-md mx-auto p-4 bg-white/95 backdrop-blur border-t border-gray-200 shadow z-30 flex flex-col gap-3">
                    <div className="flex justify-between items-start">
                        <div>
                            <span className="text-xs text-gray-400 uppercase tracking-wider block">ä»£å¢Šæ·¨é¡</span>
                            <span className="text-[10px] text-gray-400">é¸å– {selectedIds.length} ç­†</span>
                        </div>
                        <div className="text-right">
                            <span className={`text-xl font-medium block ${netAmount >= 0 ? 'text-[#333]' : 'text-red-500'}`}>
                                {netAmount >= 0 ? 'æˆ‘å¤šä»˜ ' : 'æˆ‘å°‘ä»˜ '}${Math.abs(netAmount).toLocaleString()}
                            </span>
                        </div>
                    </div>
                    <div className="flex gap-3">
                        <button onClick={() => { if(triggerHaptic) triggerHaptic(); handleExportImage(); }} className="flex-1 bg-gray-100 text-gray-600 py-3 rounded text-sm font-medium hover:bg-gray-200 transition flex items-center justify-center gap-2"><Icon name="image" size={16}/> åœ–ç‰‡</button>
                        <button onClick={() => { if(triggerHaptic) triggerHaptic(); setIsSettleModalOpen(true); }} className="flex-[1.5] bg-[#333] text-white py-3 rounded text-sm font-medium hover:bg-black transition">çµç®—</button>
                    </div>
                </div>
            )}
        {isSettleModalOpen && <SettleModal netAmount={netAmount} suggestedHalfAmount={suggestedHalfAmount} accounts={accounts} onClose={() => setIsSettleModalOpen(false)} onConfirm={handleConfirmSettle} />}        </div>
    );
};
// ==========================================
// ä¿®æ­£ç‰ˆ SettleModal (å‚³éçµç®—æ¨¡å¼ mode)
// ==========================================
const SettleModal = ({ netAmount, suggestedHalfAmount, accounts, onClose, onConfirm }) => {
    const [mode, setMode] = useState('half'); // half = æ™ºæ…§AA, full = å…¨é¡
    const [targetAcc, setTargetAcc] = useState(accounts[0]?.id);
    const [customAmount, setCustomAmount] = useState(''); 
    
    const finalAmount = useMemo(() => {
        if (mode === 'custom') return Number(customAmount) || 0;
        if (mode === 'full') return netAmount; // 100% æ”¶å›/æ”¯ä»˜
        return Math.round(suggestedHalfAmount); // â˜… ä¿®æ­£ï¼šå¥—ç”¨æ™ºæ…§ AA é‡‘é¡
    }, [mode, netAmount, suggestedHalfAmount, customAmount]);

    const isReceiving = finalAmount > 0;

    return (
        <div className="fixed inset-0 bg-black/50 z-[1300] flex items-center justify-center p-4 animate-fade-in">
            <div className="bg-white w-full max-w-sm rounded-xl p-6 animate-slide-up shadow-2xl relative">
                
                <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 p-2 active:scale-90 transition">
                    <Icon name="close" size={20}/>
                </button>

                <div className="text-center mb-6">
                    <h3 className="text-lg font-bold text-[#333]">çµç®—ç¢ºèª</h3>
                    <div className="mt-2 bg-gray-50 py-2 rounded">
                        <span className="text-xs text-gray-400 block mb-1">åŸå§‹æ·¨é¡</span>
                        <span className={`text-xl font-medium ${netAmount >= 0 ? 'text-[#333]' : 'text-red-500'}`}>
                            {netAmount >= 0 ? 'æˆ‘å¤šä»˜ ' : 'æˆ‘å°‘ä»˜ '}${Math.abs(netAmount)}
                        </span>
                    </div>
                </div>
                
                <div className="space-y-3 mb-6">
                    <label className="text-xs text-gray-400 uppercase block mb-1">çµç®—æ¨¡å¼</label>
                    <div className="flex bg-gray-100 p-1 rounded-lg mb-3">
                        <button onClick={() => setMode('half')} className={`flex-1 py-2 text-xs font-medium rounded transition ${mode === 'half' ? 'bg-white text-[#333] shadow-sm' : 'text-gray-500'}`}>AAåˆ¶ (/2)</button>
                        <button onClick={() => setMode('full')} className={`flex-1 py-2 text-xs font-medium rounded transition ${mode === 'full' ? 'bg-white text-[#333] shadow-sm' : 'text-gray-500'}`}>å…¨é¡</button>
                        <button onClick={() => setMode('custom')} className={`flex-1 py-2 text-xs font-medium rounded transition ${mode === 'custom' ? 'bg-white text-[#333] shadow-sm' : 'text-gray-500'}`}>è‡ªè¨‚</button>
                    </div>

                    <div className="w-full py-3 px-4 rounded border border-gray-200 flex justify-between items-center bg-white">
                        <div className="text-left">
                            <div className="text-sm font-medium text-[#333]">
                                {mode === 'half' ? 'æ™ºæ…§ AA (ä»£è³¼å…¨é¡, å¢Šä»˜å¹³åˆ†)' : mode === 'full' ? 'å…¨é¡çµæ¸…' : 'è‡ªè¨‚é‡‘é¡'}
                            </div>
                            <div className="text-xs text-gray-400">
                                {mode === 'custom' ? 'è«‹è¼¸å…¥é‡‘é¡' : 'ç³»çµ±è‡ªå‹•è¨ˆç®—'}
                            </div>
                        </div>
                        {mode === 'custom' ? (
                            <input 
                                type="number" 
                                value={customAmount} 
                                onChange={(e) => setCustomAmount(e.target.value)} 
                                placeholder="0"
                                className="w-24 text-right text-lg font-bold text-[#333] outline-none border-b border-gray-300 focus:border-[#333] bg-transparent"
                                autoFocus
                            />
                        ) : (
                            <div className={`text-lg font-bold ${finalAmount > 0 ? 'text-[#333]' : 'text-red-500'}`}>
                                {finalAmount > 0 ? '+' : ''}{Math.abs(finalAmount)}
                            </div>
                        )}
                    </div>

                    <div className="pt-2">
                        <label className="text-xs text-gray-400 block mb-2 uppercase">{isReceiving ? 'æ”¶æ¬¾å­˜å…¥å¸³æˆ¶' : 'ä»˜æ¬¾å¸³æˆ¶'}</label>
                        <div className="bg-gray-50 border border-gray-200 rounded px-3 py-2 flex items-center gap-2">
                            <Icon name="wallet" size={16} className="text-gray-400"/>
                            <select className="bg-transparent w-full text-sm outline-none text-[#333]" value={targetAcc} onChange={e => setTargetAcc(e.target.value)}>
                                {accounts.map(a => <option key={a.id} value={a.id}>{a.name} (${a.balance})</option>)}
                            </select>
                        </div>
                    </div>
                </div>

                <div className="flex gap-3 pt-2">
                    <button onClick={onClose} className="flex-1 py-3 text-gray-500 bg-gray-100 rounded-lg font-medium hover:bg-gray-200 transition">å–æ¶ˆ</button>
                    {/* â˜… ä¿®æ­£ï¼šå°‡ mode ä¸€ä½µå‚³å‡º */}
                    <button onClick={() => onConfirm(finalAmount, targetAcc, mode)} className="flex-[1.5] py-3 bg-[#333] text-white rounded-lg font-medium shadow-lg hover:bg-black transition">
                        ç¢ºèª{isReceiving ? 'æ”¶æ¬¾' : 'æ”¯ä»˜'}
                    </button>
                </div>
            </div>
        </div>
    );
};
// ==========================================
// ä¿®æ­£ç‰ˆ AssetsView (æ¨£å¼åŒæ­¥é¦–é ï¼šå¤§å­—é«”ç„¡æ¡†ç·š)
// ==========================================
const AssetsView = ({ onSelectAccount, onAddAccount, onEditAccount }) => {
    const { 
        accounts, handleReorderAccounts, handleSaveTransaction, 
        triggerHaptic, isPrivacyMode, togglePrivacy, 
        transactions, recurringItems // â˜… è£œä¸Šï¼šç”¨ä¾†æŠ“å–åˆ†æœŸè¨ˆç•«
    } = React.useContext(DataContext);
    
    const [isReordering, setIsReordering] = useState(false);
    const [localAccounts, setLocalAccounts] = useState(accounts);
    const [repayModal, setRepayModal] = useState(null); 

    useEffect(() => { setLocalAccounts(accounts); }, [accounts]);

    // è¨ˆç®—ç¸½è³‡ç”¢èˆ‡ç¸½è² å‚µ
    const assetSummary = React.useMemo(() => {
        let totalAssets = 0;
        let totalLiabilities = 0;
        
        accounts.forEach(acc => {
            if (acc.balance > 0) totalAssets += acc.balance;
            if (acc.balance < 0) totalLiabilities += acc.balance;
        });

        return { totalAssets, totalLiabilities, netWorth: totalAssets + totalLiabilities };
    }, [accounts]);

    const getDueWarning = (dueDay) => {
        if (!dueDay) return null;
        const today = new Date();
        const currentDay = today.getDate();
        let targetDate = new Date(today.getFullYear(), today.getMonth(), dueDay);
        if (currentDay > dueDay) targetDate.setMonth(targetDate.getMonth() + 1);
        const diffTime = targetDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        if (diffDays >= 0 && diffDays <= 7) return { days: diffDays, urgent: diffDays <= 3 };
        return null;
    };

    const getGroupType = (type) => {
        if (type === 'cash') return 'cash';
        if (type === 'bank' || type === 'stock') return 'bank';
        if (type === 'liability') return 'liability';
        return 'other';
    };

    const moveAccount = (accId, direction) => {
        const targetAcc = localAccounts.find(a => a.id === accId);
        if (!targetAcc) return;
        const targetGroup = getGroupType(targetAcc.type);
        const groupItems = localAccounts.filter(a => getGroupType(a.type) === targetGroup).sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));
        const index = groupItems.findIndex(a => a.id === accId);
        if (index === -1) return;
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= groupItems.length) return;
        const temp = groupItems[index];
        groupItems[index] = groupItems[newIndex];
        groupItems[newIndex] = temp;
        const updates = {};
        groupItems.forEach((item, idx) => { updates[item.id] = idx; });
        const newLocalAccounts = localAccounts.map(a => { if (updates[a.id] !== undefined) { return { ...a, sortOrder: updates[a.id] }; } return a; });
        setLocalAccounts(newLocalAccounts);
    };

    const saveReorder = () => { handleReorderAccounts(localAccounts); setIsReordering(false); };
    
    const groupAccounts = (accs) => {
        const sorted = [...accs].sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));
        return {
            cash: sorted.filter(a => a.type === 'cash'),
            bank: sorted.filter(a => a.type === 'bank' || a.type === 'stock'),
            liability: sorted.filter(a => a.type === 'liability')
        };
    };

    const groups = groupAccounts(localAccounts);
    
// â˜… å‡ç´šç‰ˆï¼šæ™ºæ…§è¨ˆç®—æœ¬æœŸå¸³å–®èˆ‡æœªå‡ºå¸³
    const openRepayModal = (acc) => {
        const totalDebt = Math.abs(acc.balance);
        let unbilled = 0;
        let billed = totalDebt;

        if (acc.billDay) {
            const today = new Date();
            let billYear = today.getFullYear();
            let billMonth = today.getMonth(); // 0-11
            // å¦‚æœä»Šå¤©é‚„æ²’åˆ°çµå¸³æ—¥ï¼Œé‚£ã€Œä¸Šä¸€æ¬¡çµå¸³æ—¥ã€æ˜¯ä¸Šå€‹æœˆ
            if (today.getDate() < acc.billDay) {
                billMonth -= 1;
                if (billMonth < 0) { billMonth = 11; billYear -= 1; }
            }
            // æ‰¾å‡ºä¸Šä¸€æ¬¡çµå¸³æ—¥çš„æ—¥æœŸå­—ä¸²
            const lastBillDateStr = `${billYear}-${String(billMonth + 1).padStart(2, '0')}-${String(acc.billDay).padStart(2, '0')}`;
            
            // æŠ“å‡ºé€™å¼µå¡åœ¨ã€Œä¸Šä¸€æ¬¡çµå¸³æ—¥ä¹‹å¾Œã€çš„æ‰€æœ‰äº¤æ˜“ (å³æœªå‡ºå¸³)
            const accTxs = transactions.filter(t => t.accountId === acc.id || t.targetAccountId === acc.id);
            unbilled = accTxs.filter(t => t.date > lastBillDateStr).reduce((sum, t) => {
                if (t.type === 'expense') return sum + t.amount;
                if (t.type === 'income') return sum - t.amount;
                if (t.type === 'transfer') {
                    if (t.accountId === acc.id) return sum + t.amount; // è½‰å‡º = è² å‚µå¢åŠ 
                    if (t.targetAccountId === acc.id) return sum - t.amount; // è½‰å…¥ = é‚„æ¬¾
                }
                return sum;
            }, 0);

            // é˜²å‘†è™•ç†
            if (unbilled < 0) unbilled = 0;
            if (unbilled > totalDebt) unbilled = totalDebt;
            billed = totalDebt - unbilled;
        }

        const payAcc = accounts.find(a => a.type === 'bank') || accounts[0];
        setRepayModal({ 
            targetAcc: acc, 
            payAccId: payAcc.id, 
            amount: billed > 0 ? billed : totalDebt, 
            billed, 
            unbilled, 
            totalDebt,
            mode: billed > 0 ? 'billed' : 'total' 
        });
    };

    const confirmRepay = () => {
        if (!repayModal) return;
        handleSaveTransaction({
            id: Date.now().toString(),
            createdAt: Date.now(),
            date: getLocalDateString(),
            amount: Number(repayModal.amount),
            type: 'transfer',
            accountId: repayModal.payAccId,
            targetAccountId: repayModal.targetAcc.id,
            note: `ä¿¡ç”¨å¡ç¹³è²» (${repayModal.mode === 'billed' ? 'æœ¬æœŸå¸³å–®' : repayModal.mode === 'total' ? 'å…¨é¡çµæ¸…' : 'è‡ªè¨‚é‡‘é¡'})`,
            tags: []
        });
        setRepayModal(null);
        if(triggerHaptic) triggerHaptic();
    };

const renderAccountCard = (acc) => {
        const warning = (acc.type === 'liability' && acc.dueDay) ? getDueWarning(acc.dueDay) : null;
        const isLiability = acc.type === 'liability';
        const hasLimit = isLiability && acc.limit > 0;
        
        // â˜… ä¿®æ­£ 1ï¼šç²¾æº–è¨ˆç®—ã€Œå·²ç”¨é¡åº¦ã€= æœ¬æœŸæ¬ æ¬¾ + é€±æœŸç®¡ç†ä¸­çš„æœªå‡ºå¸³åˆ†æœŸ
        let unbilledInstallments = 0;
        if (isLiability) {
            unbilledInstallments = recurringItems
                .filter(item => item.accountId === acc.id && item.active !== false && item.totalPeriods > 0)
                .reduce((sum, item) => {
                    const remainingPeriods = Math.max(0, item.totalPeriods - (item.executedPeriods || 0));
                    if (remainingPeriods === 0) return sum;
                    
                    let totalForThisItem = 0;
                    let regularPeriodsLeft = remainingPeriods;
                    
                    // â˜… ä¿®æ­£ï¼šå¦‚æœå‰©é¤˜æœŸæ•¸åŒ…å«æœ€å¾Œä¸€æœŸï¼Œä¸”æœ‰è¨­å®šç‰¹æ®Šæœ«æœŸé‡‘é¡
                    if (item.lastPeriodAmount != null) {
                        totalForThisItem += (Number(item.lastPeriodAmount) + Number(item.interest || 0));
                        regularPeriodsLeft -= 1;
                    }
                    
                    if (regularPeriodsLeft > 0) {
                        totalForThisItem += ((Number(item.amount) + Number(item.interest || 0)) * regularPeriodsLeft);
                    }
                    return sum + totalForThisItem;
                }, 0);
        }

        const totalUsed = Math.abs(acc.balance) + unbilledInstallments;
        const usagePercent = hasLimit ? Math.min(100, (totalUsed / acc.limit) * 100) : 0;
        const remainingLimit = hasLimit ? Math.max(0, acc.limit - totalUsed) : 0;        
        return (
            <div key={acc.id} onClick={() => !isReordering && onSelectAccount(acc.id)} className={`bg-white dark:bg-[#36393F] p-4 rounded border border-transparent shadow-sm flex flex-col relative group ${!isReordering && 'hover:shadow-md hover:border-gray-200 dark:hover:border-gray-600 cursor-pointer transition'}`}>
                {/* ä¸ŠåŠéƒ¨ï¼šåŸæœ‰çš„æ¨™é¡Œèˆ‡é¤˜é¡ */}
                <div className="flex items-center justify-between w-full">
                    <div className="flex items-center gap-4">
                        <div className="w-10 h-10 rounded-full bg-[#F0F0F0] dark:bg-gray-700 text-[#555] dark:text-gray-300 relative flex items-center justify-center shrink-0">
                            <Icon name={acc.type === 'cash' ? 'banknote' : isLiability ? 'creditCard' : 'wallet'} size={20}/>
                            {warning && !isReordering && <div className="absolute -top-1 -right-1 w-3 h-3 bg-[#D9534F] rounded-full border-2 border-white dark:border-[#36393F]"></div>}
                        </div>
                        <div>
                            <div className="text-sm font-medium text-[#333] dark:text-white flex items-center gap-2">
                                {acc.name}
                                {warning && !isReordering && <span className={`text-[9px] px-1.5 py-0.5 rounded font-bold ${warning.urgent ? 'bg-red-100 text-[#D9534F]' : 'bg-orange-100 text-orange-600'}`}>{warning.days === 0 ? 'ä»Šæ—¥é‚„æ¬¾' : `å‰© ${warning.days} å¤©`}</span>}
                            </div>
                            <div className="text-[10px] text-gray-400 uppercase tracking-wider flex gap-2">
                                {acc.type === 'cash' ? 'ç¾é‡‘' : isLiability ? 'è² å‚µ/ä¿¡ç”¨å¡' : 'éŠ€è¡Œ/æ•¸ä½'}
                            </div>
                        </div>
                    </div>
                    {isReordering ? (
                        <div className="flex items-center gap-2">
                            <button onClick={(e) => { e.stopPropagation(); moveAccount(acc.id, -1); }} className="p-2 text-gray-400 hover:text-[#333] dark:hover:text-white active:bg-gray-100 dark:active:bg-gray-700 rounded"><Icon name="chevronUp" size={20}/></button>
                            <button onClick={(e) => { e.stopPropagation(); moveAccount(acc.id, 1); }} className="p-2 text-gray-400 hover:text-[#333] dark:hover:text-white active:bg-gray-100 dark:active:bg-gray-700 rounded"><Icon name="chevronDown" size={20}/></button>
                        </div>
                    ) : (
                        <div className="flex items-center gap-3">
                            {isLiability && acc.balance < 0 && (
                                <button onClick={(e) => { e.stopPropagation(); openRepayModal(acc); }} className="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-xs text-gray-600 dark:text-gray-300 rounded hover:bg-[#333] hover:text-white transition">é‚„æ¬¾</button>
                            )}
                            {/* â˜… é€™è£¡ä¿ç•™ä½ å–œæ­¡çš„è² æ•¸è¡¨é” */}
                            <div className={`text-base font-medium ${isPrivacyMode ? 'text-[#333] dark:text-white' : (acc.balance < 0 ? 'text-[#D9534F]' : 'text-[#333] dark:text-white')}`}>
                                {isPrivacyMode ? '****' : `$${formatMoney(acc.balance)}`}
                            </div>
                            <button onClick={(e) => { e.stopPropagation(); onEditAccount(acc); }} className="p-2 text-gray-300 hover:text-gray-500"><Icon name="edit" size={14} /></button>
                        </div>
                    )}
                </div>

                {/* â˜… æ–°å¢ï¼šä¸‹åŠéƒ¨ é¡åº¦é€²åº¦æ¢ */}
                {hasLimit && !isReordering && (
                    <div className="w-full mt-3 pt-3 border-t border-gray-50 dark:border-gray-700">
                        <div className="flex justify-between text-[10px] text-gray-400 mb-1.5 tracking-widest font-medium">
                            {/* â˜… ä¿®æ­£ 2ï¼šç›´è§€é¡¯ç¤ºå‰©é¤˜é¡åº¦ï¼Œå¿«çˆ†æ‰æ™‚è®Šç´…å­— */}
                            <span>å‰©é¤˜é¡åº¦ <span className={usagePercent >= 90 ? 'text-[#D9534F]' : 'text-[#333] dark:text-white'}>${formatMoney(remainingLimit)}</span></span>
                            <span>ç¸½é¡åº¦ ${formatMoney(acc.limit)}</span>
                        </div>
                        <div className="h-1.5 w-full bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div 
                                className={`h-full rounded-full transition-all duration-1000 ${usagePercent >= 90 ? 'bg-[#D9534F]' : usagePercent >= 70 ? 'bg-yellow-400' : 'bg-[#333] dark:bg-white opacity-70'}`}
                                style={{ width: `${usagePercent}%` }}
                            ></div>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    return (
        <div className="h-full flex flex-col pt-10 px-6 pb-0 animate-fade-in relative">
            <div className="shrink-0 mb-2">
                <div className="flex justify-between items-center mb-2">
                    <h2 className="text-xl font-medium text-[#333] dark:text-white tracking-wide">å¸³æˆ¶ç¸½è¦½</h2>
                    <div className="flex gap-2">
                        {isReordering ? <button onClick={saveReorder} className="text-xs bg-[#333] text-white px-3 py-1.5 rounded shadow-sm">å®Œæˆ</button> : <button onClick={() => setIsReordering(true)} className="text-xs text-gray-500 px-2 py-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition">èª¿æ•´é †åº</button>}
                        {!isReordering && <button onClick={onAddAccount} className="w-8 h-8 rounded-full bg-white dark:bg-[#36393F] border border-gray-200 dark:border-gray-600 flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-[#333] hover:text-white transition"><Icon name="plus" size={16}/></button>}
                    </div>
                </div>

                {/* â˜… ä¿®æ”¹é‡é»ï¼šæ¯”ç…§é¦–é çš„æ¨£å¼ (å¤§å­—é«”ã€ä¸¦åˆ—ã€éš±ç§é–‹é—œ) */}
                <div className="flex justify-between items-end mb-2"> 
                    {/* å·¦å´ï¼šç¸½è³‡ç”¢ (ç¶ è‰²) */}
                    <div>
                        <div className="text-xs text-gray-400 mb-1 tracking-widest font-medium uppercase flex items-center gap-2">
                            ç¸½è³‡ç”¢ (ç¾é‡‘/å­˜æ¬¾)
                            <button onClick={togglePrivacy} className="text-gray-300 hover:text-gray-500 transition">
                                <Icon name={isPrivacyMode ? "eyeOff" : "eye"} size={14} /> 
                            </button>
                        </div>
                        <div className="text-3xl font-light text-[#5CB85C] tracking-tight">
                            {isPrivacyMode ? '****' : <><span className="text-lg mr-1 font-normal">$</span>{formatMoney(assetSummary.totalAssets)}</>}
                        </div>
                    </div>
                    
                    {/* å³å´ï¼šç¸½è² å‚µ (ç´…è‰²) */}
                    <div className="text-right">
                        <div className="text-xs text-gray-400 mb-1 tracking-widest font-medium uppercase">
                            ç¸½è² å‚µ (ä¿¡ç”¨å¡/è²¸æ¬¾)
                        </div>
                        <div className="text-3xl font-light text-[#D9534F] tracking-tight">
                            {isPrivacyMode ? '****' : <><span className="text-lg mr-1 font-normal">$</span>{formatMoney(Math.abs(assetSummary.totalLiabilities))}</>}
                        </div>
                    </div>
                </div>
                
                {/* æ·¨å€¼é¡¯ç¤º (ä¿ç•™åœ¨å³ä¸‹è§’è¼”åŠ©) */}
                <div className="text-right text-xs text-gray-400 mb-4 tracking-widest font-medium">
                    æ·¨å€¼: {isPrivacyMode ? '****' : `$${formatMoney(assetSummary.netWorth)}`}
                </div>
            </div>

            <div className="flex-1 overflow-y-auto no-scrollbar space-y-6 pb-20">
                {groups.cash.length > 0 && <div><h3 className="text-xs text-gray-400 mb-2 uppercase tracking-widest pl-1">ç¾é‡‘éŒ¢åŒ…</h3><div className="space-y-3">{groups.cash.map(renderAccountCard)}</div></div>}
                {groups.bank.length > 0 && <div><h3 className="text-xs text-gray-400 mb-2 uppercase tracking-widest pl-1">éŠ€è¡Œèˆ‡æ•¸ä½å¸³æˆ¶</h3><div className="space-y-3">{groups.bank.map(renderAccountCard)}</div></div>}
                {groups.liability.length > 0 && <div><h3 className="text-xs text-gray-400 mb-2 uppercase tracking-widest pl-1">ä¿¡ç”¨å¡èˆ‡è² å‚µ</h3><div className="space-y-3">{groups.liability.map(renderAccountCard)}</div></div>}
            </div>

            {/* â˜… å‡ç´šç‰ˆé‚„æ¬¾è¦–çª— */}
            {repayModal && (
                <div className="fixed inset-0 z-[1200] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-fade-in">
                    <div className="bg-white dark:bg-[#36393F] w-full max-w-sm rounded-xl p-6 shadow-xl animate-scale-up relative">
                        <button onClick={() => setRepayModal(null)} className="absolute top-4 right-4 p-2 text-gray-400 hover:text-[#333]"><Icon name="close" size={20}/></button>
                        <h3 className="text-lg font-bold text-[#333] dark:text-white mb-4">ä¿¡ç”¨å¡ç¹³è²»</h3>
                        
                        {/* æ™ºæ…§åˆ†å¸³æŒ‰éˆ• */}
                        {repayModal.targetAcc.billDay && (
                            <div className="flex bg-gray-100 dark:bg-[#2B2D30] p-1 rounded-lg mb-4">
                                <button onClick={() => setRepayModal({...repayModal, mode: 'billed', amount: repayModal.billed})} className={`flex-1 py-1.5 text-xs font-medium rounded transition flex flex-col items-center ${repayModal.mode === 'billed' ? 'bg-white dark:bg-[#40444B] text-[#333] dark:text-white shadow-sm' : 'text-gray-500'}`}>
                                    <span>æœ¬æœŸå¸³å–®</span><span className="text-[10px] font-normal">${formatMoney(repayModal.billed)}</span>
                                </button>
                                <button onClick={() => setRepayModal({...repayModal, mode: 'total', amount: repayModal.totalDebt})} className={`flex-1 py-1.5 text-xs font-medium rounded transition flex flex-col items-center ${repayModal.mode === 'total' ? 'bg-white dark:bg-[#40444B] text-[#333] dark:text-white shadow-sm' : 'text-gray-500'}`}>
                                    <span>å…¨éƒ¨çµæ¸…</span><span className="text-[10px] font-normal">${formatMoney(repayModal.totalDebt)}</span>
                                </button>
                                <button onClick={() => setRepayModal({...repayModal, mode: 'custom'})} className={`flex-1 py-1.5 text-xs font-medium rounded transition flex flex-col items-center ${repayModal.mode === 'custom' ? 'bg-white dark:bg-[#40444B] text-[#333] dark:text-white shadow-sm' : 'text-gray-500'}`}>
                                    <span>è‡ªè¨‚é‡‘é¡</span><span className="text-[10px] font-normal">--</span>
                                </button>
                            </div>
                        )}

                        <div className="space-y-4">
                            <div>
                                <label className="text-xs text-gray-400 block mb-1">æœ¬æ¬¡ç¹³ç´é‡‘é¡</label>
                                <input type="number" value={repayModal.amount} onChange={e => setRepayModal({...repayModal, amount: e.target.value, mode: 'custom'})} className="w-full border-b border-gray-300 dark:border-gray-600 bg-transparent py-1 text-2xl font-bold outline-none text-[#333] dark:text-white" />
                            </div>
                            <div>
                                <label className="text-xs text-gray-400 block mb-2">ä»˜æ¬¾å¸³æˆ¶ (è½‰å‡º)</label>
                                <select value={repayModal.payAccId} onChange={e => setRepayModal({...repayModal, payAccId: e.target.value})} className="w-full bg-white dark:bg-[#40444B] border border-gray-200 dark:border-gray-600 p-2 rounded text-sm outline-none text-[#333] dark:text-white">
                                    {accounts.filter(a => a.type !== 'liability').map(a => <option key={a.id} value={a.id}>{a.name} (${a.balance})</option>)}
                                </select>
                            </div>
                        </div>
                        <div className="flex gap-3 mt-6">
                            <button onClick={() => setRepayModal(null)} className="flex-1 py-3 text-gray-500 bg-gray-100 dark:bg-gray-700 rounded-lg font-medium hover:bg-gray-200 transition">å–æ¶ˆ</button>
                            <button onClick={confirmRepay} className="flex-[1.5] py-3 bg-[#333] dark:bg-white text-white dark:text-black rounded-lg font-medium shadow-lg hover:bg-black transition">ç¢ºèªç¹³è²»</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};
// ==========================================
// SettingsView (å„ªåŒ–ï¼šè¨­å®šé é¢-è³‡æ–™ç®¡ç†ä»‹é¢æ•´åˆ)
// ==========================================

const SettingsView = ({ onChangeTab }) => {
    const [isCloudExpanded, setIsCloudExpanded] = useState(false);

    // å¾ Context å–å¾—è³‡æ–™èˆ‡æ–¹æ³•
    const { 
        cloudSettings, setCloudSettings,
        handleExportData, handleExportCSV,
        handleImportData,
        handleManualRestore, handleCloudBackup,
        showConfirm,
        isDarkMode, toggleTheme, // ç¢ºä¿é€™è£¡æœ‰å–å‡ºæ·±è‰²æ¨¡å¼æ§åˆ¶
        autoSmsEnabled, setAutoSmsEnabled
    } = React.useContext(DataContext);

    const handleReset = () => {
        showConfirm('é‡ç½®', 'ç¢ºå®šåˆªé™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ', () => {
            localStorage.clear();
            window.location.reload();
        });
    };

    // æŠ½å‡ºä¸€å€‹å…±ç”¨çš„ Section Title å…ƒä»¶ï¼Œä¿æŒé¢¨æ ¼ä¸€è‡´
    const SectionTitle = ({ title }) => (
        <div className="text-xs text-gray-400 font-medium mb-2 mt-6 uppercase tracking-widest pl-1">
            {title}
        </div>
    );

    // æŠ½å‡ºè³‡æ–™æ“ä½œå°å¡ç‰‡
    const ActionCard = ({ icon, title, subtitle, onClick, colorClass = "text-[#333]", hoverClass = "hover:border-gray-300", children }) => (
        <div 
            onClick={onClick} 
            className={`bg-white p-3 rounded border border-transparent shadow-sm flex flex-col justify-center gap-2 cursor-pointer transition relative group ${hoverClass}`}
        >
            {children}
            <div className="flex items-center gap-2">
                <Icon name={icon} size={20} className={`${colorClass} opacity-80 group-hover:opacity-100 transition`} />
                <span className={`text-sm font-medium ${colorClass}`}>{title}</span>
            </div>
            <div className="text-[10px] text-gray-400">{subtitle}</div>
        </div>
    );

    return (
        <div className="h-full flex flex-col pt-10 px-6 pb-0 animate-fade-in">
            <div className="shrink-0 mb-2">
                <h2 className="text-xl font-medium text-[#333] tracking-wide">è¨­å®š</h2>
            </div>

            <div className="flex-1 overflow-y-auto no-scrollbar pb-24">
                
                {/* 1. ä¸€èˆ¬è¨­å®šå€å¡Š */}
                <SectionTitle title="ä¸€èˆ¬" />
                <div className="space-y-3">
                    <div onClick={toggleTheme}>
                        <SettingItem 
                            iconName={isDarkMode ? "moon" : "sun"} // è«‹ç¢ºèª IconPaths æœ‰ moon/sunï¼Œè‹¥ç„¡å¯ç”¨ image/search ä»£æ›¿
                            label={isDarkMode ? "å¤–è§€ï¼šæ·±è‰²æ¨¡å¼" : "å¤–è§€ï¼šæ·ºè‰²æ¨¡å¼"} 
                            className="transition-colors"
                        />
                    </div>
                    <div className="bg-white dark:bg-[#36393F] p-4 rounded border border-transparent shadow-sm flex items-center justify-between transition">
                        <div className="flex items-center gap-3">
                            <Icon name="phone" size={18} className="text-gray-400" />
                            <span className="text-sm text-gray-600 dark:text-gray-300">è‡ªå‹•è®€å–å‰ªè²¼ç°¿ (ç°¡è¨Šè¨˜å¸³)</span>
                        </div>
                        <div onClick={() => setAutoSmsEnabled(!autoSmsEnabled)} className={`w-9 h-5 rounded-full relative cursor-pointer transition-colors duration-300 ${autoSmsEnabled ? 'bg-[#333] dark:bg-white' : 'bg-gray-200 dark:bg-gray-600'}`}>
                            <div className={`w-3.5 h-3.5 bg-white dark:bg-[#333] rounded-full absolute top-0.5 shadow-sm transition-transform duration-300 ${autoSmsEnabled ? 'left-5' : 'left-0.5'}`}></div>
                        </div>
                    </div>
                    <div onClick={() => onChangeTab('templates')}><SettingItem iconName="lightning" label="å¿«é€Ÿè¨˜å¸³æ¨¡æ¿" hasArrow /></div>
                    <div onClick={() => onChangeTab('categories')}><SettingItem iconName="list" label="åˆ†é¡ç®¡ç†" hasArrow /></div>
                    <div onClick={() => onChangeTab('recurring')}><SettingItem iconName="calendar" label="é€±æœŸå¸³å–® / åˆ†æœŸ" hasArrow /></div>
                </div>

                {/* 2. è³‡æ–™èˆ‡å‚™ä»½å€å¡Š */}
                <SectionTitle title="è³‡æ–™åŒæ­¥" />
                
                {/* é›²ç«¯å‚™ä»½ (ç¨ç«‹å¡ç‰‡) */}
                <div className="bg-white rounded border border-transparent shadow-sm overflow-hidden transition hover:shadow-md">
                    <div 
                        onClick={() => setIsCloudExpanded(!isCloudExpanded)}
                        className="p-4 flex items-center justify-between cursor-pointer"
                    >
                        <div className="flex items-center gap-3">
                            <div className={`w-9 h-9 rounded-full flex items-center justify-center transition ${cloudSettings.url ? 'bg-green-50 text-green-600 dark:bg-green-900/30 dark:text-green-400' : 'bg-gray-100 text-gray-400 dark:bg-gray-700'}`}>
                                <Icon name="cloud" size={18} />
                            </div>
                            <div>
                                <div className="text-sm text-[#333] font-medium">Google Drive åŒæ­¥</div>
                                <div className="text-[10px] text-gray-400">
                                    {cloudSettings.url ? 'â— å·²é€£ç·š' : 'æœªè¨­å®š'}
                                </div>
                            </div>
                        </div>
                        <Icon name={isCloudExpanded ? "chevronDown" : "chevronRight"} size={16} className="text-gray-300" />
                    </div>
                    
                    {/* å±•é–‹å…§å®¹ */}
                        {isCloudExpanded && (
                            <div className="p-4 pt-0 space-y-4 animate-fade-in border-t border-gray-50 dark:border-gray-700">
                                <div className="text-[10px] text-gray-400 leading-relaxed pt-3">
                                    è¨­å®š GAS URL ä»¥å•Ÿç”¨é›²ç«¯åŒæ­¥ã€‚
                                </div>
                                
                                <div className="space-y-3">
                                    {/* è¼¸å…¥æ¬„ä½ */}
                                    <div className="space-y-2">
                                        <input 
                                            type="text" 
                                            placeholder="API URL" 
                                            value={cloudSettings.url || ''}
                                            onChange={(e) => setCloudSettings(prev => ({ ...prev, url: e.target.value }))}
                                            className="w-full bg-gray-50 dark:bg-[#40444B] border border-gray-200 dark:border-gray-600 rounded p-2 text-xs outline-none focus:border-[#333] transition"
                                        />
                                        <input 
                                            type="password" 
                                            placeholder="å¯†ç¢¼ (é¸å¡«)" 
                                            value={cloudSettings.password || ''}
                                            onChange={(e) => setCloudSettings(prev => ({ ...prev, password: e.target.value }))}
                                            className="w-full bg-gray-50 dark:bg-[#40444B] border border-gray-200 dark:border-gray-600 rounded p-2 text-xs outline-none focus:border-[#333] transition"
                                        />
                                    </div>

                                    {/* é–‹é—œå€å¡Š */}
                                    <div className="space-y-3 px-1 my-3">
                                        {/* 1. å•Ÿå‹•æª¢æŸ¥é–‹é—œ */}
                                        <div className="flex items-center justify-between">
                                            <span className="text-xs text-gray-500 dark:text-gray-400">App å•Ÿå‹•æ™‚æª¢æŸ¥é‚„åŸ</span>
                                            <div 
                                                onClick={() => setCloudSettings(prev => ({ ...prev, autoCheck: !prev.autoCheck }))}
                                                className={`w-9 h-5 rounded-full relative cursor-pointer transition-colors duration-300 ${cloudSettings.autoCheck ? 'bg-[#333] dark:bg-white' : 'bg-gray-200 dark:bg-gray-600'}`}
                                            >
                                                <div className={`w-3.5 h-3.5 bg-white dark:bg-[#333] rounded-full absolute top-0.5 shadow-sm transition-transform duration-300 ${cloudSettings.autoCheck ? 'left-5' : 'left-0.5'}`}></div>
                                            </div>
                                        </div>

                                        {/* 2. â˜… æ–°å¢ï¼šè‡ªå‹•å‚™ä»½é–‹é—œ */}
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <div className="text-xs text-gray-500 dark:text-gray-400">è³‡æ–™è®Šæ›´å¾Œè‡ªå‹•å‚™ä»½</div>
                                                <div className="text-[9px] text-gray-300">è®Šæ›´å¾Œ 5 ç§’è‡ªå‹•ä¸Šå‚³</div>
                                            </div>
                                            <div 
                                                onClick={() => setCloudSettings(prev => ({ ...prev, autoBackup: !prev.autoBackup }))}
                                                className={`w-9 h-5 rounded-full relative cursor-pointer transition-colors duration-300 ${cloudSettings.autoBackup ? 'bg-[#333] dark:bg-white' : 'bg-gray-200 dark:bg-gray-600'}`}
                                            >
                                                <div className={`w-3.5 h-3.5 bg-white dark:bg-[#333] rounded-full absolute top-0.5 shadow-sm transition-transform duration-300 ${cloudSettings.autoBackup ? 'left-5' : 'left-0.5'}`}></div>
                                            </div>
                                        </div>
                                    </div>
                                    {/* é›™æŒ‰éˆ•ï¼šå‚™ä»½ vs é‚„åŸ */}
                                    <div className="grid grid-cols-2 gap-3 pt-1">
                                        <button 
                                            onClick={() => handleManualRestore(cloudSettings.url, cloudSettings.password)} 
                                            className="py-2.5 bg-white dark:bg-[#36393F] border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-200 rounded text-xs font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition flex items-center justify-center gap-2"
                                        >
                                            <Icon name="download" size={14}/> æª¢æŸ¥é‚„åŸ
                                        </button>
                                        <button 
                                            onClick={() => handleCloudBackup(false)} 
                                            className="py-2.5 bg-[#333] dark:bg-white text-white dark:text-black border border-[#333] dark:border-white rounded text-xs font-medium hover:opacity-90 transition flex items-center justify-center gap-2"
                                        >
                                            <Icon name="upload" size={14}/> ç«‹å³å‚™ä»½
                                        </button>
                                    </div>

                                </div>
                            </div>
                        )}
                </div>

                {/* 3. æœ¬æ©Ÿè³‡æ–™å€å¡Š */}
                <SectionTitle title="æª”æ¡ˆç®¡ç†" />
                <div className="grid grid-cols-2 gap-3">
                    {/* åŒ¯å‡ºå‚™ä»½ */}
                    <ActionCard 
                        icon="download" 
                        title="å‚™ä»½æª”æ¡ˆ" 
                        subtitle="JSON æ ¼å¼" 
                        onClick={handleExportData}
                    />

                    {/* åŒ¯å‡ºå ±è¡¨ */}
                    <ActionCard 
                        icon="fileText" 
                        title="åŒ¯å‡ºå ±è¡¨" 
                        subtitle="Excel / CSV" 
                        onClick={handleExportCSV} 
                        colorClass="text-green-600 dark:text-green-400"
                    />

                    {/* åŒ¯å…¥é‚„åŸ */}
                    <ActionCard 
                        icon="upload" 
                        title="åŒ¯å…¥é‚„åŸ" 
                        subtitle="è®€å– JSON" 
                        onClick={() => {}} // å¯¦éš›é»æ“Šç”± input è§¸ç™¼
                        colorClass="text-blue-500 dark:text-blue-400"
                    >
                        <input type="file" accept=".json" onChange={handleImportData} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"/>
                    </ActionCard>

                    {/* é‡ç½®è³‡æ–™ */}
                    <ActionCard 
                        icon="rotateCcw" 
                        title="é‡ç½®è³‡æ–™" 
                        subtitle="æ¸…ç©ºæ‰€æœ‰ç´€éŒ„" 
                        onClick={handleReset} 
                        colorClass="text-[#D9534F]" 
                        hoverClass="hover:border-red-200 dark:hover:border-red-900"
                    />
                </div>

                <div className="mt-12 text-center">
                    <div className="text-[10px] text-gray-300 font-light tracking-widest uppercase">Money Master</div>
                </div>
            </div>
        </div>
    );
};
// ==========================================
// CategoryManager (åˆ†é¡ç®¡ç†å™¨) - æ“´å……ç‰ˆ
// ==========================================
const CategoryManager = ({ onBack }) => {
    const { 
        categories, 
        transactions, 
        setCategories: onUpdate, 
        showConfirm: onConfirm,
        handleMergeAndDeleteCategory: onMergeAndDelete 
    } = React.useContext(DataContext);

    const [tab, setTab] = useState('expense');
    const [isEditing, setIsEditing] = useState(false);
    const [editTarget, setEditTarget] = useState(null);
    const [isReordering, setIsReordering] = useState(false);

    // åˆªé™¤ä¿è­· UI
    const [deleteMode, setDeleteMode] = useState(null);
    const [transferTargetId, setTransferTargetId] = useState('');

    // è¡¨å–®
    const [formName, setFormName] = useState('');
    const [formIconKey, setFormIconKey] = useState('more');
    const [formColor, setFormColor] = useState('#A5A58D');
    const [formBudget, setFormBudget] = useState(''); 
    const [subCatName, setSubCatName] = useState('');

    const currentList = tab === 'expense' ? categories.expense : categories.income;

    // â˜… æ“´å……ï¼šæ›´å¤šåœ–ç¤ºé¸æ“‡
    const iconOptions = [
        // åŸºç¤èˆ‡é£²é£Ÿ
        'utensils', 'shoppingBag', 'home', 'users', 'more',
        // äº¤é€šèˆ‡æ—…è¡Œ
        'bus', 'car', 'plane', 'map', 
        // å¨›æ¨‚èˆ‡ä¼‘é–’
        'film', 'game', 'music', 'coffee', 'gift',
        // ç”Ÿæ´»èˆ‡å¥åº·
        'medical', 'heart', 'baby', 'pet', 'leaf',
        // è²¡å‹™èˆ‡å·¥ä½œ
        'briefcase', 'trendingUp', 'circleDollar', 'wallet', 'banknote',
        // æ•™è‚²èˆ‡å…¶ä»–
        'book', 'pen', 'phone', 'wifi', 'tool', 'star', 'sun', 'moon', 'cloud', 'lightning'
    ];

    // â˜… æ“´å……ï¼šæ›´å¤šè«è˜­è¿ªè‰²ç³»é¸æ“‡
    const colorOptions = [
        '#A5A58D', '#6B705C', '#CB997E', '#DDBEA9', '#FFE8D6', // å¤§åœ°è‰²
        '#B7B7A4', '#D9534F', '#5CB85C', '#333333', '#E63946', // ç¶“å…¸è‰²
        '#457B9D', '#1D3557', '#F4A261', '#2A9D8F', '#E9C46A', // æ´»åŠ›è‰²
        '#8E9AAF', '#CBC0D3', '#EFD3D7', '#FEEAFA', '#DEE2FF'  // å¤¢å¹»è‰²
    ];

    // ... (moveCategory, handleEdit, handleAdd, handleSave ç­‰é‚è¼¯ä¿æŒä¸è®Šï¼Œè«‹è¤‡è£½ä¸‹æ–¹çš„å®Œæ•´ä»£ç¢¼) ...

    const moveCategory = (index, direction) => {
        const newList = [...currentList];
        const targetIndex = index + direction;
        if (targetIndex < 0 || targetIndex >= newList.length) return;
        [newList[index], newList[targetIndex]] = [newList[targetIndex], newList[index]];
        onUpdate({ ...categories, [tab]: newList });
    };

    const handleEdit = (cat) => {
        if (isReordering) return;
        setEditTarget(cat);
        setFormName(cat.name);
        setFormIconKey(cat.iconKey || 'more');
        setFormColor(cat.color);
        setFormBudget(cat.budget ? cat.budget.toString() : ''); 
        setIsEditing(true);
    };

    const handleAdd = () => {
        setEditTarget(null);
        setFormName('');
        setFormIconKey('more');
        setFormColor('#A5A58D');
        setFormBudget('');
        setIsEditing(true);
    };

    const handleSave = () => {
        if(!formName) return;
        onUpdate(prev => {
            const currentList = prev[tab];
            const existingSubs = editTarget ? (editTarget.subCategories || []) : [];
            const newItem = {
                id: editTarget ? editTarget.id : Date.now().toString(),
                name: formName,
                iconKey: formIconKey,
                color: formColor,
                budget: Number(formBudget) || 0,
                subCategories: existingSubs
            };
            const newList = editTarget ? currentList.map(c => c.id === newItem.id ? newItem : c) : [...currentList, newItem];
            return { ...prev, [tab]: newList };
        });
        setIsEditing(false);
    };

    const handleDeleteClick = () => {
        if (!editTarget) return;
        const usageCount = transactions.filter(t => t.categoryId === editTarget.id).length;
        if (usageCount > 0) {
            setDeleteMode({ targetCat: editTarget, count: usageCount });
            const otherCats = currentList.filter(c => c.id !== editTarget.id);
            if (otherCats.length > 0) setTransferTargetId(otherCats[0].id);
        } else {
            onConfirm('åˆªé™¤åˆ†é¡', `ç¢ºå®šåˆªé™¤åˆ†é¡: ${editTarget.name}?`, () => {
                onUpdate(prev => ({ ...prev, [tab]: prev[tab].filter(c => c.id !== editTarget.id) }));
                setIsEditing(false);
            });
        }
    };

    const confirmMergeDelete = () => {
        if (!transferTargetId) return;
        onMergeAndDelete(deleteMode.targetCat.id, transferTargetId);
        setIsEditing(false);
        setDeleteMode(null);
    };

    const handleAddSubCat = () => { if(!subCatName || !editTarget) return; const newSub = { id: Date.now().toString(), name: subCatName }; const updatedCat = { ...editTarget, subCategories: [...(editTarget.subCategories || []), newSub] }; setEditTarget(updatedCat); setSubCatName(''); const newList = currentList.map(c => c.id === updatedCat.id ? updatedCat : c); onUpdate({ ...categories, [tab]: newList }); };
    const handleDeleteSubCat = (subId) => { onConfirm('åˆªé™¤ç´°é …', 'ç¢ºå®šåˆªé™¤æ­¤ç´°é …ï¼Ÿ', () => { const updatedCat = { ...editTarget, subCategories: editTarget.subCategories.filter(s => s.id !== subId) }; setEditTarget(updatedCat); const newList = currentList.map(c => c.id === updatedCat.id ? updatedCat : c); onUpdate({ ...categories, [tab]: newList }); }); };

    if (isEditing) {
        return (
            <div className="fixed inset-0 bg-white dark:bg-[#36393F] flex flex-col p-6 animate-slide-up z-[250]">
                <div className="flex items-center mb-6">
                    <button onClick={() => setIsEditing(false)} className="mr-4 text-gray-400 p-2 -ml-2"><Icon name="close" /></button>
                    <h2 className="text-lg font-medium text-[#333] dark:text-white">{editTarget ? 'ç·¨è¼¯åˆ†é¡' : 'æ–°å¢åˆ†é¡'}</h2>
                </div>
                {deleteMode ? (
                    <div className="flex-1 flex flex-col justify-center items-center p-4">
                        <div className="w-16 h-16 bg-red-50 dark:bg-red-900/20 rounded-full flex items-center justify-center text-red-500 mb-4"><Icon name="trash" size={32}/></div>
                        <h3 className="text-lg font-bold text-[#333] dark:text-white mb-2">ç„¡æ³•ç›´æ¥åˆªé™¤</h3>
                        <p className="text-sm text-gray-500 dark:text-gray-400 text-center mb-6">æ­¤åˆ†é¡åŒ…å« <strong>{deleteMode.count}</strong> ç­†äº¤æ˜“ç´€éŒ„ã€‚<br/>è«‹é¸æ“‡ä¸€å€‹åˆ†é¡ä¾†æ¥æ”¶é€™äº›ç´€éŒ„ï¼š</p>
                        <div className="w-full bg-gray-50 dark:bg-[#40444B] p-3 rounded border border-gray-200 dark:border-gray-600 mb-6">
                            <label className="text-xs text-gray-400 block mb-2 uppercase">ç§»è½‰è‡³</label>
                            <select className="w-full bg-transparent outline-none text-[#333] dark:text-white" value={transferTargetId} onChange={e => setTransferTargetId(e.target.value)}>
                                {currentList.filter(c => c.id !== deleteMode.targetCat.id).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                            </select>
                        </div>
                        <div className="flex gap-3 w-full">
                            <button onClick={() => setDeleteMode(null)} className="flex-1 py-3 text-gray-500 bg-gray-100 dark:bg-gray-700 dark:text-gray-300 rounded">å–æ¶ˆ</button>
                            <button onClick={confirmMergeDelete} className="flex-1 py-3 bg-[#333] dark:bg-white text-white dark:text-black rounded shadow">ç§»è½‰ä¸¦åˆªé™¤</button>
                        </div>
                    </div>
                ) : (
                    <>
                        <div className="space-y-6 flex-1 overflow-y-auto pb-10">
                            {/* é è¦½å€å¡Š */}
                            <div className="flex justify-center mb-4">
                                <div className="flex flex-col items-center gap-2">
                                    <div className="w-16 h-16 rounded-full flex items-center justify-center text-white shadow-md transition-all" style={{backgroundColor: formColor}}>
                                        <Icon name={formIconKey} size={32} />
                                    </div>
                                    <span className="text-sm font-medium text-[#333] dark:text-white">{formName || 'é è¦½'}</span>
                                </div>
                            </div>

                            <div>
                                <label className="text-xs text-gray-400 block mb-2 uppercase tracking-wide">åç¨±</label>
                                <input className="w-full border-b border-gray-200 dark:border-gray-700 bg-transparent py-2 text-lg outline-none rounded-none text-[#333] dark:text-white" value={formName} onChange={e => setFormName(e.target.value)} placeholder="åˆ†é¡åç¨±" />
                            </div>
                            
                            {tab === 'expense' && (
                                <div>
                                    <label className="text-xs text-gray-400 block mb-2 uppercase tracking-wide">æ¯æœˆé ç®—ç›®æ¨™</label>
                                    <div className="flex items-center gap-2 border-b border-gray-200 dark:border-gray-700 py-2">
                                        <span className="text-gray-400">$</span>
                                        <input type="number" className="w-full text-lg outline-none rounded-none bg-transparent text-[#333] dark:text-white" value={formBudget} onChange={e => setFormBudget(e.target.value)} placeholder="0 (ä¸è¨­å®š)" />
                                    </div>
                                    <p className="text-[10px] text-gray-400 mt-1">è¨­å®š 0 ä»£è¡¨ä¸å•Ÿç”¨é ç®—æé†’</p>
                                </div>
                            )}
                            
                            {editTarget && (
                                <div className="bg-gray-50 dark:bg-[#40444B] p-4 rounded border border-gray-100 dark:border-gray-600">
                                    <label className="text-xs text-gray-400 block mb-2 uppercase tracking-wide">å­åˆ†é¡ (ç´°é …)</label>
                                    <div className="flex gap-2 mb-3">
                                        <input className="flex-1 border border-gray-200 dark:border-gray-600 bg-white dark:bg-[#2B2D30] px-2 py-1 text-sm rounded outline-none text-[#333] dark:text-white" placeholder="æ–°å¢ç´°é …..." value={subCatName} onChange={e => setSubCatName(e.target.value)} />
                                        <button onClick={handleAddSubCat} className="bg-[#333] dark:bg-white text-white dark:text-black px-3 py-1 rounded text-xs">æ–°å¢</button>
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        {(editTarget.subCategories || []).map(s => (
                                            <span key={s.id} className="bg-white dark:bg-[#2B2D30] border border-gray-200 dark:border-gray-600 px-2 py-1 rounded text-xs flex items-center gap-2 text-gray-600 dark:text-gray-300">
                                                {s.name} 
                                                <button onClick={() => handleDeleteSubCat(s.id)} className="text-red-400 hover:text-red-600"><Icon name="close" size={10}/></button>
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
{/* åœ–ç¤ºé¸æ“‡å™¨ (ä¿®æ­£ï¼šæ”¹ç”¨ Flex + å›ºå®šå¤§å°ï¼Œé¿å…éå¤§) */}
                            <div>
                                <label className="text-xs text-gray-400 block mb-3 uppercase tracking-wide">åœ–ç¤º</label>
                                <div className="flex flex-wrap gap-3"> {/* æ”¹ç”¨ flex wrap */}
                                    {iconOptions.map(key => (
                                        <button 
                                            key={key} 
                                            onClick={() => setFormIconKey(key)} 
                                            // â˜… ä¿®æ”¹ï¼šç§»é™¤ aspect-squareï¼Œæ”¹ç”¨å›ºå®š w-11 h-11 (ç´„ 44pxï¼Œé©åˆæ‰‹æŒ‡é»æ“Š)
                                            className={`w-11 h-11 rounded-xl flex items-center justify-center border transition ${formIconKey === key ? 'border-[#333] dark:border-white bg-gray-100 dark:bg-gray-700 text-[#333] dark:text-white shadow-sm' : 'border-transparent bg-gray-50 dark:bg-[#40444B] text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-600'}`}
                                        >
                                            <Icon name={key} size={20} />
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            {/* é¡è‰²é¸æ“‡å™¨ (åŒæ­¥ä¿®æ­£ï¼šæ”¹ç”¨ Flex + å›ºå®šå¤§å°) */}
                            <div>
                                <label className="text-xs text-gray-400 block mb-3 uppercase tracking-wide">é¡è‰²</label>
                                <div className="flex flex-wrap gap-3"> {/* æ”¹ç”¨ flex wrap */}
                                    {colorOptions.map(c => (
                                        <button 
                                            key={c} 
                                            onClick={() => setFormColor(c)} 
                                            // â˜… ä¿®æ”¹ï¼šç§»é™¤ aspect-squareï¼Œæ”¹ç”¨å›ºå®š w-9 h-9
                                            className={`w-9 h-9 rounded-full border-2 flex items-center justify-center transition ${formColor === c ? 'border-gray-400 dark:border-white scale-110 shadow-sm' : 'border-transparent hover:scale-105'}`}
                                            style={{backgroundColor: c}} 
                                        >
                                            {formColor === c && <Icon name="check" size={14} className="text-white drop-shadow-md"/>}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                        <div className="flex gap-3 mt-4">
                             {editTarget && <button onClick={handleDeleteClick} className="flex-1 py-3 text-[#D9534F] bg-red-50 dark:bg-red-900/20 rounded font-medium">åˆªé™¤</button>}
                             <button onClick={handleSave} className="flex-[2] py-3 bg-[#333] dark:bg-white text-white dark:text-black rounded font-medium shadow-lg">å„²å­˜</button>
                        </div>
                    </>
                )}
            </div>
        );
    }

    return (
        <div className="h-full bg-[#F5F5F3] dark:bg-[#2B2D30] flex flex-col animate-slide-up z-[200] fixed inset-0">
            <div className="bg-white dark:bg-[#36393F] px-5 pt-12 pb-4 border-b border-gray-200 dark:border-gray-700">
                <div className="flex items-center justify-between mb-6">
                    <div className="flex items-center gap-4">
                        <button onClick={onBack} className="p-1 -ml-2 text-gray-500 hover:text-black dark:text-gray-300 dark:hover:text-white"><Icon name="back" size={24}/></button>
                        <h2 className="text-xl font-medium text-[#333] dark:text-white">åˆ†é¡ç®¡ç†</h2>
                    </div>
                    <div className="flex gap-2">
                        {currentList.length > 1 && (
                            isReordering ? (
                                <button onClick={() => setIsReordering(false)} className="text-xs bg-[#333] dark:bg-white text-white dark:text-black px-3 py-1.5 rounded shadow-sm">å®Œæˆ</button>
                            ) : (
                                <button onClick={() => setIsReordering(true)} className="text-xs text-gray-500 dark:text-gray-400 px-2 py-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition">èª¿æ•´é †åº</button>
                            )
                        )}
                    </div>
                </div>
                
                <div className="flex bg-[#F5F5F3] dark:bg-[#40444B] p-1 rounded">
                    <button onClick={() => { setTab('expense'); setIsReordering(false); }} className={`flex-1 py-1.5 text-sm rounded transition ${tab === 'expense' ? 'bg-white dark:bg-[#2B2D30] shadow-sm text-[#333] dark:text-white' : 'text-gray-400'}`}>æ”¯å‡º</button>
                    <button onClick={() => { setTab('income'); setIsReordering(false); }} className={`flex-1 py-1.5 text-sm rounded transition ${tab === 'income' ? 'bg-white dark:bg-[#2B2D30] shadow-sm text-[#333] dark:text-white' : 'text-gray-400'}`}>æ”¶å…¥</button>
                </div>
            </div>
            
            <div className="flex-1 overflow-y-auto p-4 space-y-2 pb-20">
                {currentList.map((c, index) => (
                    <div 
                        key={c.id} 
                        onClick={() => handleEdit(c)} 
                        className={`bg-white dark:bg-[#36393F] p-3.5 rounded flex items-center justify-between border border-transparent transition ${!isReordering && 'hover:border-gray-200 dark:hover:border-gray-600 active:scale-[0.99] cursor-pointer'}`}
                    >
                        <div className="flex items-center gap-4">
                            <div className="w-9 h-9 rounded-full flex items-center justify-center text-lg text-white shadow-sm" style={{backgroundColor: c.color}}>
                                <Icon name={c.iconKey || 'more'} size={18} />
                            </div>
                            <div>
                                <div className="text-[#333] dark:text-white flex items-center gap-2">
                                    {c.name}
                                    {c.budget > 0 && <span className="text-[9px] bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300 px-1.5 py-0.5 rounded">é ç®— ${c.budget}</span>}
                                </div>
                                <div className="text-[10px] text-gray-400">{(c.subCategories||[]).map(s=>s.name).join(', ')}</div>
                            </div>
                        </div>
                        
                        {isReordering ? (
                            <div className="flex items-center gap-1">
                                <button 
                                    onClick={(e) => { e.stopPropagation(); moveCategory(index, -1); }} 
                                    disabled={index === 0}
                                    className={`p-2 rounded ${index === 0 ? 'text-gray-200 dark:text-gray-600' : 'text-gray-400 hover:text-[#333] dark:text-gray-400 dark:hover:text-white active:bg-gray-100 dark:active:bg-gray-700'}`}
                                >
                                    <Icon name="chevronUp" size={20}/>
                                </button>
                                <button 
                                    onClick={(e) => { e.stopPropagation(); moveCategory(index, 1); }} 
                                    disabled={index === currentList.length - 1}
                                    className={`p-2 rounded ${index === currentList.length - 1 ? 'text-gray-200 dark:text-gray-600' : 'text-gray-400 hover:text-[#333] dark:text-gray-400 dark:hover:text-white active:bg-gray-100 dark:active:bg-gray-700'}`}
                                >
                                    <Icon name="chevronDown" size={20}/>
                                </button>
                            </div>
                        ) : (
                            <Icon name="edit" size={16} className="text-gray-300"/>
                        )}
                    </div>
                ))}
                
                {!isReordering && (
                    <button onClick={handleAdd} className="w-full py-3.5 border border-dashed border-gray-300 dark:border-gray-600 text-gray-400 rounded flex items-center justify-center gap-2 mt-4 hover:bg-white dark:hover:bg-[#36393F] hover:border-gray-400 transition">
                        <Icon name="plus" size={18} /> æ–°å¢åˆ†é¡
                    </button>
                )}
            </div>
        </div>
    );
};
// ==========================================
// TemplateManager (å¿«é€Ÿè¨˜å¸³æ¨¡æ¿ç®¡ç†å™¨)
// ==========================================
const TemplateManager = ({ onBack }) => {
    const { 
        quickTemplates: templates, 
        categories, 
        accounts, 
        setQuickTemplates: onUpdate, 
        showConfirm 
    } = React.useContext(DataContext);

    const [isEditing, setIsEditing] = useState(false);
    const [editId, setEditId] = useState(null);
    const [formName, setFormName] = useState('');
    const [formCat, setFormCat] = useState(categories.expense[0]?.id);
    const [formSubCat, setFormSubCat] = useState('');
    const [formAcc, setFormAcc] = useState(accounts[0]?.id);
    const [formIsSplit, setFormIsSplit] = useState(false);

    // æ’åºç‹€æ…‹
    const [isReordering, setIsReordering] = useState(false);

    const activeCat = categories.expense.find(c => c.id === formCat) || {};
    const subCats = activeCat.subCategories || [];

    // ç§»å‹•é †åºé‚è¼¯
    const moveTemplate = (index, direction) => {
        const newTemplates = [...templates];
        const targetIndex = index + direction;
        if (targetIndex < 0 || targetIndex >= newTemplates.length) return;
        [newTemplates[index], newTemplates[targetIndex]] = [newTemplates[targetIndex], newTemplates[index]];
        onUpdate(newTemplates);
    };

    const startEdit = (tpl) => {
        if (isReordering) return;
        setEditId(tpl.id);
        setFormName(tpl.name);
        setFormCat(tpl.categoryId);
        setFormSubCat(tpl.subCategoryId || '');
        setFormAcc(tpl.accountId);
        setFormIsSplit(tpl.isSplit || false);
        setIsEditing(true);
    };

    const handleSave = () => {
        if (!formName) return;
        const cat = categories.expense.find(c => c.id === formCat) || categories.expense[0];
        const newTpl = {
            id: editId || Date.now().toString(),
            name: formName,
            categoryId: formCat,
            subCategoryId: formSubCat || null,
            accountId: formAcc,
            iconKey: cat.iconKey,
            isSplit: formIsSplit
        };
        
        // ä½¿ç”¨ functional update ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§
        onUpdate(prev => {
            if (editId) {
                return prev.map(t => t.id === editId ? newTpl : t);
            } else {
                return [...prev, newTpl];
            }
        });

        setIsEditing(false);
        setEditId(null);
        setFormName('');
        setFormIsSplit(false);
        setFormSubCat('');
    };

    // â˜… ä¿®æ­£é‡é»ï¼šæ”¹ç”¨ prev => prev.filter(...) ç¢ºä¿åˆªé™¤ç•¶ä¸‹æ˜¯æœ€æ–°çš„è³‡æ–™
    const handleDelete = (id) => {
        showConfirm('åˆªé™¤æ¨¡æ¿', 'ç¢ºå®šåˆªé™¤æ­¤å¿«é€Ÿè¨˜å¸³æ¨¡æ¿ï¼Ÿ', () => {
             onUpdate(prev => prev.filter(t => t.id !== id));
        });
    };

    if (isEditing) {
        return (
            <div className="fixed inset-0 bg-white flex flex-col p-6 animate-slide-up z-50">
                <div className="flex items-center mb-8">
                    <button onClick={() => setIsEditing(false)} className="mr-4 text-gray-400 p-2 -ml-2"><Icon name="close" /></button>
                    <h2 className="text-lg font-medium">{editId ? 'ç·¨è¼¯æ¨¡æ¿' : 'æ–°å¢æ¨¡æ¿'}</h2>
                </div>
                <div className="space-y-6 flex-1">
                    <div>
                        <label className="text-xs text-gray-400 block mb-2 uppercase">æ¨¡æ¿åç¨±</label>
                        <input className="w-full border-b border-gray-200 py-2 text-lg outline-none rounded-none text-[#333]" value={formName} onChange={e => setFormName(e.target.value)} placeholder="ä¾‹å¦‚ï¼šåˆé¤" autoFocus />
                    </div>
                    <div>
                        <label className="text-xs text-gray-400 block mb-2 uppercase">é è¨­åˆ†é¡</label>
                        <select className="w-full bg-[#F5F5F3] p-3 rounded outline-none" value={formCat} onChange={e => { setFormCat(e.target.value); setFormSubCat(''); }}>
                            {categories.expense.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                        </select>
                    </div>
                    {subCats.length > 0 && (
                        <div>
                            <label className="text-xs text-gray-400 block mb-2 uppercase">é è¨­ç´°é …</label>
                            <select className="w-full bg-[#F5F5F3] p-3 rounded outline-none" value={formSubCat} onChange={e => setFormSubCat(e.target.value)}>
                                <option value="">(ç„¡)</option>
                                {subCats.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                        </div>
                    )}
                    <div>
                        <label className="text-xs text-gray-400 block mb-2 uppercase">é è¨­å¸³æˆ¶</label>
                        <select className="w-full bg-[#F5F5F3] p-3 rounded outline-none" value={formAcc} onChange={e => setFormAcc(e.target.value)}>
                            {accounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                        </select>
                    </div>
                    <div className="flex items-center justify-between bg-[#F9F9F9] p-4 rounded">
                        <span className="text-sm font-medium">é è¨­ç‚ºåˆ†å¸³/ä»£å¢Šï¼Ÿ</span>
                        <input type="checkbox" className="w-5 h-5 accent-[#333]" checked={formIsSplit} onChange={e => setFormIsSplit(e.target.checked)} />
                    </div>
                </div>
                <button onClick={handleSave} className="w-full py-3 bg-[#333] text-white rounded font-medium shadow-lg">å„²å­˜æ¨¡æ¿</button>
            </div>
        );
    }

    return (
        <div className="h-full bg-[#F5F5F3] flex flex-col animate-slide-up z-40 fixed inset-0">
            <div className="bg-white px-5 pt-12 pb-4 border-b border-gray-200 flex justify-between items-center">
                <div className="flex items-center gap-4">
                    <button onClick={onBack} className="p-1 -ml-2 text-gray-500 hover:text-black"><Icon name="back" size={24}/></button>
                    <h2 className="text-xl font-medium">å¿«é€Ÿè¨˜å¸³æ¨¡æ¿</h2>
                </div>
                <div className="flex gap-2">
                    {templates.length > 1 && (
                        isReordering ? (
                            <button onClick={() => setIsReordering(false)} className="text-xs bg-[#333] text-white px-3 py-1.5 rounded shadow-sm">å®Œæˆ</button>
                        ) : (
                            <button onClick={() => setIsReordering(true)} className="text-xs text-gray-500 px-2 py-1.5 hover:bg-gray-100 rounded transition">èª¿æ•´é †åº</button>
                        )
                    )}
                </div>
            </div>
            
            <div className="flex-1 overflow-y-auto p-4 space-y-2">
                {templates.map((t, index) => (
                    <div 
                        key={t.id} 
                        onClick={() => startEdit(t)} 
                        className={`bg-white p-3.5 rounded flex items-center justify-between border border-transparent transition ${!isReordering && 'cursor-pointer hover:border-gray-300'}`}
                    >
                        <div className="flex items-center gap-4">
                            <div className="w-9 h-9 rounded-full flex items-center justify-center text-lg text-gray-600 bg-gray-50">
                                <Icon name={t.iconKey || 'template'} size={18} />
                            </div>
                            <div>
                                <div className="text-[#333] text-sm font-medium">{t.name}</div>
                                <div className="text-xs text-gray-400">
                                    {categories.expense.find(c=>c.id===t.categoryId)?.name} Â· {accounts.find(a=>a.id===t.accountId)?.name}
                                    {t.isSplit && <span className="ml-2 bg-gray-100 px-1 rounded text-[9px]">åˆ†å¸³</span>}
                                </div>
                            </div>
                        </div>
                        
                        {isReordering ? (
                            <div className="flex items-center gap-1">
                                <button 
                                    onClick={(e) => { e.stopPropagation(); moveTemplate(index, -1); }} 
                                    disabled={index === 0}
                                    className={`p-2 rounded ${index === 0 ? 'text-gray-200' : 'text-gray-400 hover:text-[#333] active:bg-gray-100'}`}
                                >
                                    <Icon name="chevronUp" size={20}/>
                                </button>
                                <button 
                                    onClick={(e) => { e.stopPropagation(); moveTemplate(index, 1); }} 
                                    disabled={index === templates.length - 1}
                                    className={`p-2 rounded ${index === templates.length - 1 ? 'text-gray-200' : 'text-gray-400 hover:text-[#333] active:bg-gray-100'}`}
                                >
                                    <Icon name="chevronDown" size={20}/>
                                </button>
                            </div>
                        ) : (
                            <div className="flex gap-2">
                                {/* é€™è£¡ç¶å®šäº†ä¿®æ­£å¾Œçš„ handleDelete */}
                                <button onClick={(e) => { e.stopPropagation(); handleDelete(t.id); }} className="text-gray-300 hover:text-red-500 p-2"><Icon name="trash" size={16}/></button>
                            </div>
                        )}
                    </div>
                ))}
                
                {!isReordering && (
                    <button onClick={() => { setEditId(null); setFormName(''); setIsEditing(true); }} className="w-full py-3.5 border border-dashed border-gray-300 text-gray-400 rounded flex items-center justify-center gap-2 mt-4 hover:bg-white transition">
                        <Icon name="plus" size={18} /> æ–°å¢æ¨¡æ¿
                    </button>
                )}
            </div>
        </div>
    );
};
// ==========================================
// RecurringManager (å®šæœŸé …ç›®ç®¡ç†å™¨)
// ==========================================
const RecurringManager = ({ onBack }) => {
            const { 
                recurringItems, categories, accounts, transactions,
                setRecurringItems: onUpdate, showConfirm: onConfirm,
                handleSaveTransaction // â˜… å¼•å…¥å„²å­˜äº¤æ˜“å‡½å¼ï¼Œç”¨ä¾†ä¿®æ­£æœ¬æœŸæ˜ç´°
            } = React.useContext(DataContext);

            const [isEditing, setIsEditing] = useState(false);
            const [editTarget, setEditTarget] = useState(null);
            const [showPlan, setShowPlan] = useState(false);
            
            // è¡¨å–®æ¬„ä½
            const [type, setType] = useState('expense'); 
            const [name, setName] = useState('');
            const [amount, setAmount] = useState('');
            const [day, setDay] = useState('1'); 
            const [catId, setCatId] = useState('');
            const [accId, setAccId] = useState('');       
            const [targetAccId, setTargetAccId] = useState(''); 

            const [startDate, setStartDate] = useState(getLocalDateString().slice(0, 7));
            const [totalPeriods, setTotalPeriods] = useState('');
            const [interest, setInterest] = useState('');

            // â˜… é—œéµä¿®æ­£ï¼šç•¶ type æ”¹è®Šæ™‚ï¼Œç¢ºä¿ catId æ­£ç¢ºæ­¸é›¶æˆ–åˆ‡æ›åˆ°è©²é¡å‹çš„ç¬¬ä¸€å€‹åˆ†é¡
            useEffect(() => {
                if (isEditing) {
                    if (type === 'expense') {
                        // å¦‚æœç•¶å‰çš„ catId ä¸åœ¨ expense åˆ—è¡¨ä¸­ï¼Œå‰‡é‡ç½®
                        const isValid = categories.expense.some(c => c.id === catId);
                        if (!isValid && categories.expense.length > 0) setCatId(categories.expense[0].id);
                    } else if (type === 'income') {
                        // å¦‚æœç•¶å‰çš„ catId ä¸åœ¨ income åˆ—è¡¨ä¸­ï¼Œå‰‡é‡ç½®
                        const isValid = categories.income.some(c => c.id === catId);
                        if (!isValid && categories.income.length > 0) setCatId(categories.income[0].id);
                    }

                    if (accounts.length > 0) {
                        if(!accId) setAccId(accounts[0].id);
                        if(type === 'transfer' && !targetAccId) setTargetAccId(accounts.length > 1 ? accounts[1].id : accounts[0].id);
                    }
                }
            }, [type, isEditing, categories, accounts]); 

            const handleAddClick = () => {
                setEditTarget(null);
                resetForm();
                setIsEditing(true);
            };

            const handleEditClick = (item) => {
                setEditTarget(item);
                setType(item.type || 'expense');
                setName(item.name);
                setAmount(item.amount.toString());
                setDay(item.day.toString());
                setCatId(item.categoryId || '');
                setAccId(item.accountId || '');
                setTargetAccId(item.targetAccountId || '');
                setStartDate(item.startDate || getLocalDateString().slice(0, 7));
                setTotalPeriods(item.totalPeriods ? item.totalPeriods.toString() : '');
                setInterest(item.interest ? item.interest.toString() : '');
                setIsEditing(true);
            };

const handleSave = () => {
                if (!name || !amount) return;
                
                // â˜… ä¿®æ­£ï¼šç²¾æº–è¨ˆç®—æœ¬æ¯
                const newAmount = Number(amount);
                const newInterest = interest ? Number(interest) : 0;
                const newTotalAmount = newAmount + newInterest;
                
                const oldAmount = editTarget ? Number(editTarget.amount) : 0;
                const oldInterest = editTarget && editTarget.interest ? Number(editTarget.interest) : 0;
                const oldTotalAmount = oldAmount + oldInterest;

                const payload = {
                    type, name,
                    amount: newAmount,
                    day: Number(day),
                    accountId: accId,
                    categoryId: type === 'transfer' ? 'transfer' : catId,
                    targetAccountId: type === 'transfer' ? targetAccId : null,
                    startDate,
                    totalPeriods: totalPeriods ? Number(totalPeriods) : null,
                    interest: newInterest,
                    executedPeriods: editTarget ? (editTarget.executedPeriods || 0) : 0
                };

                // â˜… å¼·åŒ–ç‰ˆé€£å‹•å¼•æ“ï¼šå°‹æ‰¾é—œè¯çš„æ˜ç´° (åŒ…å«èˆŠç‰ˆæ²’æœ‰ ID çš„è³‡æ–™)
                if (editTarget && newTotalAmount !== oldTotalAmount) {
                    let relatedTxs = transactions.filter(t => t.recurringId === editTarget.id);
                    
                    // å‚™ç”¨æ–¹æ¡ˆï¼šå¦‚æœæ‰¾ä¸åˆ°ç¶å®š ID çš„è³‡æ–™ï¼Œè©¦è‘—ç”¨ã€Œåç¨±ã€å»æŠ“æœ¬æœˆæœ€æ–°çš„é‚£ä¸€ç­†
                    if (relatedTxs.length === 0) {
                        const currentMonthStr = getLocalDateString().slice(0, 7);
                        relatedTxs = transactions.filter(t => 
                            t.date.startsWith(currentMonthStr) && 
                            t.note && t.note.includes(editTarget.name)
                        );
                    }
                    
                    relatedTxs = relatedTxs.sort((a,b) => new Date(b.date) - new Date(a.date));

                    if (relatedTxs.length > 0) {
                        const lastTx = relatedTxs[0];
                        showConfirm(
                            'åŒæ­¥æ›´æ–°å¸³å–®',
                            `ç¸½é‡‘é¡å·²è®Šæ›´ç‚º $${newTotalAmount} (å«æ¯)ã€‚\n\næ˜¯å¦è¦ä¸€ä½µä¿®æ­£ã€Œæœ¬æœŸå·²ç”¢ç”Ÿã€çš„å¸³å–®é‡‘é¡ï¼Ÿ\n(é€™å°‡è‡ªå‹•ç‚ºæ‚¨èª¿æ•´å¸³æˆ¶é¤˜é¡)`,
                            () => {
                                const match = lastTx.note.match(/\(\d+\/(?:âˆ|\d+)(?:æœŸ)?\)/);
                                const periodStr = match ? match[0] : '';
                                const newNote = `[é€±æœŸ] ${payload.name} ${periodStr}${newInterest > 0 ? ` (å«æ¯${newInterest})` : ''}`.trim();
                                
                                handleSaveTransaction({
                                    ...lastTx,
                                    amount: newTotalAmount,
                                    note: newNote,
                                    recurringId: editTarget.id
                                }, lastTx.id, true);
                            }
                        );
                    }
                }

                // æ›´æ–°é€±æœŸè¨ˆç•«
                onUpdate(prev => {
                    if (editTarget) {
                        return prev.map(item => item.id === editTarget.id ? { ...item, ...payload, active: item.active, lastGeneratedMonth: item.lastGeneratedMonth } : item);
                    } else {
                        const newItem = {
                            id: 'rec_' + Date.now().toString(),
                            ...payload,
                            lastGeneratedMonth: '', 
                            active: true
                        };
                        return [...prev, newItem];
                    }
                });
                
                setIsEditing(false);
                setEditTarget(null);
                resetForm();
            };

            const toggleActive = (id) => {
                const updated = recurringItems.map(item => item.id === id ? { ...item, active: item.active === undefined ? false : !item.active } : item);
                onUpdate(updated);
            };

            const handleDelete = (id) => {
                onConfirm('åˆªé™¤', 'ç¢ºå®šè¦åˆªé™¤ï¼Ÿ', () => {
                    // â˜… ä¿®æ­£ï¼šä½¿ç”¨ prev => prev.filter(...) å¾¹åº•è§£æ±ºåˆªé™¤ç„¡æ•ˆå•é¡Œ
                    onUpdate(prev => prev.filter(item => item.id !== id));
                    
                    if (editTarget && editTarget.id === id) setIsEditing(false);
                });
            }

            const resetForm = () => {
                setType('expense');
                setName('');
                setAmount('');
                setDay('1');
                setStartDate(getLocalDateString().slice(0, 7));
                setTotalPeriods('');
                setInterest('');
                setCatId('');
                setAccId('');
                setTargetAccId('');
            };

            const generatePlan = () => {
                if (!totalPeriods) return [];
                const plan = [];
                const [startYear, startMonth] = startDate.split('-').map(Number);
                for (let i = 0; i < Number(totalPeriods); i++) {
                    const targetYear = startYear + Math.floor((startMonth - 1 + i) / 12);
                    const targetMonth = ((startMonth - 1 + i) % 12) + 1;
                    const daysInMonth = new Date(targetYear, targetMonth, 0).getDate();
                    const actualDay = Math.min(Number(day), daysInMonth);
                    const dateStr = `${targetYear}-${String(targetMonth).padStart(2,'0')}-${String(actualDay).padStart(2,'0')}`;
                    const executed = editTarget ? (i < (editTarget.executedPeriods || 0)) : false;
                    plan.push({ period: i + 1, date: dateStr, amount: Number(amount) + Number(interest || 0), status: executed ? 'å·²åŸ·è¡Œ' : 'å¾…åŸ·è¡Œ' });
                }
                return plan;
            };

            if (isEditing) {
                return (
                    <div className="h-full bg-[#F5F5F3] flex flex-col animate-slide-up z-[200] fixed inset-0 p-6 overflow-y-auto">
                        <div className="flex items-center mb-6">
                            <button onClick={() => setIsEditing(false)} className="mr-4 text-gray-400 p-2 -ml-2"><Icon name="close" /></button>
                            <h2 className="text-lg font-medium">{editTarget ? 'ç·¨è¼¯é …ç›®' : 'æ–°å¢é …ç›®'}</h2>
                        </div>
                        <div className="space-y-5 flex-1 pb-10">
                            <div><label className="text-xs text-gray-400 block mb-1">åç¨±</label><input className="w-full border-b py-1 outline-none bg-transparent" value={name} onChange={e => setName(e.target.value)} placeholder="ä¾‹å¦‚ï¼šæˆ¿ç§Ÿã€è–ªè³‡" autoFocus /></div>
                            
                            <div>
                                <label className="text-xs text-gray-400 block mb-2">é¡å‹</label>
                                <div className="flex bg-white rounded p-1 border border-gray-200">
                                    {['expense', 'income', 'transfer'].map(t => (
                                        <button key={t} onClick={() => setType(t)} className={`flex-1 py-1.5 text-xs rounded transition ${type === t ? 'bg-[#333] text-white' : 'text-gray-500'}`}>
                                            {t === 'expense' ? 'æ”¯å‡º' : t === 'income' ? 'æ”¶å…¥' : 'è½‰å¸³'}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="flex gap-4">
                                <div className="flex-1"><label className="text-xs text-gray-400 block mb-1">æ¯æœŸé‡‘é¡</label><input type="number" className="w-full border-b py-1 outline-none bg-transparent" value={amount} onChange={e => setAmount(e.target.value)} placeholder="0" /></div>
                                <div className="flex-1"><label className="text-xs text-gray-400 block mb-1">åˆ©æ¯/æ‰‹çºŒè²»</label><input type="number" className="w-full border-b py-1 outline-none bg-transparent" value={interest} onChange={e => setInterest(e.target.value)} placeholder="0" /></div>
                            </div>

                            <div className="flex gap-4">
                                <div className="flex-1"><label className="text-xs text-gray-400 block mb-1">åŸ·è¡Œæ—¥ (æ¯æœˆ)</label><input type="number" className="w-full border-b py-1 outline-none bg-transparent" value={day} onChange={e => setDay(e.target.value)} placeholder="1-31" /></div>
                                <div className="flex-1"><label className="text-xs text-gray-400 block mb-1">ç¸½æœŸæ•¸ (ç©ºç‚ºç„¡é™)</label><input type="number" className="w-full border-b py-1 outline-none bg-transparent" value={totalPeriods} onChange={e => setTotalPeriods(e.target.value)} placeholder="âˆ" /></div>
                            </div>

                            <div><label className="text-xs text-gray-400 block mb-1">èµ·æ‰£æœˆä»½</label><input type="month" className="w-full border-b py-1 outline-none bg-transparent" value={startDate} onChange={e => setStartDate(e.target.value)} /></div>

                            {type !== 'transfer' ? (
                                <div>
                                    <label className="text-xs text-gray-400 block mb-2">åˆ†é¡</label>
                                    <select className="w-full bg-white p-2 rounded" value={catId} onChange={e => setCatId(e.target.value)}>
                                        {(type === 'expense' ? categories.expense : categories.income).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                    </select>
                                </div>
                            ) : null}

                            <div className="flex gap-3">
                                <div className="flex-1">
                                    <label className="text-xs text-gray-400 block mb-2">{type === 'transfer' ? 'è½‰å‡ºå¸³æˆ¶' : 'å¸³æˆ¶'}</label>
                                    <select className="w-full bg-white p-2 rounded" value={accId} onChange={e => setAccId(e.target.value)}>
                                        {accounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                                    </select>
                                </div>
                                {type === 'transfer' && (
                                    <div className="flex-1">
                                        <label className="text-xs text-gray-400 block mb-2">è½‰å…¥å¸³æˆ¶</label>
                                        <select className="w-full bg-white p-2 rounded" value={targetAccId} onChange={e => setTargetAccId(e.target.value)}>
                                            {accounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                                        </select>
                                    </div>
                                )}
                            </div>

                            {totalPeriods && (
                                <div className="bg-white rounded border border-gray-200 p-3 mt-4">
                                    <div className="flex justify-between items-center cursor-pointer" onClick={() => setShowPlan(!showPlan)}>
                                        <span className="text-xs font-bold text-gray-500">åˆ†æœŸè©¦ç®—è¡¨</span>
                                        <Icon name={showPlan ? "chevronDown" : "chevronRight"} size={14} className="text-gray-400"/>
                                    </div>
                                    {showPlan && (
                                        <div className="mt-3 max-h-40 overflow-y-auto text-xs">
                                            <div className="grid grid-cols-3 text-gray-400 mb-1 pb-1 border-b"><span>æœŸæ•¸</span><span>æ—¥æœŸ</span><span className="text-right">ç‹€æ…‹</span></div>
                                            {generatePlan().map(p => (
                                                <div key={p.period} className="grid grid-cols-3 py-1 border-b border-gray-50 last:border-0 text-gray-600">
                                                    <span>{p.period}</span><span>{p.date}</span><span className={`text-right ${p.status === 'å·²åŸ·è¡Œ' ? 'text-green-500' : 'text-gray-400'}`}>{p.status}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                        <button onClick={handleSave} className="w-full py-3 bg-[#333] text-white rounded shadow-lg">å„²å­˜</button>
                    </div>
                );
            }

            return (
                <div className="h-full bg-[#F5F5F3] flex flex-col animate-slide-up z-[200] fixed inset-0">
                    <div className="bg-white px-5 pt-12 pb-4 border-b border-gray-200 flex items-center gap-4">
                        <button onClick={onBack} className="p-1 -ml-2 text-gray-500 hover:text-black"><Icon name="back" size={24}/></button>
                        <h2 className="text-xl font-medium">é€±æœŸç®¡ç†</h2>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-3 pb-24">
                        {recurringItems.length > 0 ? recurringItems.map(item => {
                            const isActive = item.active !== false;
                            const isFinished = item.totalPeriods && (item.executedPeriods || 0) >= item.totalPeriods;
                            const typeColor = item.type === 'income' ? 'text-green-600' : (item.type === 'transfer' ? 'text-blue-500' : 'text-gray-400');
                            
                            return (
                                <div key={item.id} className={`bg-white p-4 rounded flex items-center justify-between border transition shadow-sm ${isActive && !isFinished ? 'border-transparent' : 'border-dashed border-gray-300 opacity-60'}`}>
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2">
                                            <span className={`text-[10px] border px-1 rounded ${typeColor} border-current`}>
                                                {item.type === 'income' ? 'æ”¶å…¥' : item.type === 'transfer' ? 'è½‰å¸³' : 'æ”¯å‡º'}
                                            </span>
                                            <div className="text-[#333] font-medium">{item.name}</div>
                                            {isFinished ? <span className="text-[10px] bg-green-100 text-green-600 px-1 rounded">å·²çµæŸ</span> : (!isActive && <span className="text-[10px] bg-gray-100 text-gray-400 px-1 rounded">å·²æš«åœ</span>)}
                                        </div>
                                        <div className="text-xs text-gray-400 mt-1 flex gap-2 items-center">
                                            <span>æ¯æœˆ{item.day}è™Ÿ</span>
                                            {/* â˜… ä¿®æ­£ï¼šé¡¯ç¤ºå«æ¯ç¸½é¡ */}
                                            <span className="text-[#333] font-medium">${formatMoney(Number(item.amount) + Number(item.interest || 0))}</span>
                                            {item.interest > 0 && <span className="text-[10px] text-gray-400">(æœ¬${item.amount}+æ¯${item.interest})</span>}
                                            {item.lastPeriodAmount != null && <span className="text-[10px] text-orange-500 bg-orange-50 px-1 rounded border border-orange-100">æœ«æœŸ ${item.lastPeriodAmount}</span>}
                                            {item.totalPeriods && <span className="text-[10px] bg-gray-100 px-1 rounded">é€²åº¦: {item.executedPeriods||0}/{item.totalPeriods}</span>}                                        </div>
                                    </div>
                                    <div className="flex items-center gap-1">
                                        {!isFinished && (
                                            <div onClick={() => toggleActive(item.id)} className={`w-8 h-4 rounded-full relative cursor-pointer transition mr-2 ${isActive ? 'bg-[#333]' : 'bg-gray-200'}`}>
                                                <div className={`w-2 h-2 bg-white rounded-full absolute top-1 transition-all ${isActive ? 'left-5' : 'left-1'}`}></div>
                                            </div>
                                        )}
                                        <button onClick={() => handleEditClick(item)} className="text-gray-300 hover:text-[#333] p-2"><Icon name="edit" size={16}/></button>
                                        <button onClick={() => handleDelete(item.id)} className="text-gray-300 hover:text-red-500 p-2"><Icon name="trash" size={16}/></button>
                                    </div>
                                </div>
                            );
                        }) : (
                            <div className="text-center py-20 text-gray-400 text-sm">å°šç„¡é€±æœŸè¨­å®š</div>
                        )}
                        <button onClick={handleAddClick} className="w-full py-3.5 border border-dashed border-gray-300 text-gray-400 rounded flex items-center justify-center gap-2 mt-4 hover:bg-white transition"><Icon name="plus" size={18} /> æ–°å¢é …ç›®</button>
                    </div>
                </div>
            );
        };


        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MoneyMasterApp />);
        // --- è¨»å†Š Service Worker (PWA) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

    </script>
</body>
</html>