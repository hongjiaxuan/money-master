<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Money Master</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // 啟用 class 策略，讓我們可以手動切換
        }
    </script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

    <style>
        /* --- 全域樣式設定 --- */
        :root {
            --bg-muji: #F5F5F3;
            --text-primary: #333333;
            --text-secondary: #7F7F7F;
            --border-color: #E6E6E6;
            --nav-height: 64px;
        }

        body {
            background-color: var(--bg-muji);
            color: var(--text-primary);
            font-family: "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Microsoft JhengHei", sans-serif;
            margin: 0;
            padding: 0;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }

        #root {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes slide-up {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }

        .muji-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        
        .muji-button:active {
            opacity: 0.6;
            transform: scale(0.98);
        }
        /* 弧形視窗效果 */
        .modal-curve-top {
            border-radius: 50% 50% 0 0 / 24px 24px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }
        
        /* 預算進度條動畫 */
        @keyframes grow-width {
            from { width: 0; }
            to { width: 100%; }
        }
        .animate-grow { animation: grow-width 1s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        /* 記帳電子雞動畫 */
        @keyframes fan-out {
            from { opacity: 0; transform: translate(0, 0) scale(0.5); }
        }
        /* --- Dark Mode 全域覆寫 (莫蘭迪深灰版) --- */
        /* 1. 背景色：使用柔和的霧面深灰，而非純黑 */
        html.dark body {
            background-color: #2B2D30; /* 莫蘭迪深炭灰 */
            color: #E6E6E6; /* 柔和白，不刺眼 */
        }
        
        /* 2. 卡片背景：比背景稍亮一點的灰色，營造層次感 */
        html.dark .bg-white { 
            background-color: #36393F !important; /* 類似 Discord 的舒適灰 */
            border-color: #40444B !important;     /* 邊框顏色要淡化 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2) !important; /* 柔和陰影 */
        }
        
        /* 3. 修正原本的淺灰背景 */
        html.dark .bg-\[\#F5F5F3\] { 
            background-color: #2B2D30 !important; /* 與 Body 背景一致 */
        } 
        
        /* 4. 修正輸入框與次要區塊 */
        html.dark .bg-gray-50, 
        html.dark .bg-gray-100 { 
            background-color: #40444B !important; /* 淺一點的灰 */
            border-color: #4F545C !important; 
        }
        
        html.dark .bg-gray-200 { 
            background-color: #4F545C !important; 
        }

        /* 5. 反轉主要黑色按鈕 (改成淺灰白，讓文字變深灰) */
        html.dark .bg-\[\#333\] { 
            background-color: #B9BBBE !important; /* 莫蘭迪淺灰 */
            color: #202225 !important;            /* 深色文字 */
        } 
        
        /* 6. 文字顏色優化 (降低對比度) */
        html.dark .text-\[\#333\] { color: #E6E6E6 !important; }
        html.dark .text-gray-600 { color: #B9BBBE !important; } /* 次要文字 */
        html.dark .text-gray-500 { color: #A0A0A0 !important; }
        html.dark .text-gray-400 { color: #888888 !important; }
        
        /* 7. 邊框與細節 */
        html.dark .border-gray-100, 
        html.dark .border-gray-200 { 
            border-color: #40444B !important; 
        }
        
        html.dark input, 
        html.dark select { 
            color: #E6E6E6 !important; 
            background-color: transparent !important; 
        }
        
        html.dark .shadow-sm, 
        html.dark .shadow-md, 
        html.dark .shadow-lg { 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3) !important; 
        }
        
        /* 8. 特殊修正 */
        html.dark .muji-card { 
            background-color: #36393F; 
            border-color: #40444B; 
        }
        /* 圖表文字 */
        html.dark .recharts-text { fill: #A0A0A0 !important; }
        /* --- 記帳電子雞樣式 --- */
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        .animate-bounce-slow { animation: bounce-slow 2s infinite ease-in-out; }
        
        /* 對話框小尾巴 */
        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px 6px 0;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        /* 深色模式下的對話框 */
        html.dark .speech-bubble { background-color: #36393F; color: #E6E6E6; border: 1px solid #40444B; }
        html.dark .speech-bubble::after { border-color: #40444B transparent transparent transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // --- Icons ---
        const IconPaths = {
            wallet: <path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4M4 6v12c0 1.1.9 2 2 2h14v-4M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z" />,
            creditCard: <g><rect width="20" height="14" x="2" y="5" rx="2" /><line x1="2" x2="22" y1="10" y2="10" /></g>,
            banknote: <g><rect width="20" height="12" x="2" y="6" rx="2" /><circle cx="12" cy="12" r="2" /><path d="M6 12h.01M18 12h.01" /></g>,
            plus: <g><path d="M5 12h14" /><path d="M12 5v14" /></g>,
            home: <g><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></g>,
            pieChart: <g><path d="M21.21 15.89A10 10 0 1 1 8 2.83" /><path d="M22 12A10 10 0 0 0 12 2v10z" /></g>,
            settings: <g><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></g>,
            back: <path d="m15 18-6-6 6-6" />,
            chevronRight: <path d="m9 18 6-6-6-6" />,
            chevronDown: <path d="m6 9 6 6 6-6" />,
            fileText: <g><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" x2="8" y1="13" y2="13" /><line x1="16" x2="8" y1="17" y2="17" /><line x1="10" x2="8" y1="9" y2="9" /></g>,
            trash: <g><path d="M3 6h18" /><path d="M19 6v14c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V6" /><path d="M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></g>,
            calendar: <g><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></g>,
            rotateCcw: <g><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></g>,
            close: <g><path d="M18 6 6 18" /><path d="m6 6 12 12" /></g>,
            list: <g><line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" /><line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" /></g>,
            edit: <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />,
            utensils: <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2M7 2v20M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7" />,
            bus: <path d="M8 6v6M15 6v6M2 12h19.6M18 18h3s.5-1.7.5-2.8M15 12V2.12C15.04.97 14.16.04 13 .04H8C6.84.04 5.96.97 6 2.12V12M1 18h3s.5-1.7.5-2.8M6 12v5M18 12v5" />, 
            shoppingBag: <g><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></g>,
            film: <g><rect width="20" height="20" x="2" y="2" rx="2.18" ry="2.18"/><line x1="7" x2="7" y1="2" y2="22"/><line x1="17" x2="17" y1="2" y2="22"/><line x1="2" x2="22" y1="12" y2="12"/><line x1="2" x2="7" y1="7" y2="7"/><line x1="2" x2="7" y1="17" y2="17"/><line x1="17" x2="22" y1="17" y2="17"/><line x1="17" x2="22" y1="7" y2="7"/></g>,
            briefcase: <g><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></g>,
            trendingUp: <g><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></g>,
            circleDollar: <g><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 18V6"/></g>,
            split: <path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l5 5M4 4l5 5"/>,
            medical: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>,
            more: <g><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></g>,
            users: <g><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></g>,
            check: <polyline points="20 6 9 17 4 12" />,
            download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>,
            lightning: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />,
            template: <g><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><line x1="3" y1="9" x2="21" y2="9" /><line x1="9" y1="21" x2="9" y2="9" /></g>,
            image: <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />,
            search: <g><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></g>,
            cloud: <path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.1-2.6-2.2-4.7-4.8-4.7-2.3 0-4.2 1.6-4.7 3.8C1.8 15.6 1.8 18.5 4.5 19h13z" />,
            upload: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></g>,
	        chevronUp: <path d="m18 15-6-6-6 6" />,
            grid: <g><rect x="3" y="3" width="7" height="7" /><rect x="14" y="3" width="7" height="7" /><rect x="14" y="14" width="7" height="7" /><rect x="3" y="14" width="7" height="7" /></g>,
            userCheck: <g><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></g>,
            moon: <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />,
            sun: <g><circle cx="12" cy="12" r="5" /><line x1="12" y1="1" x2="12" y2="3" /><line x1="12" y1="21" x2="12" y2="23" /><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" /><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" /><line x1="1" y1="12" x2="3" y2="12" /><line x1="21" y1="12" x2="23" y2="12" /><line x1="4.22" y1="19.78" x2="5.64" y2="18.36" /><line x1="18.36" y1="5.64" x2="19.78" y2="4.22" /></g>,
            eye: <g><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" /><circle cx="12" cy="12" r="3" /></g>,
            eyeOff: <g><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24" /><line x1="1" y1="1" x2="23" y2="23" /></g>,
        };

        const Icon = ({ name, size = 20, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {IconPaths[name] || IconPaths.close}
            </svg>
        );

        // --- 工具函式 ---
        // 1. 金額千分位格式化
        const formatMoney = (amount) => {
            if (amount === undefined || amount === null || isNaN(amount)) return '0';
            // 移除小數點後多餘的 0，若有小數則保留
            return Number(amount).toLocaleString('en-US', { maximumFractionDigits: 2 });
        };

        // 2. 產生 UUID (確保 ID 唯一性)
        const generateId = () => Date.now().toString() + Math.random().toString(36).substr(2, 5);
        // --- Mock Data ---
        const INITIAL_ACCOUNTS = [
            { id: 'a1', name: '現金', type: 'cash', balance: 0, initialBalance: 0, currency: 'TWD' },
            { id: 'a2', name: '銀行', type: 'bank', balance: 0, initialBalance: 0, currency: 'TWD' },
            { id: 'a3', name: '信用卡', type: 'liability', balance: 0, initialBalance: 0, currency: 'TWD', limit: 150000 },
        ];

        const INITIAL_CATEGORIES = {
            expense: [
                { id: 'c1', name: '餐飲', iconKey: 'utensils', color: '#A5A58D', subCategories: [{id:'c1s1', name:'早餐'}, {id:'c1s2', name:'午餐'}, {id:'c1s3', name:'晚餐'}] },
                { id: 'c2', name: '交通', iconKey: 'bus', color: '#6B705C', subCategories: [{id:'c2s1', name:'捷運'}, {id:'c2s2', name:'計程車'}, {id:'c2s3', name:'加油'}] },
                { id: 'c3', name: '日用', iconKey: 'shoppingBag', color: '#CB997E', subCategories: [] },
                { id: 'c4', name: '娛樂', iconKey: 'film', color: '#DDBEA9', subCategories: [] },
                { id: 'c5', name: '醫療', iconKey: 'medical', color: '#FFE8D6', subCategories: [] },
            ],
            income: [
                { id: 'i1', name: '薪資', iconKey: 'briefcase', color: '#B7B7A4', subCategories: [] },
                { id: 'i2', name: '投資', iconKey: 'trendingUp', color: '#A5A58D', subCategories: [] },
                { id: 'i3', name: '其他', iconKey: 'circleDollar', color: '#DDBEA9', subCategories: [] },
            ]
        };

        const getLocalDateString = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

// 工具：繪製分帳圖片 (修正版：支援標示付款人)
    const drawReceipt = (items, totalAmount) => {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const padding = 40;
            const lineHeight = 50;
            const headerHeight = 120;
            const footerHeight = 100;
            const width = 600;
            const height = headerHeight + (items.length * lineHeight) + footerHeight + padding; // 動態高度

            canvas.width = width;
            canvas.height = height;

            // 背景
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, width, height);

            // 標題
            ctx.fillStyle = '#333333';
            ctx.font = 'bold 36px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('分帳明細', width / 2, 70);
            
            ctx.fillStyle = '#999999';
            ctx.font = '24px sans-serif';
            ctx.fillText(new Date().toISOString().split('T')[0], width / 2, 110);

            // 分隔線
            ctx.beginPath();
            ctx.moveTo(padding, headerHeight);
            ctx.lineTo(width - padding, headerHeight);
            ctx.strokeStyle = '#E5E5E5';
            ctx.stroke();

            // 列表
            ctx.font = '28px sans-serif';
            let y = headerHeight + 50;
            
            items.forEach(item => {
                // 項目名稱
                ctx.textAlign = 'left';
                ctx.fillStyle = '#333333';
                ctx.fillText(item.name, padding, y);
                
                // 特別標註：如果是對方墊付
                if (item.isOtherPaid) {
                    ctx.font = '20px sans-serif';
                    ctx.fillStyle = '#D9534F'; // 紅色
                    const nameWidth = ctx.measureText(item.name).width;
                    ctx.fillText('(對方墊)', padding + 20 + 200, y); // 簡單位移
                    ctx.font = '28px sans-serif'; // 還原字體
                }

                // 金額
                ctx.textAlign = 'right';
                ctx.fillStyle = item.isOtherPaid ? '#D9534F' : '#333333';
                ctx.fillText(`${item.isOtherPaid ? '-' : ''}$${item.amount}`, width - padding, y);
                
                y += lineHeight;
            });

            // 總結分隔線
            ctx.beginPath();
            ctx.moveTo(padding, height - footerHeight + 20);
            ctx.lineTo(width - padding, height - footerHeight + 20);
            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 2;
            ctx.stroke();

            // 總結
            ctx.fillStyle = '#333333';
            ctx.textAlign = 'left';
            ctx.font = 'bold 32px sans-serif';
            ctx.fillText('總計淨額', padding, height - 30);

            ctx.textAlign = 'right';
            ctx.fillStyle = totalAmount >= 0 ? '#333333' : '#D9534F';
            ctx.fillText(`${totalAmount >= 0 ? '我多付 ' : '我少付 '}$${Math.abs(totalAmount)}`, width - padding, height - 30);

            canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.9);
        });
    };

        // --- Components ---
        const Card = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`muji-card p-4 ${className}`}>
                {children}
            </div>
        );
// 修改：移除內部的 setDialog，改由外部傳入的函式控制
const CustomDialog = ({ isOpen, title, content, isConfirm, onConfirm, onCancel }) => {
            if (!isOpen) return null;

            // ★ 修正關鍵：建立一個專屬的處理函式
            const handleConfirmClick = () => {
                // 1. 先執行確認動作 (例如刪除)
                if (onConfirm) onConfirm();
                
                // 2. ★ 強制執行取消動作 (也就是關閉視窗)
                // 因為 DataProvider 裡的 onCancel 就是負責把 show 設為 false
                if (onCancel) onCancel();
            };

            return (
                <div className="fixed inset-0 z-[1200] bg-black/40 flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-white w-full max-w-xs rounded-lg shadow-xl animate-scale-in p-6">
                        <h3 className="text-lg font-medium text-[#333] mb-2">{title}</h3>
                        <p className="text-sm text-gray-500 mb-6 leading-relaxed">{content}</p>
                        <div className="flex gap-3 justify-end">
                            {isConfirm && (
                                <button onClick={onCancel} className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-50 rounded transition">取消</button>
                            )}
                            {/* 這裡綁定我們新寫的 handleConfirmClick */}
                            <button onClick={handleConfirmClick} className="px-4 py-2 text-sm bg-[#333] text-white rounded shadow hover:bg-black transition">
                                {isConfirm ? '確認' : '知道了'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
const TransactionCard = ({ transaction, onClick }) => {
    // ★ 修改 1：直接向 DataProvider 拿資料，不用再靠父元件傳進來
    const { accounts, categories } = React.useContext(DataContext); 

    const isTransfer = transaction.type === 'transfer';
    const cat = !isTransfer ? ((transaction.type === 'expense' ? categories.expense : categories.income).find(c => c.id === transaction.categoryId) || {}) : {};
    const subCat = !isTransfer ? (cat.subCategories || []).find(s => s.id === transaction.subCategoryId) : null;
    // 帳戶資訊
    const acc = accounts.find(a => a.id === transaction.accountId); 
    const targetAcc = isTransfer ? accounts.find(a => a.id === transaction.targetAccountId) : null; 

    const isSplit = transaction.tags && (transaction.tags.includes('#代墊') || transaction.tags.includes('#分帳'));
    const isSettled = transaction.tags && transaction.tags.includes('#已結清');
    const isAdjustment = transaction.tags && transaction.tags.includes('#調整');
    const isReimbursement = transaction.categoryId === 'reimbursement';

    // 顯示邏輯 (維持不變)
    const title = isTransfer 
        ? `轉帳: ${acc?.name} → ${targetAcc?.name}`
        : (isReimbursement ? '分帳報銷' : (cat.name || (isAdjustment ? '餘額調整' : '未分類')));

    const amountColor = isTransfer ? 'text-gray-500' : (transaction.type === 'expense' ? 'text-[#333]' : 'text-[#5CB85C]');
    const amountPrefix = isTransfer ? '' : (transaction.type === 'expense' ? '-' : '+');
    
    // Icon
    const iconName = isTransfer ? 'rotateCcw' : (isReimbursement ? 'split' : (cat.iconKey || 'more')); 

    return (
        <div onClick={onClick} className="bg-white p-4 rounded border border-transparent shadow-sm hover:shadow-md transition cursor-pointer flex items-center gap-4 relative overflow-hidden group">
            {isSplit && <div className="absolute right-0 top-0 bg-[#E0E0E0] text-[#555] text-[9px] px-1.5 py-0.5 rounded-bl">分帳</div>}
            {isSettled && <div className="absolute right-0 top-0 bg-[#5CB85C] text-white text-[9px] px-1.5 py-0.5 rounded-bl">已結清</div>}
            {isAdjustment && <div className="absolute right-0 top-0 bg-yellow-100 text-yellow-600 text-[9px] px-1.5 py-0.5 rounded-bl">調整</div>}
            {isTransfer && <div className="absolute right-0 top-0 bg-blue-50 text-blue-500 text-[9px] px-1.5 py-0.5 rounded-bl">轉帳</div>}
            
            <div className="w-10 h-10 rounded-full bg-[#F5F5F3] flex items-center justify-center text-gray-600 shrink-0 group-hover:bg-[#EAEAEA] transition">
                <Icon name={iconName} size={20} />
            </div>
            <div className="flex-1 min-w-0">
                <div className="flex justify-between items-center mb-1">
                    <span className="text-[#333] font-medium text-sm">
                        {title}
                        {subCat ? ` (${subCat.name})` : ''}
                    </span>
                    <span className={`font-medium ${amountColor}`}>
                        {amountPrefix}{formatMoney(transaction.amount)}
                    </span>
                </div>
                <div className="flex justify-between text-xs text-gray-400">
                    <div className="flex gap-2 items-center">
                        <span>{transaction.note || (isTransfer ? '內部轉帳' : acc?.name)}</span>
                        {isSplit && <Icon name="split" size={10} className="text-[#333]"/>}
                    </div>
                    <span className="font-light">{transaction.date.slice(5)}</span>
                </div>
            </div>
        </div>
    );
};


        const NavButton = ({ iconName, label, isActive, onClick }) => (
            <button onClick={onClick} className={`flex flex-col items-center gap-1.5 transition-all ${isActive ? 'text-[#333]' : 'text-gray-300 hover:text-gray-400'}`}>
                <Icon name={iconName} size={22} strokeWidth={isActive ? 2 : 1.5} />
                <span className="text-[9px] font-medium tracking-widest uppercase">{label}</span>
            </button>
        );
        const SettingItem = ({ iconName, label, className = "", hasArrow }) => (
            <div className={`bg-white p-4 rounded border border-transparent shadow-sm hover:shadow-md hover:border-gray-200 transition cursor-pointer flex items-center justify-between ${className}`}>
                <div className="flex items-center gap-3">
                    <Icon name={iconName} size={18} className={className ? "text-current" : "text-gray-400"} />
                    <span className={`text-sm ${className ? "" : "text-gray-600"}`}>{label}</span>
                </div>
                {hasArrow ? <Icon name="chevronRight" size={16} className="text-gray-300" /> : null}
            </div>
        );
        const BottomFanMenu = ({ title, items, centerContent, onBack, onClose }) => {
            const radius = 135;
            const startAngle = -170; // Left-ish
            const endAngle = -10;    // Right-ish
            const total = items.length;
            const step = total > 1 ? (endAngle - startAngle) / (total - 1) : 0;

            return (
                <div className="fixed inset-0 z-[1000] flex flex-col justify-end animate-fade-in">
                    <div className="absolute inset-0 bg-black/30 backdrop-blur-[2px]" onClick={onClose}></div>
                    <div className="relative w-full h-[320px] bg-white rounded-t-[40px] shadow-2xl animate-slide-up overflow-hidden z-10 flex flex-col items-center">
                        <div className="w-full text-center mt-6 mb-2">
                            <h3 className="text-sm font-bold text-gray-400 tracking-widest uppercase">{title}</h3>
                        </div>
                        <div className="absolute bottom-[-60px] left-1/2 -translate-x-1/2 w-[350px] h-[350px] rounded-full border border-dashed border-gray-200 pointer-events-none"></div>
                        <div className="absolute bottom-6 left-1/2 -translate-x-1/2 z-20">
                            {centerContent ? centerContent : (
                                <button onClick={onBack || onClose} className="w-16 h-16 rounded-full bg-[#333] text-white flex items-center justify-center shadow-lg active:scale-90 transition">
                                    <Icon name={onBack ? "back" : "close"} size={24} />
                                </button>
                            )}
                        </div>
                        <div className="absolute bottom-[60px] left-1/2 w-0 h-0 z-10">
                            {items.map((item, index) => {
                                const angleDeg = total === 1 ? -90 : startAngle + (index * step);
                                const angleRad = angleDeg * (Math.PI / 180);
                                const x = radius * Math.cos(angleRad);
                                const y = radius * Math.sin(angleRad);
                                return (
                                    <button 
                                        key={item.id} 
                                        onClick={item.onClick}
                                        className="absolute w-16 h-16 -ml-8 -mt-8 rounded-full bg-white shadow-md border border-gray-100 flex flex-col items-center justify-center gap-0.5 active:scale-95 transition-all hover:bg-gray-50 hover:-translate-y-1"
                                        style={{ 
                                            transform: `translate(${x}px, ${y}px)`,
                                            animation: `fan-out 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) ${index * 0.05}s backwards`
                                        }}
                                    >
                                        {item.icon}
                                        <span className="text-[10px] font-medium text-gray-600 leading-none scale-90">{item.label}</span>
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

// --- 工具：手勢偵測 Hook ---
const useSwipe = ({ onSwipeLeft, onSwipeRight, threshold = 50 }) => {
    const [touchStart, setTouchStart] = useState(null);
    const [touchEnd, setTouchEnd] = useState(null);
    const [touchStartY, setTouchStartY] = useState(null);
    const [touchEndY, setTouchEndY] = useState(null);

    const onTouchStart = (e) => {
        setTouchEnd(null);
        setTouchStart(e.targetTouches[0].clientX);
        setTouchStartY(e.targetTouches[0].clientY);
    };

    const onTouchMove = (e) => {
        setTouchEnd(e.targetTouches[0].clientX);
        setTouchEndY(e.targetTouches[0].clientY);
    };

    const onTouchEnd = () => {
        if (!touchStart || !touchEnd) return;
        
        const distanceX = touchStart - touchEnd;
        const distanceY = touchStartY - touchEndY;
        const isLeftSwipe = distanceX > threshold;
        const isRightSwipe = distanceX < -threshold;
        
        // 防呆：如果是垂直捲動（Y軸移動大於X軸），則不觸發左右滑動
        if (Math.abs(distanceX) < Math.abs(distanceY)) return;

        if (isLeftSwipe && onSwipeLeft) {
            onSwipeLeft();
        }
        if (isRightSwipe && onSwipeRight) {
            onSwipeRight();
        }
    };

    return { onTouchStart, onTouchMove, onTouchEnd };
};
// 1. 建立 Context 物件
const DataContext = React.createContext();

// 2. 建立 DataProvider 元件 (這是新的資料倉庫)
const DataProvider = ({ children }) => {
    // ==========================================
    // A. 資料狀態 (State) - 從 App 搬過來
    // ==========================================
    // 1. 資料庫 State
    const [transactions, setTransactions] = useState(() => { try { return JSON.parse(localStorage.getItem('mm_transactions')) || []; } catch { return []; } });
    const [accounts, setAccounts] = useState(() => { try { return JSON.parse(localStorage.getItem('mm_accounts')) || INITIAL_ACCOUNTS; } catch { return INITIAL_ACCOUNTS; } });
    const [categories, setCategories] = useState(() => { try { return JSON.parse(localStorage.getItem('mm_categories')) || INITIAL_CATEGORIES; } catch { return INITIAL_CATEGORIES; } });
    const [quickTemplates, setQuickTemplates] = useState(() => { try { return JSON.parse(localStorage.getItem('mm_templates')) || []; } catch { return []; } });
    const [recurringItems, setRecurringItems] = useState(() => { try { return JSON.parse(localStorage.getItem('mm_recurring')) || []; } catch { return []; } });
    
    const [cloudSettings, setCloudSettings] = useState(() => { try { return JSON.parse(localStorage.getItem('mm_cloud_settings')) || { url: '', password: '' }; } catch { return { url: '', password: '' }; } });
    const [lastSyncTime, setLastSyncTime] = useState(() => localStorage.getItem('mm_last_sync_time') || '');
    // 全域 UI 狀態 (Dialog & Loading)
    const [dialog, setDialog] = useState({ show: false, title: '', content: '', isConfirm: false, onConfirm: () => {} });
    const [isSaving, setIsSaving] = useState(false);
    const [isDarkMode, setIsDarkMode] = useState(() => { 
        try { return localStorage.getItem('mm_theme') === 'dark'; } catch { return false; } 
    });
// ★ 新增：隱私模式 (預設關閉)
    const [isPrivacyMode, setIsPrivacyMode] = useState(() => {
        try { return localStorage.getItem('mm_privacy') === 'true'; } catch { return false; }
    });
    // 監聽並儲存設定
    useEffect(() => {
        localStorage.setItem('mm_privacy', isPrivacyMode);
    }, [isPrivacyMode]);

    const togglePrivacy = () => {
        setIsPrivacyMode(prev => !prev);
        triggerHaptic();
    };
    // Dark Mode Effect
    useEffect(() => {
        if (isDarkMode) {
            document.documentElement.classList.add('dark');
            localStorage.setItem('mm_theme', 'dark');
            // 更新狀態列顏色 (針對手機瀏覽器)
            let metaThemeColor = document.querySelector("meta[name=theme-color]");
            if (!metaThemeColor) {
                metaThemeColor = document.createElement("meta");
                metaThemeColor.name = "theme-color";
                document.head.appendChild(metaThemeColor);
            }
            metaThemeColor.content = "#121212";
        } else {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('mm_theme', 'light');
            let metaThemeColor = document.querySelector("meta[name=theme-color]");
            if (metaThemeColor) metaThemeColor.content = "#F5F5F3";
        }
    }, [isDarkMode]);

    const toggleTheme = () => {
        setIsDarkMode(prev => !prev);
        triggerHaptic();
    };
    // ==========================================
    // B. 持久化與自動邏輯 (Effects) - 從 App 搬過來
    // ==========================================
    // 2. 持久化
    useEffect(() => { localStorage.setItem('mm_transactions', JSON.stringify(transactions)); }, [transactions]);
    useEffect(() => { localStorage.setItem('mm_accounts', JSON.stringify(accounts)); }, [accounts]);
    useEffect(() => { localStorage.setItem('mm_categories', JSON.stringify(categories)); }, [categories]);
    useEffect(() => { localStorage.setItem('mm_templates', JSON.stringify(quickTemplates)); }, [quickTemplates]);
    useEffect(() => { localStorage.setItem('mm_recurring', JSON.stringify(recurringItems)); }, [recurringItems]);
    useEffect(() => { localStorage.setItem('mm_cloud_settings', JSON.stringify(cloudSettings)); }, [cloudSettings]);
    useEffect(() => { if(lastSyncTime) localStorage.setItem('mm_last_sync_time', lastSyncTime); }, [lastSyncTime]);
    // 3. 自動備份
    useEffect(() => {
        if (!cloudSettings.url || !cloudSettings.password) return;
        const timer = setTimeout(() => handleCloudBackup(true), 5000); 
        return () => clearTimeout(timer);
    }, [transactions, accounts, categories, quickTemplates, recurringItems]);
    // --- 修正：週期帳單檢查邏輯 (支援多類型) ---
    useEffect(() => {
        const checkRecurring = () => {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1; 
            const currentDay = today.getDate();
            const currentMonthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            
            let newTxList = [];
            let hasUpdates = false;

            const updatedRecurring = recurringItems.map(item => {
                if (item.active === false) return item;
                if (item.startDate && item.startDate > currentMonthKey) return item;
                if (item.totalPeriods && (item.executedPeriods || 0) >= item.totalPeriods) return item;
                if (item.lastGeneratedMonth === currentMonthKey) return item;

                const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
                const targetDay = Math.min(item.day, daysInMonth);

                if (currentDay >= targetDay) {
                    // 根據類型產生交易
                    const newTx = {
                        id: generateId(),
                        createdAt: Date.now(),
                        date: `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(targetDay).padStart(2, '0')}`,
                        amount: item.amount,
                        type: item.type || 'expense', // 預設 expense
                        categoryId: item.type === 'transfer' ? 'transfer' : item.categoryId,
                        accountId: item.accountId,
                        targetAccountId: item.type === 'transfer' ? item.targetAccountId : null,
                        note: `[週期] ${item.name} (${(item.executedPeriods || 0) + 1}/${item.totalPeriods || '∞'})`,
                        tags: ['#週期帳單']
                    };
                    newTxList.push(newTx);
                    hasUpdates = true;
                    
                    return { ...item, lastGeneratedMonth: currentMonthKey, executedPeriods: (item.executedPeriods || 0) + 1 };
                }
                return item;
            });

            if (hasUpdates) {
                setTransactions(prev => [...newTxList, ...prev].sort((a, b) => new Date(b.date) - new Date(a.date)));
                
                // 更新帳戶餘額 (支援轉帳/收入/支出)
                let newAccounts = [...accounts];
                newTxList.forEach(tx => {
                    if (tx.type === 'transfer') {
                        newAccounts = newAccounts.map(a => {
                            if (a.id === tx.accountId) return { ...a, balance: a.balance - tx.amount };
                            if (a.id === tx.targetAccountId) return { ...a, balance: a.balance + tx.amount };
                            return a;
                        });
                    } else {
                        const isExpense = tx.type === 'expense';
                        newAccounts = newAccounts.map(a => a.id === tx.accountId ? {...a, balance: a.balance + (isExpense ? -tx.amount : tx.amount)} : a);
                    }
                });
                setAccounts(newAccounts);
                setRecurringItems(updatedRecurring);
                showAlert('週期入帳', `已自動執行 ${newTxList.length} 筆定期交易`);
            }
        };
        const timer = setTimeout(checkRecurring, 1000);
        return () => clearTimeout(timer);
    }, [recurringItems, accounts]);
    // ==========================================
    // C. 操作邏輯 (Handlers) - 從 App 搬過來
    // ==========================================
    // 觸發震動反饋
    const triggerHaptic = (pattern = 10) => {
        try {
            // 加強防呆：確認瀏覽器支援 vibrate API 且不是在特殊環境
            if (typeof navigator !== 'undefined' && navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        } catch (e) {
            // 如果報錯，靜默失敗，不要讓程式崩潰
            console.log('Haptic not supported');
        }
    };
// 1. 全域 UI 呼叫
    const showAlert = (title, content) => {
        setDialog({ show: true, title, content, isConfirm: false, onConfirm: () => setDialog(prev => ({...prev, show: false})) });
    };

    // ★ 修正重點：在這裡包裹 onConfirmAction，執行完動作後自動關閉視窗
    const showConfirm = (title, content, onConfirmAction) => {
        setDialog({
            show: true,
            title,
            content,
            isConfirm: true,
            onConfirm: () => {
                if (onConfirmAction) onConfirmAction(); // 1. 執行刪除動作
                setDialog(prev => ({...prev, show: false})); // 2. 關閉視窗
            }
        });
    };// 2. 交易存檔 (修正版：嚴格保留原始 createdAt 以維持排序)
    const handleSaveTransaction = (tx, editingId = null) => {
        let newAcc = [...accounts];
        let newTx = [...transactions];
        
        // --- A. 舊交易回滾 (還原餘額) ---
        // 必須先抓出舊交易的 createdAt，稍後要塞回去
        let originalCreatedAt = Date.now(); 

        if (editingId) {
            const oldTx = transactions.find(t => t.id === editingId);
            if (oldTx) {
                originalCreatedAt = oldTx.createdAt || Date.now(); // ★ 關鍵：記住它的出生時間

                if (oldTx.payer !== 'other') {
                     if (oldTx.type === 'transfer') {
                        newAcc = newAcc.map(a => { 
                            if (a.id === oldTx.accountId) return { ...a, balance: a.balance + oldTx.amount }; 
                            if (a.id === oldTx.targetAccountId) return { ...a, balance: a.balance - oldTx.amount }; 
                            return a; 
                        });
                    } else {
                        newAcc = newAcc.map(a => a.id === oldTx.accountId ? {...a, balance: a.balance + (oldTx.type === 'expense' ? oldTx.amount : -oldTx.amount)} : a);
                    }
                }
            }
            newTx = newTx.filter(t => t.id !== editingId);
        }
        
        // --- B. 新交易扣款 ---
        if (tx.payer !== 'other') {
             if (tx.type === 'transfer') {
                newAcc = newAcc.map(a => { 
                    if (a.id === tx.accountId) return { ...a, balance: a.balance - tx.amount }; 
                    if (a.id === tx.targetAccountId) return { ...a, balance: a.balance + tx.amount }; 
                    return a; 
                });
            } else {
                newAcc = newAcc.map(a => a.id === tx.accountId ? {...a, balance: a.balance + (tx.type === 'expense' ? -tx.amount : tx.amount)} : a);
            }
        }
        
        // --- C. 組合最終物件 ---
        const finalTx = { 
            ...tx, 
            id: editingId || generateId(), 
            // ★ 關鍵：如果是編輯，強制使用原始時間；如果是新增，才用現在時間
            createdAt: editingId ? originalCreatedAt : Date.now() 
        };
        
        // --- D. 排序：先比日期(Date)，日期相同比建立時間(createdAt) ---
        newTx = [finalTx, ...newTx].sort((a, b) => { 
            const dateDiff = new Date(b.date) - new Date(a.date); 
            if (dateDiff !== 0) return dateDiff; 
            return (b.createdAt || 0) - (a.createdAt || 0); 
        });
        
        setAccounts(newAcc);
        setTransactions(newTx);
    };
// 3. 刪除交易 (修正：移除不存在的 closeModal)
    const handleDeleteTransaction = (txId) => { 
        showConfirm('刪除', '確定刪除此筆交易？', () => { 
            const tx = transactions.find(t => t.id === txId); 
            if (!tx) return; // 防呆

            let newAcc = [...accounts]; 
            
            // 還原餘額邏輯
            if (tx.payer !== 'other') { // 如果不是對方墊付才需要還原
                if (tx.type === 'transfer') { 
                    newAcc = newAcc.map(a => { 
                        if (a.id === tx.accountId) return { ...a, balance: a.balance + tx.amount }; 
                        if (a.id === tx.targetAccountId) return { ...a, balance: a.balance - tx.amount }; 
                        return a; 
                    }); 
                } else { 
                    newAcc = newAcc.map(a => a.id === tx.accountId ? {...a, balance: a.balance + (tx.type === 'expense' ? tx.amount : -tx.amount)} : a); 
                } 
            }
            
            setTransactions(prev => prev.filter(t => t.id !== txId)); 
            setAccounts(newAcc); 
            // 注意：這裡移除了 closeModal()，因為 DataProvider 不控制 UI 視窗
        }); 
    };

    // 帳戶存檔 
    const handleSaveAccount = (accData) => { 
        const existing = accounts.find(a => a.id === accData.id); 
        
        if (existing) { 
            // 編輯現有帳戶
            const diff = accData.balance - existing.balance; 
            if (diff !== 0) { 
                const type = diff > 0 ? 'income' : 'expense'; 
                const adjTx = { 
                    id: generateId(), 
                    createdAt: Date.now(), 
                    date: getLocalDateString(), 
                    amount: Math.abs(diff), 
                    type: type, 
                    categoryId: 'adjustment', 
                    subCategoryId: null, 
                    accountId: accData.id, 
                    note: '餘額調整', 
                    tags: ['#調整'] 
                }; 
                setTransactions(prev => [adjTx, ...prev].sort((a, b) => new Date(b.date) - new Date(a.date))); 
            } 
            const updatedAccount = { ...existing, ...accData, initialBalance: existing.initialBalance }; 
            setAccounts(accounts.map(a => a.id === accData.id ? updatedAccount : a)); 
        } else { 
            // 新增帳戶
            const maxOrder = accounts.reduce((max, a) => Math.max(max, a.sortOrder || 0), 0); 
            setAccounts([...accounts, { ...accData, id: generateId(), initialBalance: accData.balance, sortOrder: maxOrder + 1 }]); 
        } 
        // 注意：這裡移除了 setEditingAccount(null)，因為這是 UI 層的工作
    };
    // 刪除帳戶邏輯
    const handleDeleteAccount = (accId) => {
        // 1. 檢查是否有關聯交易
        const relatedTxCount = transactions.filter(t => t.accountId === accId || t.targetAccountId === accId).length;
        const relatedRecurring = recurringItems.filter(r => r.accountId === accId || r.targetAccountId === accId).length;
        
        let warningMsg = '確定要刪除此帳戶？';
        
        if (relatedTxCount > 0 || relatedRecurring > 0) {
            warningMsg = `⚠️ 警告：此帳戶包含 ${relatedTxCount} 筆交易與 ${relatedRecurring} 個週期設定。\n\n刪除後，相關交易紀錄將保留，但帳戶名稱將顯示為未知。`;
        }

        showConfirm('刪除帳戶', warningMsg, () => {
            setAccounts(prev => prev.filter(a => a.id !== accId));
         });
    };
    //  分帳結清
    const handleSettleSplit = (newTransactions, newAccounts) => { setTransactions(newTransactions.sort((a, b) => new Date(b.date) - new Date(a.date))); setAccounts(newAccounts); };            
    //  帳戶排序
    const handleReorderAccounts = (newAccounts) => { setAccounts(newAccounts); };
    //  暫時還款提示
    const handleRepay = (liabilityAcc) => {
         const amount = Math.abs(liabilityAcc.balance);
         const bankAcc = accounts.find(a => a.type === 'bank') || accounts[0];
         // 這裡需要透過 Context 觸發 Modal，但簡化起見，我們先用 Alert 提示
         // 實際上這應該在 UI 層處理，或者將 Modal 狀態移入 Context
         showAlert('提示', '請至首頁使用「轉帳」功能進行還款');
    }
    //  合併並刪除分類
    const handleMergeAndDeleteCategory = (deleteId, targetId) => {
        // 1. 更新交易
        const newTransactions = transactions.map(t => t.categoryId === deleteId ? { ...t, categoryId: targetId } : t);
        setTransactions(newTransactions);
        
        // 2. 更新週期設定
        const newRecurring = recurringItems.map(r => r.categoryId === deleteId ? { ...r, categoryId: targetId } : r);
        setRecurringItems(newRecurring);

        // 3. 更新模板
        const newTemplates = quickTemplates.map(t => t.categoryId === deleteId ? { ...t, categoryId: targetId } : t);
        setQuickTemplates(newTemplates);

        // 4. 執行刪除 (需判斷是 expense 還是 income)
        const isExpense = categories.expense.some(c => c.id === deleteId);
        const listName = isExpense ? 'expense' : 'income';
        const newCategories = {
            ...categories,
            [listName]: categories[listName].filter(c => c.id !== deleteId)
        };
        setCategories(newCategories);
        showAlert('完成', '分類已刪除，交易資料已移轉。');
    };
    //  資料匯入匯出
    const handleExportData = () => { const data = { transactions, accounts, categories, quickTemplates, recurringItems, version: "4.9" }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `money_master_backup_${getLocalDateString()}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); };
    const handleImportData = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if (!data.transactions) { showAlert('失敗', '格式錯誤'); return; } showConfirm('確認', '確定還原？', () => applyCloudData(data)); } catch { showAlert('失敗', '解析錯誤'); } }; reader.readAsText(file); event.target.value = ''; };
// 匯出 CSV (Excel 專用)
    const handleExportCSV = () => {
        // 1. 定義 CSV 標題
        const headers = ['ID', '日期', '類型', '金額', '分類', '細項', '帳戶', '轉入帳戶', '備註', '標籤'];
        
        // 2. 轉換資料
        const rows = transactions.map(t => {
            const catName = (t.type === 'expense' ? categories.expense : categories.income).find(c => c.id === t.categoryId)?.name || (t.categoryId === 'reimbursement' ? '分帳結清' : '其他');
            
            // 尋找細項名稱
            let subName = '';
            if (t.subCategoryId) {
                const cat = (t.type === 'expense' ? categories.expense : categories.income).find(c => c.id === t.categoryId);
                const sub = cat?.subCategories?.find(s => s.id === t.subCategoryId);
                subName = sub ? sub.name : '';
            }

            const accName = accounts.find(a => a.id === t.accountId)?.name || '未知';
            const targetAccName = t.targetAccountId ? (accounts.find(a => a.id === t.targetAccountId)?.name || '') : '';
            const tagsStr = t.tags ? t.tags.join(' ') : '';
            const typeStr = t.type === 'expense' ? '支出' : (t.type === 'income' ? '收入' : '轉帳');

            // 處理 CSV 特殊字元 (如逗號)
            const safeNote = `"${(t.note || '').replace(/"/g, '""')}"`; 

            return [
                t.id,
                t.date,
                typeStr,
                t.amount,
                catName,
                subName,
                accName,
                targetAccName,
                safeNote,
                tagsStr
            ].join(',');
        });

        // 3. 組合內容 (加上 BOM \uFEFF 讓 Excel 能正確識別中文)
        const csvContent = '\uFEFF' + headers.join(',') + '\n' + rows.join('\n');

        // 4. 下載檔案
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `money_master_export_${getLocalDateString()}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
    // 7. 雲端備份相關
    const handleCloudBackup = async (isSilent = false) => {if (!cloudSettings.url || !cloudSettings.password) { if(!isSilent) showAlert('錯誤', '請先輸入網址與密碼'); return; }if (!isSilent) setIsSaving(true);const now = new Date().toISOString();const payload = { op: 'backup', password: cloudSettings.password, data: { transactions, accounts, categories, quickTemplates, recurringItems, version: "4.9", backupDate: now } };try {await fetch(cloudSettings.url, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) }).then(res => res.json()).then(res => {if (res.status === 'success') { setLastSyncTime(now); if (!isSilent) { setIsSaving(false); showAlert('成功', '備份已上傳！'); } } else { throw new Error(res.message); }});} catch (error) { if (!isSilent) { setIsSaving(false); showAlert('失敗', '連線錯誤'); } }};
    const handleManualRestore = async (inputUrl, inputPwd) => {if (!inputUrl) { showAlert('錯誤', '請輸入網址'); return; }const newSettings = { url: inputUrl, password: inputPwd };setCloudSettings(newSettings);localStorage.setItem('mm_cloud_settings', JSON.stringify(newSettings));setIsSaving(true);try {const response = await fetch(inputUrl, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ op: 'restore' }) });const data = await response.json();setIsSaving(false);if (data.status === 'error') { showAlert(data.message === 'FileNotFound' ? '連結成功' : '錯誤', data.message === 'FileNotFound' ? '目前雲端無備份' : data.message); return; }showConfirm('☁️ 找到備份', `時間：${new Date(data.backupDate).toLocaleString()}\n確定要還原嗎？`, () => applyCloudData(data));} catch (error) { setIsSaving(false); showAlert('連線失敗', '請確認 GAS 設定'); }};
    const applyCloudData = (data) => {const finalData = data.transactions ? data : (data.data || data);if (!finalData.transactions) { showAlert('錯誤', '格式有誤'); return; }setTransactions(finalData.transactions || []); setAccounts(finalData.accounts || []); setCategories(finalData.categories || []); setQuickTemplates(finalData.quickTemplates || []); setRecurringItems(finalData.recurringItems || []);setLastSyncTime(finalData.backupDate || new Date().toISOString());if(!data.silent) showAlert('完成', '資料已同步！');};

    // ==========================================
    // D. 對外公開的資料 (Context Value)
    // ==========================================
    const value = {
        transactions, accounts, categories, quickTemplates, recurringItems, cloudSettings,isDarkMode, toggleTheme,isPrivacyMode, togglePrivacy,
        setTransactions, setAccounts, setCategories, setQuickTemplates, setRecurringItems, setCloudSettings,
        totalAssets: useMemo(() => accounts.reduce((sum, acc) => sum + acc.balance, 0), [accounts]),
        
        // 動作
        handleSaveTransaction, handleDeleteTransaction, handleSaveAccount, handleReorderAccounts,
        handleSettleSplit, handleRepay, handleMergeAndDeleteCategory, // ★ 記得匯出這個
        handleExportData, handleExportCSV,handleImportData,handleDeleteAccount,
        handleCloudBackup, handleManualRestore, applyCloudData,
        showAlert, showConfirm, setIsSaving,

        triggerHaptic
    };
    return (
        <DataContext.Provider value={value}>
            {children}
            {/* 全域元件放在這裡 */}
            <CustomDialog isOpen={dialog.show} title={dialog.title} content={dialog.content} isConfirm={dialog.isConfirm} onConfirm={dialog.onConfirm} onCancel={() => setDialog(prev => ({...prev, show: false}))} />
            {isSaving && <div className="fixed inset-0 z-[1300] bg-black/50 flex items-center justify-center animate-fade-in"><div className="bg-white px-6 py-4 rounded-lg shadow-xl flex items-center gap-3"><div className="w-4 h-4 border-2 border-gray-200 border-t-[#333] rounded-full animate-spin"></div><span className="text-sm font-medium text-[#333]">處理中...</span></div></div>}
        </DataContext.Provider>
    );
};
// ==========================================
        // 修正後的 AccountModal (新增：刪除按鈕)
        // ==========================================
        const AccountModal = ({ initialData, onClose, onSave, onDelete }) => {
            const data = initialData || {};

            const [name, setName] = useState(data.name || '');
            const [type, setType] = useState(data.type || 'cash');
            const [balance, setBalance] = useState(data.balance !== undefined ? data.balance.toString() : '0');
            const [initialBalance, setInitialBalance] = useState(data.initialBalance !== undefined ? data.initialBalance.toString() : '0');
            
            // 信用卡專屬欄位
            const [limit, setLimit] = useState(data.limit ? data.limit.toString() : '');
            const [billDay, setBillDay] = useState(data.billDay ? data.billDay.toString() : '');
            const [dueDay, setDueDay] = useState(data.dueDay ? data.dueDay.toString() : '');
            const [reminder, setReminder] = useState(data.reminder || false);

            const handleSave = () => {
                if (!name.trim()) return;
                const accData = {
                    id: data.id, 
                    name, 
                    type,
                    balance: Number(balance),
                    initialBalance: Number(initialBalance),
                    currency: 'TWD'
                };

                if (type === 'liability') {
                    accData.limit = limit ? Number(limit) : 0;
                    accData.billDay = billDay ? Number(billDay) : null;
                    accData.dueDay = dueDay ? Number(dueDay) : null;
                    accData.reminder = reminder;
                }

                onSave(accData);
            };

            return (
                <div className="fixed inset-0 z-[1100] bg-black/40 flex items-center justify-center p-6 animate-fade-in">
                    <div className="absolute inset-0" onClick={onClose}></div>
                    
                    <div className="bg-white w-full max-w-sm rounded-lg shadow-xl p-6 animate-slide-up max-h-[85vh] overflow-y-auto relative z-10">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-medium text-[#333]">{data.id ? '編輯帳戶' : '新增帳戶'}</h3>
                            <div className="flex gap-2">
                                {/* ★ 新增：刪除按鈕 (只有編輯模式才顯示) */}
                                {data.id && (
                                    <button onClick={() => onDelete(data.id)} className="p-2 text-gray-300 hover:text-red-500 transition">
                                        <Icon name="trash" />
                                    </button>
                                )}
                                <button onClick={onClose} className="p-2 -mr-2 text-gray-400"><Icon name="close" /></button>
                            </div>
                        </div>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="text-xs text-gray-400 block mb-1">帳戶名稱</label>
                                <input className="w-full border-b py-1 outline-none text-[#333] placeholder-gray-300" placeholder="例如：台新信用卡" value={name} onChange={e => setName(e.target.value)} />
                            </div>
                            
                            <div>
                                <label className="text-xs text-gray-400 block mb-1">類型</label>
                                <div className="flex bg-gray-100 p-1 rounded-lg">
                                    <button onClick={() => setType('cash')} className={`flex-1 py-2 text-xs font-medium rounded transition ${type === 'cash' ? 'bg-white text-[#333] shadow-sm' : 'text-gray-500'}`}>現金</button>
                                    <button onClick={() => setType('bank')} className={`flex-1 py-2 text-xs font-medium rounded transition ${type === 'bank' ? 'bg-white text-[#333] shadow-sm' : 'text-gray-500'}`}>銀行</button>
                                    <button onClick={() => setType('liability')} className={`flex-1 py-2 text-xs font-medium rounded transition ${type === 'liability' ? 'bg-white text-[#333] shadow-sm' : 'text-gray-500'}`}>信用卡</button>
                                </div>
                            </div>
                            
                            {type === 'liability' && (
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-100 space-y-3 mt-2">
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">信用額度</label>
                                        <input type="number" className="w-full border-b border-gray-300 bg-transparent py-1 outline-none text-[#333]" placeholder="例如: 150000" value={limit} onChange={e => setLimit(e.target.value)} />
                                    </div>
                                    <div className="flex gap-4">
                                        <div className="flex-1">
                                            <label className="text-xs text-gray-500 block mb-1">結帳日 (每月)</label>
                                            <input type="number" min="1" max="31" className="w-full border-b border-gray-300 bg-transparent py-1 outline-none text-[#333]" placeholder="日" value={billDay} onChange={e => setBillDay(e.target.value)} />
                                        </div>
                                        <div className="flex-1">
                                            <label className="text-xs text-gray-500 block mb-1">還款日 (每月)</label>
                                            <input type="number" min="1" max="31" className="w-full border-b border-gray-300 bg-transparent py-1 outline-none text-[#333]" placeholder="日" value={dueDay} onChange={e => setDueDay(e.target.value)} />
                                        </div>
                                    </div>
                                    <div className="flex justify-between items-center pt-1">
                                        <span className="text-xs text-gray-500">啟用繳款提醒</span>
                                        <div onClick={() => setReminder(!reminder)} className={`w-10 h-5 rounded-full relative cursor-pointer transition ${reminder ? 'bg-[#333]' : 'bg-gray-300'}`}>
                                            <div className={`w-3 h-3 bg-white rounded-full absolute top-1 transition-all ${reminder ? 'left-6' : 'left-1'}`}></div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div>
                                <label className="text-xs text-gray-400 block mb-1">期初餘額</label>
                                <input type="number" className="w-full border-b py-1 outline-none text-[#333]" value={initialBalance} onChange={e => setInitialBalance(e.target.value)} />
                            </div>
                            <div>
                                <label className="text-xs text-gray-400 block mb-1">目前餘額 (修改將自動產生調整紀錄)</label>
                                <input type="number" className="w-full border-b py-1 outline-none font-bold text-[#333]" value={balance} onChange={e => setBalance(e.target.value)} />
                            </div>
                        </div>
                        
                        <div className="flex gap-3 mt-8 justify-end">
                            <button onClick={onClose} className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-50 rounded">取消</button>
                            <button onClick={handleSave} className="px-6 py-2 text-sm bg-[#333] text-white rounded shadow hover:bg-black transition">儲存</button>
                        </div>
                    </div>
                </div>
            );
        };
// ==========================================
// 3. MainLayout (負責 UI 顯示與導航)
// ==========================================
const MainLayout = () => {
    // --- UI 狀態 (只保留跟畫面顯示有關的) ---
    const [activeTab, setActiveTab] = useState('home');
    const [showAddModal, setShowAddModal] = useState(false);
    const [showQuickSheet, setShowQuickSheet] = useState(false);
    const [showQuickEntry, setShowQuickEntry] = useState(null);
    const [editingTransaction, setEditingTransaction] = useState(null);
    const [selectedAccountId, setSelectedAccountId] = useState(null);
    const [editingAccount, setEditingAccount] = useState(null);
    const MAIN_TABS = ['home', 'split_manager', 'assets', 'settings'];
    // --- ★ 關鍵改變：從 Context 取得資料與方法 ---
    const { 
        transactions, accounts, categories, quickTemplates, recurringItems, cloudSettings, totalAssets,
        handleSaveTransaction, handleDeleteTransaction, handleSaveAccount, handleReorderAccounts,
        handleSettleSplit, handleRepay, handleMergeAndDeleteCategory,handleDeleteAccount,
        handleExportData, handleImportData, handleManualRestore, handleCloudBackup,
        setCategories, setRecurringItems, setQuickTemplates, setCloudSettings,
        showAlert, showConfirm
    } = React.useContext(DataContext);
    // ★★★ 新增：處理滑動邏輯 ★★★
    const handleSwipeLeft = () => {
        // 向左滑：去下一個分頁 (僅限主要分頁)
        const currentIndex = MAIN_TABS.indexOf(activeTab);
        if (currentIndex !== -1 && currentIndex < MAIN_TABS.length - 1) {
            setActiveTab(MAIN_TABS[currentIndex + 1]);
        }
    };

    const handleSwipeRight = () => {
        // 向右滑：有兩種情況
        
        // 情況 A：在次級頁面 -> 執行「返回」
        if (activeTab === 'categories' || activeTab === 'recurring' || activeTab === 'templates') {
            setActiveTab('settings');
            return;
        }
        if (activeTab === 'account_detail') {
            setActiveTab('assets');
            setSelectedAccountId(null);
            return;
        }

        // 情況 B：在主要分頁 -> 去上一個分頁
        const currentIndex = MAIN_TABS.indexOf(activeTab);
        if (currentIndex > 0) {
            setActiveTab(MAIN_TABS[currentIndex - 1]);
        }
    };
    // 處理帳戶刪除的中介函式
    const onDeleteAcc = (accId) => {
        handleDeleteAccount(accId); // 呼叫 DataProvider 的刪除邏輯
        setEditingAccount(null);    // 關閉視窗 (因為 DataProvider 會跳確認視窗，這裡先關 UI)
    };
    // 啟用 Hook
    const swipeHandlers = useSwipe({ onSwipeLeft: handleSwipeLeft, onSwipeRight: handleSwipeRight });
    // --- 計算本月支出 ---
    const monthlyExpense = useMemo(() => {
        const currentMonth = new Date().getMonth(); 
        const currentYear = new Date().getFullYear(); 
        return transactions.filter(t => t.type === 'expense').filter(t => { const d = new Date(t.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear; }).reduce((sum, t) => sum + t.amount, 0); 
    }, [transactions]);
    // --- 交易操作回調 ---
    const onSaveTx = (tx) => {
        handleSaveTransaction(tx, editingTransaction ? editingTransaction.id : null);
        closeModal();
        if(showQuickEntry) setShowQuickEntry(null);
    };

    // ★ 修正重點：在這裡呼叫 closeModal()
    const onDeleteTx = (txId) => {
        handleDeleteTransaction(txId);
        closeModal(); // 立即關閉記帳視窗，隨後會顯示確認刪除的對話框
    };

    const onSaveAcc = (accData) => {
        handleSaveAccount(accData);
        setEditingAccount(null); // 這裡負責關閉帳戶編輯視窗 (因為 DataProvider 不再報錯，這裡將會正常執行)
    };    // --- Modal 開關邏輯 ---
    const openAddModal = () => { setEditingTransaction(null); setShowAddModal(true); };
    const openEditModal = (tx) => { setEditingTransaction(tx); setShowAddModal(true); };
    const closeModal = () => { setShowAddModal(false); setEditingTransaction(null); };
    // --- 內容渲染邏輯 ---
    const renderContent = () => {
        switch(activeTab) {
            case 'home': return <HomeView onEditTransaction={openEditModal} />;
            case 'assets': return <AssetsView onSelectAccount={(id) => { setSelectedAccountId(id); setActiveTab('account_detail'); }} onAddAccount={() => setEditingAccount({name:'', type:'cash', balance:0, initialBalance:0})} onEditAccount={(acc) => setEditingAccount(acc)} />;
            case 'stats': return <StatsView/>;
            case 'settings': return <SettingsView onChangeTab={setActiveTab} />;
            case 'categories': return <CategoryManager onBack={() => setActiveTab('settings')} />;
            case 'recurring': return <RecurringManager onBack={() => setActiveTab('settings')} />;
            case 'templates': return <TemplateManager onBack={() => setActiveTab('settings')} />;
            case 'split_manager': return <SplitManager />;
            case 'account_detail': return <AccountDetailView accountId={selectedAccountId} onBack={() => { setSelectedAccountId(null); setActiveTab('assets'); }} onEditTransaction={openEditModal} />;
            default: return <HomeView transactions={transactions} accounts={accounts} totalAssets={totalAssets} monthlyExpense={monthlyExpense} onEditTransaction={openEditModal} categories={categories} />;
        }
    };
    return (
        <div 
        {...swipeHandlers}
        className="h-full w-full max-w-md mx-auto border-x border-gray-200 bg-[#F5F5F3] relative flex flex-col overflow-hidden">
            <div className="flex-1 overflow-y-auto no-scrollbar pb-24 relative">{renderContent()}</div>
            {/* 快速記帳按鈕 (閃電) */}
            {['home', 'assets', 'stats', 'settings'].includes(activeTab) && (
                // ★ 修改：從 bottom-24 改為 bottom-32，讓它往上移，避免蓋到設定分頁
                <div className="absolute bottom-32 right-5 z-[50]">
                    <button onClick={() => setShowQuickSheet(true)} className="w-12 h-12 bg-white rounded-full text-[#333] shadow-lg border border-gray-200 flex items-center justify-center hover:scale-105 active:scale-95 transition-all">
                        <Icon name="lightning" size={20} className="fill-current text-yellow-400" />
                    </button>
                </div>
            )}
            {['home', 'assets', 'stats', 'split_manager', 'settings'].includes(activeTab) && (
                <div className="fixed bottom-0 w-full max-w-md bg-white border-t border-gray-200 px-6 h-[64px] flex justify-between items-center z-40 shadow-[0_-1px_3px_rgba(0,0,0,0.05)]">
                    <NavButton iconName="home" label="首頁" isActive={activeTab === 'home'} onClick={() => setActiveTab('home')} />
                    <NavButton iconName="split" label="分帳" isActive={activeTab === 'split_manager'} onClick={() => setActiveTab('split_manager')} />
                    <div className="relative -top-8">
                        <button onClick={openAddModal} className="w-16 h-16 bg-[#333] rounded-full flex items-center justify-center text-white shadow-xl hover:bg-[#000] transition-all transform active:scale-95 border-4 border-[#F5F5F3]"><Icon name="plus" size={32} /></button>
                    </div>
                    <NavButton iconName="wallet" label="資產" isActive={activeTab === 'assets' || activeTab === 'account_detail'} onClick={() => setActiveTab('assets')} />
                    <NavButton iconName="settings" label="設定" isActive={activeTab === 'settings' || activeTab === 'categories' || activeTab === 'templates'} onClick={() => setActiveTab('settings')} />
                </div>
            )}
            {showAddModal && <TransactionModal initialData={editingTransaction} onClose={closeModal} onSave={onSaveTx} onDelete={onDeleteTx} accounts={accounts} categories={categories} />}
            {showQuickSheet && <QuickAddSheet templates={quickTemplates} accounts={accounts} categories={categories} onClose={() => setShowQuickSheet(false)} onSelect={(tpl) => { setShowQuickSheet(false); setShowQuickEntry(tpl); }} onGoSettings={() => { setShowQuickSheet(false); setActiveTab('templates'); }} />}
            {showQuickEntry && <QuickEntryModal template={showQuickEntry} onClose={() => setShowQuickEntry(null)} onSave={onSaveTx} />}
            {editingAccount && <AccountModal initialData={editingAccount} onClose={() => setEditingAccount(null)} onSave={onSaveAcc} onDelete={onDeleteAcc}/>}
        </div>
    );
};
// ==========================================
// 4. 最終 Root (包裹器) - 這是修正後的版本
// ==========================================
function MoneyMasterApp() {
    return (
        <DataProvider>
            <MainLayout />
        </DataProvider>
    );
}

// ==========================================
    // 修正版 LocalChartAnalysis (收支分離 + 預算修正)
    // ==========================================
    const LocalChartAnalysis = ({ transactions, categories }) => {
        // 新增：圖表類型切換 (支出/收入)
        const [chartType, setChartType] = useState('expense'); 

        // 1. 計算數據 (嚴格區分收入與支出)
        const chartData = useMemo(() => {
            const map = {};
            let totalAmount = 0;
            
            // ★ 修正：先根據 chartType 過濾交易類型
            const targetTx = transactions.filter(t => t.type === chartType);
            const targetCats = chartType === 'expense' ? categories.expense : categories.income;

            // 統計各分類金額
            targetTx.forEach(t => {
                const cat = targetCats.find(c => c.id === t.categoryId);
                const id = cat ? cat.id : 'unknown';
                const name = cat ? cat.name : '其他';
                
                if (!map[id]) map[id] = { 
                    id, 
                    name, 
                    value: 0, 
                    color: cat ? cat.color : '#ccc',
                    budget: (chartType === 'expense' && cat) ? (cat.budget || 0) : 0 
                };
                map[id].value += t.amount;
                totalAmount += t.amount;
            });

            const sortedData = Object.values(map).sort((a,b) => b.value - a.value);
            
            // 產生圓餅圖漸層
            let currentPercent = 0;
            const gradientParts = sortedData.map(item => {
                const start = currentPercent;
                const percent = totalAmount > 0 ? (item.value / totalAmount) * 100 : 0;
                const end = currentPercent + percent;
                currentPercent = end;
                return `${item.color} ${start}% ${end}%`;
            });

            const gradientString = gradientParts.length > 0 
                ? `conic-gradient(${gradientParts.join(', ')})`
                : 'conic-gradient(#E5E5E5 0% 100%)'; 

            return { data: sortedData, total: totalAmount, gradientString };
        }, [transactions, categories, chartType]);

        // 2. 計算總預算與當日餘額 (只針對支出模式)
        const budgetData = useMemo(() => {
            if (chartType !== 'expense') return null;

            // ★ 修正：只計算「支出分類」的總預算
            const totalBudget = categories.expense.reduce((sum, c) => sum + (c.budget || 0), 0);
            
            // ★ 修正：剩餘預算 = 總預算 - 當前顯示的總支出 (chartData.total 已經是過濾後的支出總和)
            const remaining = totalBudget - chartData.total;
            
            const now = new Date();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const today = now.getDate();
            // 剩餘天數 (含今天)
            const remainingDays = Math.max(1, daysInMonth - today + 1);
            
            // ★ 修正：今日建議 = 剩餘金額 / 剩餘天數
            const dailyAvailable = remaining > 0 ? Math.floor(remaining / remainingDays) : 0;

            return {
                hasBudget: totalBudget > 0,
                total: totalBudget,
                remaining,
                dailyAvailable,
                progress: totalBudget > 0 ? Math.min(100, (chartData.total / totalBudget) * 100) : 0
            };
        }, [categories, chartData.total, chartType]);

        return (
            <div className="animate-fade-in flex flex-col gap-4 pb-4">
                {/* 切換按鈕 */}
                <div className="flex justify-center mb-2">
                    <div className="flex bg-gray-100 dark:bg-[#40444B] p-0.5 rounded-lg">
                        <button onClick={() => setChartType('expense')} className={`px-4 py-1 text-xs rounded-md transition ${chartType === 'expense' ? 'bg-white dark:bg-[#2B2D30] shadow text-[#333] dark:text-white' : 'text-gray-400'}`}>支出分佈</button>
                        <button onClick={() => setChartType('income')} className={`px-4 py-1 text-xs rounded-md transition ${chartType === 'income' ? 'bg-white dark:bg-[#2B2D30] shadow text-[#333] dark:text-white' : 'text-gray-400'}`}>收入來源</button>
                    </div>
                </div>

                {/* 總預算監控卡片 (只在支出模式顯示) */}
                {chartType === 'expense' && budgetData && budgetData.hasBudget && (
                    <Card className="flex flex-col gap-3 relative overflow-hidden">
                        <div className="flex justify-between items-end z-10">
                            <div>
                                <div className="text-xs text-gray-400 uppercase tracking-widest mb-1">本月預算餘額</div>
                                <div className={`text-2xl font-medium ${budgetData.remaining < 0 ? 'text-[#D9534F]' : 'text-[#333] dark:text-white'}`}>
                                    ${budgetData.remaining.toLocaleString()}
                                </div>
                            </div>
                            <div className="text-right">
                                <div className="text-[10px] text-gray-400 uppercase tracking-widest mb-1">今日建議支出上限</div>
                                <div className="text-base font-medium text-[#5CB85C]">${budgetData.dailyAvailable.toLocaleString()}</div>
                            </div>
                        </div>
                        <div className="h-2 w-full bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden z-10 mt-1">
                            <div 
                                className={`h-full rounded-full animate-grow ${budgetData.remaining < 0 ? 'bg-[#D9534F]' : 'bg-[#333] dark:bg-white'}`} 
                                style={{ width: `${budgetData.progress}%` }}
                            ></div>
                        </div>
                        <div className="flex justify-between text-[10px] text-gray-400 z-10">
                            <span>已用 ${chartData.total.toLocaleString()}</span>
                            <span>總預算 ${budgetData.total.toLocaleString()}</span>
                        </div>
                    </Card>
                )}

                <Card className="flex flex-col items-center pt-8 pb-8">
                    {chartData.total > 0 ? (
                        <>
                            <div className="relative w-48 h-48 rounded-full shadow-inner mb-6" style={{ background: chartData.gradientString }}>
                                <div className="absolute inset-0 m-auto w-32 h-32 bg-white dark:bg-[#36393F] rounded-full flex flex-col items-center justify-center shadow-sm">
                                    <span className="text-xs text-gray-400 uppercase tracking-widest">{chartType === 'expense' ? '總支出' : '總收入'}</span>
                                    <span className="text-xl font-medium text-[#333] dark:text-white tracking-tight">${chartData.total.toLocaleString()}</span>
                                </div>
                            </div>
                            <div className="w-full space-y-4 px-2">
                                {chartData.data.slice(0, 8).map(d => {
                                    const catBudget = d.budget;
                                    const hasCatBudget = catBudget > 0;
                                    const catProgress = hasCatBudget ? Math.min(100, (d.value / catBudget) * 100) : 0;
                                    const isOverBudget = hasCatBudget && d.value > catBudget;

                                    return (
                                        <div key={d.id} className="flex flex-col gap-1 border-b border-gray-50 dark:border-gray-700 pb-3 last:border-0">
                                            <div className="flex justify-between items-center text-xs">
                                                <div className="flex items-center gap-2">
                                                    <div className="w-3 h-3 rounded-full shadow-sm" style={{backgroundColor: d.color}}></div>
                                                    <span className="text-gray-600 dark:text-gray-300 font-medium">{d.name}</span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <span className="text-[10px] text-gray-400">{Math.round((d.value / chartData.total) * 100)}%</span>
                                                    <span className="font-medium text-gray-800 dark:text-gray-200 w-16 text-right">${d.value.toLocaleString()}</span>
                                                </div>
                                            </div>
                                            
                                            {/* 單一分類預算條 (只在支出模式且有設定預算時顯示) */}
                                            {chartType === 'expense' && hasCatBudget && (
                                                <div className="ml-5 mt-1">
                                                    <div className="h-1.5 w-full bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                                        <div 
                                                            className={`h-full rounded-full ${isOverBudget ? 'bg-[#D9534F]' : 'bg-[#333] dark:bg-white opacity-60'}`} 
                                                            style={{ width: `${catProgress}%` }}
                                                        ></div>
                                                    </div>
                                                    <div className="flex justify-between mt-0.5">
                                                        <span className={`text-[9px] ${isOverBudget ? 'text-[#D9534F]' : 'text-gray-400'}`}>
                                                            {isOverBudget ? `超支 $${(d.value - catBudget).toLocaleString()}` : `剩餘 $${(catBudget - d.value).toLocaleString()}`}
                                                        </span>
                                                        <span className="text-[9px] text-gray-300">預算 ${catBudget.toLocaleString()}</span>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </>
                    ) : (
                            <div className="flex flex-col items-center py-10 opacity-50">
                            <div className="w-32 h-32 rounded-full border-4 border-gray-100 dark:border-gray-700 mb-4 flex items-center justify-center bg-gray-50 dark:bg-gray-800">
                                <Icon name="pieChart" size={32} className="text-gray-300"/>
                            </div>
                            <div className="text-xs text-gray-400">本月尚無資料</div>
                        </div>
                    )}
                </Card>
            </div>
        );
    };
// ==========================================
// ★ 優化版：記帳電子雞 (縮小尺寸，適合融入標題)
// ==========================================
const MoneyPetWidget = () => {
    // ... (這部分的邏輯與之前完全相同，請直接複製原本的邏輯代碼) ...
    const { transactions, monthlyExpense, recurringItems, accounts } = React.useContext(DataContext);
    const [message, setMessage] = useState('');
    const [isPoked, setIsPoked] = useState(false);
    const prevCountRef = useRef(transactions.length);

    const petStats = useMemo(() => {
        const count = transactions.length;
        let stage = 'egg';
        let icon = '🥚';
        if (count >= 100) { stage = 'king'; icon = '👑🐔'; }
        else if (count >= 50) { stage = 'adult'; icon = '🐔'; }
        else if (count >= 10) { stage = 'baby'; icon = '🐣'; }

        let status = 'normal'; 
        let daysDiff = 0;
        
        if (transactions.length > 0) {
            const lastDate = new Date(transactions[0].date);
            const today = new Date();
            lastDate.setHours(0,0,0,0);
            today.setHours(0,0,0,0);
            daysDiff = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));

            if (daysDiff === 0) status = 'happy';
            else if (daysDiff >= 3) status = 'sick';
        } else {
            status = 'sick';
        }
        if (status === 'sick' && stage !== 'egg') icon = '🤒';
        return { stage, icon, status, count, daysDiff };
    }, [transactions]);

    useEffect(() => {
        if (transactions.length > prevCountRef.current) {
            setIsPoked(true); 
            setTimeout(() => setIsPoked(false), 300); 
            const feedMsgs = ["嚼嚼...謝謝款待！😋", "好耶！又吃到一筆帳了！✨", "變強了！💪", "充滿能量！🔥", "愛你！❤️"];
            setMessage(feedMsgs[Math.floor(Math.random() * feedMsgs.length)]);
            setTimeout(() => setMessage(''), 3000);
        }
        prevCountRef.current = transactions.length;
    }, [transactions.length]);

    const handlePoke = () => {
        setIsPoked(true);
        setTimeout(() => setIsPoked(false), 300);
        let msgs = [];
        if (petStats.status === 'sick') { msgs = ["咳咳...好餓...", "救命...", "飯飯..."]; } 
        else if (petStats.status === 'happy') { msgs = ["開心！", "哇！吃得好飽！", "最棒了"]; } 
        else { msgs = ["肚子空空", "等你的紀錄"]; }

        if (petStats.status !== 'sick') {
            if (monthlyExpense > 20000) msgs.push("花太多了？", "錢包哭哭", "省點錢");
            else if (monthlyExpense > 0) msgs.push("控制得不錯！", "積少成多");
            
        // ★ C. 繳費提醒邏輯 (新增部分)
            const today = new Date().getDate(); // 取得今天是幾號 (1-31)
            
            // 檢查週期支出 (範圍：今天 ~ 今天+3天)
            recurringItems.forEach(item => {
                if (item.active !== false && item.type === 'expense') {
                    // 簡單邏輯：如果設定日是今天或未來3天內
                    if (item.day >= today && item.day <= today + 3) {
                        const diff = item.day - today;
                        const timeStr = diff === 0 ? "今天" : (diff === 1 ? "明天" : `${diff}天後`);
                        msgs.push(`主人！${timeStr}是「${item.name}」的扣款日喔！`, `記得確認「${item.name}」的錢夠不夠～`);
                    }
                }
            });

            // 檢查信用卡繳款日 (範圍：今天 ~ 今天+3天)
            accounts.forEach(acc => {
                if (acc.type === 'liability' && acc.dueDay) {
                    if (acc.dueDay >= today && acc.dueDay <= today + 3) {
                        const diff = acc.dueDay - today;
                        const timeStr = diff === 0 ? "今天" : (diff === 1 ? "明天" : `${diff}天後`);
                        msgs.push(`警報！${timeStr}是「${acc.name}」的繳款截止日！`, `別忘了繳「${acc.name}」的卡費喔！`);
                    }
                }
            });
        }
        setMessage(msgs[Math.floor(Math.random() * msgs.length)]);
        setTimeout(() => setMessage(''), 3000);
    };

    return (
        // ★ 修改：移除外層 padding，改用絕對定位容器需要的 class
        <div className="flex flex-col items-center justify-center relative z-10 pointer-events-auto">
            {/* 對話框 (稍微縮小字體) */}
            <div className={`speech-bubble bg-[#333] text-white text-[10px] px-2 py-1 rounded mb-1 shadow-md transition-opacity duration-300 absolute -top-8 whitespace-nowrap ${message ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
                {message}
            </div>

            {/* 寵物本體 (縮小至 text-4xl) */}
            <button 
                onClick={handlePoke}
                className={`text-4xl transition-transform cursor-pointer select-none filter drop-shadow-sm ${petStats.status === 'happy' ? 'animate-bounce-slow' : ''} ${isPoked ? 'scale-90' : 'scale-100'}`}
                style={{ transformOrigin: 'bottom center' }}
            >
                {petStats.icon}
            </button>
            
            {/* 狀態標籤 (縮小並簡化) */}
            <div className="mt-1">
                {petStats.status === 'sick' ? (
                    <span className="text-[9px] bg-red-100 text-red-500 px-1.5 py-0.5 rounded-full animate-pulse">餓</span>
                ) : (
                    <span className="text-[9px] bg-white/60 border border-gray-200 px-1.5 py-0.5 rounded-full text-gray-400 backdrop-blur-sm">
                        {petStats.stage === 'egg' ? '幼年期' : petStats.stage === 'king' ? '國王' : '成長期'}
                    </span>
                )}
            </div>
        </div>
    );
};
const HomeView = ({ onEditTransaction }) => {
    const { transactions, accounts, categories, totalAssets, triggerHaptic, isPrivacyMode, togglePrivacy } = React.useContext(DataContext);

    const [viewMode, setViewMode] = useState('list');
    const [currentYear, setCurrentYear] = useState(new Date().getFullYear());
    const [currentMonth, setCurrentMonth] = useState(new Date().getMonth() + 1);
    
    // --- ★ 新功能：進階篩選 State ---
    const [showFilter, setShowFilter] = useState(false);
    const [filters, setFilters] = useState({
        minAmount: '',
        maxAmount: '',
        categoryId: '',
        noteKeyword: ''
    });

    // --- ★ 新功能：分頁載入 State (效能優化) ---
    const [page, setPage] = useState(1);
    const PAGE_SIZE = 20; // 每次只渲染 20 筆

    // 重置篩選
    const resetFilters = () => {
        setFilters({ minAmount: '', maxAmount: '', categoryId: '', noteKeyword: '' });
        setPage(1);
        triggerHaptic();
    };

    // 篩選邏輯
    const displayTransactions = useMemo(() => {
        let data = transactions;

        // 1. 基礎年月篩選 (如果沒有關鍵字搜尋)
        if (!filters.noteKeyword) {
            data = data.filter(t => {
                const d = new Date(t.date);
                return d.getFullYear() === currentYear && (d.getMonth() + 1) === currentMonth;
            });
        }

        // 2. 進階篩選
        if (filters.minAmount) data = data.filter(t => t.amount >= Number(filters.minAmount));
        if (filters.maxAmount) data = data.filter(t => t.amount <= Number(filters.maxAmount));
        if (filters.categoryId) data = data.filter(t => t.categoryId === filters.categoryId);
        if (filters.noteKeyword) {
            const lower = filters.noteKeyword.toLowerCase();
            data = data.filter(t => 
                (t.note && t.note.toLowerCase().includes(lower)) ||
                (categories.expense.find(c=>c.id===t.categoryId)?.name.includes(lower)) ||
                (categories.income.find(c=>c.id===t.categoryId)?.name.includes(lower))
            );
        }

        // 排序
        return data.sort((a,b) => {
            const dateDiff = new Date(b.date) - new Date(a.date);
            if (dateDiff !== 0) return dateDiff;
            return (b.createdAt || 0) - (a.createdAt || 0);
        });
    }, [transactions, currentYear, currentMonth, filters, categories]);

    // ★ 分頁邏輯：只切片顯示前 N 筆
    const paginatedTransactions = useMemo(() => {
        return displayTransactions.slice(0, page * PAGE_SIZE);
    }, [displayTransactions, page]);

    // 當篩選條件改變時，重置頁碼
    useEffect(() => { setPage(1); }, [currentYear, currentMonth, filters]);

    const currentTotalExpense = useMemo(() => displayTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0), [displayTransactions]);
    const currentTotalIncome = useMemo(() => displayTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0), [displayTransactions]);


    const groupedTransactions = useMemo(() => { 
        const groups = {}; 
        paginatedTransactions.forEach(t => { 
            if (!groups[t.date]) groups[t.date] = []; 
            groups[t.date].push(t); 
        }); 
        return Object.entries(groups).sort((a,b) => new Date(b[0]) - new Date(a[0])); 
    }, [paginatedTransactions]);

    // 日曆數據 (保持不變)
    const calendarData = useMemo(() => {
        // ... (這部分邏輯與之前相同，為節省篇幅省略，請直接複製原本的日曆邏輯) ...
        const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
        const firstDayOfWeek = new Date(currentYear, currentMonth - 1, 1).getDay();
        const days = [];
        for (let i = 0; i < firstDayOfWeek; i++) days.push(null);
        for (let i = 1; i <= daysInMonth; i++) {
            const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            const dailyTx = transactions.filter(t => t.date === dateStr);
            const dailyExp = dailyTx.filter(t => t.type === 'expense').reduce((s,t) => s + t.amount, 0);
            const dailyInc = dailyTx.filter(t => t.type === 'income').reduce((s,t) => s + t.amount, 0);
            days.push({ day: i, dateStr, expense: dailyExp, income: dailyInc, hasData: dailyTx.length > 0 });
        }
        return days;
    }, [currentYear, currentMonth, transactions]);

    const [selectedDate, setSelectedDate] = useState(null);

return (
        <div className="h-full flex flex-col pt-10 px-6 pb-0 animate-fade-in relative">
            {/* Header Area */}
            <div className="shrink-0 mb-4 z-20 bg-[#F5F5F3] dark:bg-[#2B2D30] transition-colors">
                
                {/* ★ 修改重點：改為「本月收入」與「本月支出」並列 */}
                <div className="flex justify-between items-end mb-2"> 
                    {/* 左側：總收入 */}
                    <div>
                        <div className="text-xs text-gray-400 mb-1 tracking-widest font-medium uppercase flex items-center gap-2">
                            {filters.noteKeyword ? '搜尋收入' : `${currentMonth}月總收入`}
                            <button onClick={togglePrivacy} className="text-gray-300 hover:text-gray-500 transition">
                                <Icon name={isPrivacyMode ? "eyeOff" : "eye"} size={14} /> 
                            </button>
                        </div>
                        <div className="text-3xl font-light text-[#5CB85C] tracking-tight">
                            {isPrivacyMode ? '****' : <><span className="text-lg mr-1 font-normal">$</span>{formatMoney(currentTotalIncome)}</>}
                        </div>
                    </div>
                    
                    {/* 右側：總支出 */}
                    <div className="text-right">
                        <div className="text-xs text-gray-400 mb-1 tracking-widest font-medium uppercase">
                            {filters.noteKeyword ? '搜尋支出' : `${currentMonth}月總支出`}
                        </div>
                        <div className="text-3xl font-light text-[#333] dark:text-white tracking-tight">
                            {isPrivacyMode ? '****' : <><span className="text-lg mr-1 font-normal">$</span>{formatMoney(currentTotalExpense)}</>}
                        </div>
                    </div>
                </div>

                {/* 2. 中間：電子雞 (保持不變) */}
                <div className="flex justify-center -mt-8 mb-2 relative z-10 pointer-events-none">
                    <div className="pointer-events-auto">
                        <MoneyPetWidget />
                    </div>
                </div>

                {/* 3. 下半部：搜尋與篩選 (保持不變) */}
                <div className="flex gap-2 mb-4">
                    <div className="relative flex-1">
                        <input 
                            type="text" 
                            placeholder="搜尋..." 
                            value={filters.noteKeyword} 
                            onChange={(e) => setFilters(prev => ({...prev, noteKeyword: e.target.value}))} 
                            className="w-full bg-white border border-gray-200 rounded-lg py-2 pl-9 pr-8 text-sm focus:border-[#333] outline-none shadow-sm transition-colors dark:bg-[#40444B] dark:border-transparent dark:text-gray-200" 
                        />
                        <div className="absolute left-3 top-2 text-gray-400"><Icon name="search" size={16}/></div>
                        {filters.noteKeyword && (
                            <button 
                                onClick={() => { setFilters(prev => ({...prev, noteKeyword: ''})); triggerHaptic(); }}
                                className="absolute right-2 top-2 text-gray-400 hover:text-gray-600 p-0.5 rounded-full hover:bg-gray-100 transition"
                            >
                                <Icon name="close" size={14}/>
                            </button>
                        )}
                    </div>
                    <button 
                        onClick={() => { setShowFilter(!showFilter); if(triggerHaptic) triggerHaptic(); }}
                        className={`px-3 rounded-lg border flex items-center gap-1 transition ${showFilter || filters.minAmount || filters.categoryId ? 'bg-[#333] text-white border-[#333]' : 'bg-white text-gray-500 border-gray-200 dark:bg-[#40444B] dark:border-transparent dark:text-gray-300'}`}
                    >
                        <Icon name="list" size={16} />
                        <span className="text-xs">篩選</span>
                    </button>
                </div>
                {/* 進階篩選面板 */}
                {showFilter && (
                    <div className="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4 animate-slide-up">
                        <div className="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label className="text-[10px] text-gray-400 uppercase block mb-1">最低金額</label>
                                <input type="number" value={filters.minAmount} onChange={e => setFilters(prev=>({...prev, minAmount: e.target.value}))} className="w-full bg-gray-50 border border-gray-200 rounded p-1.5 text-sm outline-none" placeholder="0"/>
                            </div>
                            <div>
                                <label className="text-[10px] text-gray-400 uppercase block mb-1">最高金額</label>
                                <input type="number" value={filters.maxAmount} onChange={e => setFilters(prev=>({...prev, maxAmount: e.target.value}))} className="w-full bg-gray-50 border border-gray-200 rounded p-1.5 text-sm outline-none" placeholder="∞"/>
                            </div>
                        </div>
                        <div className="mb-3">
                            <label className="text-[10px] text-gray-400 uppercase block mb-1">指定分類</label>
                            <select value={filters.categoryId} onChange={e => setFilters(prev=>({...prev, categoryId: e.target.value}))} className="w-full bg-gray-50 border border-gray-200 rounded p-1.5 text-sm outline-none">
                                <option value="">全部分類</option>
                                {categories.expense.map(c => <option key={c.id} value={c.id}>[支出] {c.name}</option>)}
                                {categories.income.map(c => <option key={c.id} value={c.id}>[收入] {c.name}</option>)}
                            </select>
                        </div>
                        <div className="flex justify-between items-center">
                            {/* ★ 修正：明顯的取消/重置按鈕 */}
                            <button onClick={() => { resetFilters(); setShowFilter(false); }} className="text-xs text-red-500 border border-red-200 px-3 py-1.5 rounded hover:bg-red-50 transition">
                                <Icon name="trash" size={12} className="inline mr-1"/>清除篩選
                            </button>
                            <button onClick={() => setShowFilter(false)} className="text-xs font-medium text-[#333] px-3 py-1.5 border border-gray-200 rounded hover:bg-gray-50">收起</button>
                        </div>
                    </div>
                )}

                {/* 年月選擇 (只有在沒搜尋時顯示) */}
                {!filters.noteKeyword && (
                    <div className="flex justify-between items-center">
                        <div className="flex gap-2">
                             <div className="relative">
                                <select value={currentYear} onChange={(e) => setCurrentYear(Number(e.target.value))} className="appearance-none bg-white border border-gray-200 text-[#333] text-sm py-1.5 pl-3 pr-8 rounded focus:outline-none font-medium">
                                    {Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i).map(y => <option key={y} value={y}>{y}年</option>)}
                                </select>
                                <Icon name="chevronDown" size={12} className="absolute right-2 top-3 text-gray-500 pointer-events-none"/>
                            </div>
                            <div className="relative">
                                <select value={currentMonth} onChange={(e) => setCurrentMonth(Number(e.target.value))} className="appearance-none bg-white border border-gray-200 text-[#333] text-sm py-1.5 pl-3 pr-8 rounded focus:outline-none font-medium">
                                    {Array.from({length: 12}, (_, i) => i + 1).map(m => <option key={m} value={m}>{m}月</option>)}
                                </select>
                                <Icon name="chevronDown" size={12} className="absolute right-2 top-3 text-gray-500 pointer-events-none"/>
                            </div>
                        </div>
                        <div className="flex bg-[#EAEAEA] p-0.5 rounded-lg">
                            <button onClick={() => { setViewMode('list'); if(triggerHaptic) triggerHaptic(); }} className={`p-1.5 rounded-md transition ${viewMode === 'list' ? 'bg-white shadow text-[#333]' : 'text-gray-400'}`}><Icon name="list" size={14}/></button>
                            <button onClick={() => { setViewMode('calendar'); if(triggerHaptic) triggerHaptic(); }} className={`p-1.5 rounded-md transition ${viewMode === 'calendar' ? 'bg-white shadow text-[#333]' : 'text-gray-400'}`}><Icon name="calendar" size={14}/></button>
                            <button onClick={() => { setViewMode('chart'); if(triggerHaptic) triggerHaptic(); }} className={`p-1.5 rounded-md transition ${viewMode === 'chart' ? 'bg-white shadow text-[#333]' : 'text-gray-400'}`}><Icon name="pieChart" size={14}/></button>
                        </div>
                    </div>
                )}
            </div>

            {/* Content Area */}
            <div className="flex-1 overflow-y-auto no-scrollbar space-y-4 pb-20">
                {(viewMode === 'list' || filters.noteKeyword) && (
                    <>
                        {groupedTransactions.length > 0 ? (
                            <>
                                {groupedTransactions.map(([date, txs]) => (
                                    <div key={date}>
                                        <div className="text-xs text-gray-400 mb-2 font-medium sticky top-0 bg-[#F5F5F3] py-1 z-10">{date}</div>
                                        <div className="space-y-3">
                                            {txs.map(t => <TransactionCard key={t.id} transaction={t} onClick={() => { if(triggerHaptic) triggerHaptic(); onEditTransaction(t); }} />)}
                                        </div>
                                    </div>
                                ))}
                                
                                {/* 載入更多按鈕 (優化效能用) */}
                                {paginatedTransactions.length < displayTransactions.length && (
                                    <button 
                                        onClick={() => setPage(p => p + 1)}
                                        className="w-full py-3 text-xs text-gray-400 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition"
                                    >
                                        顯示更多交易 ({displayTransactions.length - paginatedTransactions.length} 筆)
                                    </button>
                                )}
                            </>
                        ) : (
                            <div className="text-center py-20 text-gray-400 text-sm font-light">
                                <span className="text-4xl block mb-2">{filters.noteKeyword ? '🔍' : '🍃'}</span>
                                {filters.noteKeyword ? '找不到符合條件的交易' : '本月無交易紀錄'}
                            </div>
                        )}
                    </>
                )}
                
                {/* 日曆模式 (省略重複代碼，請直接使用原本的日曆 JSX) */}
                {viewMode === 'calendar' && !filters.noteKeyword && (
                    <div className="animate-fade-in">
                        {/* ... 請貼上原本的日曆 JSX ... */}
                        {/* 這裡簡單示意，記得把原本的日曆代碼放回來 */}
                         <div className="grid grid-cols-7 text-center mb-2">{['日','一','二','三','四','五','六'].map(d => <div key={d} className="text-[10px] text-gray-400">{d}</div>)}</div>
                        <div className="grid grid-cols-7 gap-1 auto-rows-[60px]">
                            {calendarData.map((cell, idx) => {
                                if (!cell) return <div key={`empty-${idx}`}></div>;
                                const isSelected = selectedDate === cell.dateStr;
                                return (
                                    <div key={cell.dateStr} onClick={() => setSelectedDate(cell.dateStr)} className={`rounded border flex flex-col items-center justify-start pt-1 cursor-pointer transition relative ${isSelected ? 'bg-white border-[#333] shadow-md z-10' : 'bg-white border-transparent hover:border-gray-200'}`}>
                                        <span className={`text-xs mb-0.5 ${cell.day === new Date().getDate() && currentMonth === new Date().getMonth()+1 ? 'bg-[#333] text-white w-5 h-5 rounded-full flex items-center justify-center' : 'text-gray-600'}`}>{cell.day}</span>
                                        {cell.expense > 0 && <span className="text-[9px] text-[#333] font-medium">-{formatMoney(cell.expense)}</span>}
                                        {cell.income > 0 && <span className="text-[9px] text-[#5CB85C] font-medium">+{formatMoney(cell.income)}</span>}
                                        {!cell.hasData && isSelected && <div className="w-1 h-1 bg-gray-300 rounded-full mt-1"></div>}
                                    </div>
                                );
                            })}
                        </div>
                        {selectedDate && (
                            <div className="mt-6 border-t border-gray-200 pt-4 animate-slide-up">
                                <div className="text-xs text-gray-400 mb-3 font-medium flex justify-between"><span>{selectedDate} 的交易</span><button onClick={() => setSelectedDate(null)} className="text-[#333]"><Icon name="close" size={12}/></button></div>
                                <div className="space-y-3">{transactions.filter(t => t.date === selectedDate).length > 0 ? transactions.filter(t => t.date === selectedDate).map(t => <TransactionCard key={t.id} transaction={t} onClick={() => onEditTransaction(t)} />) : <div className="text-center text-xs text-gray-400 py-4">本日無交易</div>}</div>
                            </div>
                        )}
                    </div>
                )}

                {/* 圖表模式 (保持不變) */}
                {viewMode === 'chart' && !filters.noteKeyword && <LocalChartAnalysis transactions={displayTransactions} categories={categories} />}
            </div>
        </div>
    );
};

// ==========================================
// ★ 升級版 StatsView (預算儀表板 + 互動圖表)
// ==========================================
const StatsView = () => {
    const { transactions, categories } = React.useContext(DataContext);
    const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, AreaChart, Area, XAxis, YAxis, CartesianGrid } = window.Recharts || {};
    
    // UI State
    const [tab, setTab] = useState('trend'); // 'trend'(趨勢) | 'budget'(預算) | 'category'(分類)
    const [currentMonth, setCurrentMonth] = useState(new Date().getMonth() + 1);
    const [activeIndex, setActiveIndex] = useState(0); // 圓餅圖互動索引

    // --- 資料計算 1: 預算分析 (Budget Data) ---
    const budgetData = useMemo(() => {
        const currentYear = new Date().getFullYear();
        // 1. 篩選本月支出
        const monthlyTx = transactions.filter(t => {
            const d = new Date(t.date);
            return t.type === 'expense' && d.getMonth() + 1 === currentMonth && d.getFullYear() === currentYear;
        });

        // 2. 依分類統計
        const map = {};
        categories.expense.forEach(c => {
            map[c.id] = { 
                name: c.name, 
                budget: c.budget || 0, 
                spent: 0, 
                color: c.color,
                icon: c.iconKey 
            };
        });

        monthlyTx.forEach(t => {
            if (map[t.categoryId]) {
                map[t.categoryId].spent += t.amount;
            }
        });

        // 3. 轉換為陣列並排序 (優先顯示有設定預算或有花費的)
        return Object.values(map)
            .filter(d => d.budget > 0 || d.spent > 0)
            .sort((a, b) => {
                // 排序邏輯：超支的排最上面 > 預算高的排上面
                const aRatio = a.budget > 0 ? a.spent / a.budget : 0;
                const bRatio = b.budget > 0 ? b.spent / b.budget : 0;
                return bRatio - aRatio; 
            });
    }, [transactions, currentMonth, categories]);

    // --- 資料計算 2: 圓餅圖 (Interactive Pie) ---
    const pieData = useMemo(() => {
        const currentYear = new Date().getFullYear();
        const filtered = transactions.filter(t => {
            const d = new Date(t.date);
            return t.type === 'expense' && d.getMonth() + 1 === currentMonth && d.getFullYear() === currentYear;
        });
        
        const map = {};
        filtered.forEach(t => {
            const cat = categories.expense.find(c => c.id === t.categoryId);
            const name = cat ? cat.name : '其他';
            if (!map[name]) map[name] = { name, value: 0, color: cat ? cat.color : '#ccc' };
            map[name].value += t.amount;
        });
        return Object.values(map).sort((a,b) => b.value - a.value);
    }, [transactions, currentMonth, categories]);

    // --- 資料計算 3: 每日趨勢 (Area Chart) ---
    const dailyData = useMemo(() => {
        const currentYear = new Date().getFullYear();
        const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
        const data = [];
        
        for(let i=1; i<=daysInMonth; i++) {
            const dateStr = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const dailyExp = transactions
                .filter(t => t.date === dateStr && t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            data.push({ day: i, amount: dailyExp });
        }
        return data;
    }, [transactions, currentMonth]);

    // 圓餅圖互動特效 (Recharts RenderShape)
    const renderActiveShape = (props) => {
        const { cx, cy, innerRadius, outerRadius, startAngle, endAngle, fill, payload, value } = props;
        return (
            <g>
                <text x={cx} y={cy-10} dy={8} textAnchor="middle" fill={fill} className="text-sm font-bold">{payload.name}</text>
                <text x={cx} y={cy+10} dy={8} textAnchor="middle" fill="#999" className="text-xs">
                    ${value.toLocaleString()}
                </text>
                <path d={window.Recharts.Sector.renderSector({cx, cy, innerRadius, outerRadius: outerRadius + 6, startAngle, endAngle}).d} fill={fill} />
            </g>
        );
    };

    if (!PieChart) return <div className="text-center py-10 text-gray-400">載入圖表中...</div>;

    return (
        <div className="h-full flex flex-col pt-10 px-6 pb-0 animate-fade-in">
            <div className="shrink-0 mb-4">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-medium text-[#333] tracking-wide">統計分析</h2>
                    <div className="flex bg-gray-100 dark:bg-[#40444B] p-1 rounded-lg">
                        <button onClick={() => setTab('trend')} className={`px-3 py-1.5 text-xs rounded-md transition ${tab === 'trend' ? 'bg-white dark:bg-[#2B2D30] shadow text-[#333] dark:text-white' : 'text-gray-400'}`}>趨勢</button>
                        <button onClick={() => setTab('category')} className={`px-3 py-1.5 text-xs rounded-md transition ${tab === 'category' ? 'bg-white dark:bg-[#2B2D30] shadow text-[#333] dark:text-white' : 'text-gray-400'}`}>圓餅</button>
                        <button onClick={() => setTab('budget')} className={`px-3 py-1.5 text-xs rounded-md transition ${tab === 'budget' ? 'bg-white dark:bg-[#2B2D30] shadow text-[#333] dark:text-white' : 'text-gray-400'}`}>預算</button>
                    </div>
                </div>
                
                {/* 月份切換 Bar */}
                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                    {Array.from({length: 12}, (_, i) => i + 1).map(m => (
                        <button 
                            key={m} 
                            onClick={() => { setCurrentMonth(m); setActiveIndex(0); }} 
                            className={`text-xs px-3.5 py-1.5 rounded-full border transition whitespace-nowrap 
                                ${currentMonth === m 
                                    ? 'bg-[#333] text-white border-[#333] shadow-md dark:bg-white dark:text-black' 
                                    : 'bg-white text-gray-400 border-gray-200 dark:bg-[#36393F] dark:border-gray-600'}`
                            }
                        >
                            {m}月
                        </button>
                    ))}
                </div>
            </div>

            <div className="flex-1 overflow-y-auto no-scrollbar pb-24">
                
                {/* === Tab 1: 每日趨勢 (Area Chart) === */}
                {tab === 'trend' && (
                    <div className="animate-fade-in space-y-4">
                        <Card className="h-64 pt-6 pr-4">
                            <h3 className="text-xs text-gray-400 uppercase tracking-widest absolute top-4 left-4">每日支出曲線</h3>
                            <ResponsiveContainer width="100%" height="100%">
                                <AreaChart data={dailyData}>
                                    <defs>
                                        <linearGradient id="colorExp" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor="#333" stopOpacity={0.1}/>
                                            <stop offset="95%" stopColor="#333" stopOpacity={0}/>
                                        </linearGradient>
                                    </defs>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f0f0f0" />
                                    <XAxis dataKey="day" axisLine={false} tickLine={false} tick={{fill: '#999', fontSize: 10}} minTickGap={10}/>
                                    <YAxis axisLine={false} tickLine={false} tick={{fill: '#999', fontSize: 10}} width={35}/>
                                    <Tooltip 
                                        contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)'}}
                                        formatter={(value) => `$${value}`}
                                        labelFormatter={(label) => `${currentMonth}月${label}日`}
                                    />
                                    <Area type="monotone" dataKey="amount" stroke="#333" fillOpacity={1} fill="url(#colorExp)" strokeWidth={2} />
                                </AreaChart>
                            </ResponsiveContainer>
                        </Card>
                        
                        <div className="grid grid-cols-2 gap-3">
                            <div className="bg-white dark:bg-[#36393F] p-4 rounded border border-gray-100 dark:border-gray-700">
                                <div className="text-xs text-gray-400 mb-1">本月總支出</div>
                                <div className="text-xl font-medium text-[#333] dark:text-white">
                                    ${pieData.reduce((a,b)=>a+b.value, 0).toLocaleString()}
                                </div>
                            </div>
                            <div className="bg-white dark:bg-[#36393F] p-4 rounded border border-gray-100 dark:border-gray-700">
                                <div className="text-xs text-gray-400 mb-1">平均日支出</div>
                                <div className="text-xl font-medium text-[#333] dark:text-white">
                                    ${Math.round(pieData.reduce((a,b)=>a+b.value, 0) / new Date().getDate()).toLocaleString()}
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {/* === Tab 2: 圓餅分類 (Interactive Pie) === */}
                {tab === 'category' && (
                    <div className="animate-fade-in">
                        <Card className="flex flex-col items-center pt-2 pb-6 min-h-[300px]">
                            {pieData.length > 0 ? (
                                <div className="h-64 w-full relative">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie 
                                                activeIndex={activeIndex}
                                                activeShape={renderActiveShape}
                                                data={pieData} 
                                                innerRadius={65} 
                                                outerRadius={85} 
                                                paddingAngle={3} 
                                                dataKey="value" 
                                                onClick={(_, index) => setActiveIndex(index)}
                                                onMouseEnter={(_, index) => setActiveIndex(index)}
                                            >
                                                {pieData.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.color} />)}
                                            </Pie>
                                        </PieChart>
                                    </ResponsiveContainer>
                                </div>
                            ) : (
                                <div className="flex flex-col items-center justify-center h-64 text-gray-400 opacity-50">
                                    <Icon name="pieChart" size={48} className="mb-2"/>
                                    <span className="text-xs">無支出資料</span>
                                </div>
                            )}
                        </Card>
                        
                        {/* 分類列表 (顯示前 5 名) */}
                        <div className="mt-4 space-y-3">
                            {pieData.map((d, idx) => (
                                <div 
                                    key={d.name} 
                                    onClick={() => { setActiveIndex(idx); window.scrollTo({top:0, behavior:'smooth'}); }}
                                    className={`flex justify-between items-center text-sm p-3 rounded border transition cursor-pointer
                                        ${idx === activeIndex 
                                            ? 'bg-white dark:bg-[#36393F] border-gray-300 dark:border-gray-500 shadow-sm' 
                                            : 'border-transparent hover:bg-white dark:hover:bg-[#36393F]'}`}
                                >
                                    <div className="flex items-center gap-3">
                                        <div className="w-2.5 h-2.5 rounded-full" style={{backgroundColor: d.color}}></div>
                                        <span className="text-gray-600 dark:text-gray-300">{d.name}</span>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <span className="font-medium text-[#333] dark:text-white">${d.value.toLocaleString()}</span>
                                        <span className="text-xs text-gray-400 w-8 text-right">{Math.round((d.value / pieData.reduce((a,b)=>a+b.value,0)) * 100)}%</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {/* === Tab 3: 預算分析 (Bullet Graph) === */}
                {tab === 'budget' && (
                    <div className="animate-fade-in space-y-4">
                        {budgetData.length > 0 ? budgetData.map(item => {
                            // 計算邏輯
                            const hasBudget = item.budget > 0;
                            const percentage = hasBudget ? Math.min((item.spent / item.budget) * 100, 100) : 0;
                            const isOverBudget = hasBudget && item.spent > item.budget;
                            const remaining = item.budget - item.spent;
                            
                            // 顏色邏輯：綠色(安全) -> 黃色(警告) -> 紅色(危險)
                            let barColor = 'bg-[#5CB85C]';
                            if (percentage > 80) barColor = 'bg-yellow-400';
                            if (percentage >= 100) barColor = 'bg-[#D9534F]';
                            
                            // 無預算時顯示灰色
                            if (!hasBudget) barColor = 'bg-gray-400';

                            return (
                                <div key={item.name} className="bg-white dark:bg-[#36393F] p-4 rounded border border-gray-100 dark:border-gray-700 shadow-sm">
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex items-center gap-3">
                                            <div className="w-8 h-8 rounded-full bg-gray-50 dark:bg-gray-700 flex items-center justify-center text-gray-500 dark:text-gray-300">
                                                <Icon name={item.icon || 'more'} size={16} />
                                            </div>
                                            <div>
                                                <div className="text-sm font-medium text-[#333] dark:text-white">{item.name}</div>
                                                <div className="text-[10px] text-gray-400">
                                                    {hasBudget 
                                                        ? (isOverBudget ? `已超支 $${Math.abs(remaining).toLocaleString()}` : `剩餘 $${remaining.toLocaleString()}`)
                                                        : '未設定預算'}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className={`text-sm font-bold ${isOverBudget ? 'text-[#D9534F]' : 'text-[#333] dark:text-white'}`}>
                                                ${item.spent.toLocaleString()}
                                            </div>
                                            {hasBudget && <div className="text-[10px] text-gray-400"> / ${item.budget.toLocaleString()}</div>}
                                        </div>
                                    </div>

                                    {/* 進度條容器 */}
                                    <div className="relative h-2.5 w-full bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                        {/* 實際進度 */}
                                        <div 
                                            className={`absolute top-0 left-0 h-full rounded-full transition-all duration-1000 ${barColor}`} 
                                            style={{ width: `${percentage}%` }}
                                        ></div>
                                        
                                        {/* 超支部分 (斑馬紋) */}
                                        {isOverBudget && (
                                            <div className="absolute top-0 left-0 h-full w-full bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNCIgaGVpZ2h0PSI0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0tMSwxIGwyLC0yIE0wLDQgbDQsLTQgTTMsNSBsMiwtMiIgc3Ryb2tlPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMykiIHN0cm9rZS13aWR0aD0iMSIvPjwvc3ZnPg==')] opacity-30"></div>
                                        )}
                                    </div>
                                    
                                    {/* 百分比標示 */}
                                    {hasBudget && (
                                        <div className="mt-1 flex justify-end">
                                            <span className={`text-[9px] font-bold ${percentage >= 100 ? 'text-[#D9534F]' : 'text-gray-400'}`}>
                                                {Math.round((item.spent / item.budget) * 100)}%
                                            </span>
                                        </div>
                                    )}
                                </div>
                            );
                        }) : (
                            <div className="text-center py-20 text-gray-400 text-sm">本月尚無支出資料</div>
                        )}
                        
                        <div className="text-center mt-6">
                            <button onClick={() => setTab('trend')} className="text-xs text-gray-400 underline">查看趨勢圖</button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};
const TransactionModal = ({ onClose, onSave, onDelete, accounts, categories, initialData }) => {
            // ★ 修改 1：從 Context 取得 transactions (用來計算常用度) 和 triggerHaptic
            const { transactions, triggerHaptic } = React.useContext(DataContext);

            // 流程定義: 
            // 1=分類/轉出, 1.5=細項, 2=付款人(支出)/轉入/存入帳戶(收入), 3=扣款帳戶(支出), 4=金額
            const [step, setStep] = useState(initialData ? 4 : 1);
            const [type, setType] = useState(initialData ? initialData.type : 'expense');
            
            const [selectedCatId, setSelectedCatId] = useState(initialData ? initialData.categoryId : null);
            const [selectedSubCatId, setSelectedSubCatId] = useState(initialData ? initialData.subCategoryId : null);
            const [selectedAcc, setSelectedAcc] = useState(initialData ? initialData.accountId : accounts[0]?.id);
            const [targetAcc, setTargetAcc] = useState(initialData ? (initialData.targetAccountId || accounts[1]?.id) : accounts[1]?.id);
            
            // splitMode: 'none'=個人, 'me'=我墊, 'other'=對方墊
            const [splitMode, setSplitMode] = useState(initialData ? (initialData.payer === 'other' ? 'other' : (initialData.tags?.includes('#分帳') ? 'me' : 'none')) : 'none');
            
            const [amountStr, setAmountStr] = useState(initialData ? initialData.amount.toString() : '0');
            const [date, setDate] = useState(initialData ? initialData.date : getLocalDateString());
            const [note, setNote] = useState(initialData ? initialData.note : '');
            const [menuPage, setMenuPage] = useState(0);

            // ★ 修改 2：智慧排序邏輯
            // 根據最近 50 筆交易，計算帳戶使用頻率，常用的排前面
            const sortedAccounts = useMemo(() => {
                if (!transactions || transactions.length === 0) return accounts;

                // 1. 統計分數
                const scores = {};
                // 取最近 50 筆即可，反應近期習慣
                const recentTx = transactions.slice(0, 50);
                
                recentTx.forEach(tx => {
                    // 轉出/扣款/存入帳戶 +1 分
                    if (tx.accountId) scores[tx.accountId] = (scores[tx.accountId] || 0) + 1;
                    // 轉入帳戶 +1 分
                    if (tx.targetAccountId) scores[tx.targetAccountId] = (scores[tx.targetAccountId] || 0) + 1;
                });

                // 2. 進行排序 (分數高者在前，分數相同維持原順序)
                return [...accounts].sort((a, b) => {
                    const scoreA = scores[a.id] || 0;
                    const scoreB = scores[b.id] || 0;
                    if (scoreB !== scoreA) return scoreB - scoreA;
                    // 如果頻率一樣，依照原本的自訂順序 (sortOrder)
                    return (a.sortOrder || 0) - (b.sortOrder || 0);
                });
            }, [accounts, transactions]);

            // 切換類型時重置
            useEffect(() => { 
                setMenuPage(0);
                if (type !== 'transfer' && !selectedCatId && !initialData) { 
                    const pool = type === 'expense' ? categories.expense : categories.income; 
                    if (pool.length > 0) setSelectedCatId(pool[0].id); 
                }
            }, [type]);

            const handleNumPad = (val) => {
                if (typeof triggerHaptic === 'function') { try { triggerHaptic(); } catch(e) {} }

                if (val === 'AC') {
                    setAmountStr('0');
                } else if (val === 'back') {
                    setAmountStr(prev => prev.length > 1 ? prev.slice(0, -1) : '0');
                } else if (val === 'OK') {
                    let amount = 0;
                    try {
                        let evalStr = amountStr;
                        if (['+','-','*','/'].includes(evalStr.slice(-1))) evalStr = evalStr.slice(0, -1);
                        amount = new Function('return ' + evalStr)();
                    } catch (e) { amount = 0; }

                    if (!amount || isNaN(amount) || amount <= 0) return;
                    
                    let finalTags = initialData ? [...(initialData.tags || [])] : [];
                    finalTags = finalTags.filter(t => t !== '#代墊' && t !== '#分帳' && t !== '#應付');
                    
                    if (type === 'expense') { 
                        if (splitMode === 'me') finalTags.push('#分帳');
                        if (splitMode === 'other') finalTags.push('#應付'); 
                    }

                    onSave({ 
                        id: initialData ? initialData.id : Date.now().toString(), 
                        date, amount, type, 
                        categoryId: type === 'transfer' ? 'transfer' : selectedCatId, 
                        subCategoryId: type === 'transfer' ? null : selectedSubCatId, 
                        accountId: (type === 'expense' && splitMode === 'other') ? accounts[0].id : selectedAcc, 
                        targetAccountId: type === 'transfer' ? targetAcc : null, 
                        note, tags: finalTags, payer: splitMode 
                    });
                } else {
                    if (['+','-','*','/'].includes(val) && ['+','-','*','/'].includes(amountStr.slice(-1))) return;
                    setAmountStr(prev => (prev === '0' || prev === 'Error') && !['+','-','*','/','.'].includes(val) ? val : prev + val);
                }
            };
            // ★ 1. 加入計算剩餘預算的邏輯
            const categoryBudgetInfo = useMemo(() => {
                if (type !== 'expense' || !selectedCatId) return null;
                
                // 找到該分類設定
                const cat = categories.expense.find(c => c.id === selectedCatId);
                if (!cat || !cat.budget) return null; // 沒設定預算就不顯示

                // 計算本月該分類已花費金額
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                const spent = transactions
                    .filter(t => {
                        const d = new Date(t.date);
                        // 包含自己，如果是編輯模式要排除自己(避免重複扣)
                        return t.type === 'expense' && 
                               t.categoryId === selectedCatId && 
                               d.getMonth() === currentMonth && 
                               d.getFullYear() === currentYear &&
                               (!initialData || t.id !== initialData.id);
                    })
                    .reduce((sum, t) => sum + t.amount, 0);

                const remaining = cat.budget - spent;
                // 加入本次輸入的金額 (amountStr) 進行預判
                const currentInput = Number(amountStr) || 0;
                const finalRemaining = remaining - currentInput;

                return { budget: cat.budget, remaining, finalRemaining };
            }, [selectedCatId, transactions, amountStr, type, initialData, categories]);
            // --- UI 渲染 ---
            const renderTypeTabs = () => (
                <div className="w-full px-8 mb-2 relative z-30">
                    <div className="flex bg-gray-100 p-1.5 rounded-xl w-full shadow-inner">
                        {['expense', 'income', 'transfer'].map(t => (
                            <button key={t} onClick={() => setType(t)} className={`flex-1 py-3 text-sm font-bold rounded-lg transition-all duration-200 ${type === t ? 'bg-white text-[#333] shadow-md transform scale-100' : 'text-gray-400 hover:bg-gray-200/50'}`}>
                                {t === 'expense' ? '支出' : t === 'income' ? '收入' : '轉帳'}
                            </button>
                        ))}
                    </div>
                </div>
            );

            const renderFanMenu = (items, onSelect, title, onBackAction) => {
                const itemsPerPage = 5;
                const totalPages = Math.ceil(items.length <= 6 ? 1 : items.length / itemsPerPage);
                const isLastPage = menuPage >= totalPages - 1;
                let displayItems = [];
                let showMore = false;

                if (items.length <= 6) { displayItems = items; } 
                else {
                    const startIndex = menuPage * itemsPerPage;
                    if (isLastPage) { displayItems = items.slice(startIndex); } 
                    else { displayItems = items.slice(startIndex, startIndex + 5); showMore = true; }
                }

                const radius = 135;
                const startAngle = -170;
                const endAngle = -10;
                const totalSlots = displayItems.length + (showMore ? 1 : 0);
                const stepAngle = totalSlots > 1 ? (endAngle - startAngle) / (totalSlots - 1) : 0;

                const handleBackClick = () => { if (menuPage > 0) setMenuPage(prev => prev - 1); else { if (onBackAction) onBackAction(); else onClose(); } };

                return (
                    <div className="fixed inset-0 z-[1000] flex flex-col justify-end animate-fade-in">
                        <div className="absolute inset-0 bg-black/30 backdrop-blur-[2px]" onClick={onClose}></div>
                        <div className="relative w-full h-[420px] bg-white rounded-t-[40px] shadow-2xl animate-slide-up overflow-hidden z-10 flex flex-col items-center pt-6">
                            {step === 1 && renderTypeTabs()}
                            <div className="w-full text-center mt-1 mb-2 h-6"><h3 className="text-sm font-bold text-gray-400 tracking-widest uppercase">{menuPage > 0 ? `${title} (第 ${menuPage + 1} 頁)` : title}</h3></div>
                            <div className="absolute bottom-[-60px] left-1/2 -translate-x-1/2 w-[350px] h-[350px] rounded-full border border-dashed border-gray-200 pointer-events-none"></div>
                            <div className="absolute bottom-8 left-1/2 -translate-x-1/2 z-20">
                                <button onClick={handleBackClick} className="w-14 h-14 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center shadow-sm active:scale-90 transition border border-gray-200"><Icon name={(menuPage > 0 || onBackAction) ? "back" : "close"} size={24} /></button>
                            </div>
                            <div className="absolute bottom-[80px] left-1/2 w-0 h-0 z-10">
                                {displayItems.map((item, index) => {
                                    const angleDeg = totalSlots === 1 ? -90 : startAngle + (index * stepAngle);
                                    const angleRad = angleDeg * (Math.PI / 180);
                                    const x = radius * Math.cos(angleRad);
                                    const y = radius * Math.sin(angleRad);
                                    return (
                                        <button key={item.id} onClick={() => onSelect(item.id)} className="absolute w-16 h-16 -ml-8 -mt-8 rounded-full bg-white shadow-[0_4px_12px_rgba(0,0,0,0.08)] border border-gray-100 flex flex-col items-center justify-center gap-0.5 active:scale-95 transition-all hover:-translate-y-1" style={{ transform: `translate(${x}px, ${y}px)`, animation: `fan-out 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) ${index * 0.05}s backwards` }}>
                                            {item.icon}
                                            <span className="text-[10px] font-medium text-gray-600 leading-none scale-90 truncate w-12 text-center">{item.label}</span>
                                        </button>
                                    );
                                })}
                                {showMore && (() => {
                                    const index = displayItems.length;
                                    const angleDeg = startAngle + (index * stepAngle);
                                    const angleRad = angleDeg * (Math.PI / 180);
                                    const x = radius * Math.cos(angleRad);
                                    const y = radius * Math.sin(angleRad);
                                    return (
                                        <button onClick={() => setMenuPage(prev => prev + 1)} className="absolute w-16 h-16 -ml-8 -mt-8 rounded-full bg-gray-50 shadow-sm border border-gray-200 flex flex-col items-center justify-center gap-0.5 active:scale-95 transition-all" style={{ transform: `translate(${x}px, ${y}px)`, animation: `fan-out 0.4s ${index * 0.05}s backwards` }}><Icon name="grid" size={20} className="text-[#333]" /><span className="text-[10px] font-medium text-gray-600">更多</span></button>
                                    );
                                })()}
                            </div>
                        </div>
                    </div>
                );
            };

            // --- 流程控制 ---

            // Step 1: 選擇分類 (或轉出帳戶)
            if (step === 1) { 
                let items = [];
                let title = "選擇分類";
                let onSelect = (id) => {};

                if (type === 'transfer') {
                    title = "選擇轉出帳戶";
                    // ★ 修改 3：改用 sortedAccounts (智慧排序)
                    items = sortedAccounts.map(acc => ({ 
                        id: acc.id, label: acc.name, 
                        icon: <Icon name={acc.type === 'cash' ? 'banknote' : acc.type === 'liability' ? 'creditCard' : 'wallet'} size={24} className="text-gray-600"/> 
                    }));
                    onSelect = (id) => { setSelectedAcc(id); setStep(2); };
                } else {
                    const activeCategories = type === 'expense' ? categories.expense : categories.income;
                    items = activeCategories.map(cat => ({ 
                        id: cat.id, label: cat.name, 
                        icon: <Icon name={cat.iconKey || 'more'} size={24} className="text-gray-600"/> 
                    }));
                    onSelect = (id) => { 
                        setSelectedCatId(id); 
                        const cat = activeCategories.find(c => c.id === id);
                        if (cat && cat.subCategories && cat.subCategories.length > 0) { setStep(1.5); } 
                        else { setSelectedSubCatId(null); setStep(2); } 
                    };
                }
                return renderFanMenu(items, onSelect, title, null);
            }

            // Step 1.5: 細項
            if (step === 1.5 && type !== 'transfer') {
                const currentCat = (type === 'expense' ? categories.expense : categories.income).find(c => c.id === selectedCatId) || {};
                const items = (currentCat.subCategories || []).map(sub => ({ id: sub.id, label: sub.name, icon: <span className="text-sm font-bold text-gray-500">{sub.name[0]}</span> }));
                const onSelect = (id) => { setSelectedSubCatId(id); setStep(2); };
                return renderFanMenu(items, onSelect, `${currentCat.name} - 細項`, () => setStep(1));
            }

            // Step 2: 付款人(支出)/轉入/存入帳戶(收入)
            if (step === 2) { 
                if (type === 'transfer') {
                    const title = "選擇轉入帳戶";
                    // ★ 修改 4：改用 sortedAccounts 並過濾
                    const targetOptions = sortedAccounts.filter(a => a.id !== selectedAcc);
                    const items = targetOptions.map(acc => ({ id: acc.id, label: acc.name, icon: <Icon name={acc.type === 'cash' ? 'banknote' : acc.type === 'liability' ? 'creditCard' : 'wallet'} size={24} className="text-gray-600"/> }));
                    const onSelect = (id) => { setTargetAcc(id); setStep(4); };
                    return renderFanMenu(items, onSelect, title, () => setStep(1));
                } else if (type === 'income') {
                    const title = "選擇存入帳戶";
                    // ★ 修改 5：改用 sortedAccounts
                    const items = sortedAccounts.map(acc => ({ id: acc.id, label: acc.name, icon: <Icon name={acc.type === 'cash' ? 'banknote' : acc.type === 'liability' ? 'creditCard' : 'wallet'} size={24} className="text-gray-600"/> }));
                    const onSelect = (id) => { setSelectedAcc(id); setStep(4); }; 
                    const onBack = () => {
                        const cat = categories.income.find(c => c.id === selectedCatId);
                        setStep(cat && cat.subCategories && cat.subCategories.length > 0 ? 1.5 : 1);
                    };
                    return renderFanMenu(items, onSelect, title, onBack);
                } else {
                    // 支出流程：選擇付款人
                    const items = [
                        { id: 'other', label: '對方墊付', icon: <Icon name="userCheck" size={24} className="text-[#333]"/> },
                        { id: 'none', label: '個人支出', icon: <Icon name="users" size={24} className="text-gray-400"/> }, 
                        { id: 'me', label: '我先墊付', icon: <Icon name="split" size={24} className="text-[#333]"/> },
                    ]; 
                    const onSelect = (id) => { 
                        setSplitMode(id);
                        if (id === 'other') setStep(4);
                        else setStep(3);
                    };
                    const onBack = () => {
                        const cat = categories.expense.find(c => c.id === selectedCatId);
                        setStep(cat && cat.subCategories && cat.subCategories.length > 0 ? 1.5 : 1);
                    };
                    return renderFanMenu(items, onSelect, "付款人 / 分帳", onBack);
                }
            }
            
            // Step 3: 選擇扣款帳戶 (僅支出出現)
            if (step === 3 && type === 'expense') { 
                const title = "選擇扣款帳戶";
                // ★ 修改 6：改用 sortedAccounts
                const items = sortedAccounts.map(acc => ({ id: acc.id, label: acc.name, icon: <Icon name={acc.type === 'cash' ? 'banknote' : acc.type === 'liability' ? 'creditCard' : 'wallet'} size={24} className="text-gray-600"/> }));
                const onSelect = (id) => { setSelectedAcc(id); setStep(4); };
                const onBack = () => setStep(2); 
                return renderFanMenu(items, onSelect, title, onBack);
            }

            // Step 4: 輸入金額 (保持不變)
            const currentCat = type !== 'transfer' ? ((type === 'expense' ? categories.expense : categories.income).find(c => c.id === selectedCatId) || {}) : {};
            const currentAccData = accounts.find(a => a.id === selectedAcc) || {};
            const targetAccData = accounts.find(a => a.id === targetAcc) || {};
            
            // 返回鍵邏輯
            const handleBackFromAmount = () => {
                if (type === 'transfer') setStep(2);
                else if (type === 'income') setStep(2); 
                else if (splitMode === 'other') setStep(2); 
                else setStep(3); 
            };

            return (
                <div className="fixed z-[200] bg-white flex flex-col animate-slide-up modal-curve-top overflow-hidden left-0 right-0 bottom-0" style={{maxHeight: '90vh'}}>
                    <div className="flex justify-between items-center px-6 pt-6 pb-2 bg-[#F5F5F3]">
                        {initialData ? <button onClick={(e) => {e.stopPropagation(); onClose();}} className="p-2 -ml-2 text-gray-400"><Icon name="close" /></button> : <button onClick={(e) => {e.stopPropagation(); handleBackFromAmount();}} className="p-2 -ml-2 text-gray-400"><Icon name="back" /></button>}
                        <div className="flex items-center gap-2">
                             {type === 'transfer' ? (
                                <><span className="text-xs text-gray-500 bg-white border border-gray-200 px-2 py-1 rounded-full">{currentAccData.name}</span><Icon name="chevronRight" size={12} className="text-gray-400"/><span className="text-xs text-[#333] bg-white border border-[#333] px-2 py-1 rounded-full">{targetAccData.name}</span></>
                             ) : (
                                <>
                                    <button onClick={() => setStep(1)} className="flex items-center gap-1 px-3 py-1 bg-white border border-gray-200 rounded-full text-xs text-gray-600 shadow-sm active:scale-95 transition"><Icon name={currentCat.iconKey||'more'} size={14}/> {currentCat.name}</button>
                                    {type === 'expense' && (
                                        splitMode === 'other' ? (
                                            <button onClick={() => setStep(2)} className="flex items-center gap-1 px-3 py-1 bg-gray-200 border border-gray-300 rounded-full text-xs text-gray-500 shadow-inner">對方墊付</button>
                                        ) : (
                                            <button onClick={() => setStep(3)} className="flex items-center gap-1 px-3 py-1 bg-white border border-gray-200 rounded-full text-xs text-gray-600 shadow-sm active:scale-95 transition">{currentAccData.name}</button>
                                        )
                                    )}
                                    {type === 'income' && (
                                        <button onClick={() => setStep(2)} className="flex items-center gap-1 px-3 py-1 bg-white border border-gray-200 rounded-full text-xs text-gray-600 shadow-sm active:scale-95 transition">{currentAccData.name}</button>
                                    )}
                                </>
                             )}
                        </div>
                        {initialData ? <button onClick={() => onDelete(initialData.id)} className="text-[#D9534F] p-2 -mr-2"><Icon name="trash" /></button> : <div className="w-8"></div>}
                    </div>
                    <div className="px-6 py-4 bg-[#F5F5F3] text-right flex flex-col justify-end">
                        {categoryBudgetInfo && (
                            <div className="flex justify-end mb-1 animate-fade-in">
                                <div className={`text-[10px] px-2 py-0.5 rounded-full border flex items-center gap-1 transition-colors
                                    ${categoryBudgetInfo.finalRemaining < 0 
                                        ? 'bg-red-50 text-red-500 border-red-100 dark:bg-red-900/20 dark:border-red-900' 
                                        : 'bg-green-50 text-green-600 border-green-100 dark:bg-green-900/20 dark:border-green-900'}`
                                }>
                                    <span>{categoryBudgetInfo.finalRemaining < 0 ? '⚠️ 超支' : '剩餘'}</span>
                                    <span className="font-medium">${categoryBudgetInfo.finalRemaining.toLocaleString()}</span>
                                    <span className="text-gray-400">/ 預算 ${categoryBudgetInfo.budget.toLocaleString()}</span>
                                </div>
                            </div>
                        )}
                        <div className="text-gray-400 text-xs mb-2 flex justify-end gap-3 items-center">
                            <div className="bg-white px-3 py-1 rounded-full text-[10px] border border-gray-200 shadow-sm flex items-center gap-1"><Icon name="calendar" size={12}/> <input type="date" value={date} onChange={e => setDate(e.target.value)} className="outline-none bg-transparent text-gray-600 font-medium font-sans h-full" required/></div>
                        </div>
                        <div className={`text-6xl font-light tracking-tighter ${type === 'transfer' ? 'text-gray-600' : type === 'expense' ? 'text-[#333]' : 'text-[#5CB85C]'}`}>{amountStr}</div>
                    </div>
                    <div className="px-5 py-3 bg-white flex flex-col gap-3 relative z-10" style={{boxShadow: '0 -10px 20px rgba(0,0,0,0.03)'}}>
                         <div className="flex gap-3">
                            {type === 'expense' && (
                                <button onClick={() => setStep(2)} className={`flex-1 rounded-lg px-3 py-3 flex items-center justify-center gap-2 transition border ${splitMode !== 'none' ? 'bg-[#333] text-white border-[#333]' : 'bg-white text-gray-400 border-gray-200'}`}>
                                    <Icon name={splitMode === 'other' ? 'userCheck' : 'split'} size={16} />
                                    <span className="text-xs font-medium">{splitMode === 'none' ? '分帳' : (splitMode === 'me' ? '我墊付' : '對方墊')}</span>
                                </button>
                            )}
                            <div className="flex-[3] bg-[#F9F9F9] rounded-lg px-3 py-3 flex items-center gap-3"><Icon name="fileText" size={16} className="text-gray-400"/><input type="text" placeholder="新增備註..." className="bg-transparent w-full text-sm outline-none text-gray-700 placeholder-gray-400" value={note} onChange={e => setNote(e.target.value)} /></div>
                        </div>
                    </div>
                    <div className="flex-1 bg-white grid grid-cols-4 p-2 gap-2 content-end pb-6 border-t border-gray-50">
                        {['7','8','9','AC','4','5','6','+','1','2','3','-','.','0','back','OK'].map(key => (<button key={key} type="button" onClick={() => handleNumPad(key)} className={`rounded-lg text-xl font-light h-16 flex items-center justify-center muji-button ${key === 'OK' ? 'bg-[#333] text-white shadow-md' : ['+','-','AC','back'].includes(key) ? 'bg-[#F9F9F9] text-gray-500' : 'text-[#333]'}`}>{key === 'back' ? <Icon name="back" size={24}/> : key}</button>))}
                    </div>
                </div>
            );
        };

// ==========================================
// ★ 補回遺失元件 1: QuickAddSheet (快速記帳選單)
// ==========================================
const QuickAddSheet = ({ templates, accounts, categories, onClose, onSelect, onGoSettings }) => {
    const [page, setPage] = useState(0);
    
    // 扇形參數
    const radius = 130;
    const startAngle = -170;
    const endAngle = -10;
    const itemsPerPage = 5;

    // 分頁計算邏輯
    let displayTemplates = [];
    let showMore = false;

    if (templates.length <= 6) {
        displayTemplates = templates;
    } else {
        const totalPages = Math.ceil(templates.length / itemsPerPage);
        const isLastPage = page >= totalPages - 1;
        const startIndex = page * itemsPerPage;

        if (isLastPage) {
            displayTemplates = templates.slice(startIndex);
        } else {
            displayTemplates = templates.slice(startIndex, startIndex + itemsPerPage);
            showMore = true;
        }
    }

    const totalSlots = displayTemplates.length + (showMore ? 1 : 0);
    const step = totalSlots > 1 ? (endAngle - startAngle) / (totalSlots - 1) : 0;

    const handleCenterClick = (e) => {
        e.stopPropagation(); // 防止誤觸背景
        if (page > 0) {
            setPage(prev => prev - 1);
        } else {
            onClose();
        }
    };

    return (
        <div className="fixed inset-0 z-[1000] flex flex-col justify-end animate-fade-in">
            {/* 背景層：點擊這裡才會關閉 */}
            <div className="absolute inset-0 bg-black/30 backdrop-blur-[2px]" onClick={onClose}></div>
            
            <div className="relative w-full h-[320px] bg-white rounded-t-[40px] shadow-2xl animate-slide-up overflow-hidden z-10 flex flex-col items-center" onClick={(e) => e.stopPropagation()}>
                <div className="w-full text-center mt-6 mb-2">
                    <h3 className="text-sm font-bold text-gray-400 tracking-widest uppercase">
                        {page > 0 ? `快速記帳 (第 ${page + 1} 頁)` : '快速記帳'}
                    </h3>
                </div>
                
                <div className="absolute bottom-[-60px] left-1/2 -translate-x-1/2 w-[350px] h-[350px] rounded-full border border-dashed border-gray-200 pointer-events-none"></div>
                
                {/* 中央按鈕 */}
                <div className="absolute bottom-6 left-1/2 -translate-x-1/2 z-20 flex flex-col gap-2 items-center">
                    {templates.length === 0 ? (
                        <button onClick={onGoSettings} className="px-6 py-3 bg-[#333] text-white rounded-full text-sm shadow-lg">建立模板</button>
                    ) : (
                        <button onClick={handleCenterClick} className="w-16 h-16 rounded-full bg-[#333] text-white flex items-center justify-center shadow-lg active:scale-90 transition border-4 border-white">
                            <Icon name={page > 0 ? "back" : "close"} size={24} />
                        </button>
                    )}
                </div>

                {/* 扇形按鈕群 */}
                <div className="absolute bottom-[60px] left-1/2 w-0 h-0 z-10">
                    {displayTemplates.map((t, index) => {
                        const angleDeg = totalSlots === 1 ? -90 : startAngle + (index * step);
                        const angleRad = angleDeg * (Math.PI / 180);
                        const x = radius * Math.cos(angleRad);
                        const y = radius * Math.sin(angleRad);
                        const accName = accounts.find(a => a.id === t.accountId)?.name || '未知';

                        return (
                            <button 
                                key={t.id} 
                                // ★ 關鍵：傳遞完整的 t (模板物件)，而不是 t.id
                                onClick={(e) => { e.stopPropagation(); onSelect(t); }}
                                className="absolute w-16 h-16 -ml-8 -mt-8 rounded-full bg-white shadow-md border border-gray-100 flex flex-col items-center justify-center gap-0.5 active:scale-95 transition-all hover:bg-gray-50 hover:border-[#333] group z-50"
                                style={{ 
                                    transform: `translate(${x}px, ${y}px)`,
                                    animation: `fan-out 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) ${index * 0.05}s backwards`
                                }}
                            >
                                <div className="text-[#333]"><Icon name={t.iconKey || 'template'} size={20}/></div>
                                <span className="text-[9px] font-medium text-gray-600 truncate max-w-[50px]">{t.name}</span>
                                <div className="absolute -bottom-8 left-1/2 -translate-x-1/2 whitespace-nowrap bg-gray-800 text-white text-[9px] px-1.5 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-30 shadow-sm">
                                    {accName} {t.isSplit && '· 分帳'}
                                </div>
                                {t.isSplit && <div className="absolute top-0 right-0 w-2.5 h-2.5 bg-[#333] rounded-full border border-white"></div>}
                            </button>
                        );
                    })}

                    {showMore && (() => {
                        const index = displayTemplates.length;
                        const angleDeg = startAngle + (index * step);
                        const angleRad = angleDeg * (Math.PI / 180);
                        const x = radius * Math.cos(angleRad);
                        const y = radius * Math.sin(angleRad);
                        
                        return (
                            <button 
                                onClick={(e) => { e.stopPropagation(); setPage(prev => prev + 1); }} 
                                className="absolute w-16 h-16 -ml-8 -mt-8 rounded-full bg-gray-50 shadow-sm border border-gray-200 flex flex-col items-center justify-center gap-0.5 active:scale-95 transition-all hover:bg-gray-100 z-50"
                                style={{ 
                                    transform: `translate(${x}px, ${y}px)`,
                                    animation: `fan-out 0.4s ${index * 0.05}s backwards` 
                                }}
                            >
                                <Icon name="grid" size={20} className="text-[#333]" />
                                <span className="text-[10px] font-medium text-gray-600">更多</span>
                            </button>
                        );
                    })()}
                </div>
                
                <button onClick={onGoSettings} className="absolute bottom-4 right-6 text-[10px] text-gray-400 flex items-center gap-1 hover:text-[#333] transition z-30">
                    管理模板 <Icon name="settings" size={10}/>
                </button>
            </div>
        </div>
    );
};

// ==========================================
// ★ 修正版：QuickEntryModal (支援小數點與計算功能)
// ==========================================
const QuickEntryModal = ({ template, onClose, onSave }) => {
    // 引入震動
    const { triggerHaptic } = React.useContext(DataContext);
    const [amountStr, setAmountStr] = useState('0');

    if (!template) return null;

    const handleNumPad = (val) => {
        if(triggerHaptic) triggerHaptic();

        if (val === 'AC') {
            setAmountStr('0');
        } else if (val === 'back') { 
            setAmountStr(prev => prev.length > 1 ? prev.slice(0, -1) : '0'); 
        } else if (val === 'OK') {
            // ★ 加入計算邏輯 (支援 50+20)
            let amount = 0;
            try {
                let evalStr = amountStr;
                if (['+','-','*','/'].includes(evalStr.slice(-1))) evalStr = evalStr.slice(0, -1);
                amount = new Function('return ' + evalStr)();
            } catch (e) { amount = 0; }

            if (amount > 0) {
                onSave({ 
                    id: Date.now().toString(), 
                    date: getLocalDateString(), 
                    amount, 
                    type: 'expense', 
                    categoryId: template.categoryId, 
                    subCategoryId: template.subCategoryId, 
                    accountId: template.accountId, 
                    note: template.name, 
                    tags: template.isSplit ? ['#分帳'] : [] 
                });
            }
        } else { 
            // 防止連續運算符號
            if (['+','-','*','/'].includes(val) && ['+','-','*','/'].includes(amountStr.slice(-1))) return;
            setAmountStr(prev => (prev === '0' && !['+','-','*','/','.'].includes(val)) ? val : prev + val); 
        }
    };

    return (
        <div className="fixed inset-0 z-[1100] bg-black/60 flex items-end justify-center animate-fade-in">
            <div className="absolute inset-0" onClick={onClose}></div>

            <div className="bg-white w-full max-w-md rounded-t-xl animate-slide-up overflow-hidden relative z-10">
                <div className="bg-[#F5F5F3] p-4 flex justify-between items-center border-b border-gray-200">
                    <div className="flex items-center gap-2">
                        <div className="p-1.5 bg-white rounded-full border border-gray-200">
                            <Icon name={template.iconKey || 'template'} size={16}/>
                        </div>
                        <span className="text-sm font-medium text-[#333]">{template.name}</span>
                    </div>
                    <button onClick={onClose} className="p-1">
                        <Icon name="close" size={20} className="text-gray-400"/>
                    </button>
                </div>
                <div className="py-6 px-6 text-right bg-[#F5F5F3]">
                    <div className="text-4xl font-light text-[#333] tracking-tighter">${amountStr}</div>
                </div>
                
                {/* ★ 修改：改為 4 欄佈局，加入 +, -, . */}
                <div className="bg-white grid grid-cols-4 p-2 gap-2 border-t border-gray-100">
                    {['7','8','9','AC','4','5','6','+','1','2','3','-','.','0','back','OK'].map(key => (
                        <button 
                            key={key} 
                            onClick={() => handleNumPad(key)} 
                            className={`h-14 rounded-lg text-xl font-light flex items-center justify-center transition active:bg-gray-100 
                                ${key === 'OK' ? 'bg-[#333] text-white shadow-md active:bg-black' : ['+','-','AC','back'].includes(key) ? 'bg-[#F9F9F9] text-gray-500' : 'text-[#333]'}`
                            }
                        >
                            {key === 'back' ? <Icon name="back" size={20}/> : key}
                        </button>
                    ))}
                </div>
            </div>
        </div>
    );
};

// SplitManager 主體
    const SplitManager = () => {
        const { transactions, accounts, categories, handleSettleSplit: onSettle, showAlert: onAlert, triggerHaptic } = React.useContext(DataContext);
        const [selectedIds, setSelectedIds] = useState([]);
        const [isSettleModalOpen, setIsSettleModalOpen] = useState(false);
        
        const splitItems = useMemo(() => transactions.filter(t => t.type === 'expense' && t.tags && (t.tags.includes('#分帳') || t.tags.includes('#應付'))), [transactions]);
        const toggleSelect = (id) => setSelectedIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
        const toggleAll = () => selectedIds.length === splitItems.length ? setSelectedIds([]) : setSelectedIds(splitItems.map(t => t.id));
        
        const netAmount = useMemo(() => {
            return splitItems.filter(t => selectedIds.includes(t.id)).reduce((sum, t) => {
                if (t.tags.includes('#分帳')) return sum + t.amount; 
                if (t.tags.includes('#應付')) return sum - t.amount; 
                return sum;
            }, 0);
        }, [splitItems, selectedIds]);

        // 匯出圖片邏輯 (修正：傳入 isOtherPaid)
        const handleExportImage = () => { 
            if (selectedIds.length === 0) return; 
            const itemsToDraw = splitItems.filter(t => selectedIds.includes(t.id)).map(t => { 
                const cat = categories.expense.find(c => c.id === t.categoryId); 
                return { 
                    name: t.note || cat?.name || '項目', 
                    amount: t.amount,
                    isOtherPaid: t.tags.includes('#應付') // 標記是否為對方墊付
                }; 
            }); 
            // 這裡傳入的 netAmount 是總淨額，顯示時會根據正負號判斷
            drawReceipt(itemsToDraw, netAmount).then(blob => { 
                const file = new File([blob], `bill_${getLocalDateString()}.jpg`, { type: 'image/jpeg' }); 
                if (navigator.share && navigator.canShare({ files: [file] })) { 
                    navigator.share({ files: [file], title: '分帳明細' }).catch(console.error); 
                } else { 
                    const link = document.createElement('a'); 
                    link.download = file.name; 
                    link.href = URL.createObjectURL(blob); 
                    document.body.appendChild(link); 
                    link.click(); 
                } 
            }); 
        };

        const handleConfirmSettle = (finalAmount, targetAccountId) => {
            if (finalAmount === 0) {
                onAlert('提示', '結算金額為 0，無需產生交易');
                setIsSettleModalOpen(false);
                return;
            }
            let newTransactions = [...transactions];
            let newAccounts = [...accounts];

            // 1. 產生結算交易
            const isIncome = finalAmount > 0;
            const settleTx = {
                id: Date.now().toString(),
                createdAt: Date.now(),
                date: getLocalDateString(),
                amount: Math.abs(finalAmount),
                type: isIncome ? 'income' : 'expense',
                categoryId: 'reimbursement',
                accountId: targetAccountId,
                note: `分帳結清`,
                tags: ['#已結清']
            };
            newTransactions = [settleTx, ...newTransactions];
            
            // 2. 更新帳戶
            newAccounts = newAccounts.map(a => a.id === targetAccountId ? { ...a, balance: a.balance + finalAmount } : a);

            // 3. 標記舊交易為已結清
            selectedIds.forEach(id => {
                const originalTx = transactions.find(t => t.id === id);
                if (!originalTx) return;
                const newTags = originalTx.tags.filter(t => t !== '#分帳' && t !== '#代墊' && t !== '#應付').concat(['#已結清']);
                newTransactions = newTransactions.map(t => t.id === id ? { ...originalTx, tags: newTags } : t);
            });

            onSettle(newTransactions, newAccounts);
            setIsSettleModalOpen(false);
            setSelectedIds([]);
            onAlert('成功', '已產生結算交易並更新帳戶');
        };

        return (
            <div className="h-full flex flex-col pt-10 px-6 pb-0 animate-fade-in">
                <div className="shrink-0 flex justify-between items-center mb-6">
                    <h2 className="text-xl font-medium text-[#333] tracking-wide">分帳管理</h2>
                    {splitItems.length > 0 && (
                        <button onClick={() => { if(triggerHaptic) triggerHaptic(); toggleAll(); }} className="text-xs text-gray-500 font-medium px-2 py-1 bg-white border border-gray-200 rounded hover:bg-gray-50 transition">
                            {selectedIds.length === splitItems.length ? '取消全選' : '全選'}
                        </button>
                    )}
                </div>

                <div className="flex-1 overflow-y-auto no-scrollbar space-y-3 pb-32">
                    {splitItems.length === 0 ? (
                        <div className="text-center py-20 text-gray-400"><Icon name="check" size={48} className="mx-auto mb-4 text-gray-200"/><p>目前無未結清項目</p></div>
                    ) : (
                        splitItems.map(t => { 
                            const cat = categories.expense.find(c => c.id === t.categoryId) || {}; 
                            const isMyPay = t.tags.includes('#分帳');
                            return (
                                <div key={t.id} onClick={() => { if(triggerHaptic) triggerHaptic(); toggleSelect(t.id); }} className={`bg-white p-4 rounded border transition cursor-pointer flex items-center gap-4 ${selectedIds.includes(t.id) ? 'border-[#333] shadow-md' : 'border-transparent shadow-sm hover:shadow-md'}`}>
                                    <div className={`w-5 h-5 rounded-full border flex items-center justify-center transition ${selectedIds.includes(t.id) ? 'bg-[#333] border-[#333]' : 'border-gray-300'}`}>
                                        {selectedIds.includes(t.id) && <Icon name="check" size={12} className="text-white"/>}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <div className="flex justify-between items-center mb-1">
                                            <span className="font-medium text-[#333] text-sm truncate">{cat.name} <span className="text-xs font-normal text-gray-400 ml-1">{t.note}</span></span>
                                            <span className={`font-bold shrink-0 ${isMyPay ? 'text-[#333]' : 'text-red-500'}`}>
                                                {isMyPay ? '' : '-'}${t.amount}
                                            </span>
                                        </div>
                                        <div className="text-xs text-gray-400 flex justify-between mt-1">
                                            <span>{t.date}</span>
                                            <span className={`text-[10px] px-1.5 rounded ${isMyPay ? 'bg-gray-100 text-gray-500' : 'bg-red-50 text-red-500'}`}>
                                                {isMyPay ? '我先墊' : '對方墊'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            ); 
                        })
                    )}
                </div>

                {selectedIds.length > 0 && (
                    <div className="fixed bottom-[64px] left-0 right-0 max-w-md mx-auto p-4 bg-white/95 backdrop-blur border-t border-gray-200 shadow z-30 flex flex-col gap-3">
                        <div className="flex justify-between items-start">
                            <div>
                                <span className="text-xs text-gray-400 uppercase tracking-wider block">代墊淨額</span>
                                <span className="text-[10px] text-gray-400">選取 {selectedIds.length} 筆</span>
                            </div>
                            <div className="text-right">
                                <span className={`text-xl font-medium block ${netAmount >= 0 ? 'text-[#333]' : 'text-red-500'}`}>
                                    {netAmount >= 0 ? '我多付 ' : '我少付 '}${Math.abs(netAmount).toLocaleString()}
                                </span>
                            </div>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={() => { if(triggerHaptic) triggerHaptic(); handleExportImage(); }} className="flex-1 bg-gray-100 text-gray-600 py-3 rounded text-sm font-medium hover:bg-gray-200 transition flex items-center justify-center gap-2"><Icon name="image" size={16}/> 圖片</button>
                            <button onClick={() => { if(triggerHaptic) triggerHaptic(); setIsSettleModalOpen(true); }} className="flex-[1.5] bg-[#333] text-white py-3 rounded text-sm font-medium hover:bg-black transition">結算</button>
                        </div>
                    </div>
                )}
                {isSettleModalOpen && <SettleModal netAmount={netAmount} accounts={accounts} onClose={() => setIsSettleModalOpen(false)} onConfirm={handleConfirmSettle} />}
            </div>
        );
    };
const SettleModal = ({ netAmount, accounts, onClose, onConfirm }) => {
            const [mode, setMode] = useState('half'); // half = AA制, full = 全額
            const [targetAcc, setTargetAcc] = useState(accounts[0]?.id);
            const [customAmount, setCustomAmount] = useState(''); 
            
            const finalAmount = useMemo(() => {
                if (mode === 'custom') return Number(customAmount) || 0;
                if (mode === 'full') return netAmount;
                return Math.round(netAmount / 2); 
            }, [mode, netAmount, customAmount]);

            const isReceiving = finalAmount > 0;

            return (
                // ★ 修改重點 1：移除 items-end，改為 items-center (讓手機版也垂直置中)
                // ★ 修改重點 2：z-index 提高到 1300，確保蓋過底部導覽列
                <div className="fixed inset-0 bg-black/50 z-[1300] flex items-center justify-center p-4 animate-fade-in">
                    
                    {/* ★ 修改重點 3：移除 rounded-t-xl (上方圓角)，改為 rounded-xl (全圓角)，讓它看起來像對話框 */}
                    <div className="bg-white w-full max-w-sm rounded-xl p-6 animate-slide-up shadow-2xl relative">
                        
                        {/* 增加右上角關閉按鈕，方便手指點擊 */}
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 p-2 active:scale-90 transition">
                            <Icon name="close" size={20}/>
                        </button>

                        <div className="text-center mb-6">
                            <h3 className="text-lg font-bold text-[#333]">結算確認</h3>
                            <div className="mt-2 bg-gray-50 py-2 rounded">
                                <span className="text-xs text-gray-400 block mb-1">原始淨額</span>
                                <span className={`text-xl font-medium ${netAmount >= 0 ? 'text-[#333]' : 'text-red-500'}`}>
                                    {netAmount >= 0 ? '我多付 ' : '我少付 '}${Math.abs(netAmount)}
                                </span>
                            </div>
                        </div>
                        
                        <div className="space-y-3 mb-6">
                            <label className="text-xs text-gray-400 uppercase block mb-1">結算模式</label>
                            <div className="flex bg-gray-100 p-1 rounded-lg mb-3">
                                <button onClick={() => setMode('half')} className={`flex-1 py-2 text-xs font-medium rounded transition ${mode === 'half' ? 'bg-white text-[#333] shadow-sm' : 'text-gray-500'}`}>AA制 (/2)</button>
                                <button onClick={() => setMode('full')} className={`flex-1 py-2 text-xs font-medium rounded transition ${mode === 'full' ? 'bg-white text-[#333] shadow-sm' : 'text-gray-500'}`}>全額</button>
                                <button onClick={() => setMode('custom')} className={`flex-1 py-2 text-xs font-medium rounded transition ${mode === 'custom' ? 'bg-white text-[#333] shadow-sm' : 'text-gray-500'}`}>自訂</button>
                            </div>

                            <div className="w-full py-3 px-4 rounded border border-gray-200 flex justify-between items-center bg-white">
                                <div className="text-left">
                                    <div className="text-sm font-medium text-[#333]">
                                        {mode === 'half' ? 'AA 平分' : mode === 'full' ? '全額結清' : '自訂金額'}
                                    </div>
                                    <div className="text-xs text-gray-400">
                                        {mode === 'custom' ? '請輸入金額' : '系統自動計算'}
                                    </div>
                                </div>
                                {mode === 'custom' ? (
                                    <input 
                                        type="number" 
                                        value={customAmount} 
                                        onChange={(e) => setCustomAmount(e.target.value)} 
                                        placeholder="0"
                                        className="w-24 text-right text-lg font-bold text-[#333] outline-none border-b border-gray-300 focus:border-[#333] bg-transparent"
                                        autoFocus
                                    />
                                ) : (
                                    <div className={`text-lg font-bold ${finalAmount > 0 ? 'text-[#333]' : 'text-red-500'}`}>
                                        {finalAmount > 0 ? '+' : ''}{Math.abs(finalAmount)}
                                    </div>
                                )}
                            </div>

                            <div className="pt-2">
                                <label className="text-xs text-gray-400 block mb-2 uppercase">{isReceiving ? '收款存入帳戶' : '付款帳戶'}</label>
                                <div className="bg-gray-50 border border-gray-200 rounded px-3 py-2 flex items-center gap-2">
                                    <Icon name="wallet" size={16} className="text-gray-400"/>
                                    <select className="bg-transparent w-full text-sm outline-none text-[#333]" value={targetAcc} onChange={e => setTargetAcc(e.target.value)}>
                                        {accounts.map(a => <option key={a.id} value={a.id}>{a.name} (${a.balance})</option>)}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div className="flex gap-3 pt-2">
                            <button onClick={onClose} className="flex-1 py-3 text-gray-500 bg-gray-100 rounded-lg font-medium hover:bg-gray-200 transition">取消</button>
                            <button onClick={() => onConfirm(finalAmount, targetAcc)} className="flex-[1.5] py-3 bg-[#333] text-white rounded-lg font-medium shadow-lg hover:bg-black transition">
                                確認{isReceiving ? '收款' : '支付'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

// ==========================================
// 修正版 AssetsView (樣式同步首頁：大字體無框線)
// ==========================================
const AssetsView = ({ onSelectAccount, onAddAccount, onEditAccount }) => {
    const { 
        accounts, handleReorderAccounts, handleSaveTransaction, 
        triggerHaptic, isPrivacyMode, togglePrivacy // 記得取出 togglePrivacy
    } = React.useContext(DataContext); 
    
    const [isReordering, setIsReordering] = useState(false);
    const [localAccounts, setLocalAccounts] = useState(accounts);
    const [repayModal, setRepayModal] = useState(null); 

    useEffect(() => { setLocalAccounts(accounts); }, [accounts]);

    // 計算總資產與總負債
    const assetSummary = React.useMemo(() => {
        let totalAssets = 0;
        let totalLiabilities = 0;
        
        accounts.forEach(acc => {
            if (acc.balance > 0) totalAssets += acc.balance;
            if (acc.balance < 0) totalLiabilities += acc.balance;
        });

        return { totalAssets, totalLiabilities, netWorth: totalAssets + totalLiabilities };
    }, [accounts]);

    const getDueWarning = (dueDay) => {
        if (!dueDay) return null;
        const today = new Date();
        const currentDay = today.getDate();
        let targetDate = new Date(today.getFullYear(), today.getMonth(), dueDay);
        if (currentDay > dueDay) targetDate.setMonth(targetDate.getMonth() + 1);
        const diffTime = targetDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        if (diffDays >= 0 && diffDays <= 7) return { days: diffDays, urgent: diffDays <= 3 };
        return null;
    };

    const getGroupType = (type) => {
        if (type === 'cash') return 'cash';
        if (type === 'bank' || type === 'stock') return 'bank';
        if (type === 'liability') return 'liability';
        return 'other';
    };

    const moveAccount = (accId, direction) => {
        const targetAcc = localAccounts.find(a => a.id === accId);
        if (!targetAcc) return;
        const targetGroup = getGroupType(targetAcc.type);
        const groupItems = localAccounts.filter(a => getGroupType(a.type) === targetGroup).sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));
        const index = groupItems.findIndex(a => a.id === accId);
        if (index === -1) return;
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= groupItems.length) return;
        const temp = groupItems[index];
        groupItems[index] = groupItems[newIndex];
        groupItems[newIndex] = temp;
        const updates = {};
        groupItems.forEach((item, idx) => { updates[item.id] = idx; });
        const newLocalAccounts = localAccounts.map(a => { if (updates[a.id] !== undefined) { return { ...a, sortOrder: updates[a.id] }; } return a; });
        setLocalAccounts(newLocalAccounts);
    };

    const saveReorder = () => { handleReorderAccounts(localAccounts); setIsReordering(false); };
    
    const groupAccounts = (accs) => {
        const sorted = [...accs].sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));
        return {
            cash: sorted.filter(a => a.type === 'cash'),
            bank: sorted.filter(a => a.type === 'bank' || a.type === 'stock'),
            liability: sorted.filter(a => a.type === 'liability')
        };
    };

    const groups = groupAccounts(localAccounts);
    
    const openRepayModal = (acc) => {
        const debt = Math.abs(acc.balance);
        const payAcc = accounts.find(a => a.type === 'bank') || accounts[0];
        setRepayModal({ targetAcc: acc, payAccId: payAcc.id, amount: debt });
    };

    const confirmRepay = () => {
        if (!repayModal) return;
        handleSaveTransaction({
            id: Date.now().toString(),
            createdAt: Date.now(),
            date: getLocalDateString(),
            amount: Number(repayModal.amount),
            type: 'transfer',
            accountId: repayModal.payAccId,
            targetAccountId: repayModal.targetAcc.id,
            note: `信用卡還款 (${repayModal.targetAcc.name})`,
            tags: []
        });
        setRepayModal(null);
    };

    const renderAccountCard = (acc) => {
        const warning = (acc.type === 'liability' && acc.dueDay) ? getDueWarning(acc.dueDay) : null;
        const isLiability = acc.type === 'liability';
        
        return (
            <div key={acc.id} onClick={() => !isReordering && onSelectAccount(acc.id)} className={`bg-white dark:bg-[#36393F] p-4 rounded border border-transparent shadow-sm flex items-center justify-between relative group ${!isReordering && 'hover:shadow-md hover:border-gray-200 dark:hover:border-gray-600 cursor-pointer transition'}`}>
                <div className="flex items-center gap-4">
                    <div className="w-10 h-10 rounded-full bg-[#F0F0F0] dark:bg-gray-700 text-[#555] dark:text-gray-300 relative flex items-center justify-center shrink-0">
                        <Icon name={acc.type === 'cash' ? 'banknote' : acc.type === 'liability' ? 'creditCard' : 'wallet'} size={20}/>
                        {warning && !isReordering && <div className="absolute -top-1 -right-1 w-3 h-3 bg-[#D9534F] rounded-full border-2 border-white dark:border-[#36393F]"></div>}
                    </div>
                    <div>
                        <div className="text-sm font-medium text-[#333] dark:text-white flex items-center gap-2">
                            {acc.name}
                            {warning && !isReordering && <span className={`text-[9px] px-1.5 py-0.5 rounded font-bold ${warning.urgent ? 'bg-red-100 text-[#D9534F]' : 'bg-orange-100 text-orange-600'}`}>{warning.days === 0 ? '今日還款' : `剩 ${warning.days} 天`}</span>}
                        </div>
                        <div className="text-[10px] text-gray-400 uppercase tracking-wider flex gap-2">
                            {acc.type === 'cash' ? '現金' : isLiability ? '負債/信用卡' : '銀行/數位'}
                            {isLiability && acc.limit > 0 && <span>({Math.round((Math.abs(acc.balance)/acc.limit)*100)}%)</span>}
                        </div>
                    </div>
                </div>
                {isReordering ? (
                    <div className="flex items-center gap-2">
                        <button onClick={(e) => { e.stopPropagation(); moveAccount(acc.id, -1); }} className="p-2 text-gray-400 hover:text-[#333] dark:hover:text-white active:bg-gray-100 dark:active:bg-gray-700 rounded"><Icon name="chevronUp" size={20}/></button>
                        <button onClick={(e) => { e.stopPropagation(); moveAccount(acc.id, 1); }} className="p-2 text-gray-400 hover:text-[#333] dark:hover:text-white active:bg-gray-100 dark:active:bg-gray-700 rounded"><Icon name="chevronDown" size={20}/></button>
                    </div>
                ) : (
                    <div className="flex items-center gap-3">
                        {isLiability && acc.balance < 0 && (
                            <button 
                                onClick={(e) => { e.stopPropagation(); openRepayModal(acc); }}
                                className="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-xs text-gray-600 dark:text-gray-300 rounded hover:bg-[#333] hover:text-white transition"
                            >
                                還款
                            </button>
                        )}
                        <div className={`text-base font-medium ${isPrivacyMode ? 'text-[#333] dark:text-white' : (acc.balance < 0 ? 'text-[#D9534F]' : 'text-[#333] dark:text-white')}`}>
                            {isPrivacyMode ? '****' : `$${formatMoney(acc.balance)}`}
                        </div>
                        <button onClick={(e) => { e.stopPropagation(); onEditAccount(acc); }} className="p-2 text-gray-300 hover:text-gray-500"><Icon name="edit" size={14} /></button>
                    </div>
                )}
            </div>
        );
    };

    return (
        <div className="h-full flex flex-col pt-10 px-6 pb-0 animate-fade-in relative">
            <div className="shrink-0 mb-2">
                <div className="flex justify-between items-center mb-2">
                    <h2 className="text-xl font-medium text-[#333] dark:text-white tracking-wide">帳戶總覽</h2>
                    <div className="flex gap-2">
                        {isReordering ? <button onClick={saveReorder} className="text-xs bg-[#333] text-white px-3 py-1.5 rounded shadow-sm">完成</button> : <button onClick={() => setIsReordering(true)} className="text-xs text-gray-500 px-2 py-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition">調整順序</button>}
                        {!isReordering && <button onClick={onAddAccount} className="w-8 h-8 rounded-full bg-white dark:bg-[#36393F] border border-gray-200 dark:border-gray-600 flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-[#333] hover:text-white transition"><Icon name="plus" size={16}/></button>}
                    </div>
                </div>

                {/* ★ 修改重點：比照首頁的樣式 (大字體、並列、隱私開關) */}
                <div className="flex justify-between items-end mb-2"> 
                    {/* 左側：總資產 (綠色) */}
                    <div>
                        <div className="text-xs text-gray-400 mb-1 tracking-widest font-medium uppercase flex items-center gap-2">
                            總資產 (現金/存款)
                            <button onClick={togglePrivacy} className="text-gray-300 hover:text-gray-500 transition">
                                <Icon name={isPrivacyMode ? "eyeOff" : "eye"} size={14} /> 
                            </button>
                        </div>
                        <div className="text-3xl font-light text-[#5CB85C] tracking-tight">
                            {isPrivacyMode ? '****' : <><span className="text-lg mr-1 font-normal">$</span>{formatMoney(assetSummary.totalAssets)}</>}
                        </div>
                    </div>
                    
                    {/* 右側：總負債 (紅色) */}
                    <div className="text-right">
                        <div className="text-xs text-gray-400 mb-1 tracking-widest font-medium uppercase">
                            總負債 (信用卡/貸款)
                        </div>
                        <div className="text-3xl font-light text-[#D9534F] tracking-tight">
                            {isPrivacyMode ? '****' : <><span className="text-lg mr-1 font-normal">$</span>{formatMoney(Math.abs(assetSummary.totalLiabilities))}</>}
                        </div>
                    </div>
                </div>
                
                {/* 淨值顯示 (保留在右下角輔助) */}
                <div className="text-right text-xs text-gray-400 mb-4 tracking-widest font-medium">
                    淨值: {isPrivacyMode ? '****' : `$${formatMoney(assetSummary.netWorth)}`}
                </div>
            </div>

            <div className="flex-1 overflow-y-auto no-scrollbar space-y-6 pb-20">
                {groups.cash.length > 0 && <div><h3 className="text-xs text-gray-400 mb-2 uppercase tracking-widest pl-1">現金錢包</h3><div className="space-y-3">{groups.cash.map(renderAccountCard)}</div></div>}
                {groups.bank.length > 0 && <div><h3 className="text-xs text-gray-400 mb-2 uppercase tracking-widest pl-1">銀行與數位帳戶</h3><div className="space-y-3">{groups.bank.map(renderAccountCard)}</div></div>}
                {groups.liability.length > 0 && <div><h3 className="text-xs text-gray-400 mb-2 uppercase tracking-widest pl-1">信用卡與負債</h3><div className="space-y-3">{groups.liability.map(renderAccountCard)}</div></div>}
            </div>

            {repayModal && (
                <div className="fixed inset-0 z-[1200] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-fade-in">
                    <div className="bg-white w-full max-w-xs rounded-xl p-6 shadow-xl animate-scale-up">
                        <h3 className="text-lg font-bold text-[#333] mb-4">信用卡還款</h3>
                        <div className="space-y-4">
                            <div>
                                <label className="text-xs text-gray-400 block mb-1">還款金額 (欠款)</label>
                                <input type="number" value={repayModal.amount} onChange={e => setRepayModal({...repayModal, amount: e.target.value})} className="w-full border-b border-gray-300 py-1 text-lg outline-none text-[#333]" />
                            </div>
                            <div>
                                <label className="text-xs text-gray-400 block mb-2">付款帳戶</label>
                                <select value={repayModal.payAccId} onChange={e => setRepayModal({...repayModal, payAccId: e.target.value})} className="w-full bg-white border border-gray-200 p-2 rounded text-sm outline-none">
                                    {accounts.filter(a => a.type !== 'liability').map(a => <option key={a.id} value={a.id}>{a.name} (${a.balance})</option>)}
                                </select>
                            </div>
                        </div>
                        <div className="flex gap-3 mt-6">
                            <button onClick={() => setRepayModal(null)} className="flex-1 py-2 text-gray-500 bg-gray-100 rounded">取消</button>
                            <button onClick={confirmRepay} className="flex-1 py-2 bg-[#333] text-white rounded">確認還款</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};
// ==========================================
// SettingsView (優化：設定頁面-資料管理介面整合)
// ==========================================

const SettingsView = ({ onChangeTab }) => {
    const [isCloudExpanded, setIsCloudExpanded] = useState(false);

    // 從 Context 取得資料與方法
    const { 
        cloudSettings, setCloudSettings,
        handleExportData, handleExportCSV,
        handleImportData,
        handleManualRestore, handleCloudBackup,
        showConfirm,
        isDarkMode, toggleTheme // 確保這裡有取出深色模式控制
    } = React.useContext(DataContext);

    const handleReset = () => {
        showConfirm('重置', '確定刪除所有資料？', () => {
            localStorage.clear();
            window.location.reload();
        });
    };

    // 抽出一個共用的 Section Title 元件，保持風格一致
    const SectionTitle = ({ title }) => (
        <div className="text-xs text-gray-400 font-medium mb-2 mt-6 uppercase tracking-widest pl-1">
            {title}
        </div>
    );

    // 抽出資料操作小卡片
    const ActionCard = ({ icon, title, subtitle, onClick, colorClass = "text-[#333]", hoverClass = "hover:border-gray-300", children }) => (
        <div 
            onClick={onClick} 
            className={`bg-white p-3 rounded border border-transparent shadow-sm flex flex-col justify-center gap-2 cursor-pointer transition relative group ${hoverClass}`}
        >
            {children}
            <div className="flex items-center gap-2">
                <Icon name={icon} size={20} className={`${colorClass} opacity-80 group-hover:opacity-100 transition`} />
                <span className={`text-sm font-medium ${colorClass}`}>{title}</span>
            </div>
            <div className="text-[10px] text-gray-400">{subtitle}</div>
        </div>
    );

    return (
        <div className="h-full flex flex-col pt-10 px-6 pb-0 animate-fade-in">
            <div className="shrink-0 mb-2">
                <h2 className="text-xl font-medium text-[#333] tracking-wide">設定</h2>
            </div>

            <div className="flex-1 overflow-y-auto no-scrollbar pb-24">
                
                {/* 1. 一般設定區塊 */}
                <SectionTitle title="一般" />
                <div className="space-y-3">
                    <div onClick={toggleTheme}>
                        <SettingItem 
                            iconName={isDarkMode ? "moon" : "sun"} // 請確認 IconPaths 有 moon/sun，若無可用 image/search 代替
                            label={isDarkMode ? "外觀：深色模式" : "外觀：淺色模式"} 
                            className="transition-colors"
                        />
                    </div>
                    <div onClick={() => onChangeTab('templates')}><SettingItem iconName="lightning" label="快速記帳模板" hasArrow /></div>
                    <div onClick={() => onChangeTab('categories')}><SettingItem iconName="list" label="分類管理" hasArrow /></div>
                    <div onClick={() => onChangeTab('recurring')}><SettingItem iconName="calendar" label="週期帳單 / 分期" hasArrow /></div>
                </div>

                {/* 2. 資料與備份區塊 */}
                <SectionTitle title="資料同步" />
                
                {/* 雲端備份 (獨立卡片) */}
                <div className="bg-white rounded border border-transparent shadow-sm overflow-hidden transition hover:shadow-md">
                    <div 
                        onClick={() => setIsCloudExpanded(!isCloudExpanded)}
                        className="p-4 flex items-center justify-between cursor-pointer"
                    >
                        <div className="flex items-center gap-3">
                            <div className={`w-9 h-9 rounded-full flex items-center justify-center transition ${cloudSettings.url ? 'bg-green-50 text-green-600 dark:bg-green-900/30 dark:text-green-400' : 'bg-gray-100 text-gray-400 dark:bg-gray-700'}`}>
                                <Icon name="cloud" size={18} />
                            </div>
                            <div>
                                <div className="text-sm text-[#333] font-medium">Google Drive 同步</div>
                                <div className="text-[10px] text-gray-400">
                                    {cloudSettings.url ? '● 已連線' : '未設定'}
                                </div>
                            </div>
                        </div>
                        <Icon name={isCloudExpanded ? "chevronDown" : "chevronRight"} size={16} className="text-gray-300" />
                    </div>
                    
                    {/* 展開內容 */}
                    {isCloudExpanded && (
                        <div className="p-4 pt-0 space-y-3 animate-fade-in border-t border-gray-50 dark:border-gray-700">
                            <div className="text-[10px] text-gray-400 leading-relaxed pt-3">
                                設定 GAS URL 以啟用自動備份。
                            </div>
                            <div className="space-y-2">
                                <input 
                                    type="text" 
                                    placeholder="API URL" 
                                    value={cloudSettings.url || ''}
                                    onChange={(e) => setCloudSettings(prev => ({ ...prev, url: e.target.value }))}
                                    className="w-full bg-gray-50 dark:bg-[#40444B] border border-gray-200 dark:border-gray-600 rounded p-2 text-xs outline-none focus:border-[#333] transition"
                                />
                                <div className="flex gap-2">
                                    <input 
                                        type="password" 
                                        placeholder="密碼" 
                                        value={cloudSettings.password || ''}
                                        onChange={(e) => setCloudSettings(prev => ({ ...prev, password: e.target.value }))}
                                        className="flex-1 bg-gray-50 dark:bg-[#40444B] border border-gray-200 dark:border-gray-600 rounded p-2 text-xs outline-none focus:border-[#333] transition"
                                    />
                                    <button onClick={() => handleManualRestore(cloudSettings.url, cloudSettings.password)} className="px-3 bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-200 rounded text-xs font-medium hover:brightness-95 transition whitespace-nowrap">連結</button>
                                    <button onClick={() => handleCloudBackup(false)} className="px-3 bg-[#333] text-white rounded text-xs font-medium hover:opacity-90 transition whitespace-nowrap">上傳</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>

                {/* 3. 本機資料區塊 */}
                <SectionTitle title="檔案管理" />
                <div className="grid grid-cols-2 gap-3">
                    {/* 匯出備份 */}
                    <ActionCard 
                        icon="download" 
                        title="備份檔案" 
                        subtitle="JSON 格式" 
                        onClick={handleExportData}
                    />

                    {/* 匯出報表 */}
                    <ActionCard 
                        icon="fileText" 
                        title="匯出報表" 
                        subtitle="Excel / CSV" 
                        onClick={handleExportCSV} 
                        colorClass="text-green-600 dark:text-green-400"
                    />

                    {/* 匯入還原 */}
                    <ActionCard 
                        icon="upload" 
                        title="匯入還原" 
                        subtitle="讀取 JSON" 
                        onClick={() => {}} // 實際點擊由 input 觸發
                        colorClass="text-blue-500 dark:text-blue-400"
                    >
                        <input type="file" accept=".json" onChange={handleImportData} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"/>
                    </ActionCard>

                    {/* 重置資料 */}
                    <ActionCard 
                        icon="rotateCcw" 
                        title="重置資料" 
                        subtitle="清空所有紀錄" 
                        onClick={handleReset} 
                        colorClass="text-[#D9534F]" 
                        hoverClass="hover:border-red-200 dark:hover:border-red-900"
                    />
                </div>

                <div className="mt-12 text-center">
                    <div className="text-[10px] text-gray-300 font-light tracking-widest uppercase">Money Master</div>
                </div>
            </div>
        </div>
    );
};
// ==========================================
// CategoryManager (分類管理器)
// ==========================================
const CategoryManager = ({ onBack }) => {
    const { 
        categories, 
        transactions, 
        setCategories: onUpdate, 
        showConfirm: onConfirm,
        handleMergeAndDeleteCategory: onMergeAndDelete 
    } = React.useContext(DataContext);

    const [tab, setTab] = useState('expense');
    const [isEditing, setIsEditing] = useState(false);
    const [editTarget, setEditTarget] = useState(null);
    
    // ★ 新增：排序狀態
    const [isReordering, setIsReordering] = useState(false);

    // 刪除保護 UI
    const [deleteMode, setDeleteMode] = useState(null);
    const [transferTargetId, setTransferTargetId] = useState('');

    // 表單
    const [formName, setFormName] = useState('');
    const [formIconKey, setFormIconKey] = useState('more');
    const [formColor, setFormColor] = useState('#A5A58D');
    const [formBudget, setFormBudget] = useState(''); 
    const [subCatName, setSubCatName] = useState('');

    const currentList = tab === 'expense' ? categories.expense : categories.income;

    // ★ 新增：移動順序邏輯
    const moveCategory = (index, direction) => {
        const newList = [...currentList];
        const targetIndex = index + direction;
        
        // 邊界檢查
        if (targetIndex < 0 || targetIndex >= newList.length) return;
        
        // 交換位置
        [newList[index], newList[targetIndex]] = [newList[targetIndex], newList[index]];
        
        onUpdate({ ...categories, [tab]: newList });
    };

    const handleEdit = (cat) => {
        if (isReordering) return; // 排序模式下不可編輯
        setEditTarget(cat);
        setFormName(cat.name);
        setFormIconKey(cat.iconKey || 'more');
        setFormColor(cat.color);
        setFormBudget(cat.budget ? cat.budget.toString() : ''); 
        setIsEditing(true);
    };

    const handleAdd = () => {
        setEditTarget(null);
        setFormName('');
        setFormIconKey('more');
        setFormColor('#A5A58D');
        setFormBudget('');
        setIsEditing(true);
    };

    const handleSave = () => {
        if(!formName) return;
        
        // ★ 修正：使用 prev 參數，避免覆蓋掉其他分頁(支出/收入)的異動
        onUpdate(prev => {
            const currentList = prev[tab]; // 根據當前的 tab (expense/income) 抓取對應列表
            const existingSubs = editTarget ? (editTarget.subCategories || []) : [];
            
            const newItem = {
                id: editTarget ? editTarget.id : Date.now().toString(),
                name: formName,
                iconKey: formIconKey,
                color: formColor,
                budget: Number(formBudget) || 0,
                subCategories: existingSubs
            };

            const newList = editTarget 
                ? currentList.map(c => c.id === newItem.id ? newItem : c) 
                : [...currentList, newItem];

            return { ...prev, [tab]: newList };
        });

        setIsEditing(false);
    };

    const handleDeleteClick = () => {
            if (!editTarget) return;
            const usageCount = transactions.filter(t => t.categoryId === editTarget.id).length;
            
            if (usageCount > 0) {
                setDeleteMode({ targetCat: editTarget, count: usageCount });
                const otherCats = currentList.filter(c => c.id !== editTarget.id);
                if (otherCats.length > 0) setTransferTargetId(otherCats[0].id);
            } else {
                onConfirm('刪除分類', `確定刪除分類: ${editTarget.name}?`, () => {
                    // ★ 修正：使用 prev 確保刪除動作正確
                    onUpdate(prev => ({
                        ...prev,
                        [tab]: prev[tab].filter(c => c.id !== editTarget.id)
                    }));
                    setIsEditing(false);
                });
            }
        };

    const confirmMergeDelete = () => {
        if (!transferTargetId) return;
        onMergeAndDelete(deleteMode.targetCat.id, transferTargetId);
        setIsEditing(false);
        setDeleteMode(null);
    };

    const handleAddSubCat = () => { if(!subCatName || !editTarget) return; const newSub = { id: Date.now().toString(), name: subCatName }; const updatedCat = { ...editTarget, subCategories: [...(editTarget.subCategories || []), newSub] }; setEditTarget(updatedCat); setSubCatName(''); const newList = currentList.map(c => c.id === updatedCat.id ? updatedCat : c); onUpdate({ ...categories, [tab]: newList }); };
    const handleDeleteSubCat = (subId) => { onConfirm('刪除細項', '確定刪除此細項？', () => { const updatedCat = { ...editTarget, subCategories: editTarget.subCategories.filter(s => s.id !== subId) }; setEditTarget(updatedCat); const newList = currentList.map(c => c.id === updatedCat.id ? updatedCat : c); onUpdate({ ...categories, [tab]: newList }); }); };
    const iconOptions = ['utensils', 'bus', 'shoppingBag', 'film', 'medical', 'briefcase', 'trendingUp', 'circleDollar', 'home', 'users', 'more'];

    if (isEditing) {
        // 這裡的 return 代碼與你原本的編輯介面完全相同，為了節省篇幅，請保留原來的邏輯
        // (如果有需要我再次完整列出編輯模式的 JSX，請告訴我)
        return (
            <div className="fixed inset-0 bg-white flex flex-col p-6 animate-slide-up z-[250]">
                <div className="flex items-center mb-6">
                    <button onClick={() => setIsEditing(false)} className="mr-4 text-gray-400 p-2 -ml-2"><Icon name="close" /></button>
                    <h2 className="text-lg font-medium">{editTarget ? '編輯分類' : '新增分類'}</h2>
                </div>
                {/* 刪除保護模式 */}
                {deleteMode ? (
                    <div className="flex-1 flex flex-col justify-center items-center p-4">
                        <div className="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center text-red-500 mb-4"><Icon name="trash" size={32}/></div>
                        <h3 className="text-lg font-bold text-[#333] mb-2">無法直接刪除</h3>
                        <p className="text-sm text-gray-500 text-center mb-6">此分類包含 <strong>{deleteMode.count}</strong> 筆交易紀錄。<br/>請選擇一個分類來接收這些紀錄：</p>
                        <div className="w-full bg-gray-50 p-3 rounded border border-gray-200 mb-6">
                            <label className="text-xs text-gray-400 block mb-2 uppercase">移轉至</label>
                            <select className="w-full bg-transparent outline-none text-[#333]" value={transferTargetId} onChange={e => setTransferTargetId(e.target.value)}>
                                {currentList.filter(c => c.id !== deleteMode.targetCat.id).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                            </select>
                        </div>
                        <div className="flex gap-3 w-full">
                            <button onClick={() => setDeleteMode(null)} className="flex-1 py-3 text-gray-500 bg-gray-100 rounded">取消</button>
                            <button onClick={confirmMergeDelete} className="flex-1 py-3 bg-[#333] text-white rounded shadow">移轉並刪除</button>
                        </div>
                    </div>
                ) : (
                    // 一般編輯表單
                    <>
                        <div className="space-y-6 flex-1 overflow-y-auto pb-10">
                            <div><label className="text-xs text-gray-400 block mb-2 uppercase tracking-wide">名稱</label><input className="w-full border-b border-gray-200 py-2 text-lg outline-none rounded-none text-[#333]" value={formName} onChange={e => setFormName(e.target.value)} placeholder="分類名稱" /></div>
                            {tab === 'expense' && (<div><label className="text-xs text-gray-400 block mb-2 uppercase tracking-wide">每月預算目標</label><div className="flex items-center gap-2 border-b border-gray-200 py-2"><span className="text-gray-400">$</span><input type="number" className="w-full text-lg outline-none rounded-none text-[#333]" value={formBudget} onChange={e => setFormBudget(e.target.value)} placeholder="0 (不設定)" /></div><p className="text-[10px] text-gray-400 mt-1">設定 0 代表不啟用預算提醒</p></div>)}
                            {editTarget && (<div className="bg-gray-50 p-4 rounded border border-gray-100"><label className="text-xs text-gray-400 block mb-2 uppercase tracking-wide">子分類 (細項)</label><div className="flex gap-2 mb-3"><input className="flex-1 border border-gray-200 px-2 py-1 text-sm rounded" placeholder="新增細項..." value={subCatName} onChange={e => setSubCatName(e.target.value)} /><button onClick={handleAddSubCat} className="bg-[#333] text-white px-3 py-1 rounded text-xs">新增</button></div><div className="flex flex-wrap gap-2">{(editTarget.subCategories || []).map(s => (<span key={s.id} className="bg-white border border-gray-200 px-2 py-1 rounded text-xs flex items-center gap-2">{s.name} <button onClick={() => handleDeleteSubCat(s.id)} className="text-red-400"><Icon name="close" size={10}/></button></span>))}</div></div>)}
                            <div><label className="text-xs text-gray-400 block mb-3 uppercase tracking-wide">圖示</label><div className="flex gap-4 flex-wrap">{iconOptions.map(key => (<button key={key} onClick={() => setFormIconKey(key)} className={`w-10 h-10 rounded-full flex items-center justify-center border transition ${formIconKey === key ? 'border-[#333] bg-gray-50 text-[#333]' : 'border-transparent bg-[#F5F5F3] text-gray-400'}`}><Icon name={key} size={20} /></button>))}</div></div>
                            <div><label className="text-xs text-gray-400 block mb-3 uppercase tracking-wide">顏色</label><div className="flex gap-3 flex-wrap">{['#A5A58D', '#6B705C', '#CB997E', '#DDBEA9', '#FFE8D6', '#B7B7A4', '#D9534F', '#5CB85C', '#333333'].map(c => (<button key={c} onClick={() => setFormColor(c)} className={`w-8 h-8 rounded-full border-2 ${formColor === c ? 'border-gray-500 scale-110' : 'border-transparent'}`} style={{backgroundColor: c}} />))}</div></div>
                        </div>
                        <div className="flex gap-3 mt-4">
                             {editTarget && <button onClick={handleDeleteClick} className="flex-1 py-3 text-[#D9534F] bg-red-50 rounded font-medium">刪除</button>}
                             <button onClick={handleSave} className="flex-[2] py-3 bg-[#333] text-white rounded font-medium shadow-lg">儲存</button>
                        </div>
                    </>
                )}
            </div>
        );
    }

    return (
        <div className="h-full bg-[#F5F5F3] flex flex-col animate-slide-up z-[200] fixed inset-0">
            <div className="bg-white px-5 pt-12 pb-4 border-b border-gray-200">
                <div className="flex items-center justify-between mb-6">
                    <div className="flex items-center gap-4">
                        <button onClick={onBack} className="p-1 -ml-2 text-gray-500 hover:text-black"><Icon name="back" size={24}/></button>
                        <h2 className="text-xl font-medium">分類管理</h2>
                    </div>
                    {/* ★ 新增：切換排序按鈕 */}
                    <div className="flex gap-2">
                        {currentList.length > 1 && (
                            isReordering ? (
                                <button onClick={() => setIsReordering(false)} className="text-xs bg-[#333] text-white px-3 py-1.5 rounded shadow-sm">完成</button>
                            ) : (
                                <button onClick={() => setIsReordering(true)} className="text-xs text-gray-500 px-2 py-1.5 hover:bg-gray-100 rounded transition">調整順序</button>
                            )
                        )}
                    </div>
                </div>
                
                <div className="flex bg-[#F5F5F3] p-1 rounded">
                    <button onClick={() => { setTab('expense'); setIsReordering(false); }} className={`flex-1 py-1.5 text-sm rounded transition ${tab === 'expense' ? 'bg-white shadow-sm text-[#333]' : 'text-gray-400'}`}>支出</button>
                    <button onClick={() => { setTab('income'); setIsReordering(false); }} className={`flex-1 py-1.5 text-sm rounded transition ${tab === 'income' ? 'bg-white shadow-sm text-[#333]' : 'text-gray-400'}`}>收入</button>
                </div>
            </div>
            
            <div className="flex-1 overflow-y-auto p-4 space-y-2 pb-20">
                {currentList.map((c, index) => (
                    <div 
                        key={c.id} 
                        onClick={() => handleEdit(c)} 
                        className={`bg-white p-3.5 rounded flex items-center justify-between border border-transparent transition ${!isReordering && 'hover:border-gray-200 active:scale-[0.99] cursor-pointer'}`}
                    >
                        <div className="flex items-center gap-4">
                            <div className="w-9 h-9 rounded-full flex items-center justify-center text-lg text-gray-600 bg-gray-50">
                                <Icon name={c.iconKey || 'more'} size={18} />
                            </div>
                            <div>
                                <div className="text-[#333] flex items-center gap-2">
                                    {c.name}
                                    {c.budget > 0 && <span className="text-[9px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">預算 ${c.budget}</span>}
                                </div>
                                <div className="text-[10px] text-gray-400">{(c.subCategories||[]).map(s=>s.name).join(', ')}</div>
                            </div>
                        </div>
                        
                        {/* ★ 修改：根據模式顯示不同按鈕 */}
                        {isReordering ? (
                            <div className="flex items-center gap-1">
                                <button 
                                    onClick={(e) => { e.stopPropagation(); moveCategory(index, -1); }} 
                                    disabled={index === 0}
                                    className={`p-2 rounded ${index === 0 ? 'text-gray-200' : 'text-gray-400 hover:text-[#333] active:bg-gray-100'}`}
                                >
                                    <Icon name="chevronUp" size={20}/>
                                </button>
                                <button 
                                    onClick={(e) => { e.stopPropagation(); moveCategory(index, 1); }} 
                                    disabled={index === currentList.length - 1}
                                    className={`p-2 rounded ${index === currentList.length - 1 ? 'text-gray-200' : 'text-gray-400 hover:text-[#333] active:bg-gray-100'}`}
                                >
                                    <Icon name="chevronDown" size={20}/>
                                </button>
                            </div>
                        ) : (
                            <Icon name="edit" size={16} className="text-gray-300"/>
                        )}
                    </div>
                ))}
                
                {/* 排序模式下隱藏新增按鈕 */}
                {!isReordering && (
                    <button onClick={handleAdd} className="w-full py-3.5 border border-dashed border-gray-300 text-gray-400 rounded flex items-center justify-center gap-2 mt-4 hover:bg-white hover:border-gray-400 transition">
                        <Icon name="plus" size={18} /> 新增分類
                    </button>
                )}
            </div>
        </div>
    );
};

// ==========================================
// TemplateManager (快速記帳模板管理器)
// ==========================================
const TemplateManager = ({ onBack }) => {
    const { 
        quickTemplates: templates, 
        categories, 
        accounts, 
        setQuickTemplates: onUpdate, 
        showConfirm 
    } = React.useContext(DataContext);

    const [isEditing, setIsEditing] = useState(false);
    const [editId, setEditId] = useState(null);
    const [formName, setFormName] = useState('');
    const [formCat, setFormCat] = useState(categories.expense[0]?.id);
    const [formSubCat, setFormSubCat] = useState('');
    const [formAcc, setFormAcc] = useState(accounts[0]?.id);
    const [formIsSplit, setFormIsSplit] = useState(false);

    // 排序狀態
    const [isReordering, setIsReordering] = useState(false);

    const activeCat = categories.expense.find(c => c.id === formCat) || {};
    const subCats = activeCat.subCategories || [];

    // 移動順序邏輯
    const moveTemplate = (index, direction) => {
        const newTemplates = [...templates];
        const targetIndex = index + direction;
        if (targetIndex < 0 || targetIndex >= newTemplates.length) return;
        [newTemplates[index], newTemplates[targetIndex]] = [newTemplates[targetIndex], newTemplates[index]];
        onUpdate(newTemplates);
    };

    const startEdit = (tpl) => {
        if (isReordering) return;
        setEditId(tpl.id);
        setFormName(tpl.name);
        setFormCat(tpl.categoryId);
        setFormSubCat(tpl.subCategoryId || '');
        setFormAcc(tpl.accountId);
        setFormIsSplit(tpl.isSplit || false);
        setIsEditing(true);
    };

    const handleSave = () => {
        if (!formName) return;
        const cat = categories.expense.find(c => c.id === formCat) || categories.expense[0];
        const newTpl = {
            id: editId || Date.now().toString(),
            name: formName,
            categoryId: formCat,
            subCategoryId: formSubCat || null,
            accountId: formAcc,
            iconKey: cat.iconKey,
            isSplit: formIsSplit
        };
        
        // 使用 functional update 確保資料一致性
        onUpdate(prev => {
            if (editId) {
                return prev.map(t => t.id === editId ? newTpl : t);
            } else {
                return [...prev, newTpl];
            }
        });

        setIsEditing(false);
        setEditId(null);
        setFormName('');
        setFormIsSplit(false);
        setFormSubCat('');
    };

    // ★ 修正重點：改用 prev => prev.filter(...) 確保刪除當下是最新的資料
    const handleDelete = (id) => {
        showConfirm('刪除模板', '確定刪除此快速記帳模板？', () => {
             onUpdate(prev => prev.filter(t => t.id !== id));
        });
    };

    if (isEditing) {
        return (
            <div className="fixed inset-0 bg-white flex flex-col p-6 animate-slide-up z-50">
                <div className="flex items-center mb-8">
                    <button onClick={() => setIsEditing(false)} className="mr-4 text-gray-400 p-2 -ml-2"><Icon name="close" /></button>
                    <h2 className="text-lg font-medium">{editId ? '編輯模板' : '新增模板'}</h2>
                </div>
                <div className="space-y-6 flex-1">
                    <div>
                        <label className="text-xs text-gray-400 block mb-2 uppercase">模板名稱</label>
                        <input className="w-full border-b border-gray-200 py-2 text-lg outline-none rounded-none text-[#333]" value={formName} onChange={e => setFormName(e.target.value)} placeholder="例如：午餐" autoFocus />
                    </div>
                    <div>
                        <label className="text-xs text-gray-400 block mb-2 uppercase">預設分類</label>
                        <select className="w-full bg-[#F5F5F3] p-3 rounded outline-none" value={formCat} onChange={e => { setFormCat(e.target.value); setFormSubCat(''); }}>
                            {categories.expense.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                        </select>
                    </div>
                    {subCats.length > 0 && (
                        <div>
                            <label className="text-xs text-gray-400 block mb-2 uppercase">預設細項</label>
                            <select className="w-full bg-[#F5F5F3] p-3 rounded outline-none" value={formSubCat} onChange={e => setFormSubCat(e.target.value)}>
                                <option value="">(無)</option>
                                {subCats.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                        </div>
                    )}
                    <div>
                        <label className="text-xs text-gray-400 block mb-2 uppercase">預設帳戶</label>
                        <select className="w-full bg-[#F5F5F3] p-3 rounded outline-none" value={formAcc} onChange={e => setFormAcc(e.target.value)}>
                            {accounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                        </select>
                    </div>
                    <div className="flex items-center justify-between bg-[#F9F9F9] p-4 rounded">
                        <span className="text-sm font-medium">預設為分帳/代墊？</span>
                        <input type="checkbox" className="w-5 h-5 accent-[#333]" checked={formIsSplit} onChange={e => setFormIsSplit(e.target.checked)} />
                    </div>
                </div>
                <button onClick={handleSave} className="w-full py-3 bg-[#333] text-white rounded font-medium shadow-lg">儲存模板</button>
            </div>
        );
    }

    return (
        <div className="h-full bg-[#F5F5F3] flex flex-col animate-slide-up z-40 fixed inset-0">
            <div className="bg-white px-5 pt-12 pb-4 border-b border-gray-200 flex justify-between items-center">
                <div className="flex items-center gap-4">
                    <button onClick={onBack} className="p-1 -ml-2 text-gray-500 hover:text-black"><Icon name="back" size={24}/></button>
                    <h2 className="text-xl font-medium">快速記帳模板</h2>
                </div>
                <div className="flex gap-2">
                    {templates.length > 1 && (
                        isReordering ? (
                            <button onClick={() => setIsReordering(false)} className="text-xs bg-[#333] text-white px-3 py-1.5 rounded shadow-sm">完成</button>
                        ) : (
                            <button onClick={() => setIsReordering(true)} className="text-xs text-gray-500 px-2 py-1.5 hover:bg-gray-100 rounded transition">調整順序</button>
                        )
                    )}
                </div>
            </div>
            
            <div className="flex-1 overflow-y-auto p-4 space-y-2">
                {templates.map((t, index) => (
                    <div 
                        key={t.id} 
                        onClick={() => startEdit(t)} 
                        className={`bg-white p-3.5 rounded flex items-center justify-between border border-transparent transition ${!isReordering && 'cursor-pointer hover:border-gray-300'}`}
                    >
                        <div className="flex items-center gap-4">
                            <div className="w-9 h-9 rounded-full flex items-center justify-center text-lg text-gray-600 bg-gray-50">
                                <Icon name={t.iconKey || 'template'} size={18} />
                            </div>
                            <div>
                                <div className="text-[#333] text-sm font-medium">{t.name}</div>
                                <div className="text-xs text-gray-400">
                                    {categories.expense.find(c=>c.id===t.categoryId)?.name} · {accounts.find(a=>a.id===t.accountId)?.name}
                                    {t.isSplit && <span className="ml-2 bg-gray-100 px-1 rounded text-[9px]">分帳</span>}
                                </div>
                            </div>
                        </div>
                        
                        {isReordering ? (
                            <div className="flex items-center gap-1">
                                <button 
                                    onClick={(e) => { e.stopPropagation(); moveTemplate(index, -1); }} 
                                    disabled={index === 0}
                                    className={`p-2 rounded ${index === 0 ? 'text-gray-200' : 'text-gray-400 hover:text-[#333] active:bg-gray-100'}`}
                                >
                                    <Icon name="chevronUp" size={20}/>
                                </button>
                                <button 
                                    onClick={(e) => { e.stopPropagation(); moveTemplate(index, 1); }} 
                                    disabled={index === templates.length - 1}
                                    className={`p-2 rounded ${index === templates.length - 1 ? 'text-gray-200' : 'text-gray-400 hover:text-[#333] active:bg-gray-100'}`}
                                >
                                    <Icon name="chevronDown" size={20}/>
                                </button>
                            </div>
                        ) : (
                            <div className="flex gap-2">
                                {/* 這裡綁定了修正後的 handleDelete */}
                                <button onClick={(e) => { e.stopPropagation(); handleDelete(t.id); }} className="text-gray-300 hover:text-red-500 p-2"><Icon name="trash" size={16}/></button>
                            </div>
                        )}
                    </div>
                ))}
                
                {!isReordering && (
                    <button onClick={() => { setEditId(null); setFormName(''); setIsEditing(true); }} className="w-full py-3.5 border border-dashed border-gray-300 text-gray-400 rounded flex items-center justify-center gap-2 mt-4 hover:bg-white transition">
                        <Icon name="plus" size={18} /> 新增模板
                    </button>
                )}
            </div>
        </div>
    );
};
// ==========================================
// RecurringManager (定期項目管理器)
// ==========================================
const RecurringManager = ({ onBack }) => {
            const { 
                recurringItems, categories, accounts, 
                setRecurringItems: onUpdate, showConfirm: onConfirm 
            } = React.useContext(DataContext);

            const [isEditing, setIsEditing] = useState(false);
            const [editTarget, setEditTarget] = useState(null);
            const [showPlan, setShowPlan] = useState(false);
            
            // 表單欄位
            const [type, setType] = useState('expense'); 
            const [name, setName] = useState('');
            const [amount, setAmount] = useState('');
            const [day, setDay] = useState('1'); 
            const [catId, setCatId] = useState('');
            const [accId, setAccId] = useState('');       
            const [targetAccId, setTargetAccId] = useState(''); 

            const [startDate, setStartDate] = useState(getLocalDateString().slice(0, 7));
            const [totalPeriods, setTotalPeriods] = useState('');
            const [interest, setInterest] = useState('');

            // ★ 關鍵修正：當 type 改變時，確保 catId 正確歸零或切換到該類型的第一個分類
            useEffect(() => {
                if (isEditing) {
                    if (type === 'expense') {
                        // 如果當前的 catId 不在 expense 列表中，則重置
                        const isValid = categories.expense.some(c => c.id === catId);
                        if (!isValid && categories.expense.length > 0) setCatId(categories.expense[0].id);
                    } else if (type === 'income') {
                        // 如果當前的 catId 不在 income 列表中，則重置
                        const isValid = categories.income.some(c => c.id === catId);
                        if (!isValid && categories.income.length > 0) setCatId(categories.income[0].id);
                    }

                    if (accounts.length > 0) {
                        if(!accId) setAccId(accounts[0].id);
                        if(type === 'transfer' && !targetAccId) setTargetAccId(accounts.length > 1 ? accounts[1].id : accounts[0].id);
                    }
                }
            }, [type, isEditing, categories, accounts]); 

            const handleAddClick = () => {
                setEditTarget(null);
                resetForm();
                setIsEditing(true);
            };

            const handleEditClick = (item) => {
                setEditTarget(item);
                setType(item.type || 'expense');
                setName(item.name);
                setAmount(item.amount.toString());
                setDay(item.day.toString());
                setCatId(item.categoryId || '');
                setAccId(item.accountId || '');
                setTargetAccId(item.targetAccountId || '');
                setStartDate(item.startDate || getLocalDateString().slice(0, 7));
                setTotalPeriods(item.totalPeriods ? item.totalPeriods.toString() : '');
                setInterest(item.interest ? item.interest.toString() : '');
                setIsEditing(true);
            };

            const handleSave = () => {
                if (!name || !amount) return;
                
                const payload = {
                    type, name,
                    amount: Number(amount),
                    day: Number(day),
                    accountId: accId,
                    categoryId: type === 'transfer' ? 'transfer' : catId,
                    targetAccountId: type === 'transfer' ? targetAccId : null,
                    startDate,
                    totalPeriods: totalPeriods ? Number(totalPeriods) : null,
                    interest: interest ? Number(interest) : 0,
                    executedPeriods: editTarget ? (editTarget.executedPeriods || 0) : 0
                };

                // ★ 修正：使用 prev 確保資料最新
                onUpdate(prev => {
                    if (editTarget) {
                        return prev.map(item => item.id === editTarget.id ? { ...item, ...payload, active: item.active, lastGeneratedMonth: item.lastGeneratedMonth } : item);
                    } else {
                        const newItem = {
                            id: Date.now().toString(),
                            ...payload,
                            lastGeneratedMonth: '', 
                            active: true
                        };
                        return [...prev, newItem];
                    }
                });
                
                setIsEditing(false);
                setEditTarget(null);
                resetForm();
            };

            const toggleActive = (id) => {
                const updated = recurringItems.map(item => item.id === id ? { ...item, active: item.active === undefined ? false : !item.active } : item);
                onUpdate(updated);
            };

            const handleDelete = (id) => {
                onConfirm('刪除', '確定要刪除？', () => {
                    // ★ 修正：使用 prev => prev.filter(...) 徹底解決刪除無效問題
                    onUpdate(prev => prev.filter(item => item.id !== id));
                    
                    if (editTarget && editTarget.id === id) setIsEditing(false);
                });
            }

            const resetForm = () => {
                setType('expense');
                setName('');
                setAmount('');
                setDay('1');
                setStartDate(getLocalDateString().slice(0, 7));
                setTotalPeriods('');
                setInterest('');
                setCatId('');
                setAccId('');
                setTargetAccId('');
            };

            const generatePlan = () => {
                if (!totalPeriods) return [];
                const plan = [];
                const [startYear, startMonth] = startDate.split('-').map(Number);
                for (let i = 0; i < Number(totalPeriods); i++) {
                    const d = new Date(startYear, startMonth - 1 + i, Number(day));
                    const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2,'0')}-${String(Number(day)).padStart(2,'0')}`;
                    const executed = editTarget ? (i < (editTarget.executedPeriods || 0)) : false;
                    plan.push({ period: i + 1, date: dateStr, amount: Number(amount), status: executed ? '已執行' : '待執行' });
                }
                return plan;
            };

            if (isEditing) {
                return (
                    <div className="h-full bg-[#F5F5F3] flex flex-col animate-slide-up z-[200] fixed inset-0 p-6 overflow-y-auto">
                        <div className="flex items-center mb-6">
                            <button onClick={() => setIsEditing(false)} className="mr-4 text-gray-400 p-2 -ml-2"><Icon name="close" /></button>
                            <h2 className="text-lg font-medium">{editTarget ? '編輯項目' : '新增項目'}</h2>
                        </div>
                        <div className="space-y-5 flex-1 pb-10">
                            <div><label className="text-xs text-gray-400 block mb-1">名稱</label><input className="w-full border-b py-1 outline-none bg-transparent" value={name} onChange={e => setName(e.target.value)} placeholder="例如：房租、薪資" autoFocus /></div>
                            
                            <div>
                                <label className="text-xs text-gray-400 block mb-2">類型</label>
                                <div className="flex bg-white rounded p-1 border border-gray-200">
                                    {['expense', 'income', 'transfer'].map(t => (
                                        <button key={t} onClick={() => setType(t)} className={`flex-1 py-1.5 text-xs rounded transition ${type === t ? 'bg-[#333] text-white' : 'text-gray-500'}`}>
                                            {t === 'expense' ? '支出' : t === 'income' ? '收入' : '轉帳'}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="flex gap-4">
                                <div className="flex-1"><label className="text-xs text-gray-400 block mb-1">每期金額</label><input type="number" className="w-full border-b py-1 outline-none bg-transparent" value={amount} onChange={e => setAmount(e.target.value)} placeholder="0" /></div>
                                <div className="flex-1"><label className="text-xs text-gray-400 block mb-1">利息/手續費</label><input type="number" className="w-full border-b py-1 outline-none bg-transparent" value={interest} onChange={e => setInterest(e.target.value)} placeholder="0" /></div>
                            </div>

                            <div className="flex gap-4">
                                <div className="flex-1"><label className="text-xs text-gray-400 block mb-1">執行日 (每月)</label><input type="number" className="w-full border-b py-1 outline-none bg-transparent" value={day} onChange={e => setDay(e.target.value)} placeholder="1-31" /></div>
                                <div className="flex-1"><label className="text-xs text-gray-400 block mb-1">總期數 (空為無限)</label><input type="number" className="w-full border-b py-1 outline-none bg-transparent" value={totalPeriods} onChange={e => setTotalPeriods(e.target.value)} placeholder="∞" /></div>
                            </div>

                            <div><label className="text-xs text-gray-400 block mb-1">起扣月份</label><input type="month" className="w-full border-b py-1 outline-none bg-transparent" value={startDate} onChange={e => setStartDate(e.target.value)} /></div>

                            {type !== 'transfer' ? (
                                <div>
                                    <label className="text-xs text-gray-400 block mb-2">分類</label>
                                    <select className="w-full bg-white p-2 rounded" value={catId} onChange={e => setCatId(e.target.value)}>
                                        {(type === 'expense' ? categories.expense : categories.income).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                    </select>
                                </div>
                            ) : null}

                            <div className="flex gap-3">
                                <div className="flex-1">
                                    <label className="text-xs text-gray-400 block mb-2">{type === 'transfer' ? '轉出帳戶' : '帳戶'}</label>
                                    <select className="w-full bg-white p-2 rounded" value={accId} onChange={e => setAccId(e.target.value)}>
                                        {accounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                                    </select>
                                </div>
                                {type === 'transfer' && (
                                    <div className="flex-1">
                                        <label className="text-xs text-gray-400 block mb-2">轉入帳戶</label>
                                        <select className="w-full bg-white p-2 rounded" value={targetAccId} onChange={e => setTargetAccId(e.target.value)}>
                                            {accounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                                        </select>
                                    </div>
                                )}
                            </div>

                            {totalPeriods && (
                                <div className="bg-white rounded border border-gray-200 p-3 mt-4">
                                    <div className="flex justify-between items-center cursor-pointer" onClick={() => setShowPlan(!showPlan)}>
                                        <span className="text-xs font-bold text-gray-500">分期試算表</span>
                                        <Icon name={showPlan ? "chevronDown" : "chevronRight"} size={14} className="text-gray-400"/>
                                    </div>
                                    {showPlan && (
                                        <div className="mt-3 max-h-40 overflow-y-auto text-xs">
                                            <div className="grid grid-cols-3 text-gray-400 mb-1 pb-1 border-b"><span>期數</span><span>日期</span><span className="text-right">狀態</span></div>
                                            {generatePlan().map(p => (
                                                <div key={p.period} className="grid grid-cols-3 py-1 border-b border-gray-50 last:border-0 text-gray-600">
                                                    <span>{p.period}</span><span>{p.date}</span><span className={`text-right ${p.status === '已執行' ? 'text-green-500' : 'text-gray-400'}`}>{p.status}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                        <button onClick={handleSave} className="w-full py-3 bg-[#333] text-white rounded shadow-lg">儲存</button>
                    </div>
                );
            }

            return (
                <div className="h-full bg-[#F5F5F3] flex flex-col animate-slide-up z-[200] fixed inset-0">
                    <div className="bg-white px-5 pt-12 pb-4 border-b border-gray-200 flex items-center gap-4">
                        <button onClick={onBack} className="p-1 -ml-2 text-gray-500 hover:text-black"><Icon name="back" size={24}/></button>
                        <h2 className="text-xl font-medium">週期管理</h2>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-3 pb-24">
                        {recurringItems.length > 0 ? recurringItems.map(item => {
                            const isActive = item.active !== false;
                            const isFinished = item.totalPeriods && (item.executedPeriods || 0) >= item.totalPeriods;
                            const typeColor = item.type === 'income' ? 'text-green-600' : (item.type === 'transfer' ? 'text-blue-500' : 'text-gray-400');
                            
                            return (
                                <div key={item.id} className={`bg-white p-4 rounded flex items-center justify-between border transition shadow-sm ${isActive && !isFinished ? 'border-transparent' : 'border-dashed border-gray-300 opacity-60'}`}>
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2">
                                            <span className={`text-[10px] border px-1 rounded ${typeColor} border-current`}>
                                                {item.type === 'income' ? '收入' : item.type === 'transfer' ? '轉帳' : '支出'}
                                            </span>
                                            <div className="text-[#333] font-medium">{item.name}</div>
                                            {isFinished ? <span className="text-[10px] bg-green-100 text-green-600 px-1 rounded">已結束</span> : (!isActive && <span className="text-[10px] bg-gray-100 text-gray-400 px-1 rounded">已暫停</span>)}
                                        </div>
                                        <div className="text-xs text-gray-400 mt-1 flex gap-2 items-center">
                                            <span>每月{item.day}號</span>
                                            <span className="text-[#333] font-medium">${formatMoney(item.amount)}</span>
                                            {item.totalPeriods && <span className="text-[10px] bg-gray-100 px-1 rounded">進度: {item.executedPeriods||0}/{item.totalPeriods}</span>}
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-1">
                                        {!isFinished && (
                                            <div onClick={() => toggleActive(item.id)} className={`w-8 h-4 rounded-full relative cursor-pointer transition mr-2 ${isActive ? 'bg-[#333]' : 'bg-gray-200'}`}>
                                                <div className={`w-2 h-2 bg-white rounded-full absolute top-1 transition-all ${isActive ? 'left-5' : 'left-1'}`}></div>
                                            </div>
                                        )}
                                        <button onClick={() => handleEditClick(item)} className="text-gray-300 hover:text-[#333] p-2"><Icon name="edit" size={16}/></button>
                                        <button onClick={() => handleDelete(item.id)} className="text-gray-300 hover:text-red-500 p-2"><Icon name="trash" size={16}/></button>
                                    </div>
                                </div>
                            );
                        }) : (
                            <div className="text-center py-20 text-gray-400 text-sm">尚無週期設定</div>
                        )}
                        <button onClick={handleAddClick} className="w-full py-3.5 border border-dashed border-gray-300 text-gray-400 rounded flex items-center justify-center gap-2 mt-4 hover:bg-white transition"><Icon name="plus" size={18} /> 新增項目</button>
                    </div>
                </div>
            );
        };


        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MoneyMasterApp />);
        // --- 註冊 Service Worker (PWA) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

    </script>
</body>
</html>